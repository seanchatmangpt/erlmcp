%% Production System Configuration for erlmcp v3
%% Environment: production
%% Purpose: Hardened, optimized, minimal debug output, maximum security
%% Security: Strict restrictions, all debug features disabled

%% ============================================================================
%% PRODUCTION CONFIGURATION - READ AND UNDERSTAND BEFORE MODIFYING
%% - NO debug endpoints enabled
%% - Minimal logging for performance
%% - All security features enabled
%% - Optimized for high throughput
%% - Secrets externalized to Docker secrets / Vault
%% ============================================================================

[
    %% erlmcp application configuration
    {erlmcp, [
        %% --------------------------------------------------------------------
        %% Logging Configuration - WARN level only for production
        %% --------------------------------------------------------------------
        {log_level, warn},
        {logger_level, warn},

        %% --------------------------------------------------------------------
        %% Client Defaults - strict, production-grade
        %% --------------------------------------------------------------------
        {client_defaults, #{
            timeout => 5000,
            strict_mode => true,
            max_pending_requests => 100,
            retry_attempts => 2,
            retry_backoff_ms => 1000,
            circuit_breaker_enabled => true,
            circuit_breaker_threshold => 10,
            circuit_breaker_timeout => 30000
        }},

        %% --------------------------------------------------------------------
        %% Server Defaults - optimized for production
        %% --------------------------------------------------------------------
        {server_defaults, #{
            max_subscriptions_per_resource => 1000,
            max_progress_tokens => 10000,
            enable_debug_endpoints => false   %% NEVER enable in production
        }},

        %% --------------------------------------------------------------------
        %% Transport Settings - production hardened
        %% --------------------------------------------------------------------
        {transport_defaults, #{
            tcp => #{
                connect_timeout => 5000,
                keepalive => true,
                nodelay => true,
                listen_backlog => 512,
                send_timeout => 30000,
                recbuf => 16384,      %% 16KB receive buffer
                sndbuf => 16384       %% 16KB send buffer
            },
            http => #{
                connect_timeout => 5000,
                request_timeout => 30000,
                max_connections => 400,
                connection_keepalive => true,
                http2_enabled => true,
                max_keepalive => 100
            },
            stdio => #{
                enabled => false  %% Disabled in production
            }
        }},

        %% --------------------------------------------------------------------
        %% Connection Pooling - conservative, well-tuned
        %% --------------------------------------------------------------------
        {connection_pooling, #{
            enabled => true,
            pool_size => 50,
            max_overflow => 20,
            pool_timeout => 30000,
            idle_timeout_ms => 600000  %% 10 minutes
        }},

        %% --------------------------------------------------------------------
        %% Caching - enabled with longer TTL
        %% --------------------------------------------------------------------
        {cache_enabled, true},
        {cache_ttl_seconds, 3600},
        {cache_max_size, 100000},
        {cache_compression, true},

        %% --------------------------------------------------------------------
        %% Feature Toggles - experimental disabled
        %% --------------------------------------------------------------------
        {features, #{
            rate_limiting => true,
            rate_limit_per_second => 1000,
            rate_limit_burst => 100,
            async_processing => true,
            webhook_delivery => true,
            experimental => false  %% NO experimental features
        }},

        %% --------------------------------------------------------------------
        %% Production-Specific Options
        %% --------------------------------------------------------------------
        {production, #{
            enable_console_logging => false,
            enable_file_logging => true,
            enable_sql_logging => false,
            enable_http_logging => false,
            enable_profiling => false,
            enable_performance_monitoring => true,
            enable_security_audit_log => true,
            audit_log_dir => "/var/log/erlmcp/audit",
            enable_backup_validation => true,
            enable_graceful_shutdown => true,
            shutdown_timeout => 30000
        }}
    ]},

    %% ============================================================================
    %% Kernel Configuration
    %% ============================================================================
    {kernel, [
        {logger_level, warn},
        {logger, [
            %% Console handler - WARN and ERROR only
            {handler, default, logger_std_h, #{
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 500,    %% Higher queue in prod
                    drop_mode_qlen => 5000,
                    flush_qlen => 10000
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", msg, "\n"],
                    time_offset => "",
                    time_designator => $T,
                    single_line => true,      %% Compact format
                    max_size => 2048
                }},
                filters => [
                    {progress_reports, {fun logger_filters:progress/2, stop}},
                    {sasl_reports, {fun logger_filters:domain/2, {stop, sub, [otp, sasl]}}}
                ],
                level => warn
            }},

            %% File handler - errors and warnings only
            {handler, file_prod, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/erlmcp.log",
                    max_no_bytes => 104857600,  %% 100 MB
                    max_no_files => 30,         %% Keep 30 files = ~3 GB
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => warning
            }},

            %% Separate critical errors file
            {handler, file_critical, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/erlmcp-critical.log",
                    max_no_bytes => 52428800,  %% 50 MB
                    max_no_files => 10,
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => error
            }}
        ]}
    ]},

    %% ============================================================================
    %% SASL Configuration
    %% ============================================================================
    {sasl, [
        {sasl_error_logger, false},
        {errlog_type, error},
        {error_logger_format_depth, 20}
    ]},

    %% ============================================================================
    %% Runtime Options
    %% ============================================================================
    {erl_crash_dump, "/var/log/erlmcp/erl_crash.dump"},

    %% ============================================================================
    %% Network Configuration - production optimized
    %% ============================================================================
    {inet, [
        {tcp_listeners, [
            #{port => 6000, opts => [
                binary,
                {packet, raw},
                {reuseaddr, true},
                {recbuf, 16384},      %% 16KB receive buffer
                {sndbuf, 16384},      %% 16KB send buffer
                {nodelay, true},
                {keepalive, true},
                {backlog, 512}
            ]}
        ]}
    ]},

    %% ============================================================================
    %% Observability - Fully enabled
    %% ============================================================================
    {opentelemetry, [
        {enabled, true},
        {exporter, otlp},
        {endpoint, "${OTEL_EXPORTER_OTLP_ENDPOINT}"},
        {service_name, "erlmcp"},
        {resource_attributes, #{
            "deployment.environment" => "production",
            "service.version" => "${APP_VERSION:-3.0.0}",
            "service.sha" => "${COMMIT_SHA:-unknown}"
        }},
        {sampler, trace_id_ratio_based},
        {sampling_ratio, 0.01},    %% 1% sampling in production
        {batch_size, 512},
        {batch_timeout, 5000}
    ]},

    {prometheus, [
        {enabled, true},
        {collectors, [
            prometheus_counter,
            prometheus_gauge,
            prometheus_histogram,
            prometheus_process_collector
        ]},
        {port, 9100},
        {path, "/metrics"},
        {push_gateway_enabled, true},
        {push_gateway_url, "${PROMETHEUS_PUSH_GATEWAY_URL:-http://prometheus-pushgateway:9091"},
        {push_interval, 60000}
    ]},

    %% ============================================================================
    %% Security Configuration
    %% ============================================================================
    {erlmcp_security, [
        {tls_enabled, true},
        {tls_cert_file, "${ERLMCP_TLS_CERT_FILE:-/run/secrets/tls.crt}"},
        {tls_key_file, "${ERLMCP_TLS_KEY_FILE:-/run/secrets/tls.key}"},
        {tls_ca_file, "${ERLMCP_TLS_CA_FILE:-/run/secrets/tls-ca.crt}"},
        {tls_verify, verify_peer},
        {tls_fail_if_no_peer_cert, true}
    ]},

    %% ============================================================================
    %% Cluster Configuration
    %% ============================================================================
    {erlmcp_cluster, [
        {enabled, true},
        {autoconnect, true},
        {discovery_mode, swarm},    %% or: kubernetes, dns
        {heartbeat_interval, 10000},
        {node_cleanup_interval, 60000},
        {split_brain_strategy, majority},
        {split_brain_check_interval, 30000}
    ]},

    %% ============================================================================
    %% Health Check Configuration
    %% ============================================================================
    {erlmcp_health, [
        {enabled, true},
        {port, 9090},
        {path, "/health"},
        {interval, 15000},           %% More frequent in production
        {timeout, 10000},
        {retries, 3}
    ]}
].

%% ============================================================================
%% Environment Variables Required (set in .env.prod or docker-compose.override.prod.yml)
%% ============================================================================
%% ERLMCP_ENV=production
%% ERLANG_COOKIE_FILE=/run/secrets/erlang.cookie
%% ERLMCP_NODE_NAME=erlmcp@${HOSTNAME}
%% ERLMCP_LOG_LEVEL=warn
%% ERLMCP_PORT=8080
%% ERL_DIST_PORT=9100
%%
%% Database (use Docker secrets or external vault):
%% ERLMCP_DB_HOST=${DB_HOST}
%% ERLMCP_DB_PORT=5432
%% ERLMCP_DB_NAME=erlmcp_prod
%% ERLMCP_DB_USER=erlmcp
%% ERLMCP_DB_PASSWORD_FILE=/run/secrets/db_password
%%
%% Redis:
%% REDIS_ENABLED=true
%% REDIS_HOST=${REDIS_HOST}
%% REDIS_PORT=6379
%% REDIS_PASSWORD_FILE=/run/secrets/redis_password
%%
%% TLS:
%% ERLMCP_TLS_ENABLED=true
%% ERLMCP_TLS_CERT_FILE=/run/secrets/tls.crt
%% ERLMCP_TLS_KEY_FILE=/run/secrets/tls.key
%% ERLMCP_TLS_CA_FILE=/run/secrets/tls-ca.crt
%%
%% OpenTelemetry:
%% OTEL_EXPORTER_OTLP_ENDPOINT=https://otel-collector.prod.svc.cluster.local:4317
%% OTEL_SERVICE_NAME=erlmcp
%% OTEL_SAMPLING_RATE=0.01
%%
%% Version:
%% APP_VERSION=3.0.0
%% COMMIT_SHA=${COMMIT_SHA}
%%
%% ============================================================================
%% SECRET MANAGEMENT (Docker Secrets):
%% ============================================================================
%% Create secrets with:
%%   echo "secure-cookie-value" | docker secret create erlmcp-erlang-cookie -
%%   echo "db-password" | docker secret create erlmcp-db-password -
%%   echo "redis-password" | docker secret create erlmcp-redis-password -
%%   cat tls.crt | docker secret create erlmcp-tls-cert -
%%   cat tls.key | docker secret create erlmcp-tls-key -
%%   cat ca-bundle.crt | docker secret create erlmcp-tls-ca -
%% ============================================================================
