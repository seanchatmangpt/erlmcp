%% ========================================================================
%% erlmcp v3 Production System Configuration
%% ========================================================================
%% This config works with vm.args.production for optimal performance
%%
%% Key settings:
%%   - Connection pooling: 50 base + 20 overflow = 70 max connections
%%   - Rate limiting: Token bucket with configurable limits per service
%%   - HTTP transport: 400 max connections with HTTP/2
%%   - TCP transport: 512 listen backlog
%%   - Caching: 1 hour TTL, 100K max entries
%%
%% ========================================================================

[
    %% ====================================================================
    %% ERLMCP APPLICATION CONFIGURATION
    %% ====================================================================
    {erlmcp, [
        %% Logging configuration - ERROR level only for production
        {log_level, error},
        {logger_level, error},

        %% Client defaults - strict, production-grade
        {client_defaults, #{
            timeout => 5000,
            strict_mode => true,
            max_pending_requests => 100,
            retry_attempts => 2,
            retry_backoff_ms => 1000,
            circuit_breaker_enabled => true,
            circuit_breaker_threshold => 10,
            circuit_breaker_timeout => 30000
        }},

        %% Server defaults - optimized for throughput
        {server_defaults, #{
            max_subscriptions_per_resource => 1000,
            max_progress_tokens => 10000,
            enable_debug_endpoints => false  % NEVER enable in production
        }},

        %% Transport settings - production hardened
        {transport_defaults, #{
            tcp => #{
                connect_timeout => 5000,
                keepalive => true,
                nodelay => true,
                listen_backlog => 1024,      %% Increased from 512
                send_timeout => 30000,
                recv_timeout => 30000,
                buffer => 8192               %% 8KB buffers
            },
            http => #{
                connect_timeout => 5000,
                request_timeout => 30000,
                max_connections => 500,      %% Increased from 400
                connection_keepalive => true,
                http2_enabled => true,
                max_headers => 100,
                max_body_size => 10485760    %% 10MB
            },
            stdio => #{
                enabled => false  % Disabled in production
            }
        }},

        %% ====================================================================
        %% CONNECTION POOLING - Production Optimized
        %% ====================================================================
        %% These settings work with vm.args +Q 131072 (max ports)
        %%
        %% Pool breakdown:
        %%   - Base pool: 50 connections always available
        %%   - Overflow: 20 additional connections under load
        %%   - Total: 70 connections max per pool type
        %%
        %% With 3 pool types (TCP, HTTP, WS): 210 total pooled connections
        %% Remaining ports available for ephemeral connections
        %%
        {connection_pooling, #{
            enabled => true,
            pool_size => 50,                %% Base pool size
            max_overflow => 20,             %% Additional under load
            pool_timeout => 30000,          %% 30 second checkout timeout
            idle_timeout_ms => 300000,      %% 5 minutes (reduced from 10)
            max_connections => 70,          %% Hard limit
            strategy => fifo,                %% First-In-First-Out
            overflow_ttl => 60000,          %% Overflow lives 1 minute
            health_check_interval => 30000  %% Health check every 30s
        }},

        %% Per-transport pool configuration
        {tcp_pool, #{
            pool_size => 50,
            max_overflow => 20,
            lease_timeout => 30000
        }},
        {http_pool, #{
            pool_size => 50,
            max_overflow => 20,
            lease_timeout => 30000
        }},
        {ws_pool, #{
            pool_size => 50,
            max_overflow => 20,
            lease_timeout => 30000
        }},

        %% ====================================================================
        %% RATE LIMITING - Production Optimized
        %% ====================================================================
        %% Token bucket algorithm with refill interval
        %%
        %% Service-specific limits (configurable per deployment):
        %%
        {rate_limiting, #{
            enabled => true,

            %% Per-client message rate (messages/second)
            max_messages_per_sec => 100,

            %% Per-client connection rate (connections/second)
            max_connections_per_sec => 10,

            %% Global message rate across all clients (messages/second)
            global_max_messages_per_sec => 10000,

            %% Tool execution rate per client (calls/second)
            max_tool_calls_per_sec => 50,

            %% Resource subscription rate per client (subscriptions/second)
            max_subscriptions_per_sec => 20,

            %% Token bucket refill interval (milliseconds)
            bucket_refill_interval_ms => 100,

            %% DDoS protection: block after this many violations per minute
            ddos_violation_threshold => 100,

            %% DDoS protection: duration to block IP (milliseconds)
            ddos_block_duration_ms => 300000,  %% 5 minutes

            %% Per-service rate limits (API Gateway)
            api_gateway_rate_limit => 1000,    %% 1000 req/sec per gateway
            auth_rate_limit => 50,             %% 50 auth ops/sec
            registry_rate_limit => 500,         %% 500 registry ops/sec

            %% Burst capacity (multiplier of max rate)
            burst_multiplier => 2.0            %% Allow 2x burst
        }},

        %% ====================================================================
        %% CACHING - Production Optimized
        %% ====================================================================
        {cache_enabled, true},
        {cache_ttl_seconds => 3600},         %% 1 hour
        {cache_max_size => 100000},          %% 100K entries
        {cache_compression, true},           %% Compress large values
        {cache_max_entry_size => 1048576},   %% 1MB max entry
        {cache_eviction_policy => lru},      %% Least Recently Used

        %% ====================================================================
        %% FEATURE TOGGLES
        %% ====================================================================
        {features, #{
            rate_limiting => true,
            async_processing => true,
            webhook_delivery => true,
            experimental => false,           %% NO experimental features
            telemetry => true,               %% OpenTelemetry enabled
            metrics => true,                 %% Prometheus metrics
            health_check => true,            %% Health endpoints
            circuit_breaker => true,         %% Fault tolerance
            retry_with_backoff => true       %% Automatic retries
        }},

        %% ====================================================================
        %% PRODUCTION-SPECIFIC OPTIONS
        %% ====================================================================
        {production, #{
            enable_console_logging => false,
            enable_file_logging => true,
            enable_sql_logging => false,
            enable_http_logging => false,
            enable_profiling => false,
            enable_performance_monitoring => true,
            enable_security_audit_log => true,
            audit_log_dir => "/var/log/erlmcp/audit",
            audit_log_max_size => 104857600, %% 100MB per file
            audit_log_max_files => 10,
            enable_backup_validation => true
        }}
    ]},

    %% ====================================================================
    %% KERNEL CONFIGURATION
    %% ====================================================================
    {kernel, [
        {logger_level, error},

        %% Logger configuration with production handlers
        {logger, [
            %% Console handler - ERROR and CRITICAL only
            {handler, default, logger_std_h, #{
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 1000,    %% Higher queue in prod
                    drop_mode_qlen => 10000,
                    flush_qlen => 20000
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", msg, "\n"],
                    time_offset => "",
                    time_designator => $T,
                    single_line => true,       %% Compact format
                    max_size => 2048
                }},
                filters => [
                    {progress_reports, {fun logger_filters:progress/2, stop}},
                    {sasl_reports, {fun logger_filters:domain/2, {stop, sub, [otp, sasl]}}}
                ],
                level => error
            }},

            %% File handler - all logs with rotation
            {handler, file_prod, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/erlmcp.log",
                    max_no_bytes => 104857600,  %% 100 MB
                    max_no_files => 50,         %% Keep 50 files = ~5 GB
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => info
            }},

            %% Separate critical errors file
            {handler, file_critical, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/critical.log",
                    max_no_bytes => 52428800,  %% 50 MB
                    max_no_files => 10,
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => critical
            }}
        ]},

        %% Global logger limits
        {logger_level, error},
        {logger_handlerDefaults, #{
            sync_mode_qlen => 1000,
            drop_mode_qlen => 10000,
            flush_qlen => 20000
        }}
    ]},

    %% ====================================================================
    %% SASL (SYSTEM ARCHITECTURE SUPPORT LIBRARIES)
    %% ====================================================================
    {sasl, [
        {sasl_error_logger, false},
        {errlog_type, error},
        {error_logger_format_depth, 20}
    ]},

    %% ====================================================================
    %% PROMETHEUS METRICS COLLECTION
    %% ====================================================================
    {prometheus, [
        {collectors, [
            prometheus_counter,
            prometheus_gauge,
            prometheus_histogram,
            prometheus_process_collector
        ]},
        {push_gateway_enabled, true},
        {push_gateway_url, "http://prometheus-pushgateway:9091"},
        {push_gateway_interval, 15000},  %% 15 seconds

        %% Metrics-specific configuration
        {metrics, #{
            http_histograms => true,
            http_duration_buckets => [10, 25, 50, 100, 250, 500, 1000, 2500, 5000, 10000],
            pool_metrics => true,
            rate_limit_metrics => true
        }}
    ]},

    %% ====================================================================
    %% OPENTELEMETRY CONFIGURATION
    %% ====================================================================
    {opentelemetry, [
        {processors, [{otel_batch_processor, #{
            scheduled_delay_ms => 1000,
            max_queue_size => 2048,
            export_timeout_ms => 30000,
            max_export_batch_size => 512
        }}]},
        {exporters, [
            {otel_exporter_otlp_http, #{
                endpoint => "http://otel-collector:4318",
                http_headers => [{"User-Agent", "erlmcp/3.0"}]
            }}
        ]},
        {resource_service_name, "erlmcp"},
        {resource_service_version, "3.0.0"},
        {traces_exporter, otlp},
        {metrics_exporter, otlp},
        {logs_exporter, none}  %% Use logger for logs
    ]},

    %% ====================================================================
    %% ERLANG VM TUNING (supplement to vm.args)
    %% ====================================================================
    {erl_crash_dump, "/var/log/erlmcp/erl_crash.dump"},

    %% ====================================================================
    %% TCP/INET SETTINGS - Production Optimized
    %% ====================================================================
    {inet, [
        {tcp_listeners, [
            #{port => 8080, opts => [
                binary,
                {packet, raw},
                {reuseaddr, true},
                {recbuf, 32768},      %% 32KB receive buffer (increased)
                {sndbuf, 32768},      %% 32KB send buffer (increased)
                {nodelay, true},
                {keepalive, true},
                {backlog, 1024}       %% Increased from 512
            ]}
        ]},

        %% Backend TCP listeners
        {tcp_backend_listeners, [
            #{port => 6000, opts => [
                binary,
                {packet, 4},
                {reuseaddr, true},
                {recbuf, 65536},      %% 64KB for backend
                {sndbuf, 65536},
                {nodelay, true},
                {keepalive, true},
                {backlog, 512}
            ]}
        ]}
    ]},

    %% ====================================================================
    %% SSL/TLS CONFIGURATION
    %% ====================================================================
    {ssl, [
        {protocol_version, ['tlsv1.3', 'tlsv1.2']},
        {secure_renegotiate, true},
        {client_renegotiation, false},
        {ciphers, [
            %% TLS 1.3 ciphers
            "TLS_AES_128_GCM_SHA256",
            "TLS_AES_256_GCM_SHA384",
            "TLS_CHACHA20_POLY1305_SHA256",
            %% TLS 1.2 ciphers
            "ECDHE-ECDSA-AES128-GCM-SHA256",
            "ECDHE-RSA-AES128-GCM-SHA256",
            "ECDHE-ECDSA-AES256-GCM-SHA384",
            "ECDHE-RSA-AES256-GCM-SHA384"
        ]},
        {honor_cipher_order, true},
        {session_lifetime, 300}     %% 5 minutes
    ]},

    %% ====================================================================
    %% COWBOY HTTP SERVER CONFIGURATION
    %% ====================================================================
    {cowboy, [
        {max_connections, 500},
        {max_keepalive, 1000},
        {timeout, 30000},
        {idle_timeout, 60000},
        {request_timeout, 30000},
        {connection_type, supervisor},
        {logger, error_logger},
        {stream_handlers, [
            cowboy_stream_h,
            cowboy_compress_h,
            cowboy_metrics_h
        ]}
    ]},

    %% ====================================================================
    %% OS MONITORING
    %% ====================================================================
    {os_mon, [
        {start_cpu_sup, true},
        {start_disksup, true},
        {start_memsup, true},
        {memory_check_interval, 60},
        {disk_space_check_interval, 300},
        {disk_almost_full_threshold, 0.8},    %% 80%
        {disk_almost_full_threshold, 0.9}     %% 90% critical
    ]},

    %% ====================================================================
    %% RUNTIME TOOLS
    %% ====================================================================
    {runtime_tools, [
        {enabled, true},
        {scheduler_sleep_time, 1000}
    ]}
].

%% ========================================================================
%% END OF PRODUCTION CONFIGURATION
%% ========================================================================
%% For deployment, mount this file to:
%%   /opt/erlmcp/etc/sys.config
%%
%% Or override via environment:
%%   ERLMCP_CONFIG_FILE=/path/to/sys.config.production
%%
%% ========================================================================
