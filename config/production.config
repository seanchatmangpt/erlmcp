%% Production configuration for erlmcp
%% This configuration is optimized for performance and stability
[
    {erlmcp, [
        %% Server configuration
        {server_name, erlmcp_prod_server},
        {port, 8080},
        {max_connections, 1000},    % Higher for production load
        {timeout, 5000},            % Standard timeout
        {acceptors, 20},            % More acceptors for production
        
        %% Socket options
        {socket_opts, [
            {reuseaddr, true},
            {keepalive, true},
            {nodelay, true},
            {send_timeout, 5000},
            {send_timeout_close, true}
        ]},
        
        %% Protocol options
        {protocol_opts, [
            {timeout, 5000},
            {max_message_size, 2097152}  % 2MB for production
        ]},
        
        %% Transport configurations
        {transports, [
            %% Standard I/O transport (enabled for production)
            {stdio, #{
                enabled => true,
                buffer_size => 2048,        % Larger buffer for production
                timeout => 5000,
                encoding => utf8
            }},
            
            %% TCP transport (disabled by default in production)
            {tcp, #{
                enabled => false,
                port => 8080,
                acceptors => 20,
                socket_opts => [
                    {reuseaddr, true},
                    {keepalive, true},
                    {nodelay, true},
                    {send_timeout, 5000},
                    {send_timeout_close, true}
                ],
                backlog => 2048
            }},
            
            %% HTTP transport (disabled by default in production)
            {http, #{
                enabled => false,
                port => 8081,
                path => "/mcp",
                ssl_opts => [
                    {certfile, "priv/ssl/server.crt"},
                    {keyfile, "priv/ssl/server.key"},
                    {versions, ['tlsv1.2', 'tlsv1.3']},
                    {ciphers, [
                        "TLS_AES_256_GCM_SHA384",
                        "TLS_CHACHA20_POLY1305_SHA256",
                        "TLS_AES_128_GCM_SHA256",
                        "ECDHE-RSA-AES256-GCM-SHA384",
                        "ECDHE-RSA-AES128-GCM-SHA256"
                    ]}
                ],
                cors_enabled => false
            }}
        ]},
        
        %% Logging configuration (minimal for production)
        {log_level, warning},
        {log_file, "/var/log/erlmcp/erlmcp.log"},
        
        %% Monitoring and metrics (enabled for production monitoring)
        {metrics_enabled, true},
        {tracing_enabled, false}    % Disabled for performance
    ]},
    
    %% Kernel configuration
    {kernel, [
        {logger_level, warning},
        {logger, [
            {handler, default, logger_std_h, #{
                level => warning,
                config => #{
                    type => standard_error,
                    sync_mode_qlen => 100,
                    drop_mode_qlen => 10000,
                    flush_qlen => 20000
                },
                formatter => {logger_formatter, #{
                    single_line => true,
                    template => [time, " [", level, "] ", pid, " - ", msg, "\n"]
                }}
            }},
            {handler, file, logger_std_h, #{
                level => info,
                config => #{
                    type => {file, "/var/log/erlmcp/erlmcp.log"},
                    sync_mode_qlen => 100,
                    drop_mode_qlen => 10000,
                    flush_qlen => 20000,
                    file_check => 5000
                },
                formatter => {logger_formatter, #{
                    single_line => true,
                    template => [time, " [", level, "] ", pid, " - ", msg, "\n"]
                }}
            }}
        ]}
    ]},
    
    %% SASL configuration (minimal for production)
    {sasl, [
        {sasl_error_logger, {file, "/var/log/erlmcp/sasl-error.log"}},
        {errlog_type, error},
        {error_logger_mf_dir, "/var/log/erlmcp/sasl"},
        {error_logger_mf_maxbytes, 52428800},  % 50MB
        {error_logger_mf_maxfiles, 10}
    ]},
    
    %% Runtime system tuning for production
    {vm_args, [
        %% Set schedulers equal to CPU cores
        "+S auto:auto",
        %% Enable SMP
        "-smp auto",
        %% Set process limit
        "+P 1048576",
        %% Set ETS limit
        "+e 256000",
        %% Enable kernel poll
        "+K true",
        %% Async threads
        "+A 64",
        %% Distribution buffer size
        "+zdbbl 32768",
        %% Memory allocators
        "+MBas aobf",
        "+MHas aobf",
        "+MMmcs 30"
    ]}
].