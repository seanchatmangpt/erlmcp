%% Production environment configuration for erlmcp v0.6.0 + TCPS
%% Purpose: Production deployment with full security and performance optimization
%% Features: Error-only logging, full auth, TLS, connection pooling

[
    {erlmcp, [
        %% Logging (minimal for production)
        {log_level, error},
        {log_output, [
            {file, "/var/log/erlmcp/production.log"},
            {console, false}
        ]},
        {log_rotation, #{
            enabled => true,
            max_size_mb => 100,
            max_files => 10
        }},

        %% Server Configuration
        {server_defaults, #{
            max_subscriptions_per_resource => 5000,
            max_progress_tokens => 50000,
            request_timeout => 30000,
            max_concurrent_requests => 1000
        }},

        %% Client Configuration
        {client_defaults, #{
            timeout => 5000,
            strict_mode => true,
            max_pending_requests => 500,
            retry_attempts => 3,
            retry_delay => 2000
        }},

        %% Transport Configuration
        {transport_defaults, #{
            tcp => #{
                host => "0.0.0.0",
                port => 8080,
                connect_timeout => 5000,
                keepalive => true,
                nodelay => true,
                max_connections => 1000,
                backlog => 1024,
                tls => #{
                    enabled => true,
                    certfile => "/etc/erlmcp/certs/server.crt",
                    keyfile => "/etc/erlmcp/certs/server.key",
                    cacertfile => "/etc/erlmcp/certs/ca.crt",
                    verify => verify_peer,
                    versions => ['tlsv1.2', 'tlsv1.3'],
                    ciphers => [
                        "ECDHE-ECDSA-AES256-GCM-SHA384",
                        "ECDHE-RSA-AES256-GCM-SHA384",
                        "ECDHE-ECDSA-AES128-GCM-SHA256",
                        "ECDHE-RSA-AES128-GCM-SHA256"
                    ]
                }
            },
            http => #{
                connect_timeout => 5000,
                request_timeout => 30000,
                max_connections => 500,
                tls_enabled => true
            },
            stdio => #{
                buffer_size => 16384
            }
        }},

        %% TCPS Configuration
        {tcps, #{
            enabled => true,
            mode => production,
            quality_gates => #{
                test_pass_rate => 0.95,
                test_coverage => 0.80,
                fail_fast => true
            },
            work_order => #{
                validate_on_compile => true,
                generate_receipt => true,
                check_determinism => true,
                require_approval => true
            },
            andon => #{
                enabled => true,
                webhook_url => {env, "TCPS_ANDON_WEBHOOK_URL"},
                pagerduty_api_key => {env, "PAGERDUTY_API_KEY"},
                escalation_timeout => 180,
                auto_rollback => true
            },
            observability => #{
                otel_enabled => true,
                otel_endpoint => {env, "OTEL_EXPORTER_OTLP_ENDPOINT"},
                otel_headers => {env, "OTEL_EXPORTER_OTLP_HEADERS"},
                trace_sampling_rate => 0.1,
                metrics_interval => 60,
                span_processor => batch,
                max_queue_size => 2048,
                max_export_batch_size => 512
            },
            persistence => #{
                enabled => true,
                backend => postgres,
                connection => #{
                    host => {env, "ERLMCP_DB_HOST"},
                    port => {env, "ERLMCP_DB_PORT", 5432},
                    database => {env, "ERLMCP_DB_NAME"},
                    username => {env, "ERLMCP_DB_USER"},
                    password => {env, "ERLMCP_DB_PASSWORD"},
                    pool_size => 50,
                    max_overflow => 100,
                    ssl => true,
                    ssl_opts => [
                        {verify, verify_peer},
                        {cacertfile, "/etc/erlmcp/certs/db-ca.crt"}
                    ]
                },
                read_replica => #{
                    enabled => true,
                    host => {env, "ERLMCP_DB_REPLICA_HOST"},
                    port => {env, "ERLMCP_DB_REPLICA_PORT", 5432}
                }
            }
        }},

        %% Authentication & Authorization
        {auth, #{
            enabled => true,
            type => jwt,
            jwt => #{
                secret_key => {env, "ERLMCP_JWT_SECRET"},
                algorithm => hs256,
                expiration => 3600,
                issuer => "erlmcp-production"
            },
            oauth2 => #{
                enabled => true,
                provider => "https://auth.example.com",
                client_id => {env, "OAUTH2_CLIENT_ID"},
                client_secret => {env, "OAUTH2_CLIENT_SECRET"}
            },
            rbac => #{
                enabled => true,
                roles => [admin, operator, readonly]
            }
        }},

        %% Connection Pooling
        {poolboy, [
            {size, 50},
            {max_overflow, 100},
            {strategy, lifo}
        ]},

        %% Dashboard
        {dashboard, #{
            enabled => true,
            port => 3000,
            host => "0.0.0.0",
            tls => #{
                enabled => true,
                certfile => "/etc/erlmcp/certs/dashboard.crt",
                keyfile => "/etc/erlmcp/certs/dashboard.key"
            }
        }},

        %% Performance Tuning
        {performance, #{
            gc_strategy => aggressive,
            process_limit => 262144,
            max_heap_size => 4294967296,  % 4GB
            message_queue_limit => 10000
        }},

        %% Monitoring & Alerting
        {monitoring, #{
            enabled => true,
            prometheus_port => 9090,
            health_check_interval => 30,
            metrics_retention_days => 30
        }}
    ]},

    %% SASL (System Architecture Support Libraries)
    {sasl, [
        {sasl_error_logger, {file, "/var/log/erlmcp/production-sasl.log"}},
        {errlog_type, error},
        {error_logger_format_depth, 50}
    ]},

    %% Kernel
    {kernel, [
        {logger_level, error},
        {logger, [
            {handler, default, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/production-kernel.log",
                    max_no_bytes => 104857600,  % 100MB
                    max_no_files => 10,
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    single_line => true,
                    time_designator => $
                }}
            }}
        ]},
        {inet_dist_listen_min, 9100},
        {inet_dist_listen_max, 9200}
    ]},

    %% SSL/TLS
    {ssl, [
        {session_lifetime, 300},
        {protocol_version, ['tlsv1.2', 'tlsv1.3']}
    ]}
].
