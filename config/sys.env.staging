%% Staging System Configuration for erlmcp v3
%% Environment: staging
%% Purpose: Production-like behavior, integration testing, pre-production validation
%% Security: Moderate restrictions, test capabilities enabled

%% ============================================================================
%% STAGING CONFIGURATION
%% - Balances production-like behavior with testing needs
%% - Most features enabled for integration testing
%% - Monitoring and observability fully enabled
%% - Debug endpoints available for troubleshooting
%% ============================================================================

[
    %% erlmcp application configuration
    {erlmcp, [
        %% --------------------------------------------------------------------
        %% Logging Configuration - INFO level for normal operation
        %% --------------------------------------------------------------------
        {log_level, info},
        {logger_level, info},

        %% --------------------------------------------------------------------
        %% Client Defaults - production-like but with test flexibility
        %% --------------------------------------------------------------------
        {client_defaults, #{
            timeout => 5000,
            strict_mode => true,
            max_pending_requests => 250,
            retry_attempts => 3,
            retry_backoff_ms => 500
        }},

        %% --------------------------------------------------------------------
        %% Server Defaults
        %% --------------------------------------------------------------------
        {server_defaults, #{
            max_subscriptions_per_resource => 2000,
            max_progress_tokens => 20000,
            enable_debug_endpoints => true   %% Still enabled for testing
        }},

        %% --------------------------------------------------------------------
        %% Transport Settings
        %% --------------------------------------------------------------------
        {transport_defaults, #{
            tcp => #{
                connect_timeout => 5000,
                keepalive => true,
                nodelay => true,
                listen_backlog => 256
            },
            http => #{
                connect_timeout => 5000,
                request_timeout => 30000,
                max_connections => 200
            },
            stdio => #{
                enabled => true
            }
        }},

        %% --------------------------------------------------------------------
        %% Connection Pooling
        %% --------------------------------------------------------------------
        {connection_pooling, #{
            enabled => true,
            pool_size => 20,
            max_overflow => 10,
            pool_timeout => 10000
        }},

        %% --------------------------------------------------------------------
        %% Caching - enabled in staging
        %% --------------------------------------------------------------------
        {cache_enabled, true},
        {cache_ttl_seconds, 1800},
        {cache_max_size, 10000},

        %% --------------------------------------------------------------------
        %% Feature Toggles - most enabled for testing
        %% --------------------------------------------------------------------
        {features, #{
            rate_limiting => true,
            rate_limit_per_second => 500,
            async_processing => true,
            webhook_delivery => true,
            experimental => true
        }},

        %% --------------------------------------------------------------------
        %% Staging-Specific Options
        %% --------------------------------------------------------------------
        {staging, #{
            enable_console_logging => true,
            enable_file_logging => true,
            enable_sql_logging => false,
            enable_http_logging => false,
            enable_profiling => true,
            profile_dir => "/var/log/erlmcp/profiles",
            enable_smoke_tests => true,
            enable_integration_tests => true,
            enable_health_checks => true
        }}
    ]},

    %% ============================================================================
    %% Kernel Configuration
    %% ============================================================================
    {kernel, [
        {logger_level, info},
        {logger, [
            %% Console handler - INFO and above
            {handler, default, logger_std_h, #{
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 100,
                    drop_mode_qlen => 1000,
                    flush_qlen => 2000
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", {mfa, ["N/A"]}, ":", line, " ", msg, "\n"],
                    time_offset => "",
                    time_designator => $T,
                    single_line => false,
                    max_size => 4096
                }},
                filters => [
                    {progress_reports, {fun logger_filters:progress/2, stop}},
                    {sasl_reports, {fun logger_filters:domain/2, {stop, sub, [otp, sasl]}}}
                ],
                level => info
            }},

            %% File handler - DEBUG for analysis
            {handler, file_staging, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/erlmcp-staging.log",
                    max_no_bytes => 104857600,  %% 100 MB
                    max_no_files => 10,
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => debug
            }},

            %% Separate handler for error logs
            {handler, file_errors, logger_std_h, #{
                config => #{
                    file => "/var/log/erlmcp/erlmcp-errors.log",
                    max_no_bytes => 52428800,  %% 50 MB
                    max_no_files => 5,
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => error
            }}
        ]}
    ]},

    %% ============================================================================
    %% SASL Configuration
    %% ============================================================================
    {sasl, [
        {sasl_error_logger, false},
        {errlog_type, error},
        {error_logger_format_depth, 20}
    ]},

    %% ============================================================================
    %% Runtime Options
    %% ============================================================================
    {erl_crash_dump, "/var/log/erlmcp/erl_crash.dump"},

    %% ============================================================================
    %% Network Configuration
    %% ============================================================================
    {inet, [
        {tcp_listeners, [
            #{port => 6000, opts => [binary, {packet, raw}, {reuseaddr, true}]}
        ]}
    ]},

    %% ============================================================================
    %% Observability - Enabled for monitoring validation
    %% ============================================================================
    {opentelemetry, [
        {enabled, true},
        {exporter, otlp},
        {endpoint, "http://otel-collector:4317"},
        {service_name, "erlmcp-staging"},
        {resource_attributes, #{
            "deployment.environment" => "staging",
            "service.version" => "3.0.0"
        }},
        {sampler, trace_id_ratio_based},
        {sampling_ratio, 0.1}
    ]},

    {prometheus, [
        {enabled, true},
        {collectors, [prometheus_counter, prometheus_gauge, prometheus_histogram]},
        {port, 9100},
        {path, "/metrics"}
    ]},

    %% ============================================================================
    %% Health Check Configuration
    %% ============================================================================
    {erlmcp_health, [
        {enabled, true},
        {port, 9090},
        {path, "/health"},
        {interval, 30000}
    ]}
].

%% ============================================================================
%% Environment Variables Required (set in .env.staging or docker-compose.override.staging.yml)
%% ============================================================================
%% ERLMCP_ENV=staging
%% ERLANG_COOKIE_FILE=/run/secrets/erlang.cookie
%% ERLMCP_NODE_NAME=erlmcp_staging@${HOSTNAME}
%% ERLMCP_LOG_LEVEL=info
%% ERLMCP_PORT=8080
%% ERL_DIST_PORT=9100
%%
%% Database:
%% ERLMCP_DB_HOST=postgres-staging
%% ERLMCP_DB_PORT=5432
%% ERLMCP_DB_NAME=erlmcp_staging
%% ERLMCP_DB_USER=erlmcp
%% ERLMCP_DB_PASSWORD_FILE=/run/secrets/db_password
%%
%% Redis:
%% REDIS_ENABLED=true
%% REDIS_HOST=redis-staging
%% REDIS_PORT=6379
%% REDIS_PASSWORD_FILE=/run/secrets/redis_password
%%
%% OpenTelemetry:
%% OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
%% OTEL_SERVICE_NAME=erlmcp-staging
%% OTEL_SAMPLING_RATE=0.1
%% ============================================================================
