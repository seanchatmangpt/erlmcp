################################################################################
# HAProxy Configuration - erlmcp Load Balancer
#
# Distributes 100K concurrent connections across 4-node erlmcp cluster
# - 25K connections per node
# - Round-robin load balancing with sticky sessions
# - Health checks every 3 seconds
# - Automatic failover with connection draining
#
# Usage:
#   haproxy -f config/haproxy.cfg
################################################################################

################################################################################
# GLOBAL SETTINGS
################################################################################
global
    # Log to stdout (change to syslog for production)
    log stdout local0 info
    log stdout local0 notice

    # Maximum connections allowed
    maxconn 100000

    # Performance tuning
    tune.maxconn 100000
    tune.http.maxhdr 4096
    tune.http.default-type "application/json"

    # Connection timeout settings (milliseconds)
    tune.http.client-timeout 30000
    tune.http.server-timeout 30000
    tune.http.keep-alive-timeout 5000

    # Buffer tuning for large messages (16MB max per sys.config)
    tune.bufsize 16384
    tune.maxrewrite 16384

    # SSL/TLS defaults
    tune.ssl.default-dh-param 2048
    tune.ssl.ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1305

    # Stats socket for monitoring
    stats socket /var/run/haproxy.sock mode 0660 level admin

    # Daemon mode (set to off for docker/foreground)
    daemon

    # PID file location
    pidfile /var/run/haproxy.pid


################################################################################
# DEFAULTS - Applied to all sections unless overridden
################################################################################
defaults
    log     global
    mode    tcp

    # TCP connection timeout (milliseconds)
    timeout connect 5000

    # Client socket timeout (ms) - 5 minutes for long-lived connections
    timeout client 300000

    # Server socket timeout (ms) - 5 minutes for long-lived connections
    timeout server 300000

    # Keep-alive timeout
    timeout http-keep-alive 5000

    # Request timeout
    timeout http-request 30000

    # Queue timeout when pool exhausted
    timeout queue 30000

    # Server checks timeout
    timeout check 3000

    # Options for TCP mode
    option tcplog
    option dontlognull
    option tcp-smart-connect

    # Error file
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http


################################################################################
# STATS PAGE - Monitoring & Diagnostics
################################################################################
listen stats
    bind 127.0.0.1:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats admin if TRUE


################################################################################
# FRONTEND - Listens for incoming client connections
################################################################################
frontend mcp_frontend_tcp
    # Listen on all interfaces, port 8000 for TCP (non-HTTP) MCP connections
    bind 0.0.0.0:8000
    bind [::]:8000

    # Set mode to tcp for stream processing
    mode tcp

    # Connection limiting per IP (prevent single IP from exhausting pool)
    # Max 100 connections per client IP
    stick-table type ip size 100k expire 30m store conn_cur,conn_rate(1s),http_req_rate(10s)
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc_conn_cur ge 100 }

    # Request rate limiting: max 100 msgs/sec per IP
    tcp-request content reject if { sc_http_req_rate(0) gt 100 }

    # Default backend
    default_backend mcp_cluster_tcp


################################################################################
# FRONTEND - HTTP/WebSocket connections (for HTTP-based MCP)
################################################################################
frontend mcp_frontend_http
    # Listen on all interfaces, port 8080 for HTTP/WebSocket MCP
    bind 0.0.0.0:8080
    bind [::]:8080

    # Switch to HTTP mode for header processing
    mode http

    # HTTP logging
    option httplog
    option http-server-close

    # Add X-Forwarded-For header (client IP tracking through proxy)
    option forwardfor except 127.0.0.1

    # Preserve original Host header
    option http-keep-alive

    # Connection limiting per IP
    stick-table type ip size 100k expire 30m store conn_cur,conn_rate(1s),http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_conn_cur ge 100 }

    # Rate limiting: max 100 HTTP requests/sec per IP
    http-request deny if { sc_http_req_rate(0) gt 100 }

    # WebSocket detection (upgrade header)
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket hdr_cnt(Connection) gt 0

    # Select backend based on path
    use_backend mcp_websocket_backend if is_websocket path_beg /mcp/ws
    use_backend mcp_sse_backend if path_beg /mcp/sse
    use_backend mcp_http_backend if path_beg /mcp

    # Default backend
    default_backend mcp_http_backend


################################################################################
# FRONTEND - HTTPS/Secure WebSocket (optional TLS termination)
################################################################################
frontend mcp_frontend_https
    # Listen on all interfaces, port 8443 for HTTPS
    bind 0.0.0.0:8443 ssl crt /etc/ssl/certs/haproxy.pem
    bind [::]:8443 ssl crt /etc/ssl/certs/haproxy.pem

    # HTTP mode for HTTPS/WebSocket
    mode http

    # Redirect HTTP to HTTPS (handled in mcp_frontend_http with config)
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port %[dst_port]

    # Connection limiting per IP
    stick-table type ip size 100k expire 30m store conn_cur,conn_rate(1s),http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_conn_cur ge 100 }

    # WebSocket detection
    acl is_websocket hdr(Upgrade) -i websocket

    # Route to backends
    use_backend mcp_websocket_backend if is_websocket path_beg /mcp/ws
    use_backend mcp_sse_backend if path_beg /mcp/sse
    use_backend mcp_http_backend if path_beg /mcp

    default_backend mcp_http_backend


################################################################################
# BACKEND - TCP connections (generic MCP protocol)
################################################################################
backend mcp_cluster_tcp
    # TCP round-robin balancing
    mode tcp

    # Round-robin load balancing
    balance roundrobin

    # Sticky sessions - hash source IP to always route to same node
    # This keeps client connections on the same server
    stick-table type string len 32 size 100k expire 30m
    stick on src

    # Connection limit per backend (25K per node as configured)
    option contstcp

    # Health check: TCP connection test every 3 seconds, requires 2 successful checks
    default-server inter 3000 fall 2 rise 2 slowstart 60s

    # Node 1: erlmcp1 on port 8000
    server erlmcp1 localhost:9001 check maxconn 25000 weight 100

    # Node 2: erlmcp2 on port 8000
    server erlmcp2 localhost:9002 check maxconn 25000 weight 100

    # Node 3: erlmcp3 on port 8000
    server erlmcp3 localhost:9003 check maxconn 25000 weight 100

    # Node 4: erlmcp4 on port 8000
    server erlmcp4 localhost:9004 check maxconn 25000 weight 100


################################################################################
# BACKEND - HTTP connections
################################################################################
backend mcp_http_backend
    # HTTP mode for header processing
    mode http

    # Round-robin load balancing
    balance roundrobin

    # Sticky sessions using cookie (JSESSIONID pattern)
    # Creates cookie-based session affinity to keep requests on same node
    cookie SERVERID insert indirect nocache

    # Health check: HTTP GET /health every 3 seconds
    default-server inter 3000 fall 2 rise 2 slowstart 60s

    # HTTP compression for responses > 1KB
    compression algo gzip
    compression type application/json text/plain text/html

    # Node 1
    server erlmcp1 localhost:8080 check cookie erlmcp1 maxconn 25000 weight 100

    # Node 2
    server erlmcp2 localhost:8081 check cookie erlmcp2 maxconn 25000 weight 100

    # Node 3
    server erlmcp3 localhost:8082 check cookie erlmcp3 maxconn 25000 weight 100

    # Node 4
    server erlmcp4 localhost:8083 check cookie erlmcp4 maxconn 25000 weight 100


################################################################################
# BACKEND - WebSocket connections
################################################################################
backend mcp_websocket_backend
    # HTTP mode for WebSocket upgrade headers
    mode http

    # Round-robin load balancing
    balance roundrobin

    # Sticky sessions using source IP (WebSocket persistence)
    stick-table type ip size 100k expire 30m
    stick on src

    # Health check: TCP connection every 3 seconds (WebSocket not HTTP-testable)
    default-server inter 3000 fall 2 rise 2 slowstart 60s

    # WebSocket-specific options
    option http-keep-alive
    option prefer-last-server

    # Long timeout for WebSocket keep-alive connections
    timeout client 300000
    timeout server 300000
    timeout tunnel 300000

    # Nodes
    server erlmcp1 localhost:8080/mcp/ws check maxconn 25000 weight 100
    server erlmcp2 localhost:8081/mcp/ws check maxconn 25000 weight 100
    server erlmcp3 localhost:8082/mcp/ws check maxconn 25000 weight 100
    server erlmcp4 localhost:8083/mcp/ws check maxconn 25000 weight 100


################################################################################
# BACKEND - Server-Sent Events (SSE)
################################################################################
backend mcp_sse_backend
    # HTTP mode for SSE streaming
    mode http

    # Round-robin load balancing
    balance roundrobin

    # Sticky sessions: keep SSE clients on same server
    stick-table type ip size 100k expire 30m
    stick on src

    # Health check
    default-server inter 3000 fall 2 rise 2 slowstart 60s

    # SSE-specific options: no buffering, keep connection open
    option http-keep-alive
    option prefer-last-server

    # Long timeout for SSE streaming
    timeout client 300000
    timeout server 300000
    timeout tunnel 300000

    # Nodes
    server erlmcp1 localhost:8081/mcp/sse check maxconn 25000 weight 100
    server erlmcp2 localhost:8082/mcp/sse check maxconn 25000 weight 100
    server erlmcp3 localhost:8083/mcp/sse check maxconn 25000 weight 100
    server erlmcp4 localhost:8084/mcp/sse check maxconn 25000 weight 100
