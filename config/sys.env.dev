%% Development System Configuration for erlmcp v3
%% Environment: development
%% Purpose: Fast iteration, extensive logging, easy debugging
%% Security: Permissive settings, local-only access

%% ============================================================================
%% WARNING: This configuration is for DEVELOPMENT ONLY
%% - Debug endpoints are ENABLED
%% - Security restrictions are RELAXED
%% - Resource limits are LOW
%% - Logging is VERBOSE
%% DO NOT deploy to production
%% ============================================================================

[
    %% erlmcp application configuration
    {erlmcp, [
        %% --------------------------------------------------------------------
        %% Logging Configuration - VERY VERBOSE for development
        %% --------------------------------------------------------------------
        {log_level, debug},
        {logger_level, debug},

        %% OTP 28: Hibernation configuration for memory optimization
        %% Reduces memory per idle connection from ~50KB to ~5KB (75% reduction)
        {hibernate_after, 5000},  %% Hibernate after 5 seconds of inactivity

        %% --------------------------------------------------------------------
        %% Client Defaults - permissive for testing
        %% --------------------------------------------------------------------
        {client_defaults, #{
            timeout => 10000,           %% 10 second timeout for debugging
            strict_mode => false,        %% Allow lenient mode in dev
            max_pending_requests => 500, %% Higher limit for load testing
            retry_attempts => 3,
            retry_backoff_ms => 100
        }},

        %% --------------------------------------------------------------------
        %% Server Defaults
        %% --------------------------------------------------------------------
        {server_defaults, #{
            max_subscriptions_per_resource => 5000,
            max_progress_tokens => 50000,
            enable_debug_endpoints => true   %% Debug endpoints enabled in dev
        }},

        %% --------------------------------------------------------------------
        %% Transport Settings - all methods enabled
        %% --------------------------------------------------------------------
        {transport_defaults, #{
            tcp => #{
                connect_timeout => 10000,
                keepalive => true,
                nodelay => true,
                listen_backlog => 128
            },
            http => #{
                connect_timeout => 10000,
                request_timeout => 60000,    %% Longer timeout in dev
                max_connections => 500
            },
            stdio => #{
                enabled => true
            }
        }},

        %% --------------------------------------------------------------------
        %% Connection Pooling
        %% --------------------------------------------------------------------
        {connection_pooling, #{
            enabled => true,
            pool_size => 10,
            max_overflow => 5,
            pool_timeout => 5000
        }},

        %% --------------------------------------------------------------------
        %% Caching - DISABLED in development for fresh data
        %% --------------------------------------------------------------------
        {cache_enabled, false},

        %% --------------------------------------------------------------------
        %% Feature Toggles
        %% --------------------------------------------------------------------
        {features, #{
            rate_limiting => false,
            async_processing => false,
            webhook_delivery => false,
            experimental => true
        }},

        %% --------------------------------------------------------------------
        %% Development-Specific Options
        %% --------------------------------------------------------------------
        {development, #{
            enable_console_logging => true,
            enable_file_logging => true,
            enable_sql_logging => true,
            enable_http_logging => true,
            enable_profiling => true,
            profile_dir => "profiles",
            enable_debug_shell => true,
            enable_introspection => true
        }}
    ]},

    %% ============================================================================
    %% Kernel Configuration
    %% ============================================================================
    {kernel, [
        {logger_level, debug},
        {logger, [
            %% Console handler - ALL messages
            {handler, default, logger_std_h, #{
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 10,      %% Low queue, quick flushing
                    drop_mode_qlen => 1000,
                    flush_qlen => 2000
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", {mfa, ["N/A"]}, ":", line, " ", msg, "\n"],
                    time_offset => "",
                    time_designator => $T,
                    single_line => false,
                    max_size => 8192
                }},
                level => debug
            }},

            %% File handler - everything for analysis
            {handler, file_dev, logger_std_h, #{
                config => #{
                    file => "logs/erlmcp-dev.log",
                    max_no_bytes => 52428800,  %% 50 MB (generous for dev)
                    max_no_files => 10,
                    compress_on_rotate => false
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => debug
            }}
        ]}
    ]},

    %% ============================================================================
    %% SASL Configuration
    %% ============================================================================
    {sasl, [
        {sasl_error_logger, false},
        {errlog_type, all},
        {error_logger_format_depth, 50}
    ]},

    %% ============================================================================
    %% Runtime Options
    %% ============================================================================
    {erl_crash_dump, "logs/erl_crash.dump"},

    %% ============================================================================
    %% Network Configuration
    %% ============================================================================
    {inet, [
        {tcp_listeners, [
            #{port => 6000, opts => [binary, {packet, raw}, {reuseaddr, true}]}
        ]}
    ]},

    %% ============================================================================
    %% Observability - Disabled in dev for performance
    %% ============================================================================
    {opentelemetry, [
        {enabled, false}
    ]},

    {prometheus, [
        {enabled, false}
    ]}
].

%% ============================================================================
%% Environment Variables Required (set in .env.dev or docker-compose.override.dev.yml)
%% ============================================================================
%% ERLMCP_ENV=development
%% ERLANG_COOKIE=dev_cookie_change_me
%% ERLMCP_NODE_NAME=erlmcp_dev@127.0.0.1
%% ERLMCP_LOG_LEVEL=debug
%% ERLMCP_PORT=8080
%% ERL_DIST_PORT=9100
%%
%% Database (optional):
%% ERLMCP_DB_HOST=localhost
%% ERLMCP_DB_PORT=5432
%% ERLMCP_DB_NAME=erlmcp_dev
%% ERLMCP_DB_USER=erlmcp
%% ERLMCP_DB_PASSWORD=dev_password
%%
%% Redis (optional):
%% REDIS_ENABLED=false
%% REDIS_HOST=localhost
%% REDIS_PORT=6379
%% ============================================================================
