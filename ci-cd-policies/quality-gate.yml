# ErlMCP v3 CI/CD Quality Gate Policies
# Enterprise-grade quality assurance for production releases

version: 1.0
description: "Comprehensive quality gate policy for ErlMCP v3 CI/CD pipeline"

# Overall Quality Gates
quality_gates:
  # Must pass ALL gates before deployment
  mandatory_gates:
    compile:
      enabled: true
      severity: critical
      criteria:
        errors: 0
        warnings: 0  # Strict zero-warnings policy
      action: fail

    unit_tests:
      enabled: true
      severity: critical
      criteria:
        pass_rate: 1.0  # 100% pass rate
        coverage_min: 80  # 80% minimum coverage
        execution_time: 300  # Max 5 minutes
      action: fail

    integration_tests:
      enabled: true
      severity: critical
      criteria:
        pass_rate: 1.0
        coverage_min: 70
        execution_time: 600
      action: fail

    dialyzer:
      enabled: true
      severity: critical
      criteria:
        warnings: 0  # Zero tolerance for type errors
      action: fail

    xref:
      enabled: true
      severity: critical
      criteria:
        undefined_functions: 0
        unused_functions: 0
        unused_imports: 0
      action: fail

    security_scan:
      enabled: true
      severity: critical
      criteria:
        critical_vulnerabilities: 0
        high_vulnerabilities: 0
        medium_vulnerabilities: 0  # Zero tolerance for medium+ in prod
      action: fail

    performance_regression:
      enabled: true
      severity: critical
      criteria:
        max_regression: 5  # 5% maximum allowed regression
      action: warn  # Allow but warn

    compliance:
      enabled: true
      severity: critical
      criteria:
        score_min: 90  # 90% compliance score
      action: fail

  # Advisory gates that don't block but require attention
  advisory_gates:
    code_complexity:
      enabled: true
      severity: medium
      criteria:
        cyclomatic_complexity_max: 20
        maintainability_index_min: 70
      action: warn

    dependency_scanning:
      enabled: true
      severity: medium
      criteria:
        outdated_deps: 0
        security_alerts: 0
      action: warn

    documentation:
      enabled: true
      severity: medium
      criteria:
        coverage_min: 90  # 90% doc coverage
      action: warn

# Environment-specific policies
environment_policies:
  development:
    compile:
      action: fail
    unit_tests:
      coverage_min: 60
    security_scan:
      medium_vulnerabilities_allowed: 5
    performance_regression:
      max_regression: 10

  staging:
    compile:
      action: fail
    unit_tests:
      coverage_min: 80
    security_scan:
      medium_vulnerabilities_allowed: 0
    performance_regression:
      max_regression: 5

  production:
    compile:
      action: fail
    unit_tests:
      coverage_min: 90
    security_scan:
      medium_vulnerabilities_allowed: 0
      low_vulnerabilities_allowed: 0
    performance_regression:
      max_regression: 2  # 2% in production

# Policy enforcement
enforcement:
  # Critical gates must pass in all environments
  critical_gates:
    - compile
    - unit_tests
    - dialyzer
    - xref
    - security_scan

  # Progressive enforcement for production
  production_enhancement:
    additional_gates:
      - compliance
      - performance_regression
    stricter_criteria:
      coverage_min: 90
      regression_threshold: 2

# Notification policies
notifications:
  # Send notifications for these gate failures
  failure_notifications:
    channels: ['slack', 'email']
    environments: ['staging', 'production']

  # Advisory notifications
  advisory_notifications:
    channels: ['slack']
    severity_threshold: 'medium'
    environments: ['staging', 'production']

# Reporting
reporting:
  formats: ['html', 'json', 'xml']
  retention_days: 90
  include_metrics: true
  include_recommendations: true