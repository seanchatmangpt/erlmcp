%% -*- erlang -*-
%% vim: set ft=erlang ts=4 sw=4 et:

%% Rebar3 configuration for erlmcp
%% Purpose: Multi-application (umbrella) project for Model Context Protocol SDK
%% Structure: apps/{erlmcp_core, erlmcp_transports, erlmcp_observability, erlmcp_validation}

%% Minimum OTP version - STRICT: Only OTP 28+ allowed
%% This project requires the most recent Erlang/OTP version for:
%%   - Latest performance optimizations
%%   - JIT compiler improvements
%%   - Security patches
%%   - Modern language features
%% Lower versions will fail with a clear error message.
{minimum_otp_vsn, "28"}.

%% Dependencies (shared across all apps)
{deps,
 [% JSON encoding/decoding
  {jsx, "3.1.0"},
  % JSON Schema validation (jesse maintained fork)
  {jesse, "1.8.1"},
  % Process registry (O(log N) lookup)
  {gproc, "0.9.0"},
  % HTTP client (gun for HTTP/2 and WebSocket)
  {gun, "2.0.1"},
  % TCP acceptor pool (ranch)
  {ranch, "2.1.0"},
  % Connection pooling (poolboy)
  {poolboy, "1.5.2"},
  % HTTP server (cowboy for HTTP/WebSocket/SSE)
  {cowboy, "2.10.0"},
  % Template engine (bbmustache)
  {bbmustache, "1.12.2"},
  % JWT validation (CRITICAL - security dependency)
  {jose, "1.11.1"},
  % OpenTelemetry (observability)
  {opentelemetry_api, "1.5.0"},
  {opentelemetry, "1.7.0"},
  {opentelemetry_exporter, "1.10.0"}]}.

%% Shell (for `rebar3 shell`)
{shell,
 [{apps, [erlmcp_core, erlmcp_transports, erlmcp_observability, erlmcp_validation]},
  {config, "config/sys.config"},
  {vm_args, "vm.args"}]}.

%% EUnit configuration
{eunit_opts, [verbose, {report, {eunit_surefire, [{dir, "log/eunit"}]}}, {cover_enabled, true}]}.

%% Common Test configuration
{ct_opts, [{dir, "test"}, {logdir, "log/ct"}, {cover_enabled, true}]}.

%% Coverage configuration
{cover_enabled, true}.

{cover_opts, [verbose]}.

{cover_export_enabled, true}.

%% Dialyzer configuration
{dialyzer,
 [{warnings, [error_handling, underspecs, unknown, unmatched_returns]},
  {get_warnings, true},
  {plt_apps, all_deps},
  {plt_location, local},
  {plt_prefix, "erlmcp"},
  {base_plt_apps, [stdlib, kernel, erts, sasl, mnesia, crypto, ssl, inets, public_key, asn1, ssh]},
  {base_plt_location, global}]}.

%% Xref configuration (cross-reference analysis)
{xref_checks,
 [undefined_function_calls,
  undefined_functions,
  locals_not_used,
  deprecated_function_calls,
  deprecated_functions]}.

%% Plugins
{plugins,
 [rebar3_hex,                % Hex.pm publishing
  rebar3_format,             % Code formatting
  rebar3_lint,               % Linting
  rebar3_proper,             % Property-based testing
  rebar3_auto]}.                % Auto-compilation

%% Global compiler options (applies to all profiles)
%% IMPORTANT: These include paths must be available for ALL compilations,
%% including default profile (used by rebar3 compile without profile)
{erl_opts,
 [debug_info,
  {i, "include"},
  {i, "apps/erlmcp_core/include"},
  {i, "apps/erlmcp_transports/include"},
  {i, "apps/erlmcp_observability/include"},
  {i, "apps/erlmcp_validation/include"}]}.

%% Profiles
{profiles,
 [%% Test profile (for running tests with optimized settings)
  {test,
   [{erl_opts,
     [debug_info,
      % warnings_as_errors,  % Temporarily disabled - many unused variables in test fixtures
      {i, "include"},
      {i, "apps/erlmcp_core/include"},
      {i, "apps/erlmcp_transports/include"},
      {i, "apps/erlmcp_observability/include"},
      {i, "apps/erlmcp_validation/include"},
      {i, "_build/test/lib/*/include"},  % Dependency includes
      {d, 'TEST'}]},
    {deps, [{proper, "1.4.0"}, {meck, "0.9.2"}]},
    {cover_enabled, true},
    {cover_export_enabled, true}]},
  %% Production profile (for release builds)
  {prod,
   [{erl_opts,
     [no_debug_info,
      warnings_as_errors,
      {i, "include"},
      {i, "apps/erlmcp_core/include"},
      {i, "apps/erlmcp_transports/include"},
      {i, "apps/erlmcp_observability/include"},
      {i, "apps/erlmcp_validation/include"}]},
    {relx, [{dev_mode, false}, {include_erts, true}, {include_src, false}, {system_libs, true}]}]},
  %% Development profile (default, verbose)
  {dev,
   [{erl_opts, [debug_info, {i, "include"}, {i, "apps/erlmcp_core/include"}, {d, 'DEBUG'}]}]}]}.

%% Format configuration
{format,
 [{files,
   ["rebar.config",
    "{src,include,test}/**/*.{erl,hrl,app.src}",
    "apps/*/src/**/*.{erl,hrl}",
    "apps/*/include/**/*.hrl",
    "apps/*/test/**/*.{erl,hrl}"]},
  {formatter, default_formatter},
  {options,
   #{paper => 100,
     ribbon => 100,
     break_indent => 4}}]}.

%% Hex.pm configuration
{hex, [{doc, #{provider => ex_doc}}]}.

%% EDoc configuration
{edoc_opts,
 [{preprocess, true},
  {includes, ["include"]},
  {title, "ErlMCP - Model Context Protocol SDK for Erlang/OTP"},
  {overview, "apps/erlmcp_core/doc/overview.edoc"},
  {dir, "doc"}]}.

%% Relx (release) configuration
{relx,
 [{release,
   {erlmcp, "2.1.0"},
   [erlmcp_core,
    erlmcp_transports,
    erlmcp_observability,
    erlmcp_validation,
    jsx,
    jesse,
    gproc,
    gun,
    ranch,
    poolboy,
    cowboy,
    bbmustache,
    jose,
    opentelemetry_api,
    opentelemetry,
    opentelemetry_exporter,
    mnesia,
    sasl]},
  %% Configuration file selection (controlled by ERLMCP_PROFILE environment variable)
  %%
  %% The sys_config setting points to config/sys.config, which is a symlink
  %% created by the Makefile. The Makefile reads $ERLMCP_PROFILE (default: dev)
  %% and creates the symlink:
  %%
  %%   config/sys.config -> config/sys.config.${ERLMCP_PROFILE}
  %%
  %% Available profiles:
  %%   - dev (default): Development with verbose logging, relaxed timeouts
  %%   - test: CI/CD optimized, fast timeouts, deterministic behavior
  %%   - staging: Production-like with debugging enabled
  %%   - prod: Production hardened, minimal logging
  %%
  %% To switch profiles:
  %%   export ERLMCP_PROFILE=staging
  %%   make clean compile
  %%
  %% See docs/ENVIRONMENT_GUIDE.md for comprehensive profile documentation
  {sys_config, "./config/sys.config"},
  {vm_args, "./vm.args"},
  {dev_mode, true},
  {include_erts, false},
  {include_src, false},
  {extended_start_script, true},
  {overlay,
   [{mkdir, "log"},
    {mkdir, "data"},
    {mkdir, "etc"},
    {copy, "config/sys.config", "etc/sys.config"}]}]}.

%% Overrides (dependency-specific configurations)
{overrides, [{override, jsx, [{plugins, []}]}]}.

%% Project applications
{project_app_dirs, ["apps/*"]}.

%% Source directories
{src_dirs,
 ["apps/erlmcp_core/src",
  "apps/erlmcp_transports/src",
  "apps/erlmcp_observability/src",
  "apps/erlmcp_validation/src"]}.

%% Include directories
%% NOTE: Disabled extra_src_dirs to prevent test files from being compiled
%% during normal compilation. Test files should only be compiled when using
%% the test profile (rebar3 as test compile).
%%
%% {extra_src_dirs,
%%  ["apps/erlmcp_core/test",
%%   "apps/erlmcp_transports/test",
%%   "apps/erlmcp_observability/test",
%%   "apps/erlmcp_validation/test"]}.
