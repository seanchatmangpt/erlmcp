% === WORKSPACE CONFIGURATION: erlmcp + taiea ===
% This is the root rebar.config for the erlmcp workspace.
% TAIEA is a separate umbrella application in ./taiea with its own rebar.config

{erl_opts, [
    debug_info,
    warn_export_vars,
    warn_shadow_vars,
    warn_obsolete_guard,
    warn_unused_import,
    {platform_define, "^2[1-9]|^[3-9]", 'POST_OTP_21'}
]}.

{src_dirs, ["src", "src/tcps"]}.
{test_dirs, ["test"]}.

% Core dependencies for erlmcp workspace
{deps, [
    {jsx, "3.1.0"},
    {jesse, "1.8.1"},
    {gproc, "0.9.0"},
    {gun, "2.0.1"},
    {ranch, "2.1.0"},
    {poolboy, "1.5.2"},
    {bbmustache, "1.12.2"},  % Mustache template engine for TCPS artifacts
    {cowboy, "2.10.0"},      % HTTP server for TCPS dashboard
    % OpenTelemetry for observability (latest versions as of Oct 2025)
    {opentelemetry_api, "1.5.0"},
    {opentelemetry, "1.7.0"},
    {opentelemetry_exporter, "1.10.0"},
    % MCP 2025-11-25 Feature Support
    {jobs, "0.10.0"},         % Job queue for Tasks API
    {fs, "0.9.2"}             % Filesystem monitoring for Roots enforcement
    % Note: OAuth implemented via standard httpc + jsx for token management
]}.

{shell, [
    {config, "config/sys.config"},
    {apps, [erlmcp]}
]}.

{profiles, [
    {prod, [
        {erl_opts, [
            no_debug_info,
            warnings_as_errors,
            {d, 'PROD'}
        ]},
        {relx, [
            {dev_mode, false},
            {include_erts, true},
            {include_src, false}
        ]}
    ]},
    {test, [
        {deps, [
            {proper, "1.4.0"},
            {meck, "0.9.2"},
            {coveralls, "2.2.0"}
        ]},
        {erl_opts, [
            debug_info,
            export_all,
            nowarn_missing_spec,
            nowarn_export_all
        ]},
        {cover_enabled, true},
        {cover_export_enabled, true},
        {coveralls_coverdata, "_build/test/cover/*.coverdata"},
        {coveralls_service_name, "github"},
        {coveralls_parallel, true}
    ]},
    {testlocal, [
        {src_dirs, ["src", "priv/test", "examples/simple", "examples/calculator", "examples/weather"]},
        {deps, [
            {proper, "1.4.0"},
            {meck, "0.9.2"},
            {coveralls, "2.2.0"}
        ]},
        {erl_opts, [
            debug_info,
            export_all,
            nowarn_missing_spec,
            nowarn_export_all
        ]},
        {cover_enabled, true},
        {cover_export_enabled, true},
        {coveralls_coverdata, "_build/test/cover/*.coverdata"},
        {coveralls_service_name, "github"},
        {coveralls_parallel, true}
    ]},
    {dev, [
        {deps, [
            {recon, "2.5.3"},
            {observer_cli, "1.7.4"}
        ]},
        {plugins, [
            {rebar3_format, "1.3.0"},
            {rebar3_lint, "3.0.1"}
        ]}
    ]},
    {simple, [
        {src_dirs, ["src", "examples/simple"]},
        {erl_opts, [
            debug_info,
            nowarn_missing_spec,
            nowarn_export_all,
            nowarn_unused_function,
            nowarn_unused_variable
        ]},
        {shell, [
            {config, "config/sys.config"},
            {apps, [erlmcp]}
        ]},
        {erl_first_files, [
            "examples/simple_server.erl",
            "examples/simple_client.erl"
        ]}
    ]},
    {calculator, [
        {src_dirs, ["src", "examples/calculator"]},
        {erl_opts, [
            debug_info,
            nowarn_missing_spec,
            nowarn_export_all,
            nowarn_unused_function,
            nowarn_unused_variable
        ]},
        {shell, [
            {config, "config/sys.config"},
            {apps, [erlmcp]}
        ]}
    ]},
    {weather, [
        {src_dirs, ["src", "examples/weather"]},
        {erl_opts, [
            debug_info,
            nowarn_missing_spec,
            nowarn_export_all,
            nowarn_unused_function,
            nowarn_unused_variable
        ]},
        {shell, [
            {config, "config/sys.config"},
            {apps, [erlmcp]}
        ]}
    ]}
]}.

{dialyzer, [
    {warnings, [
        unmatched_returns,
        error_handling,
        unknown,
        no_improper_lists,
        no_fun_app,
        no_match,
        no_opaque,
        no_fail_call,
        no_contracts,
        no_behaviours,
        no_undefined_callbacks
    ]},
    {plt_apps, top_level_deps},
    {plt_extra_apps, [kernel, stdlib, ssl, inets]},
    {plt_location, local},
    {base_plt_apps, [kernel, stdlib, erts, ssl, inets]},
    {base_plt_location, global},
    {exclude_apps, []},
    {apps, [erlmcp]}
]}.

{xref_checks, [
    undefined_function_calls,
    undefined_functions,
    locals_not_used,
    deprecated_function_calls,
    deprecated_functions
]}.

{xref_ignores, [
    %% Ignore dynamically called functions
    {erlmcp_transport_stdio, read_loop, 2},
    {erlmcp_transport_tcp, send, 2}
]}.

{cover_enabled, true}.
{cover_export_enabled, true}.
{cover_opts, [verbose]}.

{alias, [
    {check, [xref, dialyzer, {proper, "-c"}, cover]},
    {test, [eunit, {proper, "-c"}, cover]},
    {cleanplus, [clean, {cover, "-r"}]},
    {simple, [compile, shell]},
    %% TCPS aliases
    {tcps_validate, [{tcps, shacl_validate}, {tcps, check_quality_gates}]},
    {tcps_build, [{tcps, shacl_validate}, compile, {tcps, generate_receipt}]},
    {tcps_full, [{tcps, shacl_validate}, compile, {tcps, generate_receipt},
                 eunit, {tcps, check_quality_gates}]}
]}.

%% ============================================================================
%% RELEASE CONFIGURATION - erlmcp v0.6.0
%% ============================================================================
%% Production release configuration with ERTS, overlays, and multi-environment support
%% ============================================================================

{relx, [
    {release, {erlmcp, "0.7.0"},
     [erlmcp,
      gproc,
      gun,
      ranch,
      poolboy,
      jsx,
      jesse,
      bbmustache,
      cowboy,
      opentelemetry_api,
      opentelemetry,
      opentelemetry_exporter,
      jobs,
      fs,
      sasl]},

    {sys_config, "./config/sys.config"},
    {vm_args, "./vm.args"},

    {dev_mode, false},
    {include_erts, true},
    {include_src, false},

    {extended_start_script, true},
    {extended_start_script_hooks, [
        {pre_start, [{custom, "hooks/pre_start"}]},
        {post_start, [{custom, "hooks/post_start"}]},
        {pre_stop, [{custom, "hooks/pre_stop"}]}
    ]},

    {overlay, [
        {mkdir, "log"},
        {mkdir, "data"},
        {mkdir, "etc"},

        %% Copy scripts
        {copy, "scripts/start_dashboard.sh", "bin/start_dashboard"},
        {copy, "tools/tcps", "bin/tcps"},

        %% Copy dashboard
        {copy, "priv/dashboard", "priv/dashboard"},

        %% Copy ontologies and shapes
        {copy, "ontology", "priv/ontology"},
        {copy, "shapes", "priv/shapes"},

        %% Copy configuration templates
        {template, "config/sys.config", "etc/sys.config"},
        {template, "vm.args", "etc/vm.args"},

        %% Copy environment configs
        {copy, "config/dev.config", "etc/dev.config"},
        {copy, "config/staging.config", "etc/staging.config"},
        {copy, "config/production.config", "etc/production.config"}
    ]},

    %% Profiles for different environments
    {profile, dev, [
        {dev_mode, true},
        {include_erts, false},
        {sys_config, "./config/dev.config"}
    ]},

    {profile, staging, [
        {dev_mode, false},
        {include_erts, true},
        {sys_config, "./config/staging.config"},
        {overlay, [
            {copy, "config/staging.config", "etc/sys.config"}
        ]}
    ]},

    {profile, prod, [
        {dev_mode, false},
        {include_erts, true},
        {include_src, false},
        {sys_config, "./config/production.config"},
        {overlay, [
            {copy, "config/production.config", "etc/sys.config"}
        ]},
        {overlay_vars, "config/prod.vars"}
    ]}
]}.

%% ============================================================================
%% TCPS PROVIDER HOOKS - Toyota Code Production System Integration
%% ============================================================================
%% Automatic quality enforcement at each build stage:
%%   Pre-compile:  SHACL validation (work orders & ontology)
%%   Post-compile: Receipt generation (compilation metrics)
%%   Post-test:    Quality gates check (80% pass, 80% coverage)
%%   Pre-release:  Deterministic build verification
%%
%% Failures trigger Andon events and block pipeline.
%% ============================================================================

%% Temporarily disabled TCPS provider hooks for testing
%% {provider_hooks, [
%%     %% Pre-compile: Validate SHACL shapes
%%     {pre, [
%%         {compile, {tcps, shacl_validate}}
%%     ]},
%%
%%     %% Post-compile: Generate compilation receipt
%%     {post, [
%%         {compile, {tcps, generate_receipt}}
%%     ]},
%%
%%     %% Post-test: Check quality gates (pass rate, coverage)
%%     {post, [
%%         {eunit, {tcps, check_quality_gates}}
%%     ]},
%%
%%     %% Pre-release: Verify deterministic build
%%     {pre, [
%%         {release, {tcps, check_quality_gates}}
%%     ]}
%% ]}.

{plugins, [
    rebar3_hex,
    {rebar3_proper, "0.12.1"},
    {coveralls, "2.2.0"},
    %% TCPS Plugin - Toyota Code Production System integration
    rebar3_tcps_plugin
]}.

%% Formatting configuration for rebar3_format
{format, [
    {files, ["src/*.erl", "include/*.hrl", "test/*.erl", "examples/*.erl"]},
    {formatter, default_formatter},
    {encoding, utf8},
    {paper, 100},
    {ribbon, 90},
    {break_indent, 4},
    {sub_indent, 2}
]}.
