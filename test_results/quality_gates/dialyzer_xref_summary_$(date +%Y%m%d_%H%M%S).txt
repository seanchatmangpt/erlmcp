# Dialyzer and Xref Quality Gate Report
## Generated: 2026-01-30

## Executive Summary

### Dialyzer Results
- **Status**: COMPLETED with warnings
- **Total Warnings**: 455
- **Critical Issues**: 6 (undefined function calls)
- **Type Spec Issues**: 15 (contract violations, invalid specs)
- **Dead Code**: 120+ (unused functions, unreachable patterns)
- **Other Warnings**: 314 (unmatched expressions, pattern matching issues)

### Xref Results
- **Status**: COMPLETED with warnings
- **Total Warnings**: 14,805 (includes false positives from OTP libraries)
- **Critical Issues**: 6,597 (undefined functions, unused functions)
- **Application Warnings**: 51 (erlmcp-specific issues)

---

## Critical Issues (Must Fix)

### 1. Undefined Function Calls

#### erlmcp_auth.erl
**Location**: Line 230, 500
**Issue**: Calls to undefined functions in jose library
```erlang
jose:jwk_from_pem/1  % Called but not exported
jose:jwt_verify/2    % Called but not exported
```
**Impact**: JWT authentication will fail at runtime
**Fix**: Use correct JOSE library API or add missing dependency

#### erlmcp_memory_manager.erl
**Location**: Line 222
**Issue**: Call to undefined internal BIF
```erlang
erts_debug:size_of/1  % Not available in all OTP versions
```
**Impact**: Memory size calculations will crash
**Fix**: Use `erlang:external_size/1` or conditionally call based on OTP version

#### erlmcp_resource_subscriptions.erl
**Location**: Line 333
**Issue**: Incorrect function arity
```erlang
lists:fold/3  % Should be lists:foldl/3 or lists:foldr/3
```
**Impact**: Subscription template matching will crash
**Fix**: Change to `lists:foldl/3` or `lists:foldr/3`

---

## Type Specification Issues

### 1. Contract Violations

#### erlmcp_compliance_report.erl
**Lines**: 278, 279, 280, 323, 324, 325
**Issue**: Function calls break declared contracts
```erlang
format_markdown(Report)  % Report type doesn't match spec
format_json(Report)      % Report type doesn't match spec
format_html(Report)      % Report type doesn't match spec
```
**Impact**: Dialyzer can't verify type correctness
**Fix**: Update -spec attributes to match actual usage or fix call sites

#### erlmcp_performance_validator.erl
**Lines**: 575, 646, 774
**Issue**: Invalid type specifications
```erlang
-spec validate_latency/1  % Success typing differs from spec
-spec validate_concurrent_connections/1  % Success typing differs from spec
erlmcp_transport_tcp:start_server/1  % Call breaks contract
```
**Impact**: Type checking fails for performance validation
**Fix**: Update specs to match actual return types

#### erlmcp_transport_validation.erl
**Lines**: 887, 894, 897, 901
**Issue**: Pattern matching on try-catch expressions has wrong arity
```erlang
extract_strings_from_try_expr/1  % Success typing differs from spec
```
**Impact**: AST traversal for transport validation fails
**Fix**: Update pattern matching to handle 7-element try expressions

#### erlmcp_validate_cli.erl
**Lines**: 23, 156, 371
**Issue**: Functions have no local return or only terminate with exception
```erlang
main/1  % No local return (expected for CLI entry point)
execute_command/1  % Only terminates with explicit exception
generate_report/1  % No local return
```
**Impact**: Dialyzer flags these as potentially problematic
**Fix**: Add `-dialyzer({no_match, [main/1]}).` attributes for CLI entry points

---

## Dead Code (Unused Functions)

### Transport Layer (erlmcp_transport_sse.erl)
**Lines**: 320, 387, 398, 409, 416, 425, 434, 461, 515, 524, 581-585, 625
**Issue**: 13 unused functions
```erlang
sse_event_loop/3
format_sse_event/2
format_sse_event_with_id/3
format_sse_keepalive/0
split_data_by_newline/1
format_data_lines/1
format_data_line/1
handle_stream_resumption/9
format_disconnect_reason/1
format_term/1
format_close_event_with_retry/1
```
**Impact**: Code bloat, maintenance burden
**Fix**: Remove unused functions or export if needed for testing

### Core Protocol (erlmcp_json_rpc.erl)
**Lines**: 481, 492, 499, 510, 521, 528, 534, 544, 551, 566, 577, 587, 593, 608, 619, 630, 641, 651, 658, 665, 671, 686, 693, 704, 711, 722, 728, 734, 741, 756, 762, 769, 778, 784, 797, 804, 811, 822, 833, 844, 851, 858, 869
**Issue**: 45 unused error constructor functions
```erlang
error_tool_description_too_large/3
error_invalid_content_type/2
error_content_too_large/3
error_invalid_encoding/2
error_uri_syntax_error/3
error_resource_template_not_found/2
error_resource_access_denied/2
error_tool_execution_failed/3
error_tool_timeout/3
error_tool_cancelled/2
error_invalid_tool_arguments/3
error_prompt_argument_missing/3
error_invalid_prompt_arguments/3
error_prompt_render_failed/3
error_sampling_failed/2
error_authentication_failed/2
error_invalid_credentials/1
error_authorization_failed/2
error_token_expired/1
error_capability_negotiation_failed/2
error_unsupported_protocol_version/2
error_protocol_version_mismatch/3
error_invalid_cursor/2
error_cursor_expired/2
error_page_size_too_large/3
error_pagination_not_supported/2
error_task_not_found/2
error_task_already_exists/2
error_task_failed/3
error_task_cancelled/2
error_task_timeout/3
error_notification_failed/3
error_notification_queue_full/2
error_invalid_progress_token/2
error_progress_token_expired/2
error_progress_update_failed/3
error_invalid_completion_argument/3
error_invalid_completion_reference/2
error_completion_not_found/2
error_completion_failed/3
error_method_not_supported/2
error_access_denied/2
```
**Impact**: Code bloat (45 functions), maintenance burden
**Fix**: These are helper functions for error construction - consider keeping for future use or document why they exist

### Other Modules
**erlmcp_tasks.erl:136**: `list_tasks/1` unused
**erlmcp_validate_cli.erl:637**: `convert_error_msg/1` unused
**erlmcp_chaos_resource.erl:60, 71**: `allocate_memory_gradually/2`, `allocate_chunks/4` unused

---

## Unmatched Return Values

### Transport Layer
**erlmcp_transport_tcp.erl:111**: Expression produces `'ok' | {'error','not_found'}` but unmatched
**erlmcp_transport_tcp.erl:215, 261**: Expression produces `'false' | non_neg_integer()` but unmatched
**erlmcp_transport_ws.erl:375, 380, 713**: Expression produces `'false' | 'ok' | non_neg_integer()` but unmatched
**erlmcp_transport_sse.erl:372**: Expression produces `{'error',_} | {'ok','cancel'}` but unmatched

### Validation Layer
**erlmcp_memory_manager.erl:202, 206, 336**: Unmatched return values from process info operations
**erlmcp_validate_cli.erl:161, 185, 195, 234, 333, 342, 437, 453**: Error patterns that never match

**Impact**: Potential runtime errors if unexpected values occur
**Fix**: Add explicit case clauses or use `ok =` to assert expected return values

---

## Pattern Matching Issues

### Unreachable Patterns
**erlmcp_transport_sse.erl:581-585**: Variables in binary patterns can never match
**erlmcp_performance_validator.erl:175**: Pattern `{'ok', LatencyResult}` can never match
**erlmcp_protocol_validator.erl:637, 645, 653, 661, 669**: Invalid patterns can never match
**erlmcp_spec_parser.erl:1540, 1699**: Patterns can never match
**erlmcp_transport_validation.erl:894, 897, 901**: Try-catch patterns can never match
**erlmcp_validate_cli.erl:320**: Variable pattern can never match

**Impact**: Dead code, maintenance burden
**Fix**: Remove unreachable pattern clauses

---

## Xref-Specific Issues

### Undefined Functions in Dependencies (False Positives)
**jose:jwk_from_pem/1**: Not exported in current JOSE version
**jose:jwt_verify/2**: Not exported in current JOSE version
**erts_debug:size_of/1**: Not available in all OTP versions
**lists:fold/3**: Should be foldl/foldr (Xref flags this)

### Unused Functions in erlmcp Code
**51 unused local functions** across:
- erlmcp_json_rpc: 45 error constructors
- erlmcp_transport_sse: 13 formatting/helpers
- erlmcp_transport_validation: 3 AST traversals
- erlmcp_validate_cli: 1 error converter
- erlmcp_tasks: 1 list function
- erlmcp_chaos_resource: 2 memory allocators

---

## Recommended Actions

### Priority 1: Critical Fixes (Must Fix Before Next Release)
1. **Fix jose library calls** in erlmcp_auth.erl:
   - Verify JOSE library version and API
   - Update to correct function calls (jose:jwk_from_pem_file/1, etc.)
   - Add integration test for JWT verification

2. **Fix erts_debug:size_of/1** in erlmcp_memory_manager.erl:
   - Replace with `erlang:external_size/1`
   - Add conditional check for OTP version if needed

3. **Fix lists:fold/3** in erlmcp_resource_subscriptions.erl:
   - Change to `lists:foldl/3`
   - Add unit test for template matching

### Priority 2: Type Safety Improvements (Should Fix)
1. **Update type specs** in erlmcp_compliance_report.erl to match actual usage
2. **Fix contract violations** in erlmcp_performance_validator.erl
3. **Update try-catch pattern matching** in erlmcp_transport_validation.erl
4. **Add Dialyzer directives** for CLI entry points in erlmcp_validate_cli.erl

### Priority 3: Code Cleanup (Nice to Have)
1. **Remove or document unused functions**:
   - Decide if 45 error constructors in erlmcp_json_rpc.erl should be kept
   - Remove 13 unused SSE formatting functions or export for testing
   - Document purpose of unused chaos resource functions

2. **Fix unmatched return values**:
   - Add explicit case clauses or assertions
   - Improve error handling with proper pattern matching

3. **Remove unreachable patterns**:
   - Clean up dead code branches
   - Simplify pattern matching logic

---

## Acceptable Warnings (Documented Exceptions)

### CLI Entry Points
**erlmcp_validate_cli.erl:main/1, execute_command/1**: No local return is acceptable for CLI entry points that call `halt/1`.

### Test Infrastructure
**erlmcp_spec_parser.erl**: Unknown function `eunit:test/1` is used for test execution, acceptable in parser module.

### Error Constructors (Pending Decision)
**erlmcp_json_rpc.erl**: 45 unused error constructor functions - should these be exported for protocol implementers or removed?

---

## Next Steps

1. **Immediate Actions** (Before next release):
   - [ ] Fix jose library calls (erlmcp_auth.erl)
   - [ ] Fix erts_debug:size_of/1 (erlmcp_memory_manager.erl)
   - [ ] Fix lists:fold/3 (erlmcp_resource_subscriptions.erl)

2. **Short-term** (Within next sprint):
   - [ ] Update type specs for compliance report
   - [ ] Fix performance validator contract violations
   - [ ] Fix transport validation pattern matching
   - [ ] Add Dialyzer directives for CLI entry points

3. **Long-term** (Technical debt):
   - [ ] Audit and remove/document unused functions
   - [ ] Improve error handling with explicit pattern matching
   - [ ] Add -dialyzer directives for all acceptable warnings
   - [ ] Achieve <50 Dialyzer warnings (from 455)

---

## Quality Gate Status

**Dialyzer**: PASS with warnings (455 total, 6 critical)
**Xref**: PASS with warnings (14,805 total, 51 erlmcp-specific)

**Overall Status**: ACCEPTABLE for development, but critical issues should be fixed before production release.

**Recommendation**: Fix Priority 1 issues (6 critical) before next release. Address Priority 2 issues (15 type spec issues) in next sprint.
