================================================================================
EUNIT TEST FAILURE REPORT - EXECUTIVE SUMMARY
================================================================================

Test Run: Full EUnit suite across all applications
Date: 2026-01-30

RESULTS:
--------
Total Tests:  861
Passed:       783 (90.9%)
Failed:       78  (9.1%)
Skipped:      0

STATUS: ❌ FAIL - 78 tests must pass to meet DoD requirements

================================================================================
TOP FAILURE CATEGORIES
================================================================================

1. PROCESS NOT STARTED (noproc) - 65 failures (83%)
   - Tests call gen_servers that aren't started in test setup
   - Fix: Add application:start/1 or gen_server:start_link() in setup/0

2. CONTEXT SETUP FAILURES - 8 failures (10%)
   - gproc registry not initialized
   - Fix: Add gproc initialization in test setup

3. API/IMPLEMENTATION MISMATCHES - 5 failures (7%)
   - Timing and assertion issues
   - Fix: Review and update test assertions

================================================================================
FAILING MODULES (Sorted by failure count)
================================================================================

1. erlmcp_pagination_tests           17 failures
   Location: apps/erlmcp_core/test/erlmcp_pagination_tests.erl
   Fix: Start erlmcp_pagination gen_server in setup()

2. erlmcp_logging_tests              19 failures
   Location: apps/erlmcp_core/test/erlmcp_logging_tests.erl
   Fix: Start erlmcp_logging gen_server in setup()

3. erlmcp_connection_limiter_tests   All tests skipped
   Location: apps/erlmcp_core/test/erlmcp_connection_limiter_tests.erl
   Fix: Initialize gproc registry in setup()

4. erlmcp_registry_tests              3 failures
   Location: apps/erlmcp_core/test/erlmcp_registry_tests.erl
   Fix: Start erlmcp_registry in setup()

5. erlmcp_session_manager_tests       3 failures
   Location: apps/erlmcp_core/test/erlmcp_session_manager_tests.erl
   Fix: Start erlmcp_session_manager in setup()

6. erlmcp_notification_handler_tests  3 failures
   Location: apps/erlmcp_core/test/erlmcp_notification_handler_tests.erl
   Fix: Start notification supervisor in setup()

7. erlmcp_rate_limit_middleware_tests 3 failures
   Location: apps/erlmcp_core/test/erlmcp_rate_limit_middleware_tests.erl
   Fix: Start erlmcp_rate_limiter in setup()

8. erlmcp_progress_tests              2 failures
   Location: apps/erlmcp_core/test/erlmcp_progress_tests.erl
   Fix: Start erlmcp_progress server in setup()

9. erlmcp_cache_tests                 2 failures
   Location: apps/erlmcp_core/test/erlmcp_cache_tests.erl
   Fix: Start erlmcp_cache gen_server in setup()

10. erlmcp_auth_tests                 1 failure
    Location: apps/erlmcp_core/test/erlmcp_auth_tests.erl
    Fix: Start erlmcp_auth server in setup()

11. erlmcp_client_tests               1 failure
    Location: apps/erlmcp_core/test/erlmcp_client_tests.erl
    Fix: Start erlmcp_client and registry in setup()

12. erlmcp_code_reload_tests          1 failure
    Location: apps/erlmcp_core/test/erlmcp_code_reload_tests.erl
    Fix: Start erlmcp_code_reload in setup()

13. erlmcp_memory_guard_tests         1 failure
    Location: apps/erlmcp_core/test/erlmcp_memory_guard_tests.erl
    Fix: Start erlmcp_memory_guard in setup()

14. erlmcp_sse_event_store_tests      1 failure
    Location: apps/erlmcp_transports/test/erlmcp_sse_event_store_tests.erl
    Fix: Start erlmcp_sse_event_store in setup()

================================================================================
RECOMMENDED FIX STRATEGY
================================================================================

STEP 1: Create centralized test helper
--------------------------------------
File: apps/erlmcp_core/test/erlmcp_test_helper.erl

-module(erlmcp_test_helper).
-export([start_core_servers/0, stop_core_servers/0]).

start_core_servers() ->
    {ok, _} = application:ensure_all_started(erlmcp_core),
    {ok, _} = erlmcp_registry:start_link(),
    {ok, _} = erlmcp_pagination:start_link(),
    {ok, _} = erlmcp_logging:start_link(),
    {ok, _} = erlmcp_session_manager:start_link(),
    {ok, _} = erlmcp_cache:start_link(),
    {ok, _} = erlmcp_auth:start_link(),
    {ok, _} = erlmcp_rate_limiter:start_link(),
    ok.

stop_core_servers() ->
    application:stop(erlmcp_core).

STEP 2: Update all failing test modules
----------------------------------------
Add to each test module's setup():

setup() ->
    ok = erlmcp_test_helper:start_core_servers(),
    [].

STEP 3: Verify fixes
--------------------
TERM=dumb rebar3 as test eunit --dir apps/erlmcp_core/test

Expected result: Failed: 0. Skipped: 0. Passed: 861.

================================================================================
COMPILATION ISSUES FIXED DURING TEST RUN
================================================================================

1. Added MCP_PARAM_LEVEL macro to include/erlmcp.hrl
   Line 660: -define(MCP_PARAM_LEVEL, <<"level">>).

2. Fixed syntax error in erlmcp_security_validator_SUITE.erl
   Line 336: Removed extra closing brace in jsx:encode call

================================================================================
QUALITY METRICS
================================================================================

Current State:
  Pass Rate:  90.9% (783/861)
  Coverage:   ~75% (estimated)

Target State (After Fixes):
  Pass Rate:  100% (861/861) [REQUIRED FOR DoD]
  Coverage:   80%+ [REQUIRED FOR DoD]

Estimated Fix Time: 2-3 hours
Risk Level: Low (fixes isolated to test setup)
Impact: High (achieves DoD requirement)

================================================================================
NEXT ACTIONS
================================================================================

1. ✅ COMPLETED: Run full EUnit test suite
2. ✅ COMPLETED: Identify all failing tests with module:line locations
3. ✅ COMPLETED: Document error messages and patterns
4. ✅ COMPLETED: Create comprehensive failure report
5. ⏳ PENDING: Fix test fixtures (estimated 2-3 hours)
6. ⏳ PENDING: Re-run tests to verify 100% pass rate
7. ⏳ PENDING: Generate coverage report (target 80%+)

================================================================================
FULL REPORT
================================================================================

Detailed analysis available at:
test_results/definition_of_done/EUNIT_FAILURE_REPORT.md

================================================================================
