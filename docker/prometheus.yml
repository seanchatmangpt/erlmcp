# ==============================================================================
# erlmcp v3 Prometheus Configuration
# Complete metrics scraping configuration for production monitoring
# ==============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s
  external_labels:
    cluster: 'erlmcp-production'
    environment: 'docker'
    monitor: 'erlmcp-v3'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
      timeout: 10s
      api_version: v2

# Rule files - includes alerting and recording rules
rule_files:
  - "alert_rules.yml"
  - "recording_rules.yml"

# Scrape configurations
scrape_configs:
  # ================================================================
  # erlmcp Core Application Metrics
  # ================================================================
  - job_name: 'erlmcp-core'
    static_configs:
      - targets: ['erlmcp:9090']
        labels:
          service: 'erlmcp'
          component: 'core'
          app: 'erlmcp-v3'
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s
    scheme: http
    honor_labels: true
    honor_timestamps: true

  # ================================================================
  # OTEL Collector Metrics (for distributed tracing)
  # ================================================================
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']
        labels:
          service: 'otel-collector'
          component: 'observability'
    metrics_path: '/metrics'
    scrape_interval: 30s
    scrape_timeout: 10s
    scheme: http
    honor_labels: true

  # ================================================================
  # Prometheus self-monitoring
  # ================================================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          component: 'monitoring'
    metrics_path: '/metrics'
    scrape_interval: 30s

  # ================================================================
  # Alertmanager metrics
  # ================================================================
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
        labels:
          service: 'alertmanager'
          component: 'monitoring'
    metrics_path: '/metrics'
    scrape_interval: 30s

  # ================================================================
  # Node Exporter - System level metrics (CPU, Memory, Disk)
  # ================================================================
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node-exporter'
          component: 'infrastructure'
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s

  # ================================================================
  # cAdvisor - Container metrics
  # ================================================================
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          service: 'cadvisor'
          component: 'containers'
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s

  # ================================================================
  # Grafana metrics
  # ================================================================
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
          component: 'visualization'
    metrics_path: '/metrics'
    scrape_interval: 30s

# ================================================================
# Storage Configuration
# ================================================================
storage:
  tsdb:
    path: /prometheus
    retention:
      time: 15d
      size: 10GB
    # WAL configuration for durability
    wal:
      truncate-frequency: 2h

# ================================================================
# Tracing Configuration (optional)
# ================================================================
tracing:
  endpoint: "localhost:4318"
  client_type: "grpc"
  headers:
    X-Trace-Enabled: "true"

# ================================================================
# Web Configuration
# ==============================================================
web:
  enable_admin_api: true
  enable_lifecycle: true
  cors:
    allowed_origins:
      - "http://localhost:3000"
      - "http://grafana:3000"
