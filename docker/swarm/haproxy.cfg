global
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    chroot /var/lib/haproxy
    pidfile /var/run/haproxy.pid
    stats socket /var/run/haproxy.sock mode 600 level admin
    log /dev/log local0
    log /dev/log local1 notice
    tune.ssl.default-dh-param 2048

defaults
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option redispatch
    timeout http-keep-alive 10s
    timeout client 60s
    timeout server 60s
    timeout check 5s
    maxconn 4096
    retries 3
    balance roundrobin
    option httpchk GET /health

# Frontend for erlmcp-core
frontend erlmcp-core-frontend
    bind *:80
    redirect scheme https if !{ ssl_fc }
    bind *:443 ssl crt /etc/letsencrypt/live/example.com/fullchain.pem ca-file /etc/letsencrypt/live/example.com/chain.pem
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    acl is_erlmcp_core path_beg /erlmcp-core
    use_backend erlmcp-core-backend if is_erlmcp_core
    default_backend erlmcp-core-backend

# Frontend for erlmcp-server
frontend erlmcp-server-frontend
    bind *:8080
    http-request set-header X-Forwarded-Proto https
    acl is_erlmcp_server path_beg /erlmcp-server
    use_backend erlmcp-server-backend if is_erlmcp_server
    default_backend erlmcp-server-backend

# Backend for erlmcp-core services
backend erlmcp-core-backend
    option httpchk GET /health
    http-check expect status 200
    balance roundrobin
    option httpclose
    option forwardfor
    server core-1 erlmcp-core-1:8080 check inter 10s rise 2 fall 3
    server core-2 erlmcp-core-2:8080 check inter 10s rise 2 fall 3
    server core-3 erlmcp-core-3:8080 check inter 10s rise 2 fall 3

# Backend for erlmcp-server services
backend erlmcp-server-backend
    option httpchk GET /health
    http-check expect status 200
    balance roundrobin
    option httpclose
    option forwardfor
    server server-1 erlmcp-server-1:8081 check inter 10s rise 2 fall 3
    server server-2 erlmcp-server-2:8081 check inter 10s rise 2 fall 3
    server server-3 erlmcp-server-3:8081 check inter 10s rise 2 fall 3
    server server-4 erlmcp-server-4:8081 check inter 10s rise 2 fall 3
    server server-5 erlmcp-server-5:8081 check inter 10s rise 2 fall 3
    server server-6 erlmcp-server-6:8081 check inter 10s rise 2 fall 3

# Statistics frontend
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats realm Haproxy Statistics
    stats auth admin:password
    stats refresh 30s
    stats show-legends
    stats show-node

# Redis health check
listen redis-check
    bind *:6380
    mode tcp
    timeout connect 5s
    timeout client 5s
    timeout server 5s
    server redis-1 redis:6379 check inter 10s rise 2 fall 3
    server redis-2 redis:6379 check inter 10s rise 2 fall 3
    server redis-3 redis:6379 check inter 10s rise 2 fall 3

# PostgreSQL health check
listen postgres-check
    bind *:6432
    mode tcp
    timeout connect 5s
    timeout client 5s
    timeout server 5s
    server postgres-1 postgres:5432 check inter 10s rise 2 fall 3
    server postgres-2 postgres:5432 check inter 10s rise 2 fall 3
    server postgres-3 postgres:5432 check inter 10s rise 2 fall 3

# Service mesh configuration
listen envoy-management
    bind *:15000
    mode tcp
    timeout connect 5s
    timeout client 5s
    timeout server 5s
    server envoy-1 envoy:15000 check inter 10s rise 2 fall 3
    server envoy-2 envoy:15000 check inter 10s rise 2 fall 3
    server envoy-3 envoy:15000 check inter 10s rise 2 fall 3
    server envoy-4 envoy:15000 check inter 10s rise 2 fall 3
    server envoy-5 envoy:15000 check inter 10s rise 2 fall 3
    server envoy-6 envoy:15000 check inter 10s rise 2 fall 3