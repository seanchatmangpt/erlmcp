# ==============================================================================
# AWS Emulators for Local Development (LocalStack)
# ==============================================================================
# Provides local emulation of AWS services for development and testing.
# Allows erlmcp to be developed without a real AWS account.
#
# Usage:
#   docker compose -f docker/docker-compose.aws-emulators.yml up -d
#
# Services emulated:
# - S3 (object storage)
# - SQS (message queues)
# - SNS (notifications)
# - Secrets Manager (secrets)
# - SSM Parameter Store (configuration)
# - CloudWatch Logs (logging)
# - DynamoDB (NoSQL)
# - KMS (encryption keys)
# - ECR (container registry)
# - ECS (container orchestration - limited)
#
# Note: ECS/Fargate/RDS don't have full emulation.
# Use PostgreSQL directly for database simulation.
# ==============================================================================

services:
  # ==========================================================================
  # LocalStack - AWS Service Emulator
  # ==========================================================================
  localstack:
    image: localstack/localstack:3.0
    ports:
      - "4566:4566"           # Main LocalStack endpoint
      - "4510-4559:4510-4559" # External service ports
    environment:
      - DEBUG=${DEBUG:-0}
      - SERVICES=s3,sqs,sns,secretsmanager,ssm,logs,dynamodb,kms,ecr,iam
      - DEFAULT_REGION=us-east-1
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
      - EAGER_SERVICE_LOADING=1
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./localstack-init:/etc/localstack/init/ready.d
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - aws-emulator

  # ==========================================================================
  # LocalStack Initialization
  # ==========================================================================
  localstack-setup:
    image: amazon/aws-cli:2.15.0
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://localstack:4566
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "=== Setting up LocalStack resources ==="

        # Create S3 buckets
        echo "Creating S3 buckets..."
        aws --endpoint-url=http://localstack:4566 s3 mb s3://erlmcp-artifacts
        aws --endpoint-url=http://localstack:4566 s3 mb s3://erlmcp-logs
        aws --endpoint-url=http://localstack:4566 s3 mb s3://erlmcp-terraform-state

        # Create SQS queues
        echo "Creating SQS queues..."
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name erlmcp-events
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name erlmcp-events-dlq
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name erlmcp-notifications

        # Create SNS topics
        echo "Creating SNS topics..."
        aws --endpoint-url=http://localstack:4566 sns create-topic --name erlmcp-alerts
        aws --endpoint-url=http://localstack:4566 sns create-topic --name erlmcp-events

        # Subscribe SQS to SNS
        aws --endpoint-url=http://localstack:4566 sns subscribe \
          --topic-arn arn:aws:sns:us-east-1:000000000000:erlmcp-events \
          --protocol sqs \
          --notification-endpoint arn:aws:sqs:us-east-1:000000000000:erlmcp-events

        # Create KMS key
        echo "Creating KMS key..."
        aws --endpoint-url=http://localstack:4566 kms create-key \
          --description "erlmcp encryption key" \
          --tags TagKey=Name,TagValue=erlmcp-key
        aws --endpoint-url=http://localstack:4566 kms create-alias \
          --alias-name alias/erlmcp \
          --target-key-id $$(aws --endpoint-url=http://localstack:4566 kms list-keys --query 'Keys[0].KeyId' --output text)

        # Create Secrets Manager secrets
        echo "Creating secrets..."
        aws --endpoint-url=http://localstack:4566 secretsmanager create-secret \
          --name erlmcp-dev/erlang-cookie \
          --secret-string "erlmcp_local_dev_cookie_secret"

        aws --endpoint-url=http://localstack:4566 secretsmanager create-secret \
          --name erlmcp-dev/database-url \
          --secret-string "postgresql://erlmcp:erlmcp_local@postgres:5432/erlmcp"

        aws --endpoint-url=http://localstack:4566 secretsmanager create-secret \
          --name erlmcp-dev/api-keys \
          --secret-string '{"mcp_api_key":"test-api-key","webhook_secret":"test-webhook-secret"}'

        # Create SSM parameters
        echo "Creating SSM parameters..."
        aws --endpoint-url=http://localstack:4566 ssm put-parameter \
          --name /erlmcp-dev/config \
          --type String \
          --value '{"environment":"dev","region":"us-east-1","log_level":"debug"}'

        aws --endpoint-url=http://localstack:4566 ssm put-parameter \
          --name /erlmcp-dev/features \
          --type String \
          --value '{"clustering":true,"metrics":true,"tracing":true}'

        # Create CloudWatch log groups
        echo "Creating CloudWatch log groups..."
        aws --endpoint-url=http://localstack:4566 logs create-log-group \
          --log-group-name /ecs/erlmcp-dev
        aws --endpoint-url=http://localstack:4566 logs create-log-group \
          --log-group-name /ecs/exec/erlmcp-dev

        # Create DynamoDB tables
        echo "Creating DynamoDB tables..."
        aws --endpoint-url=http://localstack:4566 dynamodb create-table \
          --table-name erlmcp-sessions \
          --attribute-definitions AttributeName=session_id,AttributeType=S \
          --key-schema AttributeName=session_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST

        aws --endpoint-url=http://localstack:4566 dynamodb create-table \
          --table-name erlmcp-cache \
          --attribute-definitions AttributeName=cache_key,AttributeType=S \
          --key-schema AttributeName=cache_key,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST

        # Create ECR repository
        echo "Creating ECR repository..."
        aws --endpoint-url=http://localstack:4566 ecr create-repository \
          --repository-name erlmcp

        echo "=== LocalStack setup complete ==="
    networks:
      - aws-emulator

  # ==========================================================================
  # PostgreSQL (simulates RDS)
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: erlmcp
      POSTGRES_PASSWORD: erlmcp_local
      POSTGRES_DB: erlmcp
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U erlmcp"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aws-emulator

  # ==========================================================================
  # Redis (simulates ElastiCache)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aws-emulator

  # ==========================================================================
  # Prometheus (simulates CloudWatch Metrics)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus-aws.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aws-emulator

  # ==========================================================================
  # Grafana (simulates CloudWatch Dashboards)
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.2.0
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aws-emulator

  # ==========================================================================
  # Jaeger (simulates X-Ray)
  # ==========================================================================
  jaeger:
    image: jaegertracing/all-in-one:1.52
    ports:
      - "5775:5775/udp"   # Zipkin compact thrift
      - "6831:6831/udp"   # Jaeger compact thrift
      - "6832:6832/udp"   # Jaeger binary thrift
      - "5778:5778"       # Serve configs
      - "16686:16686"     # UI
      - "14268:14268"     # Jaeger thrift
      - "14250:14250"     # gRPC
      - "9411:9411"       # Zipkin
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:14269/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aws-emulator

  # ==========================================================================
  # erlmcp Application (configured for AWS emulators)
  # ==========================================================================
  erlmcp:
    build:
      context: ..
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "9090:9090"
      - "4369:4369"
    environment:
      - ERLMCP_PROFILE=dev
      - ERLMCP_PORT=8080
      - ERLMCP_METRICS_PORT=9090
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
      - LOCALSTACK_HOSTNAME=localstack
      - S3_ENDPOINT=http://localstack:4566
      - SQS_ENDPOINT=http://localstack:4566
      - SNS_ENDPOINT=http://localstack:4566
      - SECRETSMANAGER_ENDPOINT=http://localstack:4566
      - SSM_ENDPOINT=http://localstack:4566
      - DYNAMODB_ENDPOINT=http://localstack:4566
      - CLOUDWATCH_ENDPOINT=http://localstack:4566
      - DATABASE_URL=postgresql://erlmcp:erlmcp_local@postgres:5432/erlmcp
      - REDIS_URL=redis://redis:6379
      - ERLANG_COOKIE=erlmcp_local_dev_cookie
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - OTEL_EXPORTER_JAEGER_ENDPOINT=http://jaeger:14268/api/traces
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - aws-emulator

  # ==========================================================================
  # AWS CLI for manual testing
  # ==========================================================================
  awscli:
    image: amazon/aws-cli:2.15.0
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://localstack:4566
    entrypoint: ["tail", "-f", "/dev/null"]
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - aws-emulator

networks:
  aws-emulator:
    driver: bridge

volumes:
  localstack-data:
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:
