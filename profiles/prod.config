%% Production Profile - Strict Performance & Security
%% Use when: Live deployments, mission-critical services
%%
%% Characteristics:
%% - Minimal logging (info only, no debug)
%% - Strict rate limits (prevent abuse)
%% - Circuit breaker ON (prevent cascades)
%% - Refusal-based backpressure (deterministic)
%% - Standard message size limits (MCP compliance)
%% - HTTPS required (security first)

[
    {erlmcp, [
        %% Logging: INFO only (minimal overhead)
        {log_level, info},

        %% Client: Standard limits
        {client_defaults, #{
            timeout => 5000,
            strict_mode => true,        % Enforce strict protocol compliance
            max_pending_requests => 100
        }},

        %% Server: Protective limits
        {server_defaults, #{
            max_subscriptions_per_resource => 1000,
            max_progress_tokens => 10000
        }},

        %% Message sizes: Standard MCP compliance
        {message_size_limits, #{
            default => 16777216,        % 16 MB
            http_body => 16777216,
            sse_event => 16777216,
            websocket => 16777216,
            tcp => 16777216,
            stdio => 16777216
        }},

        %% Transport: Standard timeouts
        {transport_defaults, #{
            tcp => #{
                connect_timeout => 5000,
                keepalive => true,
                nodelay => true
            },
            http => #{
                connect_timeout => 5000,
                request_timeout => 30000,
                max_connections => 100
            }
        }},

        %% HTTP Security: Strict for production
        {http_security, [
            {allowed_origins, [
                "https://trusted-domain.com",
                "https://trusted-domain.com:*"
            ]},
            {session_timeout, 1800},     % 30 minutes
            {require_https, true},       % MUST use HTTPS
            {http_redirect_to_https, true},
            {http_bind_address, "127.0.0.1"}
        ]},

        %% HTTPS: ENABLED and enforced
        {https_config, [
            {enabled, true},
            {certfile, "priv/cert.pem"},
            {keyfile, "priv/key.pem"},
            {cacertfile, undefined},
            {min_tls_version, 'tlsv1.2'},
            {ciphers, [
                "ECDHE-RSA-AES256-GCM-SHA384",
                "ECDHE-RSA-AES128-GCM-SHA256",
                "ECDHE-RSA-CHACHA20-POLY1305",
                "DHE-RSA-AES256-GCM-SHA384",
                "DHE-RSA-AES128-GCM-SHA256"
            ]},
            {enable_hsts, true},
            {hsts_max_age, 31536000},   % 1 year
            {hsts_include_subdomains, true},
            {verify_mode, 'verify_peer'},
            {sni_enabled, true},
            {verify_hostname, true},
            {verify_depth, 3}
        ]},

        %% Localhost binding: ENFORCED
        {localhost_binding, [
            {enforce_localhost_only, true},
            {http_bind_address, "127.0.0.1"},
            {http_bind_ipv6, "::1"},
            {security_policy, "localhost_only"}
        ]},

        %% Rate limiting: STRICT to prevent abuse
        {rate_limiting, #{
            max_messages_per_sec => 100,        % Tight per-client limit
            max_connections_per_sec => 10,
            global_max_messages_per_sec => 10000,
            max_tool_calls_per_sec => 50,
            max_subscriptions_per_sec => 20,
            bucket_refill_interval_ms => 100,
            ddos_violation_threshold => 100,    % Strict threshold
            ddos_block_duration_ms => 300000,   % 5 minutes
            enabled => true  % ENABLED for production
        }},

        %% Backpressure: Adaptive and protective
        {backpressure, #{
            max_messages_per_sec => 500,
            burst_multiplier => 2.0,
            adaptive_enabled => true,          % Enable adaptive reduction
            latency_threshold_ms => 100,       % Sensitive threshold
            rate_reduction_percent => 10,      % 10% reduction per violation
            queue_depth_threshold_percent => 80
        }},

        %% Circuit breaker: ENABLED (prevent cascades)
        {circuit_breaker, #{
            enabled => true,  % ENABLED in production
            failure_threshold => 5,             % Strict threshold
            cool_down_time_ms => 30000,        % 30 seconds
            p95_latency_threshold_ms => 200,
            error_rate_threshold_percent => 1.0,
            cpu_threshold_percent => 90,
            memory_threshold_percent => 85,
            recovery_timeout_ms => 60000,
            half_open_timeout_ms => 30000
        }},

        %% Queue limits: Strict with refusal
        {queue_limits, #{
            max_messages => 1000,               % Conservative limit
            max_bytes => 52428800,              % 50 MB
            backpressure_action => refuse,      % Deterministic refusal
            enable_tenant_limits => true,       % Multi-tenant protection
            cleanup_interval_ms => 30000
        }},

        %% Connection pool: Optimized for 100K
        {connection_pool_config, #{
            pool_count => 128,
            pool_size => 50,
            max_overflow => 20,
            auto_create_pools => false,
            checkout_timeout => 5000,
            worker_timeout => 10000
        }},

        %% Lifecycle: Strict cleanup
        {lifecycle_management, #{
            subscription_ttl_ms => 3600000,     % 1 hour expiry
            task_ttl_ms => 3600000,
            max_subscriptions_per_server => 10000,
            cleanup_interval_ms => 30000,
            cleanup_batch_size => 1000
        }},

        %% Session replication: ENABLED for HA
        {session_replication, [
            {enabled, true},
            {replica_nodes, []},                % Configure for your cluster
            {batch_size, 100},
            {batch_timeout_ms, 20},
            {replication_rpc_timeout_ms, 5000},
            {health_check_interval_ms, 5000},
            {failure_threshold, 3},
            {storage_mode, mnesia},             % Persistent storage
            {cleanup_interval_ms, 30000},
            {enable_compression, true},
            {max_session_size_bytes, 65536}
        ]}
    ]},

    {kernel, [
        {logger_level, info},
        {logger, [
            {handler, default, logger_std_h, #{
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 100,
                    drop_mode_qlen => 1000,
                    flush_qlen => 2000
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"],
                    time_offset => "",
                    time_designator => $T,
                    single_line => false,
                    max_size => 4096
                }},
                filters => [
                    {progress_reports, {fun logger_filters:progress/2, stop}},
                    {sasl_reports, {fun logger_filters:domain/2, {stop, sub, [otp, sasl]}}}
                ],
                level => info
            }},
            %% Persistent file logging
            {handler, file_log, logger_std_h, #{
                config => #{
                    file => "logs/erlmcp.log",
                    max_no_bytes => 10485760,  % 10 MB
                    max_no_files => 5,
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " ", mfa, ":", line, " ", msg, "\n"]
                }},
                level => info
            }}
        ]}
    ]},

    {sasl, [
        {sasl_error_logger, false},     % Use kernel logger only
        {errlog_type, error},           % Errors only
        {error_logger_format_depth, 20}
    ]}
].
