%% Government/Regulated Environment Profile - Audit & Determinism
%% Use when: Government agencies, compliance requirements, audit trails
%%
%% Characteristics:
%% - Full audit logging enabled (every operation logged)
%% - Deterministic behavior (no randomness, reproducible)
%% - All operations traceable (request IDs, correlation IDs)
%% - Strict refusal on limits (refuse > drop > disconnect)
%% - Complete HTTPS/TLS enforcement (FIPS-140-2 compatible)
%% - Session audit trail maintained
%% - Comprehensive rate limiting (prevent resource abuse)

[
    {erlmcp, [
        %% Logging: DEBUG with full traceability
        {log_level, debug},

        %% Client: Deterministic defaults
        {client_defaults, #{
            timeout => 5000,
            strict_mode => true,        % Strict protocol compliance
            max_pending_requests => 100
        }},

        %% Server: Conservative limits with audit trail
        {server_defaults, #{
            max_subscriptions_per_resource => 500,  % Lower for audit
            max_progress_tokens => 5000
        }},

        %% Message sizes: Conservative, compliance-focused
        {message_size_limits, #{
            default => 10485760,        % 10 MB (conservative)
            http_body => 10485760,
            sse_event => 10485760,
            websocket => 10485760,
            tcp => 10485760,
            stdio => 10485760
        }},

        %% Transport: Deterministic, no randomness
        {transport_defaults, #{
            tcp => #{
                connect_timeout => 5000,
                keepalive => true,
                nodelay => true
            },
            http => #{
                connect_timeout => 5000,
                request_timeout => 30000,
                max_connections => 100
            }
        }},

        %% HTTP Security: Maximum strictness
        {http_security, [
            {allowed_origins, [
                "https://gov-agency.gov",
                "https://gov-agency.gov:*",
                "https://localhost",
                "https://127.0.0.1"
            ]},
            {session_timeout, 900},     % 15 minutes (strict)
            {require_https, true},      % REQUIRED
            {http_redirect_to_https, true},
            {http_bind_address, "127.0.0.1"}
        ]},

        %% HTTPS: FIPS-140-2 compatible configuration
        {https_config, [
            {enabled, true},
            {certfile, "priv/cert.pem"},
            {keyfile, "priv/key.pem"},
            {cacertfile, "priv/ca-bundle.pem"},
            %% TLS 1.2 or higher (FIPS-140-2 requirement)
            {min_tls_version, 'tlsv1.2'},
            %% FIPS-140-2 approved cipher suites only
            {ciphers, [
                "ECDHE-RSA-AES256-GCM-SHA384",      % Suite B
                "ECDHE-RSA-AES128-GCM-SHA256",      % Suite B
                "DHE-RSA-AES256-GCM-SHA384",        % Suite B
                "DHE-RSA-AES128-GCM-SHA256",        % Suite B
                "ECDHE-ECDSA-AES256-GCM-SHA384"     % Suite B
            ]},
            {enable_hsts, true},
            {hsts_max_age, 31536000},       % 1 year
            {hsts_include_subdomains, true},
            {verify_mode, 'verify_peer'},   % REQUIRED peer verification
            {sni_enabled, true},
            {verify_hostname, true},        % REQUIRED hostname verification
            {verify_depth, 3},
            %% Certificate pinning for added security (optional)
            {pinned_certs, undefined}
        ]},

        %% Localhost binding: STRICTLY enforced
        {localhost_binding, [
            {enforce_localhost_only, true},
            {http_bind_address, "127.0.0.1"},
            {http_bind_ipv6, "::1"},
            {security_policy, "localhost_only"}
        ]},

        %% Rate limiting: Audit-friendly and strict
        {rate_limiting, #{
            max_messages_per_sec => 50,         % Very conservative
            max_connections_per_sec => 5,      % Tight control
            global_max_messages_per_sec => 5000,
            max_tool_calls_per_sec => 20,
            max_subscriptions_per_sec => 10,
            bucket_refill_interval_ms => 100,
            ddos_violation_threshold => 50,     % Very strict
            ddos_block_duration_ms => 600000,   % 10 minutes (long block)
            enabled => true  % ENABLED for government environments
        }},

        %% Backpressure: Strict and auditable
        {backpressure, #{
            max_messages_per_sec => 200,        % Conservative
            burst_multiplier => 1.5,            % Minimal burst allowed
            adaptive_enabled => true,           % Adaptive protection
            latency_threshold_ms => 50,         % Very sensitive
            rate_reduction_percent => 20,       % Aggressive reduction
            queue_depth_threshold_percent => 70 % Early detection
        }},

        %% Circuit breaker: STRICT for determinism
        {circuit_breaker, #{
            enabled => true,  % ENABLED and strict
            failure_threshold => 3,             % Very sensitive
            cool_down_time_ms => 60000,         % 60 seconds
            p95_latency_threshold_ms => 150,    % Strict latency SLA
            error_rate_threshold_percent => 0.5,
            cpu_threshold_percent => 80,        % Lower threshold
            memory_threshold_percent => 80,
            recovery_timeout_ms => 120000,      % 2 minutes
            half_open_timeout_ms => 30000
        }},

        %% Queue limits: Refuse only (no drops in audit environment)
        {queue_limits, #{
            max_messages => 500,                % Conservative
            max_bytes => 26214400,              % 25 MB
            backpressure_action => refuse,      % DETERMINISTIC: refuse > drop
            enable_tenant_limits => true,
            cleanup_interval_ms => 10000        % Frequent cleanup
        }},

        %% Connection pool: Sized for audit overhead
        {connection_pool_config, #{
            pool_count => 64,
            pool_size => 25,                    % Smaller for audit
            max_overflow => 10,
            auto_create_pools => false,
            checkout_timeout => 5000,
            worker_timeout => 10000
        }},

        %% Lifecycle: Aggressive cleanup for audit trails
        {lifecycle_management, #{
            subscription_ttl_ms => 1800000,     % 30 minutes
            task_ttl_ms => 1800000,
            max_subscriptions_per_server => 5000,
            cleanup_interval_ms => 15000,       % Very frequent
            cleanup_batch_size => 500
        }},

        %% Session replication: REQUIRED for gov environments
        {session_replication, [
            {enabled, true},
            {replica_nodes, []},                % Must configure for deployment
            {batch_size, 50},                   % Smaller batches for consistency
            {batch_timeout_ms, 10},             % Frequent flushes
            {replication_rpc_timeout_ms, 3000}, % Strict timeout
            {health_check_interval_ms, 3000},   % Frequent health checks
            {failure_threshold, 2},             % Lower threshold
            {storage_mode, mnesia},             % Persistent storage REQUIRED
            {cleanup_interval_ms, 15000},
            {enable_compression, false},        % Disable compression (audit-friendly)
            {max_session_size_bytes, 32768}     % Very conservative
        ]},

        %% Audit logging configuration (custom)
        {audit_logging, [
            {enabled, true},
            {log_all_operations, true},         % Log everything
            {log_file, "logs/audit.log"},
            {max_file_size, 52428800},          % 50 MB
            {max_files, 12},                    % Keep 12 months of daily logs
            {compression, gzip},
            {include_correlation_id, true},
            {include_session_id, true},
            {include_user_id, true},
            {log_sensitive_data, false}         % Don't log credentials
        ]}
    ]},

    {kernel, [
        {logger_level, debug},
        {logger, [
            {handler, default, logger_std_h, #{
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 1,        % Sync immediately (audit trail integrity)
                    drop_mode_qlen => unlimited,
                    flush_qlen => 0
                },
                formatter => {logger_formatter, #{
                    %% Detailed format with correlation ID
                    template => [time, " [", level, "] ", pid, " [", correlation_id, "] ", mfa, ":", line, " ", msg, "\n"],
                    time_offset => "Z",         % UTC timestamps
                    time_designator => $T,
                    single_line => false,
                    max_size => 16384
                }},
                level => debug
            }},
            %% Comprehensive audit logging
            {handler, audit_log, logger_std_h, #{
                config => #{
                    file => "logs/audit-trail.log",
                    max_no_bytes => 52428800,   % 50 MB
                    max_no_files => 12,         % 12 files = 1 year
                    compress_on_rotate => true
                },
                formatter => {logger_formatter, #{
                    template => [time, " [", level, "] ", pid, " [", correlation_id, "] ", mfa, ":", line, " ", msg, "\n"],
                    time_offset => "Z",
                    time_designator => $T,
                    single_line => false
                }},
                level => info
            }}
        ]}
    ]},

    {sasl, [
        {sasl_error_logger, true},      % Log errors for audit
        {errlog_type, all},             % All error types
        {error_logger_format_depth, 30}
    ]}
].
