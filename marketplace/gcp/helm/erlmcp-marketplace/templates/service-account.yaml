{{/*
  erlmcp Service Account for GCP Marketplace
  Kubernetes Service Account with Workload Identity annotation
*/}}

apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "erlmcp.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: service-account
  annotations:
    {{- with .Values.serviceAccount.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- if .Values.global.gcp.workloadIdentity.enabled }}
    # Workload Identity annotation
    iam.gke.io/gcp-service-account: {{ .Values.global.gcp.workloadIdentity.gsaEmail | quote }}
    {{- end }}
automountServiceAccountToken: {{ .Values.serviceAccount.automountServiceAccountToken | default true }}
secrets:
  {{- if .Values.serviceAccount.secrets }}
  {{- toYaml .Values.serviceAccount.secrets | nindent 2 }}
  {{- end }}
---
{{/* IAM Policy for Workload Identity (managed via Terraform) */}}
{{- if .Values.global.gcp.workloadIdentity.enabled }}
{{/* The IAM binding is created in Terraform:
    resource "google_service_account_iam_member" "workload_identity" {
      service_account_id = google_service_account.erlmcp.name
      role               = "roles/iam.workloadIdentityUser"
      member             = "serviceAccount:${project_id}.svc.id.goog[${namespace}/${sa_name}]"
    }
*/}}
{{- end }}
---
{{/* Kubernetes Secret for Service Account token */}}
{{- if .Values.serviceAccount.createTokenSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.serviceAccountName" . }}-token
  namespace: {{ .Release.Namespace }}
  annotations:
    kubernetes.io/service-account.name: {{ include "erlmcp.serviceAccountName" . }}
type: kubernetes.io/service-account-token
{{- end }}
