# ggen Configuration for erlmcp - MCP Protocol Code Generation
# Ontology-driven code generation for Model Context Protocol (MCP) 2025-11-25
# Version: 0.6.0
# Purpose: Generate type-safe, validated Erlang/OTP implementations from MCP ontology

[project]
name = "erlmcp"
version = "0.6.0"
description = "MCP 2025-11-25 compliant Erlang/OTP SDK with ontology-driven code generation"
authors = ["erlmcp Team"]
license = "Apache-2.0"
homepage = "https://github.com/seanchatmangpt/erlmcp"
repository = "https://github.com/seanchatmangpt/erlmcp"

# Target specification compliance
[project.mcp]
specification_version = "2025-11-25"
specification_url = "https://modelcontextprotocol.io/specification/2025-11-25"
compliance_target = 95  # Target 95%+ compliance score

# RDF Ontology Configuration
[ontology]
# Primary MCP protocol ontology
primary = "ontology/mcp.ttl"

# Source directories for RDF/Turtle ontologies
source = "ontology/"

# Ontology paths (MCP protocol definitions)
paths = [
    "ontology/mcp.ttl",                    # MCP protocol core
    "ontology/mcp_messages.ttl",           # Message types and methods
    "ontology/mcp_components.ttl",         # Resources, Tools, Prompts, Tasks
    "ontology/mcp_lifecycle.ttl",          # Phase transitions, state machines
    "ontology/mcp_validation.ttl",         # Validation rules and schemas
    "ontology/mcp_errors.ttl",             # Error codes and handling
    "ontology/mcp_transports.ttl",         # Transport behaviors
    "ontology/mcp_capabilities.ttl"        # Capability negotiation
]

# SHACL shapes for validation
shapes = "shapes/mcp_shapes.ttl"

# Ontology format (turtle, rdf/xml, n-triples, json-ld)
format = "turtle"

# Ontology validation on load
validate_on_load = true

# Ontology caching for performance
cache_parsed = true
cache_path = ".ggen_cache/ontology/"

# SPARQL Queries Configuration
[queries]
# Directory containing SPARQL queries
source_dir = "sparql/mcp_queries"

# Use optimized queries when available
optimized_dir = "sparql/mcp_queries_optimized"

# Query timeout (milliseconds)
timeout_ms = 10000

# Query caching
cache_results = true

# Named queries for MCP protocol generation
[queries.named]
# Server message handlers
server_handlers = "server_message_handlers.rq"
server_methods = "server_methods.rq"
server_phases = "server_lifecycle_phases.rq"
server_capabilities = "server_capability_checks.rq"

# Client API methods
client_methods = "client_api_methods.rq"
client_requests = "client_request_types.rq"
client_responses = "client_response_handling.rq"

# Validation rules
validation_tools = "validation_tool_arguments.rq"
validation_resources = "validation_resource_uris.rq"
validation_prompts = "validation_prompt_arguments.rq"
validation_schemas = "validation_json_schemas.rq"

# Task management
task_lifecycle = "task_state_machine.rq"
task_transitions = "task_state_transitions.rq"
task_methods = "task_api_methods.rq"

# Error definitions
error_codes = "error_code_definitions.rq"
error_handlers = "error_recovery_handlers.rq"

# Transport behaviors
transport_interface = "transport_behavior_callbacks.rq"
transport_validation = "transport_message_validation.rq"

# Protocol metadata
protocol_messages = "protocol_all_messages.rq"
protocol_notifications = "protocol_notification_types.rq"

# Template Configuration
[templates]
# Template directory for MCP-specific templates
source_dir = "ggen_templates/mcp"

# Template engine: tera (Jinja2-like for Rust/Erlang)
engine = "tera"

# Template includes (shared partials)
includes_dir = "ggen_templates/mcp/partials"

# Output directory for generated files
output_dir = "generated/mcp"

# Template globals (available in all templates)
[templates.globals]
mcp_version = "2025-11-25"
generator_version = "6.0.0"
erlang_min_version = "25"
otp_behaviors = ["gen_server", "gen_statem", "supervisor"]

# Output Configuration
[output]
# Clean output directory before generation
clean = false

# Create output directory if it doesn't exist
create_dirs = true

# Preserve existing files not generated by ggen
preserve_existing = true

# Generate index of all created files
generate_index = true
index_path = "generated/mcp/INDEX.md"

# Generate manifest with checksums
generate_manifest = true
manifest_path = "generated/mcp/MANIFEST.json"

# Backup before overwriting
backup_existing = true
backup_dir = "generated/mcp/.backups"

# Output paths by file type
[output.paths]
erlang_modules = "apps/erlmcp_core/src/generated/"
erlang_headers = "include/generated/"
erlang_tests = "test/generated/"
documentation = "docs/generated/mcp/"
schemas = "priv/schemas/generated/"

# Generation Rules - SPARQL to Template Mappings
# Each rule extracts data via SPARQL and renders through Tera template

# =============================================================================
# SERVER MESSAGE HANDLERS
# =============================================================================

[[generation.rules]]
name = "server_initialize_handler"
description = "Generate initialize request handler with phase validation"
query = "server_handlers"
filter = "method = 'initialize'"
template = "erlang/server/handler_initialize.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_initialize.erl"
enabled = true

[[generation.rules]]
name = "server_tool_call_handler"
description = "Generate tools/call handler with schema validation (P0 FIX)"
query = "server_handlers"
filter = "method = 'tools/call'"
template = "erlang/server/handler_tool_call.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_tool_call.erl"
enabled = true
priority = "P0"  # Critical - adds missing validation

[[generation.rules]]
name = "server_resource_handlers"
description = "Generate all resource/* method handlers"
query = "server_handlers"
filter = "method LIKE 'resources/%'"
template = "erlang/server/handler_resources.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_resources.erl"
enabled = true

[[generation.rules]]
name = "server_prompt_handlers"
description = "Generate prompts/* method handlers"
query = "server_handlers"
filter = "method LIKE 'prompts/%'"
template = "erlang/server/handler_prompts.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_prompts.erl"
enabled = true

[[generation.rules]]
name = "server_task_handlers"
description = "Generate tasks/* method handlers (P0 - 30% of spec missing)"
query = "task_methods"
template = "erlang/server/handler_tasks.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_tasks.erl"
enabled = true
priority = "P0"  # Critical - implements 30% of missing spec

[[generation.rules]]
name = "server_logging_handler"
description = "Generate logging/setLevel handler"
query = "server_handlers"
filter = "method = 'logging/setLevel'"
template = "erlang/server/handler_logging.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_logging.erl"
enabled = true

[[generation.rules]]
name = "server_sampling_handler"
description = "Generate sampling/createMessage handler"
query = "server_handlers"
filter = "method = 'sampling/createMessage'"
template = "erlang/server/handler_sampling.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_handler_sampling.erl"
enabled = true

# =============================================================================
# CLIENT API METHODS
# =============================================================================

[[generation.rules]]
name = "client_api_core"
description = "Generate client API for core methods (initialize, ping)"
query = "client_methods"
filter = "category = 'core'"
template = "erlang/client/api_core.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_client_api.erl"
enabled = true

[[generation.rules]]
name = "client_api_resources"
description = "Generate client API for resource operations"
query = "client_methods"
filter = "category = 'resources'"
template = "erlang/client/api_resources.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_client_resources.erl"
enabled = true

[[generation.rules]]
name = "client_api_tools"
description = "Generate client API for tool operations"
query = "client_methods"
filter = "category = 'tools'"
template = "erlang/client/api_tools.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_client_tools.erl"
enabled = true

[[generation.rules]]
name = "client_api_tasks"
description = "Generate client API for task operations (P0)"
query = "client_methods"
filter = "category = 'tasks'"
template = "erlang/client/api_tasks.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_client_tasks.erl"
enabled = true
priority = "P0"

[[generation.rules]]
name = "client_timeout_management"
description = "Generate per-request timeout management (P0 FIX)"
query = "client_requests"
template = "erlang/client/timeout_manager.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_client_timeout.erl"
enabled = true
priority = "P0"  # Critical - fixes memory leak

# =============================================================================
# VALIDATORS
# =============================================================================

[[generation.rules]]
name = "validator_tool_arguments"
description = "Generate tool argument JSON Schema validator (P0 FIX)"
query = "validation_tools"
template = "erlang/validators/tool_validator.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_tool_validator.erl"
enabled = true
priority = "P0"  # Critical - missing validation

[[generation.rules]]
name = "validator_resource_uris"
description = "Generate resource URI validator with path traversal prevention"
query = "validation_resources"
template = "erlang/validators/resource_validator.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_resource_validator.erl"
enabled = true

[[generation.rules]]
name = "validator_prompt_arguments"
description = "Generate prompt argument validator (already implemented, regenerate for consistency)"
query = "validation_prompts"
template = "erlang/validators/prompt_validator.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_prompt_validator.erl"
enabled = true

[[generation.rules]]
name = "validator_schemas"
description = "Generate JSON Schema validation utilities"
query = "validation_schemas"
template = "erlang/validators/schema_validator.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_schema_validator.erl"
enabled = true

# =============================================================================
# TASK MANAGER STATE MACHINE
# =============================================================================

[[generation.rules]]
name = "task_manager"
description = "Generate task manager gen_server with state machine (P0)"
query = "task_lifecycle"
template = "erlang/task/task_manager.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_task_manager.erl"
enabled = true
priority = "P0"  # Critical - 30% of spec

[[generation.rules]]
name = "task_supervisor"
description = "Generate task supervisor for dynamic task workers"
query = "task_lifecycle"
template = "erlang/task/task_supervisor.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_task_sup.erl"
enabled = true
priority = "P0"

[[generation.rules]]
name = "task_worker"
description = "Generate task worker gen_server for async execution"
query = "task_lifecycle"
template = "erlang/task/task_worker.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_task_worker.erl"
enabled = true
priority = "P0"

[[generation.rules]]
name = "task_types"
description = "Generate task state types and records"
query = "task_lifecycle"
template = "erlang/task/task_types.hrl.tera"
output = "include/generated/erlmcp_task_types.hrl"
enabled = true

# =============================================================================
# ERROR DEFINITIONS
# =============================================================================

[[generation.rules]]
name = "error_codes"
description = "Generate all MCP error code definitions (100+ codes)"
query = "error_codes"
template = "erlang/errors/error_codes.hrl.tera"
output = "include/generated/erlmcp_error_codes.hrl"
enabled = true

[[generation.rules]]
name = "error_handlers"
description = "Generate error response builders"
query = "error_handlers"
template = "erlang/errors/error_handlers.erl.tera"
output = "apps/erlmcp_core/src/generated/erlmcp_error_handlers.erl"
enabled = true

# =============================================================================
# TRANSPORT BEHAVIORS
# =============================================================================

[[generation.rules]]
name = "transport_behavior"
description = "Generate transport behavior with all callbacks"
query = "transport_interface"
template = "erlang/transport/behavior.erl.tera"
output = "apps/erlmcp_transports/src/generated/erlmcp_transport_behavior.erl"
enabled = true

[[generation.rules]]
name = "transport_validation"
description = "Generate transport message validation"
query = "transport_validation"
template = "erlang/transport/validation.erl.tera"
output = "apps/erlmcp_transports/src/generated/erlmcp_transport_validator.erl"
enabled = true

# =============================================================================
# TYPE DEFINITIONS
# =============================================================================

[[generation.rules]]
name = "mcp_types"
description = "Generate all MCP type definitions and records"
query = "protocol_messages"
template = "erlang/types/mcp_types.hrl.tera"
output = "include/generated/erlmcp_types.hrl"
enabled = true

[[generation.rules]]
name = "mcp_records"
description = "Generate Erlang records from MCP ontology classes"
query = "protocol_messages"
template = "erlang/types/mcp_records.hrl.tera"
output = "include/generated/erlmcp_records.hrl"
enabled = true

# =============================================================================
# TESTS
# =============================================================================

[[generation.rules]]
name = "test_stubs"
description = "Generate EUnit test stubs for all handlers"
query = "server_handlers"
template = "erlang/tests/handler_tests.erl.tera"
output = "test/generated/erlmcp_handler_tests.erl"
enabled = true

[[generation.rules]]
name = "test_validators"
description = "Generate validator test suites"
query = "validation_schemas"
template = "erlang/tests/validator_tests.erl.tera"
output = "test/generated/erlmcp_validator_tests.erl"
enabled = true

[[generation.rules]]
name = "test_task_manager"
description = "Generate task manager test suite"
query = "task_lifecycle"
template = "erlang/tests/task_manager_tests.erl.tera"
output = "test/generated/erlmcp_task_manager_tests.erl"
enabled = true

# =============================================================================
# DOCUMENTATION
# =============================================================================

[[generation.rules]]
name = "docs_api_reference"
description = "Generate API reference documentation"
query = "protocol_messages"
template = "docs/api_reference.md.tera"
output = "docs/generated/mcp/API_REFERENCE.md"
enabled = true

[[generation.rules]]
name = "docs_compliance_matrix"
description = "Generate MCP compliance matrix"
query = "protocol_messages"
template = "docs/compliance_matrix.md.tera"
output = "docs/generated/mcp/COMPLIANCE_MATRIX.md"
enabled = true

# =============================================================================
# VALIDATION CONFIGURATION
# =============================================================================

[validation]
# Run SHACL validation before generation
shacl_validate = true

# Fail on validation errors
fail_on_error = true

# Generate validation report
report_path = "generated/mcp/validation_report.md"

# Validation strictness
strict_mode = true

# Validate against JSON schemas
validate_json_schemas = true

# Validate OTP patterns
validate_otp_compliance = true

# =============================================================================
# QUALITY GATES (TCPS Manufacturing Principles)
# =============================================================================

[quality]
# Enforce quality gates (Jidoka - built-in quality)
enforce_gates = true

# Stop-the-line on quality violations (Andon)
andon_on_failure = true

# Quality gate definitions
[quality.gates]
# Gate 1: Compilation
compilation_required = true
zero_errors = true
zero_warnings = false  # Warnings allowed

# Gate 2: Type checking
dialyzer_required = true
dialyzer_success_typing = true

# Gate 3: Cross-reference analysis
xref_required = true
xref_no_undefined_calls = true

# Gate 4: Test coverage
eunit_required = true
min_test_coverage = 0.80  # 80% minimum
min_pass_rate = 1.00      # 100% pass rate

# Gate 5: Code quality
max_cyclomatic_complexity = 10
max_function_length = 50
max_module_length = 1000

# Gate 6: Documentation
edoc_required = false  # Optional for generated code
min_doc_coverage = 0.60

[quality.andon]
# Andon signal thresholds (Toyota stop-the-line)
red_threshold = 1      # STOP: Critical errors
yellow_threshold = 3   # CAUTION: Warnings
green_threshold = 0    # GO: All clear

# =============================================================================
# ERLANG-SPECIFIC GENERATION SETTINGS
# =============================================================================

[erlang]
# OTP version compatibility
min_otp_version = "25"
max_otp_version = "27"

# Module naming convention
module_prefix = "erlmcp_"
generated_suffix = ""

# Include paths
include_paths = [
    "include/",
    "include/generated/",
    "apps/erlmcp_core/include/"
]

# Code formatting
format_generated = true
formatter = "rebar3_format"
line_length = 100

# Dialyzer types
generate_types = true
export_types = true
strict_typing = true

# Behavior compliance
validate_behaviors = true
required_callbacks = true

# Documentation
generate_edoc = true
edoc_format = "markdown"

# Supervision trees
[erlang.supervision]
default_strategy = "one_for_one"
default_intensity = 3
default_period = 5
default_shutdown = 5000

# gen_server defaults
[erlang.gen_server]
default_timeout = 5000
handle_info_all = true
format_status = true

# gen_statem defaults
[erlang.gen_statem]
callback_mode = "state_functions"
state_enter = true

# =============================================================================
# DETERMINISM SETTINGS (TCPS Compliance)
# =============================================================================

[determinism]
# Deterministic builds (same input â†’ identical output)
enabled = true

# Sort keys in generated JSON/maps
sort_keys = true

# Use UTC timestamps in ISO 8601 format
utc_timestamps = true

# Include checksums in generated files
include_checksums = true

# Checksum algorithm (sha256, sha512)
checksum_algorithm = "sha256"

# Reproducible file order
sort_output_files = true

# Deterministic random seed (for testing)
deterministic_seed = 12345

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

[logging]
# Log level: debug, info, warn, error
level = "info"

# Log format: text, json
format = "text"

# Log output path (stdout, stderr, or file path)
output = "stdout"

# Log file rotation (if file output)
rotate_size_mb = 10
rotate_count = 5

# Verbose SPARQL queries
log_queries = false

# Verbose template rendering
log_templates = false

# =============================================================================
# PERFORMANCE OPTIMIZATION
# =============================================================================

[performance]
# Parallel template rendering
parallel_rendering = true
max_workers = 4

# Cache SPARQL query results
cache_queries = true
cache_ttl_seconds = 3600

# Cache template compilation
cache_templates = true

# Incremental generation (only changed files)
incremental = true

# =============================================================================
# FEATURE FLAGS
# =============================================================================

[features]
# Enable AI-powered generation (requires ggen-ai)
ai_generation = false

# Enable PaaS infrastructure generation
paas_generation = false

# Enable experimental features
experimental = false

# Enable hot code reload generation
hot_reload = true

# Enable clustering support
clustering = false

# Enable distributed registry
distributed_registry = false

# =============================================================================
# DEVELOPMENT SETTINGS
# =============================================================================

[dev]
# Watch mode: auto-regenerate on file changes
watch = false

# Watch paths
watch_paths = [
    "ontology/**/*.ttl",
    "ggen_templates/**/*.tera",
    "sparql/**/*.rq"
]

# Debounce delay (ms)
watch_debounce_ms = 500

# Auto-format on generation
auto_format = true

# Auto-test on generation
auto_test = false

# =============================================================================
# HOOKS (Pre/Post Generation)
# =============================================================================

[hooks]
# Pre-generation hooks
pre_generate = [
    "rebar3 clean",
    "rm -rf apps/erlmcp_core/src/generated/*"
]

# Post-generation hooks
post_generate = [
    "rebar3 compile",
    "rebar3 dialyzer",
    "rebar3 xref",
    "rebar3 eunit --module=erlmcp_handler_tests"
]

# On error hooks
on_error = [
    "echo 'Generation failed - check validation_report.md'"
]

# =============================================================================
# METADATA & PROVENANCE
# =============================================================================

[metadata]
# Include generation metadata in files
include_metadata = true

# Metadata format
metadata_format = "edoc_comment"

# Include provenance information
include_provenance = true

# Provenance details
[metadata.provenance]
generator = "ggen"
generator_version = "6.0.0"
ontology_source = "ontology/mcp.ttl"
specification = "MCP 2025-11-25"
generated_at = "{{ timestamp }}"
git_commit = "{{ git_sha }}"
git_branch = "{{ git_branch }}"

# =============================================================================
# SECURITY
# =============================================================================

[security]
# Validate all inputs
validate_inputs = true

# Prevent path traversal in outputs
prevent_path_traversal = true

# Sanitize template variables
sanitize_variables = true

# Maximum file size (MB)
max_file_size_mb = 10

# =============================================================================
# INTEGRATION WITH BUILD SYSTEM
# =============================================================================

[integration]
# Build system: rebar3, mix, erlang.mk
build_system = "rebar3"

# Integration mode
[integration.rebar3]
# Add generated modules to rebar.config
update_config = false

# Include generated directories
src_dirs = ["apps/erlmcp_core/src/generated"]
include_dirs = ["include/generated"]

# Run as rebar3 plugin
plugin_mode = false

# =============================================================================
# EXAMPLES & TEMPLATES
# =============================================================================

# Example: Custom template variable
[custom]
project_name = "erlmcp"
organization = "seanchatmangpt"
year = 2026
