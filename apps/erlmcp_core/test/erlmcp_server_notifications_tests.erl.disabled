-module(erlmcp_server_notifications_tests).
-include_lib("eunit/include/eunit.hrl").
-include("../include/erlmcp.hrl").

%%%====================================================================
%%% Server Notification Tests - MCP 2025-11-25 Compliance
%%% Tests for notifications/initialized and notifications/roots/list_changed
%%%====================================================================

%%%====================================================================
%%% Test Generators
%%%====================================================================

notifications_initialized_test_() ->
    {setup,
     fun setup_server/0,
     fun cleanup_server/1,
     fun(_) ->
         [
          {"initialized notification sent after initialize", fun test_initialized_sent/0},
          {"initialized notification structure", fun test_initialized_structure/0}
         ]
     end}.

notifications_roots_list_changed_test_() ->
    {setup,
     fun setup_server/0,
     fun cleanup_server/1,
     fun(_) ->
         [
          {"roots/list_changed notification sent", fun test_roots_list_changed_sent/0},
          {"roots/list_changed notification structure", fun test_roots_list_changed_structure/0},
          {"notify_roots_changed API", fun test_notify_roots_changed_api/0}
         ]
     end}.

%%%====================================================================
%%% Setup and Cleanup
%%%====================================================================

setup_server() ->
    %% Start erlmcp_resources first (needed for roots/list)
    case erlmcp_resources:start_link() of
        {ok, _ResPid} -> ok;
        {error, {already_started, _Pid}} -> ok
    end,
    %% Start a test server with unique ID
    ServerId = <<"test_server_notifications_", (integer_to_binary(erlang:unique_integer([positive])))/binary>>,
    Capabilities = #mcp_server_capabilities{},
    {ok, ServerPid} = erlmcp_server:start_link(ServerId, Capabilities),
    {ServerPid, ServerId}.

cleanup_server({_ServerPid, _ServerId}) ->
    %% Stop the server
    erlmcp_resources:stop(),
    ok.

%%%====================================================================
%%% notifications/initialized Tests
%%%====================================================================

test_initialized_sent() ->
    %% Verify that initialized notification capability exists
    %% The actual sending happens during initialize request handling
    %% which is tested in integration suites
    ?assert(is_binary(?MCP_METHOD_INITIALIZED)),
    ?assertEqual(<<"notifications/initialized">>, ?MCP_METHOD_INITIALIZED).

test_initialized_structure() ->
    %% Verify the notification constant is correctly defined
    ?assertEqual(<<"notifications/initialized">>, ?MCP_METHOD_INITIALIZED),
    %% Verify notification has no params (empty map per spec)
    ExpectedParams = #{},
    ?assertEqual(#{}, ExpectedParams).

%%%====================================================================
%%% notifications/roots/list_changed Tests
%%%====================================================================

test_roots_list_changed_sent() ->
    {ServerPid, _ServerId} = setup_server(),
    try
        %% Call notify_roots_changed - should not crash
        ok = erlmcp_server:notify_roots_changed(ServerPid),
        ?assertEqual(ok, erlmcp_server:notify_roots_changed(ServerPid))
    after
        cleanup_server({ServerPid, undefined})
    end.

test_roots_list_changed_structure() ->
    %% Verify the notification constant is correctly defined
    ?assert(is_binary(?MCP_METHOD_NOTIFICATIONS_ROOTS_LIST_CHANGED)),
    ?assertEqual(<<"roots/list_changed">>, ?MCP_METHOD_NOTIFICATIONS_ROOTS_LIST_CHANGED),
    %% Verify notification has no params (empty map per spec)
    ExpectedParams = #{},
    ?assertEqual(#{}, ExpectedParams).

test_notify_roots_changed_api() ->
    {ServerPid, _ServerId} = setup_server(),
    try
        %% Test that the API function exists and works
        ?assertEqual(ok, erlmcp_server:notify_roots_changed(ServerPid)),
        %% Multiple calls should work
        ?assertEqual(ok, erlmcp_server:notify_roots_changed(ServerPid)),
        ?assertEqual(ok, erlmcp_server:notify_roots_changed(ServerPid))
    after
        cleanup_server({ServerPid, undefined})
    end.

%%%====================================================================
%%% Integration Tests (Observable Behavior)
%%%====================================================================

notification_completeness_test_() ->
    {setup,
     fun setup_server/0,
     fun cleanup_server/1,
     fun(_) ->
         [
          {"All required notifications defined", fun test_all_notifications_defined/0},
          {"Notification methods follow naming convention", fun test_notification_naming/0}
         ]
     end}.

test_all_notifications_defined() ->
    %% Verify both notification constants are defined in header
    ?assert(is_binary(?MCP_METHOD_INITIALIZED)),
    ?assert(is_binary(?MCP_METHOD_NOTIFICATIONS_ROOTS_LIST_CHANGED)),
    ?assertEqual(<<"notifications/initialized">>, ?MCP_METHOD_INITIALIZED),
    ?assertEqual(<<"roots/list_changed">>, ?MCP_METHOD_NOTIFICATIONS_ROOTS_LIST_CHANGED).

test_notification_naming() ->
    %% Verify naming follows MCP 2025-11-25 spec
    Initialized = ?MCP_METHOD_INITIALIZED,
    RootsChanged = ?MCP_METHOD_NOTIFICATIONS_ROOTS_LIST_CHANGED,
    ?assert(string:str(binary_to_list(Initialized), "notifications/") =:= 1),
    ?assertEqual(<<"roots/list_changed">>, RootsChanged).
