%%%-------------------------------------------------------------------
%%% @doc
%%% Protocol Validator Tests - Chicago School TDD
%%%
%%% "ACTUAL VALIDATION OR IT DOESN'T EXIST."
%%%
%%% Tests REAL invalid messages, verifies they're rejected.
%%% NO MOCKS. NO FAKE IMPLEMENTATIONS.
%%%
%%% @end
%%%-------------------------------------------------------------------
-module(erlmcp_protocol_validator_tests).

-include_lib("eunit/include/eunit.hrl").
-include("erlmcp.hrl").

%%%===================================================================
%%% Test Groups
%%%===================================================================

%% @doc Group: validate_jsonrpc tests
validate_jsonrpc_test_() ->
    [
        {"Valid request with id and method", fun test_valid_request/0},
        {"Valid response with id and result", fun test_valid_response/0},
        {"Valid notification with method and no id", fun test_valid_notification/0},
        {"Missing jsonrpc version field", fun test_missing_jsonrpc/0},
        {"Wrong jsonrpc version", fun test_wrong_jsonrpc_version/0},
        {"Invalid message type (not a map)", fun test_invalid_message_type/0},
        {"Request with missing method", fun test_request_missing_method/0},
        {"Request with invalid method type", fun test_request_invalid_method_type/0},
        {"Response with both result and error", fun test_response_both_result_and_error/0},
        {"Response with neither result nor error", fun test_response_no_result_or_error/0},
        {"Response with invalid error object", fun test_response_invalid_error_object/0},
        {"Notification with id (should be rejected)", fun test_notification_with_id/0},
        {"Notification with missing method", fun test_notification_missing_method/0}
    ].

%% @doc Group: validate_request tests
validate_request_test_() ->
    [
        {"Valid initialize request with undefined params", fun test_valid_initialize_request/0},
        {"Valid tools/call request with map params", fun test_valid_tools_call_request/0},
        {"Valid resources/list request with array params", fun test_valid_resources_list_array/0},
        {"Unknown method name", fun test_unknown_method/0},
        {"Invalid method type (not binary)", fun test_invalid_method_type/0},
        {"Valid method with invalid params type", fun test_invalid_params_type/0}
    ].

%% @doc Group: validate_response tests
validate_response_test_() ->
    [
        {"Valid response with string result", fun test_valid_response_string/0},
        {"Valid response with map result", fun test_valid_response_map/0},
        {"Valid response with error object", fun test_valid_response_error/0},
        {"Invalid response id (negative)", fun test_invalid_response_id_negative/0},
        {"Invalid response id type", fun test_invalid_response_id_type/0},
        {"Valid response with error object invalid code", fun test_response_invalid_error_code/0}
    ].

%% @doc Group: validate_notification tests
validate_notification_test_() ->
    [
        {"Valid notifications/initialized", fun test_valid_notification_initialized/0},
        {"Valid notifications/progress", fun test_valid_notification_progress/0},
        {"Unknown notification name", fun test_unknown_notification/0},
        {"Invalid notification type (not binary)", fun test_invalid_notification_type/0}
    ].

%% @doc Group: validate_error_code tests
validate_error_code_test_() ->
    [
        {"Valid JSON-RPC parse error (-32700)", fun test_valid_jsonrpc_parse_error/0},
        {"Valid JSON-RPC method not found (-32601)", fun test_valid_jsonrpc_method_not_found/0},
        {"Valid MCP resource not found (-32001)", fun test_valid_mcp_resource_not_found/0},
        {"Valid MCP tool not found (-32002)", fun test_valid_mcp_tool_not_found/0},
        {"Valid experimental elicitation failed (1090)", fun test_valid_experimental_code/0},
        {"Invalid error code (outside range)", fun test_invalid_error_code/0},
        {"Invalid error code type (not integer)", fun test_invalid_error_code_type/0}
    ].

%% @doc Group: validate_method_name tests
validate_method_name_test_() ->
    [
        {"Valid: initialize", fun test_valid_method_initialize/0},
        {"Valid: resources/list", fun test_valid_method_resources_list/0},
        {"Valid: tools/call", fun test_valid_method_tools_call/0},
        {"Valid: tasks/create (new in 2025-11-25)", fun test_valid_method_tasks_create/0},
        {"Valid: completion/complete (new in 2025-11-25)", fun test_valid_method_completion/0},
        {"Invalid: unknown/method", fun test_invalid_method_name/0},
        {"Invalid: empty string", fun test_invalid_method_empty/0}
    ].

%% @doc Group: validate_notification_name tests
validate_notification_name_test_() ->
    [
        {"Valid: notifications/initialized", fun test_valid_notification_initialized/0},
        {"Valid: notifications/progress", fun test_valid_notification_progress/0},
        {"Valid: notifications/cancelled", fun test_valid_notification_cancelled/0},
        {"Invalid: unknown/notification", fun test_invalid_notification_name/0}
    ].

%% @doc Group: validate_field_type tests
validate_field_type_test_() ->
    [
        {"Valid: binary field with binary value", fun test_valid_field_binary/0},
        {"Valid: integer field with integer value", fun test_valid_field_integer/0},
        {"Valid: map field with map value", fun test_valid_field_map/0},
        {"Valid: array field with list value", fun test_valid_field_array/0},
        {"Valid: any field with any value", fun test_valid_field_any/0},
        {"Valid: union type [binary, integer]", fun test_valid_field_union/0},
        {"Invalid: binary field with integer value", fun test_invalid_field_type_mismatch/0},
        {"Invalid: map field with list value", fun test_invalid_field_type_map_list/0}
    ].

%% @doc Group: validate_required_fields tests
validate_required_fields_test_() ->
    [
        {"All required fields present", fun test_all_required_fields_present/0},
        {"Missing one required field", fun test_missing_one_required_field/0},
        {"Missing multiple required fields", fun test_missing_multiple_required_fields/0},
        {"Empty required fields list", fun test_empty_required_fields/0}
    ].

%% @doc Group: format_validation_error tests
format_validation_error_test_() ->
    [
        {"Format error: unknown_method", fun test_format_unknown_method/0},
        {"Format error: type_mismatch", fun test_format_type_mismatch/0},
        {"Format error: missing_required_fields", fun test_format_missing_fields/0}
    ].

%%%===================================================================
%%% Test Functions - validate_jsonrpc
%%%===================================================================

test_valid_request() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1,
        <<"method">> => <<"initialize">>,
        <<"params">> => #{protocolVersion => <<"2025-11-25">>}
    },
    ?assertEqual(ok, erlmcp_protocol_validator:validate_jsonrpc(Message)).

test_valid_response() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1,
        <<"result">> => #{protocolVersion => <<"2025-11-25">>}
    },
    ?assertEqual(ok, erlmcp_protocol_validator:validate_jsonrpc(Message)).

test_valid_notification() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"method">> => <<"notifications/initialized">>
    },
    ?assertEqual(ok, erlmcp_protocol_validator:validate_jsonrpc(Message)).

test_missing_jsonrpc() ->
    Message = #{
        <<"id">> => 1,
        <<"method">> => <<"initialize">>
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := invalid_jsonrpc_version}}, Result).

test_wrong_jsonrpc_version() ->
    Message = #{
        <<"jsonrpc">> => <<"1.0">>,
        <<"id">> => 1,
        <<"method">> => <<"initialize">>
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := invalid_jsonrpc_version}}, Result).

test_invalid_message_type() ->
    Message = <<"not a map">>,
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := not_map}}, Result).

test_request_missing_method() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1
    },
    %% This is treated as an invalid response (no method = response, but missing result/error)
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := missing_result_and_error}}, Result).

test_request_invalid_method_type() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1,
        <<"method">> => 12345
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := invalid_method_type}}, Result).

test_response_both_result_and_error() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1,
        <<"result">> => #{},
        <<"error">> => #{code => -32700, message => <<"Parse error">>}
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := both_result_and_error}}, Result).

test_response_no_result_or_error() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := missing_result_and_error}}, Result).

test_response_invalid_error_object() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1,
        <<"error">> => #{message => <<"Error">>}  %% Missing code
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := missing_error_code}}, Result).

test_notification_with_id() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>,
        <<"id">> => 1,
        <<"method">> => <<"notifications/initialized">>
    },
    %% This is actually valid - it's a request, not a notification
    ?assertEqual(ok, erlmcp_protocol_validator:validate_jsonrpc(Message)).

test_notification_missing_method() ->
    Message = #{
        <<"jsonrpc">> => <<"2.0">>
    },
    Result = erlmcp_protocol_validator:validate_jsonrpc(Message),
    ?assertMatch({error, #{reason := missing_method}}, Result).

%%%===================================================================
%%% Test Functions - validate_request
%%%===================================================================

test_valid_initialize_request() ->
    Method = <<"initialize">>,
    Params = undefined,
    ?assertEqual(ok, erlmcp_protocol_validator:validate_request(Method, Params)).

test_valid_tools_call_request() ->
    Method = <<"tools/call">>,
    Params = #{name => <<"test_tool">>, arguments => #{}},
    ?assertEqual(ok, erlmcp_protocol_validator:validate_request(Method, Params)).

test_valid_resources_list_array() ->
    Method = <<"resources/list">>,
    Params = [],
    ?assertEqual(ok, erlmcp_protocol_validator:validate_request(Method, Params)).

test_unknown_method() ->
    Method = <<"unknown/method">>,
    Params = #{},
    Result = erlmcp_protocol_validator:validate_request(Method, Params),
    ?assertMatch({error, #{reason := unknown_method}}, Result).

test_invalid_method_type() ->
    Method = 12345,
    Params = #{},
    Result = erlmcp_protocol_validator:validate_request(Method, Params),
    ?assertMatch({error, #{reason := invalid_method_type}}, Result).

test_invalid_params_type() ->
    Method = <<"initialize">>,
    Params = <<"invalid">>,
    Result = erlmcp_protocol_validator:validate_request(Method, Params),
    ?assertMatch({error, #{reason := invalid_params_type}}, Result).

%%%===================================================================
%%% Test Functions - validate_response
%%%===================================================================

test_valid_response_string() ->
    Id = 1,
    Result = <<"success">>,
    ?assertEqual(ok, erlmcp_protocol_validator:validate_response(Id, Result)).

test_valid_response_map() ->
    Id = <<"request-1">>,
    Result = #{status => ok},
    ?assertEqual(ok, erlmcp_protocol_validator:validate_response(Id, Result)).

test_valid_response_error() ->
    Id = null,
    Error = #{code => -32601, message => <<"Method not found">>},
    ?assertEqual(ok, erlmcp_protocol_validator:validate_response(Id, Error)).

test_invalid_response_id_negative() ->
    Id = -1,
    Result = #{},
    Result2 = erlmcp_protocol_validator:validate_response(Id, Result),
    ?assertMatch({error, #{reason := negative_id}}, Result2).

test_invalid_response_id_type() ->
    Id = #{},
    Result = #{},
    Result2 = erlmcp_protocol_validator:validate_response(Id, Result),
    ?assertMatch({error, #{reason := invalid_id_type}}, Result2).

test_response_invalid_error_code() ->
    Id = 1,
    Error = #{code => -99999, message => <<"Invalid">>},
    Result = erlmcp_protocol_validator:validate_response(Id, Error),
    ?assertMatch({error, #{reason := invalid_error_code}}, Result).

%%%===================================================================
%%% Test Functions - validate_notification
%%%===================================================================

test_valid_notification_initialized() ->
    Notification = <<"notifications/initialized">>,
    Params = #{},
    ?assertEqual(ok, erlmcp_protocol_validator:validate_notification(Notification, Params)).

test_valid_notification_progress() ->
    Notification = <<"notifications/progress">>,
    Params = #{progressToken => 1, progress => 0.5},
    ?assertEqual(ok, erlmcp_protocol_validator:validate_notification(Notification, Params)).

test_valid_notification_cancelled() ->
    Notification = <<"notifications/cancelled">>,
    Params = #{requestId => 1, reason => <<"User cancelled">>},
    ?assertEqual(ok, erlmcp_protocol_validator:validate_notification(Notification, Params)).

test_unknown_notification() ->
    Notification = <<"notifications/unknown">>,
    Params = #{},
    Result = erlmcp_protocol_validator:validate_notification(Notification, Params),
    ?assertMatch({error, #{reason := unknown_notification}}, Result).

test_invalid_notification_type() ->
    Notification = 12345,
    Params = #{},
    Result = erlmcp_protocol_validator:validate_notification(Notification, Params),
    ?assertMatch({error, #{reason := invalid_notification_type}}, Result).

%%%===================================================================
%%% Test Functions - validate_error_code
%%%===================================================================

test_valid_jsonrpc_parse_error() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_error_code(-32700)).

test_valid_jsonrpc_method_not_found() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_error_code(-32601)).

test_valid_mcp_resource_not_found() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_error_code(-32001)).

test_valid_mcp_tool_not_found() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_error_code(-32002)).

test_valid_experimental_code() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_error_code(1090)).

test_invalid_error_code() ->
    Result = erlmcp_protocol_validator:validate_error_code(-99999),
    ?assertMatch({error, #{reason := invalid_error_code}}, Result).

test_invalid_error_code_type() ->
    Result = erlmcp_protocol_validator:validate_error_code(<<"not an integer">>),
    ?assertMatch({error, #{reason := invalid_error_code_type}}, Result).

%%%===================================================================
%%% Test Functions - validate_method_name
%%%===================================================================

test_valid_method_initialize() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_method_name(<<"initialize">>)).

test_valid_method_resources_list() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_method_name(<<"resources/list">>)).

test_valid_method_tools_call() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_method_name(<<"tools/call">>)).

test_valid_method_tasks_create() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_method_name(<<"tasks/create">>)).

test_valid_method_completion() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_method_name(<<"completion/complete">>)).

test_invalid_method_name() ->
    Result = erlmcp_protocol_validator:validate_method_name(<<"unknown/method">>),
    ?assertMatch({error, #{reason := unknown_method}}, Result).

test_invalid_method_empty() ->
    Result = erlmcp_protocol_validator:validate_method_name(<<"">>),
    ?assertMatch({error, #{reason := unknown_method}}, Result).

%%%===================================================================
%%% Test Functions - validate_notification_name
%%%===================================================================

test_valid_notification_name_initialized() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_notification_name(<<"notifications/initialized">>)).

test_valid_notification_name_progress() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_notification_name(<<"notifications/progress">>)).

test_valid_notification_name_cancelled() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_notification_name(<<"notifications/cancelled">>)).

test_invalid_notification_name() ->
    Result = erlmcp_protocol_validator:validate_notification_name(<<"notifications/unknown">>),
    ?assertMatch({error, #{reason := unknown_notification}}, Result).

%%%===================================================================
%%% Test Functions - validate_field_type
%%%===================================================================

test_valid_field_binary() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"test">>, <<"value">>, binary)).

test_valid_field_integer() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"count">>, 42, integer)).

test_valid_field_map() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"data">>, #{}, map)).

test_valid_field_array() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"items">>, [], array)).

test_valid_field_any() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"any">>, whatever, any)).

test_valid_field_union() ->
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"union">>, <<"text">>, [binary, integer])),
    ?assertEqual(ok, erlmcp_protocol_validator:validate_field_type(<<"union">>, 123, [binary, integer])).

test_invalid_field_type_mismatch() ->
    Result = erlmcp_protocol_validator:validate_field_type(<<"text">>, 123, binary),
    ?assertMatch({error, #{reason := type_mismatch}}, Result).

test_invalid_field_type_map_list() ->
    Result = erlmcp_protocol_validator:validate_field_type(<<"data">>, [], map),
    ?assertMatch({error, #{reason := type_mismatch}}, Result).

%%%===================================================================
%%% Test Functions - validate_required_fields
%%%===================================================================

test_all_required_fields_present() ->
    Message = #{<<"a">> => 1, <<"b">> => 2},
    Required = [<<"a">>, <<"b">>],
    ?assertEqual(ok, erlmcp_protocol_validator:validate_required_fields(Message, Required)).

test_missing_one_required_field() ->
    Message = #{<<"a">> => 1},
    Required = [<<"a">>, <<"b">>],
    Result = erlmcp_protocol_validator:validate_required_fields(Message, Required),
    ?assertMatch({error, #{reason := missing_required_fields}}, Result).

test_missing_multiple_required_fields() ->
    Message = #{},
    Required = [<<"a">>, <<"b">>, <<"c">>],
    Result = erlmcp_protocol_validator:validate_required_fields(Message, Required),
    ?assertMatch({error, #{reason := missing_required_fields}}, Result).

test_empty_required_fields() ->
    Message = #{},
    Required = [],
    ?assertEqual(ok, erlmcp_protocol_validator:validate_required_fields(Message, Required)).

%%%===================================================================
%%% Test Functions - format_validation_error
%%%===================================================================

test_format_unknown_method() ->
    Error = #{reason => unknown_method, details => #{method => <<"unknown">>}},
    Formatted = erlmcp_protocol_validator:format_validation_error(Error),
    ?assert(is_binary(Formatted)),
    ?assertNotEqual(<<>>, Formatted).

test_format_type_mismatch() ->
    Error = #{reason => type_mismatch, details => #{field => <<"test">>, expected => binary, actual => integer}},
    Formatted = erlmcp_protocol_validator:format_validation_error(Error),
    ?assert(is_binary(Formatted)),
    ?assertNotEqual(<<>>, Formatted).

test_format_missing_fields() ->
    Error = #{reason => missing_required_fields, details => #{missing => [<<"a">>, <<"b">>]}},
    Formatted = erlmcp_protocol_validator:format_validation_error(Error),
    ?assert(is_binary(Formatted)),
    ?assertNotEqual(<<>>, Formatted).
