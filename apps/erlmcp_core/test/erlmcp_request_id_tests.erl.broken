%%%-------------------------------------------------------------------
%%% @doc
%%% EUnit tests for erlmcp_request_id module.
%%%
%%% This test suite verifies request ID management with overflow protection.
%%% Tests follow Chicago School TDD principles:
%%% - Real functions (no mocks needed for pure functions)
%%% - State-based verification (assert on return values)
%%% - Comprehensive boundary and error path testing
%%% - Property-based tests for invariants
%%%
%%% @end
%%%-------------------------------------------------------------------
-module(erlmcp_request_id_tests).
-include_lib("eunit/include/eunit.hrl").

%%%====================================================================
%%% Constants
%%%====================================================================

-define(MAX_SAFE_REQUEST_ID, 1152921504606846975). % 2^60 - 1
-define(MIN_REQUEST_ID, 1).

%%%====================================================================
%%% Basic Functionality Tests
%%%====================================================================

%% @doc Test normal increment from 1 to 2
safe_increment_normal_test() ->
    ?assertEqual({ok, 2}, erlmcp_request_id:safe_increment(1)).

%% @doc Test increment from a larger number
safe_increment_large_test() ->
    ?assertEqual({ok, 1000000}, erlmcp_request_id:safe_increment(999999)).

%% @doc Test increment from mid-range value
safe_increment_mid_range_test() ->
    MidValue = 500000000000000000,
    ?assertEqual({ok, MidValue + 1}, erlmcp_request_id:safe_increment(MidValue)).

%% @doc Test multiple sequential increments
safe_increment_sequential_test() ->
    ?assertEqual({ok, 2}, erlmcp_request_id:safe_increment(1)),
    ?assertEqual({ok, 3}, erlmcp_request_id:safe_increment(2)),
    ?assertEqual({ok, 4}, erlmcp_request_id:safe_increment(3)),
    ?assertEqual({ok, 5}, erlmcp_request_id:safe_increment(4)).

%%%====================================================================
%%% Boundary Tests
%%%====================================================================

%% @doc Test increment at maximum safe request ID (should overflow)
safe_increment_at_max_test() ->
    MaxId = ?MAX_SAFE_REQUEST_ID,
    ?assertEqual({error, overflow}, erlmcp_request_id:safe_increment(MaxId)).

%% @doc Test increment just below maximum (should succeed)
safe_increment_below_max_test() ->
    MaxId = ?MAX_SAFE_REQUEST_ID,
    ?assertEqual({ok, MaxId}, erlmcp_request_id:safe_increment(MaxId - 1)).

%% @doc Test increment far below maximum
safe_increment_far_below_max_test() ->
    MaxId = ?MAX_SAFE_REQUEST_ID,
    ?assertEqual({ok, MaxId - 99}, erlmcp_request_id:safe_increment(MaxId - 100)).

%% @doc Test validate minimum valid request ID
validate_id_min_test() ->
    ?assertEqual(ok, erlmcp_request_id:validate_id(?MIN_REQUEST_ID)).

%% @doc Test validate maximum valid request ID
validate_id_max_test() ->
    ?assertEqual(ok, erlmcp_request_id:validate_id(?MAX_SAFE_REQUEST_ID)).

%% @doc Test validate mid-range request ID
validate_id_mid_range_test() ->
    MidValue = 500000000000000000,
    ?assertEqual(ok, erlmcp_request_id:validate_id(MidValue)).

%%%====================================================================
%%% Error Path Tests - Invalid Input Types
%%%====================================================================

%% @doc Test safe_increment with atom input
safe_increment_atom_test() ->
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment(atom)),
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment(<<"binary">>)),
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment([list])),
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment({tuple, 1})),
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment(1.5)).

%% @doc Test safe_increment with zero (below minimum)
safe_increment_zero_test() ->
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment(0)).

%% @doc Test safe_increment with negative number
safe_increment_negative_test() ->
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment(-1)),
    ?assertEqual({error, invalid_id}, erlmcp_request_id:safe_increment(-100)).

%% @doc Test validate_id with zero
validate_id_zero_test() ->
    ?assertEqual({error, {invalid_id, 0}}, erlmcp_request_id:validate_id(0)).

%% @doc Test validate_id with negative numbers
validate_id_negative_test() ->
    ?assertEqual({error, {invalid_id, -1}}, erlmcp_request_id:validate_id(-1)),
    ?assertEqual({error, {invalid_id, -100}}, erlmcp_request_id:validate_id(-100)).

%% @doc Test validate_id with number exceeding maximum
validate_id_exceeds_max_test() ->
    ?assertEqual({error, {exceeds_maximum, ?MAX_SAFE_REQUEST_ID + 1}},
                 erlmcp_request_id:validate_id(?MAX_SAFE_REQUEST_ID + 1)),
    ?assertEqual({error, {exceeds_maximum, ?MAX_SAFE_REQUEST_ID + 1000}},
                 erlmcp_request_id:validate_id(?MAX_SAFE_REQUEST_ID + 1000)).

%% @doc Test validate_id with non-integer types
validate_id_not_integer_test() ->
    ?assertEqual({error, {not_integer, atom}}, erlmcp_request_id:validate_id(atom)),
    ?assertEqual({error, {not_integer, <<"binary">>}}, erlmcp_request_id:validate_id(<<"binary">>)),
    ?assertEqual({error, {not_integer, [1,2,3]}}, erlmcp_request_id:validate_id([1,2,3])),
    ?assertEqual({error, {not_integer, {1,2}}}, erlmcp_request_id:validate_id({1,2})),
    ?assertEqual({error, {not_integer, 1.5}}, erlmcp_request_id:validate_id(1.5)).

%% @doc Test validate_id with undefined and null
validate_id_special_values_test() ->
    ?assertEqual({error, {not_integer, undefined}}, erlmcp_request_id:validate_id(undefined)),
    ?assertEqual({error, {not_integer, null}}, erlmcp_request_id:validate_id(null)).

%%%====================================================================
%%% Property-Based Tests (Proper)
%%%====================================================================
%%% Note: These are Proper properties, run with: rebar3 proper -c

%% @doc Property: safe_increment always increases or returns overflow
%% @private
prop_safe_increment_increases() ->
    proper:forall(proper_types:range(1, ?MAX_SAFE_REQUEST_ID),
        fun(Id) ->
            case erlmcp_request_id:safe_increment(Id) of
                {ok, NextId} when NextId > Id -> true;
                {error, overflow} when Id == ?MAX_SAFE_REQUEST_ID -> true;
                _ -> false
            end
        end).

%% @doc Property: validate_id accepts all valid request IDs
%% @private
prop_validate_id_accepts_valid() ->
    proper:forall(proper_types:range(1, ?MAX_SAFE_REQUEST_ID),
        fun(Id) ->
            erlmcp_request_id:validate_id(Id) =:= ok
        end).

%% @doc Property: safe_increment and validate_id are consistent
%% @private
prop_increment_validate_consistency() ->
    proper:forall(proper_types:range(1, ?MAX_SAFE_REQUEST_ID - 1),
        fun(Id) ->
            {ok, NextId} = erlmcp_request_id:safe_increment(Id),
            ok =:= erlmcp_request_id:validate_id(NextId)
        end).

%%%====================================================================
%%% Monitoring and Threshold Tests
%%%====================================================================

%% @doc Test get_usage_percentage at minimum ID
get_usage_percentage_min_test() ->
    Usage = erlmcp_request_id:get_usage_percentage(1),
    ?assert(Usage > 0.0),
    ?assert(Usage < 0.000001).

%% @doc Test get_usage_percentage at 50%
get_usage_percentage_half_test() ->
    HalfId = ?MAX_SAFE_REQUEST_ID div 2,
    Usage = erlmcp_request_id:get_usage_percentage(HalfId),
    ?assert(Usage > 49.0),
    ?assert(Usage < 51.0).

%% @doc Test get_usage_percentage at maximum
get_usage_percentage_max_test() ->
    Usage = erlmcp_request_id:get_usage_percentage(?MAX_SAFE_REQUEST_ID),
    ?assertEqual(100.0, Usage).

%% @doc Test check_thresholds at normal level
check_thresholds_normal_test() ->
    {ok, normal, Usage} = erlmcp_request_id:check_thresholds(1),
    ?assert(Usage < 80.0).

%% @doc Test check_thresholds at warning level
check_thresholds_warning_test() ->
    {ok, warning, Usage} = erlmcp_request_id:check_thresholds(?ID_WARNING_THRESHOLD),
    ?assert(Usage >= 80.0),
    ?assert(Usage < 90.0).

%% @doc Test check_thresholds at critical level
check_thresholds_critical_test() ->
    {ok, critical, Usage} = erlmcp_request_id:check_thresholds(?ID_CRITICAL_THRESHOLD),
    ?assert(Usage >= 90.0),
    ?assert(Usage < 96.0).

%% @doc Test check_thresholds at reserved level
check_thresholds_reserved_test() ->
    {ok, reserved, Usage} = erlmcp_request_id:check_thresholds(?ID_RESERVED_THRESHOLD),
    ?assert(Usage >= 96.0),
    ?assert(Usage < 100.0).

%% @doc Test check_thresholds at exhausted level
check_thresholds_exhausted_test() ->
    {ok, exhausted, Usage} = erlmcp_request_id:check_thresholds(?MAX_SAFE_REQUEST_ID),
    ?assertEqual(100.0, Usage).

%% @doc Test check_thresholds with invalid ID
check_thresholds_invalid_test() ->
    {ok, normal, 0.0} = erlmcp_request_id:check_thresholds(0),
    {ok, normal, 0.0} = erlmcp_request_id:check_thresholds(-1),
    {ok, normal, 0.0} = erlmcp_request_id:check_thresholds(1.5).

%%%====================================================================
%%% Integration Tests
%%%====================================================================

%% @doc Test realistic workflow: increment and validate sequence
realistic_workflow_test() ->
    % Start with ID 1
    {ok, Id2} = erlmcp_request_id:safe_increment(1),
    ?assertEqual(2, Id2),
    ?assertEqual(ok, erlmcp_request_id:validate_id(Id2)),

    % Increment to 100
    {ok, Id100} = lists:foldl(
        fun(_, {ok, AccId}) ->
            erlmcp_request_id:safe_increment(AccId)
        end,
        {ok, 2},
        lists:seq(1, 98)
    ),
    ?assertEqual(100, Id100),
    ?assertEqual(ok, erlmcp_request_id:validate_id(Id100)),

    % Try to go beyond maximum
    MaxId = ?MAX_SAFE_REQUEST_ID,
    {ok, MaxId} = erlmcp_request_id:safe_increment(MaxId - 1),
    ?assertEqual({error, overflow}, erlmcp_request_id:safe_increment(MaxId)).

%% @doc Test boundary values with increment
boundary_increment_test() ->
    % Test near minimum
    ?assertEqual({ok, 2}, erlmcp_request_id:safe_increment(1)),
    ?assertEqual({ok, 3}, erlmcp_request_id:safe_increment(2)),
    ?assertEqual({ok, 4}, erlmcp_request_id:safe_increment(3)),

    % Test near maximum
    MaxId = ?MAX_SAFE_REQUEST_ID,
    ?assertEqual({ok, MaxId - 2}, erlmcp_request_id:safe_increment(MaxId - 3)),
    ?assertEqual({ok, MaxId - 1}, erlmcp_request_id:safe_increment(MaxId - 2)),
    ?assertEqual({ok, MaxId}, erlmcp_request_id:safe_increment(MaxId - 1)),
    ?assertEqual({error, overflow}, erlmcp_request_id:safe_increment(MaxId)).
