%%%-------------------------------------------------------------------
%%% @doc erlmcp_sampling_tests - Test suite for sampling capability
%%% Chicago School TDD - Real process testing, no mocks
%%% @end
%%%-------------------------------------------------------------------
-module(erlmcp_sampling_tests).

-include_lib("eunit/include/eunit.hrl").
-include("erlmcp.hrl").

%%====================================================================
%% Test Fixtures
%%====================================================================

sampling_test_() ->
    {setup,
     fun setup_sampling/0,
     fun cleanup_sampling/1,
     [
         {"Create message with valid input", fun test_create_message_valid/0},
         {"Create message with system prompt", fun test_create_message_with_system/0},
         {"Create message with conversation history", fun test_create_message_history/0},
         {"Validate model preferences", fun test_model_preferences/0},
         {"Validate stop sequences", fun test_stop_sequences/0},
         {"Handle empty messages", fun test_empty_messages/0},
         {"Handle invalid message format", fun test_invalid_message_format/0},
         {"Handle invalid temperature", fun test_invalid_temperature/0},
         {"Mock provider echo mode", fun test_mock_echo_mode/0},
         {"Mock provider template mode", fun test_mock_template_mode/0}
     ]
    }.

setup_sampling() ->
    %% Start the sampling server
    {ok, Pid} = erlmcp_sampling:start_link(),
    %% Set to echo mode for testing
    erlmcp_mock_llm:set_response_mode(echo),
    Pid.

cleanup_sampling(_Pid) ->
    %% Stop the sampling server
    gen_server:stop(erlmcp_sampling),
    ok.

%%====================================================================
%% Test Cases
%%====================================================================

%% @doc Test creating a message with valid input
test_create_message_valid() ->
    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Hello, MCP!">>}
    ],
    Params = #{
        <<"temperature">> => 0.7,
        <<"maxTokens">> => 100
    },

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result),
    {ok, Response} = Result,
    ?assertMatch(#{<<"role">> := <<"assistant">>}, Response),
    ?assertMatch(#{<<"content">> := _}, Response),
    ?assertMatch(#{<<"model">> := _}, Response),
    ?assertMatch(#{<<"usage">> := _}, Response).

%% @doc Test creating a message with system prompt
test_create_message_with_system() ->
    Messages = [
        #{<<"role">> => <<"system">>, <<"content">> => <<"You are a helpful assistant.">>},
        #{<<"role">> => <<"user">>, <<"content">> => <<"Hi!">>}
    ],
    Params = #{},

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result),
    {ok, Response} = Result,
    ?assertMatch(#{<<"role">> := <<"assistant">>}, Response).

%% @doc Test creating a message with conversation history
test_create_message_history() ->
    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"First message">>},
        #{<<"role">> => <<"assistant">>, <<"content">> => <<"First response">>},
        #{<<"role">> => <<"user">>, <<"content">> => <<"Second message">>}
    ],
    Params = #{<<"temperature">> => 0.5},

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result),
    {ok, Response} = Result,
    ?assert(maps:is_key(<<"role">>, Response)),
    ?assert(maps:is_key(<<"content">>, Response)).

%% @doc Test model preferences parameter
test_model_preferences() ->
    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Test">>}
    ],
    Params = #{
        <<"modelPreferences">> => #{
            <<"costPriority">> => 0.5,
            <<"speedPriority">> => 0.7,
            <<"intelligencePriority">> => 0.3
        },
        <<"temperature">> => 0.8
    },

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result).

%% @doc Test stop sequences parameter
test_stop_sequences() ->
    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Continue until STOP">>}
    ],
    Params = #{
        <<"stopSequences">> => [<<"STOP">>, <<"END">>]
    },

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result).

%% @doc Test handling of empty message list
test_empty_messages() ->
    Messages = [],
    Params = #{},

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({error, empty_messages}, Result).

%% @doc Test handling of invalid message format
test_invalid_message_format() ->
    %% Missing role field
    Messages = [
        #{<<"content">> => <<"No role field">>}
    ],
    Params = #{},

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({error, invalid_message_format}, Result).

%% @doc Test handling of invalid temperature
test_invalid_temperature() ->
    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Test">>}
    ],
    Params = #{
        <<"temperature">> => 3.0  % Temperature must be between 0.0 and 2.0
    },

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({error, invalid_temperature}, Result).

%% @doc Test mock provider echo mode
test_mock_echo_mode() ->
    erlmcp_mock_llm:set_response_mode(echo),

    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Echo this">>}
    ],
    Params = #{},

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result),
    {ok, Response} = Result,
    #{<<"content">> := Content} = Response,
    ?assert(<<"Echo:">> =:= Content).

%% @doc Test mock provider template mode
test_mock_template_mode() ->
    erlmcp_mock_llm:set_response_mode(template),

    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Template test">>}
    ],
    Params = #{},

    Result = erlmcp_sampling:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result),
    {ok, Response} = Result,
    ?assertMatch(#{<<"role">> := <<"assistant">>}, Response).

%%====================================================================
%% Unit Tests (Without Fixtures)
%%====================================================================

%% @doc Test message validation
validate_messages_test_() ->
    [
     ?_assertEqual(ok, erlmcp_sampling:validate_messages([
        #{<<"role">> => <<"user">>, <<"content">> => <<"Test">>}
     ])),
     ?_assertEqual({error, empty_messages},
                  erlmcp_sampling:validate_messages([])),
     ?_assertEqual({error, invalid_message_format},
                  erlmcp_sampling:validate_messages([#{<<"content">> => <<"No role">>}])),
     ?_assertEqual({error, messages_must_be_list},
                  erlmcp_sampling:validate_messages(<<"not a list">>))
    ].

%% @doc Test parameter validation
validate_params_test_() ->
    [
     ?_assertEqual(ok, erlmcp_sampling:validate_params(#{
        <<"temperature">> => 0.7,
        <<"maxTokens">> => 100
     })),
     ?_assertEqual(ok, erlmcp_sampling:validate_params(#{})),
     ?_assertEqual({error, invalid_temperature},
                  erlmcp_sampling:validate_params(#{<<"temperature">> => 3.0})),
     ?_assertEqual({error, params_must_be_map},
                  erlmcp_sampling:validate_params(<<"not a map">>))
    ].

%% @doc Test mock LLM provider directly
mock_llm_echo_test() ->
    erlmcp_mock_llm:set_response_mode(echo),

    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Test message">>}
    ],
    Params = #{<<"temperature">> => 0.5},

    Result = erlmcp_mock_llm:create_message(Messages, Params),

    ?assertMatch({ok, _}, Result),
    {ok, Response} = Result,
    ?assertMatch(#{<<"role">> := <<"assistant">>}, Response),
    ?assertMatch(#{<<"content">> := <<"Echo: ", _/binary>>}, Response).

%% @doc Test mock LLM error mode
mock_llm_error_test() ->
    erlmcp_mock_llm:set_response_mode(error),

    Messages = [
        #{<<"role">> => <<"user">>, <<"content">> => <<"Test">>}
    ],
    Params = #{},

    Result = erlmcp_mock_llm:create_message(Messages, Params),

    ?assertMatch({error, mock_provider_error}, Result).

%% @doc Test token estimation
estimate_tokens_test() ->
    %% Test binary estimation
    Tokens1 = erlmcp_mock_llm:estimate_tokens(<<"Hello world">>),
    ?assert(Tokens1 > 0),

    %% Test message list estimation
    Messages = [
        #{<<"content">> => <<"First message">>},
        #{<<"content">> => <<"Second message">>}
    ],
    Tokens2 = erlmcp_mock_llm:estimate_tokens(Messages),
    ?assert(Tokens2 > Tokens1),

    ok.

%%====================================================================
%% Integration Tests
%%====================================================================

%% @doc Test full sampling workflow
sampling_workflow_test_() ->
    {setup,
     fun() ->
         {ok, Pid} = erlmcp_sampling:start_link(),
         erlmcp_mock_llm:set_response_mode(template),
         Pid
     end,
     fun(Pid) ->
         gen_server:stop(Pid)
     end,
     fun(_) ->
         [
          fun() ->
              %% Create a conversation
              Messages = [
                  #{<<"role">> => <<"system">>, <<"content">> => <<"You are helpful.">>},
                  #{<<"role">> => <<"user">>, <<"content">> => <<"What is 2+2?">>}
              ],

              %% Call with full parameters
              Params = #{
                  <<"model">> => <<"gpt-4">>,
                  <<"temperature">> => 0.3,
                  <<"maxTokens">> => 500
              },

              Result = erlmcp_sampling:create_message(Messages, Params),

              ?assertMatch({ok, _}, Result),
              {ok, Response} = Result,
              ?assertMatch(#{<<"role">> := <<"assistant">>}, Response),
              ?assertMatch(#{<<"usage">> := #{<<"promptTokens">> := _}}, Response)
          end
         ]
     end
    }.

%% @doc Test provider switching
provider_switching_test_() ->
    {setup,
     fun() ->
         {ok, Pid} = erlmcp_sampling:start_link(),
         Pid
     end,
     fun(Pid) ->
         gen_server:stop(Pid)
     end,
     fun(_Pid) ->
         [
          fun() ->
              %% Get initial provider
              InitialProvider = erlmcp_sampling:get_model_provider(),
              ?assert(is_atom(InitialProvider)),

              %% Set to same provider (should work)
              ok = erlmcp_sampling:set_model_provider(InitialProvider),

              %% Verify it's still the same
              ?assertEqual(InitialProvider, erlmcp_sampling:get_model_provider())
          end
         ]
     end
    }.
