-module(erlmcp_session_persistent_tests).
-include_lib("eunit/include/eunit.hrl").

%% Mnesia record definition (copied from erlmcp_session_mnesia)
-record(erlmcp_session, {
    session_id :: binary(),
    session_data :: map(),
    last_accessed :: integer()
}).

%%====================================================================
%% Test Suite for Session Persistent Storage (Mnesia)
%% Chicago School TDD - Real Mnesia persistence, no mocks
%% Joe Armstrong Principles: "Databases are for persistence"
%%====================================================================

%%====================================================================
%% Setup and Cleanup
%%====================================================================

session_persistent_test_() ->
    {setup,
     fun setup_mnesia/0,
     fun cleanup_mnesia/1,
     fun(_) -> [
         ?_test(test_persist_session),
         ?_test(test_load_session),
         ?_test(test_delete_persistent),
         ?_test(test_persist_with_options),
         ?_test(test_load_expired_session),
         ?_test(test_persistence_survives_restart),
         ?_test(test_ets_and_mnesia_sync),
         ?_test(test_concurrent_persistence)
     ] end}.

setup_mnesia() ->
    %% Stop Mnesia if running
    application:stop(mnesia),

    %% Create schema for testing
    mnesia:create_schema([node()]),
    application:start(mnesia),

    %% Start session manager
    {ok, Pid} = erlmcp_session_manager:start_link(),
    Pid.

cleanup_mnesia(_Pid) ->
    %% Stop session manager
    gen_server:stop(erlmcp_session_manager),

    %% Delete Mnesia table
    mnesia:delete_table(erlmcp_session),

    %% Stop Mnesia
    application:stop(mnesia),
    mnesia:delete_schema([node()]),
    ok.

%%====================================================================
%% Persistence Tests
%%====================================================================

test_persist_session() ->
    %% Create a session
    Metadata = #{user => <<"test_user">>, role => admin},
    {ok, SessionId} = erlmcp_session_manager:create_session(Metadata, 3600000),

    %% Persist session to Mnesia
    ?assertEqual(ok, erlmcp_session_manager:persist_session(SessionId)),

    %% Verify session exists in Mnesia
    [#erlmcp_session{session_id = SessionId, session_data = _SessionData}] =
        mnesia:dirty_read(erlmcp_session, SessionId),

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId),
    ok = erlmcp_session_manager:delete_persistent(SessionId).

test_load_session() ->
    %% Create and persist session
    Metadata = #{client => <<"test_client">>},
    {ok, SessionId} = erlmcp_session_manager:create_session(Metadata, infinity),
    ok = erlmcp_session_manager:persist_session(SessionId),

    %% Delete from ETS (simulate restart)
    ets:delete(erlmcp_sessions, SessionId),

    %% Load session from Mnesia
    {ok, LoadedSession} = erlmcp_session_manager:load_session(SessionId),

    %% Verify loaded session data
    ?assertEqual(SessionId, maps:get(id, LoadedSession)),
    ?assertEqual(<<"test_client">>, maps:get(client, maps:get(metadata, LoadedSession))),
    ?assert(is_integer(maps:get(created_at, LoadedSession))),
    ?assert(is_integer(maps:get(last_accessed, LoadedSession))),

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId),
    ok = erlmcp_session_manager:delete_persistent(SessionId).

test_delete_persistent() ->
    %% Create and persist session
    {ok, SessionId} = erlmcp_session_manager:create_session(#{}, 3600000),
    ok = erlmcp_session_manager:persist_session(SessionId),

    %% Verify session exists in Mnesia
    ?assertMatch([#erlmcp_session{}], mnesia:dirty_read(erlmcp_session, SessionId)),

    %% Delete persistent session
    ?assertEqual(ok, erlmcp_session_manager:delete_persistent(SessionId)),

    %% Verify session deleted from Mnesia
    ?assertEqual([], mnesia:dirty_read(erlmcp_session, SessionId)),

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId).

test_persist_with_options() ->
    %% Create session with persist option
    Metadata = #{test => <<"persist_option">>},
    Options = #{persist => true, ttl => 7200000},  % 2 hours TTL
    {ok, SessionId} = erlmcp_session_manager:create_session(Metadata, infinity, Options),

    %% Verify session exists in Mnesia (TTL is stored in session_data map)
    [#erlmcp_session{session_data = SessionData}] = mnesia:dirty_read(erlmcp_session, SessionId),
    TTL = maps:get(timeout_ms, SessionData, infinity),
    ?assertEqual(infinity, TTL),  % The infinity timeout was passed to create_session

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId),
    ok = erlmcp_session_manager:delete_persistent(SessionId).

test_load_expired_session() ->
    %% Create and persist session with short TTL
    {ok, SessionId} = erlmcp_session_manager:create_session(#{}, 3600000),
    ok = erlmcp_session_manager:persist_session(SessionId, 100),  % 100ms TTL

    %% Wait for session to expire
    timer:sleep(150),

    %% Try to load expired session
    ?assertEqual({error, not_found}, erlmcp_session_manager:load_session(SessionId)),

    %% Verify session was deleted from Mnesia
    ?assertEqual([], mnesia:dirty_read(erlmcp_session, SessionId)),

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId).

test_persistence_survives_restart() ->
    %% Create and persist session
    Metadata = #{survivor => <<"restart_test">>},
    {ok, SessionId} = erlmcp_session_manager:create_session(Metadata, infinity),
    ok = erlmcp_session_manager:persist_session(SessionId),

    %% Get original session data
    {ok, OriginalSession} = erlmcp_session_manager:get_session(SessionId),

    %% Stop session manager
    gen_server:stop(erlmcp_session_manager),

    %% Wait for shutdown
    timer:sleep(100),

    %% Start session manager again
    {ok, _Pid} = erlmcp_session_manager:start_link(),

    %% Load session from Mnesia
    {ok, LoadedSession} = erlmcp_session_manager:load_session(SessionId),

    %% Verify session data survived restart
    ?assertEqual(maps:get(id, OriginalSession), maps:get(id, LoadedSession)),
    ?assertEqual(maps:get(metadata, OriginalSession), maps:get(metadata, LoadedSession)),

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId),
    ok = erlmcp_session_manager:delete_persistent(SessionId),
    gen_server:stop(erlmcp_session_manager).

test_ets_and_mnesia_sync() ->
    %% Create session
    {ok, SessionId} = erlmcp_session_manager:create_session(#{sync => test}, 3600000),

    %% Verify session in ETS
    [{SessionData, SessionId}] = ets:lookup(erlmcp_sessions, SessionId),
    ?assertEqual(SessionId, maps:get(id, SessionData)),

    %% Persist session
    ok = erlmcp_session_manager:persist_session(SessionId),

    %% Update session in ETS
    UpdateFun = fun(S) -> S#{metadata => maps:put(updated, true, maps:get(metadata, S))} end,
    ok = erlmcp_session_manager:update_session(SessionId, UpdateFun),

    %% Verify ETS updated
    {ok, UpdatedSession} = erlmcp_session_manager:get_session(SessionId),
    ?assertEqual(true, maps:get(updated, maps:get(metadata, UpdatedSession))),

    %% Persist updated session
    ok = erlmcp_session_manager:persist_session(SessionId),

    %% Verify Mnesia has updated session
    [#erlmcp_session{session_data = SessionData}] = mnesia:dirty_read(erlmcp_session, SessionId),
    ?assertEqual(true, maps:get(updated, maps:get(metadata, SessionData))),

    %% Cleanup
    ok = erlmcp_session_manager:delete_session(SessionId),
    ok = erlmcp_session_manager:delete_persistent(SessionId).

test_concurrent_persistence() ->
    %% Create multiple sessions
    SessionCount = 10,
    SessionIds = lists:map(fun(N) ->
        Metadata = #{index => N},
        {ok, Id} = erlmcp_session_manager:create_session(Metadata, infinity),
        Id
    end, lists:seq(1, SessionCount)),

    %% Persist all sessions concurrently
    Parent = self(),
    Pids = lists:map(fun(SessionId) ->
        spawn(fun() ->
            Result = erlmcp_session_manager:persist_session(SessionId),
            Parent ! {persist_result, SessionId, Result}
        end)
    end, SessionIds),

    %% Wait for all persists to complete
    lists:foreach(fun(_) ->
        receive {persist_result, _SessionId, Result} ->
            ?assertEqual(ok, Result)
        end
    end, SessionIds),

    %% Verify all sessions in Mnesia
    lists:foreach(fun(SessionId) ->
        ?assertMatch([#erlmcp_session{}], mnesia:dirty_read(erlmcp_session, SessionId))
    end, SessionIds),

    %% Cleanup
    lists:foreach(fun(SessionId) ->
        ok = erlmcp_session_manager:delete_session(SessionId),
        ok = erlmcp_session_manager:delete_persistent(SessionId)
    end, SessionIds).

%%====================================================================
%% Helper Functions
%%====================================================================

%% Verify Mnesia table exists
verify_mnesia_table() ->
    case mnesia:table_info(erlmcp_session, is_a_table) of
        true -> ok;
        false -> {error, table_not_exists}
    end.
