-module(erlmcp_memory_monitor_tests).
-include_lib("eunit/include/eunit.hrl").

%%====================================================================
%% Test Helpers
%%====================================================================

setup() ->
    {ok, Pid} = erlmcp_memory_monitor:start_link(),
    Pid.

cleanup(Pid) ->
    gen_server:stop(Pid).

%%====================================================================
%% Unit Tests
%%====================================================================

memory_monitor_start_test() ->
    Pid = setup(),
    ?assert(is_pid(Pid)),
    ?assert(is_process_alive(Pid)),
    cleanup(Pid).

check_memory_pressure_test() ->
    Pid = setup(),
    Result = erlmcp_memory_monitor:check_memory_pressure(),
    case Result of
        ok -> ok;
        {alert, high_binary_memory} -> ok;
        Other -> ?assertEqual(ok, Other)
    end,
    cleanup(Pid).

force_gc_test() ->
    Pid = setup(),
    %% Get memory before GC
    Before = erlang:memory(total),

    %% Force garbage collection
    ok = erlmcp_memory_monitor:force_gc(),

    %% Get memory after GC
    After = erlang:memory(total),

    %% Memory should not increase (may decrease or stay same)
    ?assert(After =< Before),
    cleanup(Pid).

get_memory_stats_test() ->
    Pid = setup(),
    Stats = erlmcp_memory_monitor:get_memory_stats(),

    %% Verify stats structure
    ?assert(is_map(Stats)),
    ?assert(maps:is_key(total_mb, Stats)),
    ?assert(maps:is_key(binary_mb, Stats)),
    ?assert(maps:is_key(binary_percent, Stats)),
    ?assert(maps:is_key(system_mb, Stats)),
    ?assert(maps:is_key(processes_mb, Stats)),
    ?assert(maps:is_key(process_count, Stats)),

    %% Verify values are reasonable
    ?assert(maps:get(total_mb, Stats) > 0),
    ?assert(maps:get(binary_mb, Stats) >= 0),
    ?assert(maps:get(binary_percent, Stats) >= 0),
    ?assert(maps:get(binary_percent, Stats) =< 100),
    ?assert(maps:get(system_mb, Stats) >= 0),
    ?assert(maps:get(processes_mb, Stats) >= 0),
    ?assert(maps:get(process_count, Stats) > 0),

    cleanup(Pid).

periodic_gc_test() ->
    Pid = setup(),

    %% Send force_gc message directly
    Pid ! force_gc,

    %% Give it time to process
    timer:sleep(100),

    %% Process should still be alive
    ?assert(is_process_alive(Pid)),

    cleanup(Pid).

memory_pressure_alert_test() ->
    Pid = setup(),

    %% The monitor should handle memory pressure without crashing
    Result = erlmcp_memory_monitor:check_memory_pressure(),
    case Result of
        ok -> ok;
        {alert, high_binary_memory} -> ok;
        Other -> ?assertEqual(ok, Other)
    end,

    cleanup(Pid).

concurrent_operations_test() ->
    Pid = setup(),

    %% Spawn multiple concurrent operations
    spawn(fun() -> erlmcp_memory_monitor:force_gc() end),
    spawn(fun() -> erlmcp_memory_monitor:get_memory_stats() end),
    spawn(fun() -> erlmcp_memory_monitor:check_memory_pressure() end),

    %% Give them time to complete
    timer:sleep(200),

    %% Monitor should still be alive
    ?assert(is_process_alive(Pid)),

    cleanup(Pid).

%%====================================================================
%% Integration Tests
%%====================================================================

memory_stats_accuracy_test() ->
    Pid = setup(),

    %% Get stats from monitor
    MonitorStats = erlmcp_memory_monitor:get_memory_stats(),

    %% Get stats directly from Erlang
    Total = erlang:memory(total) / (1024 * 1024),
    Binary = erlang:memory(binary) / (1024 * 1024),
    System = erlang:memory(system) / (1024 * 1024),
    Processes = erlang:memory(processes_used) / (1024 * 1024),
    ProcessCount = erlang:system_info(process_count),

    %% Verify stats match (within small tolerance)
    ?assert(abs(maps:get(total_mb, MonitorStats) - Total) < 1.0),
    ?assert(abs(maps:get(binary_mb, MonitorStats) - Binary) < 1.0),
    ?assert(abs(maps:get(system_mb, MonitorStats) - System) < 1.0),
    ?assert(abs(maps:get(processes_mb, MonitorStats) - Processes) < 1.0),
    ?assertEqual(ProcessCount, maps:get(process_count, MonitorStats)),

    cleanup(Pid).

stress_test_test() ->
    Pid = setup(),

    %% Simulate high memory usage by creating binaries
    Binaries = [crypto:strong_rand_bytes(1024 * 1024) || _ <- lists:seq(1, 10)],

    %% Check memory pressure
    Result = erlmcp_memory_monitor:check_memory_pressure(),

    %% Should handle high memory without crashing
    case Result of
        ok -> ok;
        {alert, _} -> ok;
        _ -> ?assert(false, {unexpected_result, Result})
    end,

    %% Force GC to clean up
    ok = erlmcp_memory_monitor:force_gc(),

    %% Verify binaries are still accessible
    ?assert(length(Binaries) =:= 10),

    cleanup(Pid).
