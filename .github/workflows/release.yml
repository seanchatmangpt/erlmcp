name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # Trigger on semver tags (v2.0.0, v2.1.0-rc.1, etc)

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  pre-release-validation:
    name: Pre-Release Validation Gate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is-prerelease: ${{ steps.extract.outputs.is-prerelease }}
      validation-passed: ${{ steps.validate.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: extract
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if prerelease (contains -, rc, beta, alpha)
          if [[ $VERSION =~ -(alpha|beta|rc) ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-otp26-${{ hashFiles('rebar.lock', 'apps/*/rebar.config') }}
          restore-keys: |
            ${{ runner.os }}-otp26-

      - name: Run Release Blocker Check
        id: blocker-check
        run: |
          chmod +x ./tools/release/release-blocker-check.sh

          echo "::group::Release Blocker Check"
          if ./tools/release/release-blocker-check.sh; then
            echo "✓ No release blockers found"
            echo "blockers=false" >> $GITHUB_OUTPUT
          else
            echo "✗ Release blockers detected"
            echo "blockers=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "::endgroup::"

      - name: Run Pre-Release Validator
        id: validate
        run: |
          chmod +x ./tools/release/pre-release-validator.sh

          echo "::group::Pre-Release Validation"
          if ./tools/release/pre-release-validator.sh ${{ steps.extract.outputs.version }}; then
            echo "✓ Pre-release validation passed"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ Pre-release validation failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "::endgroup::"

      - name: Generate Release Gate Dashboard
        if: always()
        run: |
          chmod +x ./tools/release/release-gate-dashboard.sh

          echo "::group::Release Gate Dashboard"
          ./tools/release/release-gate-dashboard.sh ${{ steps.extract.outputs.version }} || true
          echo "::endgroup::"

      - name: Generate Release Readiness Report
        if: always()
        run: |
          chmod +x ./tools/release/release-readiness-report.sh

          echo "::group::Release Readiness Report"
          ./tools/release/release-readiness-report.sh ${{ steps.extract.outputs.version }} || true
          echo "::endgroup::"

      - name: Upload Validation Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: release-validation-reports
          path: |
            /tmp/pre-release-validation-*.txt
            /tmp/release-readiness-*.md
          retention-days: 30

      - name: Block Release on Validation Failure
        if: steps.validate.outputs.passed != 'true' || steps.blocker-check.outputs.blockers == 'true'
        run: |
          echo "::error::Release validation failed - release blocked"
          echo ""
          echo "Fix all validation failures and blockers, then:"
          echo "1. Address all RED items in validation report"
          echo "2. Re-run: ./tools/release/pre-release-validator.sh ${{ steps.extract.outputs.version }}"
          echo "3. Re-run: ./tools/release/release-blocker-check.sh"
          echo "4. Push new tag when ready"
          exit 1

  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: pre-release-validation
    outputs:
      version: ${{ needs.pre-release-validation.outputs.version }}
      is-prerelease: ${{ needs.pre-release-validation.outputs.is-prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag matches version files
        run: |
          VERSION=${{ needs.pre-release-validation.outputs.version }}
          echo "Verifying version $VERSION in source files..."

          # Check root rebar.config relx version
          if grep -q "{release, {erlmcp, \"$VERSION\"}" rebar.config 2>/dev/null; then
            echo "✓ rebar.config release version matches"
          else
            echo "⚠ rebar.config version mismatch (expected $VERSION)"
          fi

          # Check umbrella app versions
          for app in erlmcp_core erlmcp_transports erlmcp_observability tcps_erlmcp; do
            APP_FILE="apps/$app/src/${app}.app.src"
            if [ -f "$APP_FILE" ]; then
              if grep -q "{vsn, \"$VERSION\"}" "$APP_FILE"; then
                echo "✓ $app version matches"
              else
                echo "⚠ $app version mismatch"
              fi
            fi
          done

  manual-approval:
    name: Manual Release Approval
    runs-on: ubuntu-latest
    needs: [pre-release-validation, validate]
    environment:
      name: production-release
      url: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.pre-release-validation.outputs.version }}

    steps:
      - name: Display Release Summary
        run: |
          echo "::notice::Release v${{ needs.pre-release-validation.outputs.version }} ready for approval"
          echo ""
          echo "Pre-release validation: ✓ PASSED"
          echo "Blocker check: ✓ PASSED"
          echo "Version: ${{ needs.pre-release-validation.outputs.version }}"
          echo "Is prerelease: ${{ needs.pre-release-validation.outputs.is-prerelease }}"
          echo ""
          echo "Awaiting manual approval to proceed with release..."

  test:
    name: Test Suite (OTP ${{ matrix.otp-version }})
    runs-on: ubuntu-latest
    needs: [validate, manual-approval]
    strategy:
      matrix:
        otp-version: ['25', '26', '27']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp-version }}
          rebar3-version: ${{ matrix.otp-version >= 26 && '3.25' || '3.22' }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-otp${{ matrix.otp-version }}-${{ hashFiles('rebar.lock', 'apps/*/rebar.config') }}
          restore-keys: |
            ${{ runner.os }}-otp${{ matrix.otp-version }}-

      - name: Download dependencies
        run: rebar3 get-deps

      - name: Compile umbrella
        run: rebar3 compile

      - name: Verify all umbrella apps compiled
        run: |
          for app in erlmcp_core erlmcp_transports erlmcp_observability tcps_erlmcp; do
            if [ -d "apps/$app/ebin" ]; then
              echo "✓ $app compiled ($(ls apps/$app/ebin/*.beam | wc -l) modules)"
            else
              echo "❌ $app failed to compile"
              exit 1
            fi
          done

      - name: Run unit tests
        run: rebar3 eunit

      - name: Run integration tests
        run: rebar3 ct --dir=test/integration

      - name: Run property tests
        run: rebar3 proper -c

      - name: Run dialyzer (type checking)
        run: rebar3 dialyzer

      - name: Run xref (cross-reference checks)
        run: rebar3 xref

      - name: Generate coverage report
        run: rebar3 cover

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./_build/test/cover/
          flags: erlang-otp${{ matrix.otp-version }}
          fail_ci_if_error: false

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate, test, manual-approval]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Build production release
        run: |
          echo "Building erlmcp v${{ needs.validate.outputs.version }} production release..."
          rebar3 as prod compile
          rebar3 as prod release

      - name: Verify release structure
        run: |
          RELEASE_DIR="_build/prod/rel/erlmcp"

          if [ -d "$RELEASE_DIR" ]; then
            echo "✓ Release directory created"
            ls -lh "$RELEASE_DIR/"

            # Verify critical files
            [ -f "$RELEASE_DIR/bin/erlmcp" ] && echo "✓ erlmcp start script exists"
            [ -d "$RELEASE_DIR/lib" ] && echo "✓ lib directory exists ($(ls $RELEASE_DIR/lib | wc -l) apps)"
            [ -f "$RELEASE_DIR/releases/${{ needs.validate.outputs.version }}/erlmcp.rel" ] && echo "✓ Release file exists"
          else
            echo "❌ Release build failed - directory not found"
            exit 1
          fi

      - name: Create tarball
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          TARBALL="erlmcp-${VERSION}.tar.gz"

          tar -czf "$TARBALL" -C _build/prod/rel erlmcp
          ls -lh "$TARBALL"

          # Create checksums
          sha256sum "$TARBALL" > "${TARBALL}.sha256"
          md5sum "$TARBALL" > "${TARBALL}.md5"

          echo "✓ Tarball created: $TARBALL"
          cat "${TARBALL}.sha256"

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v3
        with:
          name: erlmcp-release-${{ needs.validate.outputs.version }}
          path: |
            erlmcp-${{ needs.validate.outputs.version }}.tar.gz
            erlmcp-${{ needs.validate.outputs.version }}.tar.gz.sha256
            erlmcp-${{ needs.validate.outputs.version }}.tar.gz.md5
          retention-days: 90

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate, test, manual-approval]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate.outputs.version }}
            type=raw,value=latest,enable=${{ needs.validate.outputs.is-prerelease == 'false' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max
          build-args: |
            VERSION=${{ needs.validate.outputs.version }}
            OTP_VERSION=26

  publish-hex:
    name: Publish to Hex Package Manager
    runs-on: ubuntu-latest
    needs: [validate, test, manual-approval]
    if: ${{ needs.validate.outputs.is-prerelease == 'false' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Publish umbrella apps to Hex
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: |
          # Publish each umbrella app individually
          for app in erlmcp_core erlmcp_transports erlmcp_observability tcps_erlmcp; do
            if [ -f "apps/$app/src/${app}.app.src" ]; then
              echo "Publishing $app to Hex..."
              cd "apps/$app"
              rebar3 hex publish --yes || echo "⚠ Failed to publish $app (may already exist)"
              cd ../..
            fi
          done

          # Publish root umbrella package
          echo "Publishing erlmcp umbrella to Hex..."
          rebar3 hex publish --yes

  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build-artifacts, docker-build, manual-approval]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v3

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ needs.validate.outputs.version }}

          # Extract from CHANGELOG if exists
          if [ -f CHANGELOG.md ]; then
            # Try to extract this version's section
            NOTES=$(sed -n "/^## \[$VERSION\]/,/^## \[/p" CHANGELOG.md | sed '$d')
            if [ -z "$NOTES" ]; then
              # Fallback to getting everything since last version
              NOTES=$(sed -n "/^## \[/,/^## \[/p" CHANGELOG.md | head -n -1)
            fi
          fi

          # Default if no changelog
          if [ -z "$NOTES" ]; then
            NOTES="## erlmcp v$VERSION

**Erlang/OTP MCP SDK - Umbrella Release**

This release includes:
- \`erlmcp_core\` - JSON-RPC, Registry, Client/Server
- \`erlmcp_transports\` - STDIO, TCP, HTTP, WebSocket
- \`erlmcp_observability\` - Metrics, Traces, OpenTelemetry
- \`tcps_erlmcp\` - Toyota Code Production System (optional)

### Installation

\`\`\`erlang
{deps, [{erlmcp, \"$VERSION\"}]}.
\`\`\`

Or download the release tarball below.

See [CHANGELOG.md](CHANGELOG.md) for full details."
          fi

          # Store in multiline format
          {
            echo "content<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: erlmcp v${{ needs.validate.outputs.version }}
          body: ${{ steps.notes.outputs.content }}
          draft: false
          prerelease: ${{ needs.validate.outputs.is-prerelease }}
          files: |
            erlmcp-release-${{ needs.validate.outputs.version }}/erlmcp-${{ needs.validate.outputs.version }}.tar.gz
            erlmcp-release-${{ needs.validate.outputs.version }}/erlmcp-${{ needs.validate.outputs.version }}.tar.gz.sha256
            erlmcp-release-${{ needs.validate.outputs.version }}/erlmcp-${{ needs.validate.outputs.version }}.tar.gz.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  benchmark-release:
    name: Benchmark Release Build
    runs-on: ubuntu-latest
    needs: [validate, build-artifacts, manual-approval]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Build release
        run: |
          rebar3 as prod compile
          rebar3 as prod release

      - name: Run quick release benchmark
        run: |
          echo "Running benchmark on release build..."

          # Start release in background
          _build/prod/rel/erlmcp/bin/erlmcp daemon

          # Wait for startup
          sleep 5

          # Run quick benchmark
          _build/prod/rel/erlmcp/bin/erlmcp eval "
            erlmcp_bench_core_ops:run(<<\"core_ops_10k\">>).
          "

          # Stop release
          _build/prod/rel/erlmcp/bin/erlmcp stop

          echo "✓ Release benchmark completed"
        timeout-minutes: 10
        continue-on-error: true

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate, test, build-artifacts, docker-build, github-release, manual-approval]
    if: always()

    steps:
      - name: Print summary
        run: |
          cat << 'EOF'
          ╔═══════════════════════════════════════════╗
          ║     erlmcp Release Pipeline Complete     ║
          ╚═══════════════════════════════════════════╝

          Version: v${{ needs.validate.outputs.version }}
          Prerelease: ${{ needs.validate.outputs.is-prerelease }}
          Type: Umbrella Release (4 applications)

          Build Status:
          ✓ Pre-Release Validation: PASSED
          ✓ Manual Approval: APPROVED
          ✓ Validation: ${{ needs.validate.result }}
          ✓ Tests (OTP 25/26/27): ${{ needs.test.result }}
          ✓ Artifacts: ${{ needs.build-artifacts.result }}
          ✓ Docker: ${{ needs.docker-build.result }}
          ✓ GitHub Release: ${{ needs.github-release.result }}

          Umbrella Applications:
          • erlmcp_core - JSON-RPC, Registry, Client/Server
          • erlmcp_transports - STDIO, TCP, HTTP, WebSocket
          • erlmcp_observability - Metrics, Traces, OpenTelemetry
          • tcps_erlmcp - Toyota Code Production System

          Artifacts:
          • Tarball: erlmcp-${{ needs.validate.outputs.version }}.tar.gz
          • Docker: ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}
          • Hex: erlmcp v${{ needs.validate.outputs.version }}

          Next Steps:
          1. Review release notes at:
             ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.validate.outputs.version }}
          2. Test Docker image: docker pull ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}
          3. Verify Hex packages published
          4. Update downstream projects
          5. Announce release

          Documentation:
          - CHANGELOG.md - Release notes
          - README.md - Getting started
          - docs/ - Full documentation
          EOF
