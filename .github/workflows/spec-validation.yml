name: MCP Spec Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'Validation level'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - comprehensive

env:
  SPEC_VERSION: "2025-11-25"
  COMPLIANCE_THRESHOLD: 95
  OTP_VERSION: "26"

jobs:
  # =============================================================================
  # JOB 1: Compilation and Dependency Validation
  # =============================================================================
  compile:
    name: Compile and Validate Dependencies
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: '3.25'

      - name: Cache rebar3 dependencies
        uses: actions/cache@v3
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-rebar3-${{ hashFiles('**/rebar.lock') }}
          restore-keys: |
            ${{ runner.os }}-rebar3-

      - name: Fetch dependencies
        run: rebar3 get-deps

      - name: Compile all applications
        id: compile
        run: |
          echo "::group::Compiling all applications"
          TERM=dumb rebar3 compile
          COMPILE_EXIT=${?}
          echo "::endgroup::"

          if [ ${COMPILE_EXIT} -ne 0 ]; then
            echo "::error::Compilation FAILED"
            echo "status=failed" >> ${GITHUB_OUTPUT}
            exit 1
          fi

          echo "status=success" >> ${GITHUB_OUTPUT}
          echo "Compiled successfully"

  # =============================================================================
  # JOB 2: EUnit Tests - Protocol Validation
  # =============================================================================
  eunit-tests:
    name: EUnit Tests (Protocol Validation)
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: compile

    strategy:
      matrix:
        app: [erlmcp_core, erlmcp_transports, erlmcp_validation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: '3.25'

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-eunit-${{ matrix.app }}-${{ hashFiles('**/rebar.lock') }}

      - name: Compile ${{ matrix.app }}
        run: |
          TERM=dumb rebar3 compile
          rebar3 eunit --compile_only

      - name: Run EUnit tests for ${{ matrix.app }}
        id: eunit
        run: |
          echo "::group::EUnit Tests - ${{ matrix.app }}"
          rebar3 eunit --application=${{ matrix.app }} --verbose
          EUNIT_EXIT=${?}
          echo "::endgroup::"

          # Capture test results
          TEST_LOG=$(find _build/test/logs -name "*.log" 2>/dev/null | head -1 || echo "")

          if [ ${EUNIT_EXIT} -ne 0 ]; then
            echo "::error::EUnit tests FAILED for ${{ matrix.app }}"
            echo "status=failed" >> ${GITHUB_OUTPUT}
          else
            echo "status=success" >> ${GITHUB_OUTPUT}
          fi

      - name: Upload EUnit test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: eunit-results-${{ matrix.app }}
          path: _build/test/logs/
          retention-days: 7

  # =============================================================================
  # JOB 3: Common Test - MCP Spec Compliance Suite
  # =============================================================================
  spec-compliance-tests:
    name: MCP Spec Compliance Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    needs: compile

    strategy:
      matrix:
        suite:
          - erlmcp_spec_compliance_SUITE
          - erlmcp_protocol_validator_tests
          - erlmcp_transport_validator_tests
          - erlmcp_security_validator_tests
          - erlmcp_performance_validator_SUITE

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: '3.25'

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-ct-${{ matrix.suite }}-${{ hashFiles('**/rebar.lock') }}

      - name: Compile test suite
        run: |
          TERM=dumb rebar3 compile
          rebar3 ct --compile_only

      - name: Run ${{ matrix.suite }}
        id: ct_suite
        run: |
          echo "::group::Common Test - ${{ matrix.suite }}"
          rebar3 ct --suite=apps/erlmcp_validation/test/${{ matrix.suite }}.ct --cover
          CT_EXIT=${?}
          echo "::endgroup::"

          if [ ${CT_EXIT} -ne 0 ]; then
            echo "::error::Test suite ${{ matrix.suite }} FAILED"
            echo "status=failed" >> ${GITHUB_OUTPUT}
          else
            echo "status=success" >> ${GITHUB_OUTPUT}
          fi

      - name: Generate coverage report
        if: always()
        run: |
          echo "::group::Coverage Report - ${{ matrix.suite }}"
          rebar3 cover --verbose

          # Extract coverage percentage
          COVERAGE=$(find _build/test/cover -name "*.coverdata" -exec echo {} \; | head -1)

          if [ -n "$COVERAGE" ]; then
            echo "Coverage data: $COVERAGE"
          fi
          echo "::endgroup::"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ct-results-${{ matrix.suite }}
          path: |
            _build/test/logs/
            _build/test/cover/
          retention-days: 14

  # =============================================================================
  # JOB 4: Validation CLI - Spec Compliance Report
  # =============================================================================
  validation-report:
    name: Generate Validation Report
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [eunit-tests, spec-compliance-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: '3.25'

      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-validation-${{ hashFiles('**/rebar.lock') }}

      - name: Compile validation application
        run: |
          TERM=dumb rebar3 compile
          rebar3 as validation escriptize

      - name: Run validation CLI
        id: validation
        run: |
          echo "::group::Running MCP Spec Validation"

          # Run validation with all sections
          ./_build/validation/bin/erlmcp_validate run --all \
            --format json \
            --output validation_report.json

          VALIDATION_EXIT=${?}
          echo "::endgroup::"

          if [ ${VALIDATION_EXIT} -ne 0 ]; then
            echo "::warning::Validation completed with warnings"
          fi

          # Extract compliance percentage
          if [ -f validation_report.json ]; then
            COMPLIANCE=$(jq -r '.summary.status // "unknown"' validation_report.json)
            TOTAL=$(jq -r '.summary.total // 0' validation_report.json)
            PASSED=$(jq -r '.summary.passed // 0' validation_report.json)
            FAILED=$(jq -r '.summary.failed // 0' validation_report.json)

            echo "validation_status=${COMPLIANCE}" >> ${GITHUB_OUTPUT}
            echo "total_tests=${TOTAL}" >> ${GITHUB_OUTPUT}
            echo "passed_tests=${PASSED}" >> ${GITHUB_OUTPUT}
            echo "failed_tests=${FAILED}" >> ${GITHUB_OUTPUT}
          else
            echo "validation_status=error" >> ${GITHUB_OUTPUT}
          fi

      - name: Generate markdown report
        if: always()
        run: |
          ./_build/validation/bin/erlmcp_validate report \
            --format markdown \
            --output validation_report.md

      - name: Generate validation summary
        if: always()
        run: |
          echo "## MCP Spec Validation Results" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}
          echo "**Specification:** MCP ${{ env.SPEC_VERSION }}" >> ${GITHUB_STEP_SUMMARY}
          echo "**Validation Status:** ${{ steps.validation.outputs.validation_status }}" >> ${GITHUB_STEP_SUMMARY}
          echo "**Tests:** ${{ steps.validation.outputs.passed_tests }}/${{ steps.validation.outputs.total_tests }} passed" >> ${GITHUB_STEP_SUMMARY}

          if [ "${{ steps.validation.outputs.failed_tests }}" -gt 0 ]; then
            echo "" >> ${GITHUB_STEP_SUMMARY}
            echo "::warning::Validation found ${{ steps.validation.outputs.failed_tests }} failing tests"
          fi

          # Append markdown report
          if [ -f validation_report.md ]; then
            echo "" >> ${GITHUB_STEP_SUMMARY}
            cat validation_report.md >> ${GITHUB_STEP_SUMMARY}
          fi

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: mcp-validation-report
          path: |
            validation_report.json
            validation_report.md
          retention-days: 30

      - name: Check validation threshold
        if: always()
        run: |
          if [ -f validation_report.json ]; then
            STATUS=$(jq -r '.summary.status // "unknown"' validation_report.json)

            if [ "${STATUS}" = "failed" ]; then
              echo "::error::Validation FAILED"
              exit 1
            elif [ "${STATUS}" = "success" ]; then
              echo "Validation PASSED"
            else
              echo "::warning::Validation completed with warnings"
            fi
          else
            echo "::error::Validation report not found"
            exit 1
          fi

  # =============================================================================
  # JOB 5: Transport Layer Validation
  # =============================================================================
  transport-validation:
    name: Transport Layer Validation
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: compile

    strategy:
      matrix:
        transport: [stdio, tcp, http]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: '3.25'

      - name: Run transport validation
        id: transport_val
        run: |
          echo "::group::Transport Validation - ${{ matrix.transport }}"

          # Create test script
          cat > transport_validation.erl << 'EOF'
          #!/usr/bin/env escript
          main([Transport]) ->
              io:format("Validating transport: ~s~n", [Transport]),

              %% Start required applications
              application:ensure_all_started(erlmcp),

              %% Run transport validation
              case code:load_file(erlmcp_transport_validator) of
                {module, _} ->
                  Result = erlmcp_transport_validator:run(list_to_existing_atom(Transport)),
                  io:format("Result: ~p~n", [Result]),
                  init:stop(0);
                {error, Reason} ->
                  io:format("Failed to load validator: ~p~n", [Reason]),
                  init:stop(1)
              end.
          EOF

          escript transport_validation.erl ${{ matrix.transport }}
          TRANSPORT_EXIT=${?}
          echo "::endgroup::"

          if [ ${TRANSPORT_EXIT} -ne 0 ]; then
            echo "::warning::Transport validation ${{ matrix.transport }} has issues"
            echo "status=warning" >> ${GITHUB_OUTPUT}
          else
            echo "status=success" >> ${GITHUB_OUTPUT}
          fi

  # =============================================================================
  # JOB 6: Final Validation Gate
  # =============================================================================
  validation-gate:
    name: Validation Quality Gate
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    needs: [eunit-tests, spec-compliance-tests, validation-report, transport-validation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/

      - name: Validate all gates
        id: gate
        run: |
          echo "::group::Validation Gate Check"

          # Check EUnit results
          EUNIT_FAILED=0
          for app in erlmcp_core erlmcp_transports erlmcp_validation; do
            if [ -f "artifacts/eunit-results-${app}/test.log" ]; then
              if grep -q "failed" "artifacts/eunit-results-${app}/test.log"; then
                echo "::error::EUnit tests failed for ${app}"
                EUNIT_FAILED=1
              fi
            fi
          done

          # Check CT results
          CT_FAILED=0
          for suite_dir in artifacts/ct-results-*/; do
            if [ -d "${suite_dir}" ]; then
              if find "${suite_dir}" -name "*.log" -exec grep -l "FAILED" {} \; | grep -q .; then
                echo "::warning::Some CT tests failed"
                CT_FAILED=1
              fi
            fi
          done

          # Check validation report
          VALIDATION_STATUS="unknown"
          if [ -f "artifacts/mcp-validation-report/validation_report.json" ]; then
            VALIDATION_STATUS=$(jq -r '.summary.status // "unknown"' artifacts/mcp-validation-report/validation_report.json)
          fi

          # Final gate decision
          GATE_STATUS="passed"

          if [ ${EUNIT_FAILED} -ne 0 ]; then
            GATE_STATUS="failed"
          fi

          if [ "${VALIDATION_STATUS}" = "failed" ]; then
            GATE_STATUS="failed"
          fi

          echo "eunit_status=${EUNIT_FAILED}" >> ${GITHUB_OUTPUT}
          echo "ct_status=${CT_FAILED}" >> ${GITHUB_OUTPUT}
          echo "validation_status=${VALIDATION_STATUS}" >> ${GITHUB_OUTPUT}
          echo "gate_status=${GATE_STATUS}" >> ${GITHUB_OUTPUT}
          echo "::endgroup::"

          if [ "${GATE_STATUS}" = "failed" ]; then
            echo "::error::Validation gate FAILED"
            exit 1
          else
            echo "Validation gate PASSED"
          fi

      - name: Generate gate summary
        if: always()
        run: |
          echo "## MCP Spec Validation Gate" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}
          echo "**Status:** ${{ steps.gate.outputs.gate_status }}" >> ${GITHUB_STEP_SUMMARY}
          echo "**Specification:** MCP ${{ env.SPEC_VERSION }}" >> ${GITHUB_STEP_SUMMARY}
          echo "**EUnit:** $([ "${{ steps.gate.outputs.eunit_status }}" = "0" ] && echo "PASSED" || echo "FAILED")" >> ${GITHUB_STEP_SUMMARY}
          echo "**CT Tests:** $([ "${{ steps.gate.outputs.ct_status }}" = "0" ] && echo "PASSED" || echo "WARNING")" >> ${GITHUB_STEP_SUMMARY}
          echo "**Validation:** ${{ steps.gate.outputs.validation_status }}" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}

          if [ "${{ steps.gate.outputs.gate_status }}" = "passed" ]; then
            echo "✅ **MERGE ALLOWED** - All validation gates passed" >> ${GITHUB_STEP_SUMMARY}
          else
            echo "❌ **MERGE BLOCKED** - Fix validation issues" >> ${GITHUB_STEP_SUMMARY}
          fi

      - name: Comment PR with validation results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## MCP Spec Validation Results\n\n';
            comment += `**Status:** ${'{ steps.gate.outputs.gate_status }}\n`;
            comment += `**Specification:** MCP ${{ env.SPEC_VERSION }}\n\n`;

            try {
              const report = JSON.parse(fs.readFileSync('artifacts/mcp-validation-report/validation_report.json', 'utf8'));
              comment += `**Tests:** ${report.summary.passed}/${report.summary.total} passed\n\n`;

              if (report.summary.failed > 0) {
                comment += `⚠️ ${report.summary.failed} tests failed\n\n`;
              }
            } catch (e) {
              comment += '⚠️ Could not read validation report\n\n';
            }

            comment += '\n---\n';
            comment += '*Full details available in workflow artifacts*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
