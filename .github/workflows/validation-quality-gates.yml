name: Validation Framework Quality Gates

on:
  push:
    branches: [main, 'feature/**', 'epic/**']
  pull_request:
    branches: [main, 'release/**']
  workflow_call:

env:
  COVERAGE_THRESHOLD: 80
  TEST_TIMEOUT_MINUTES: 30

jobs:
  # =============================================================================
  # JOB 1: Validation Framework Compilation
  # =============================================================================
  validation-compile:
    name: Validation Framework Compilation
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    strategy:
      matrix:
        otp_version: [25, 26, 27]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: ${{ matrix.otp_version >= 26 && '3.25' || '3.22' }}

      - name: Cache validation build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-val-compile-otp${{ matrix.otp_version }}-${{ hashFiles('apps/erlmcp_validation/rebar.config') }}
          restore-keys: |
            ${{ runner.os }}-val-compile-otp${{ matrix.otp_version }}-
            ${{ runner.os }}-val-compile-

      - name: Compile validation application
        id: compile_validation
        run: |
          echo "::group::Compiling Validation Application"
          TERM=dumb rebar3 as validation compile
          COMPILE_EXIT=$?
          echo "::endgroup::"

          if [ $COMPILE_EXIT -ne 0 ]; then
            echo "::error::Validation app compilation FAILED"
            echo "compile_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Verify all expected modules compiled
          VALIDATION_MODS=(
            "erlmcp_spec_parser"
            "erlmcp_protocol_validator"
            "erlmcp_transport_validator"
            "erlmcp_validation_runner"
            "erlmcp_compliance_report"
          )

          ALL_MODS=true
          for mod in "${VALIDATION_MODS[@]}"; do
            if [ -f "_build/validation/lib/erlmcp_validation/ebin/${mod}.beam" ]; then
              echo "✅ $mod compiled"
            else
              echo "❌ $mod missing"
              ALL_MODS=false
            fi
          done

          if [ "$ALL_MODS" = false ]; then
            echo "::error::Some validation modules failed to compile"
            echo "compile_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "compile_status=success" >> $GITHUB_OUTPUT
          echo "✅ All validation modules compiled successfully"

      - name: Verify validation app structure
        run: |
          echo "## Validation App Structure - OTP ${{ matrix.otp_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check app file
          if [ -f "apps/erlmcp_validation/src/erlmcp_validation.app.src" ]; then
            echo "✅ App file exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ App file missing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Count modules
          MOD_COUNT=$(find apps/erlmcp_validation/src -name "*.erl" | wc -l)
          BEAM_COUNT=$(find _build/validation/lib/erlmcp_validation/ebin -name "*.beam" 2>/dev/null | wc -l)

          echo "**Source modules:** $MOD_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Compiled modules:** $BEAM_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$BEAM_COUNT" -eq 0 ]; then
            echo "::error::No BEAM files found for validation app"
            exit 1
          fi

  # =============================================================================
  # JOB 2: Validation Framework Tests
  # =============================================================================
  validation-tests:
    name: Validation Framework Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: validation-compile

    strategy:
      matrix:
        otp_version: [26]
        test_type:
          - eunit
          - ct

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: '3.25'

      - name: Cache validation tests
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-val-tests-otp${{ matrix.otp_version }}-${{ matrix.test_type }}-${{ hashFiles('apps/erlmcp_validation/rebar.config') }}

      - name: Run ${{ matrix.test_type }} tests
        id: validation_tests
        run: |
          echo "::group::Validation ${{ matrix.test_type }} Tests"

          if [ "${{ matrix.test_type }}" = "eunit" ]; then
            rebar3 as validation eunit --cover
            TEST_EXIT=$?
          else
            rebar3 as validation ct --cover
            TEST_EXIT=$?
          fi

          echo "::endgroup::"

          if [ $TEST_EXIT -ne 0 ]; then
            echo "::error::Validation ${{ matrix.test_type }} tests FAILED"
            echo "test_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "test_status=success" >> $GITHUB_OUTPUT
          echo "✅ Validation ${{ matrix.test_type }} tests passed"

      - name: Check validation test coverage
        if: always()
        run: |
          echo "::group::Validation Test Coverage"

          rebar3 as validation cover --verbose

          # Extract coverage for validation app
          VAL_COV=$(rebar3 as validation cover --verbose 2>&1 | grep "erlmcp_validation" | awk '{print $NF}' || echo "0%")

          echo "Validation app coverage: $VAL_COV"

          if [ "$VAL_COV" != "0%" ]; then
            COV_NUM=$(echo $VAL_COV | sed 's/%//')
            echo "**Validation App Coverage:** $VAL_COV" >> $GITHUB_STEP_SUMMARY

            if [ "$COV_NUM" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
              echo "::warning::Validation test coverage below ${{ env.COVERAGE_THRESHOLD }}%: $VAL_COV"
            fi
          fi

          echo "::endgroup::"

      - name: Upload validation test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-${{ matrix.test_type }}-results-otp${{ matrix.otp_version }}
          path: |
            _build/validation/cover/
            _build/validation/logs/
          retention-days: 14

  # =============================================================================
  # JOB 3: Spec Parser Validation
  # =============================================================================
  spec-parser-validation:
    name: Spec Parser Validation
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: validation-compile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Validate spec parser functionality
        id: spec_parser
        run: |
          echo "::group::Spec Parser Validation"

          rebar3 as validation shell --eval "
            application:ensure_all_started(erlmcp_validation),

            %% Test spec parsing
            {ok, Spec} = erlmcp_spec_parser:parse_specification(<<\"2025-11-25\">>),
            io:format(\"✅ Spec parsed successfully~n\"),

            %% Verify required sections
            Methods = erlmcp_spec_parser:method_requirements(),
            io:format(\"✅ Method requirements: ~p~n\", [maps:size(Methods)]),

            ErrorCodes = erlmcp_spec_parser:error_code_requirements(),
            io:format(\"✅ Error code requirements: ~p~n\", [maps:size(ErrorCodes)]),

            Transports = erlmcp_spec_parser:transport_requirements(),
            io:format(\"✅ Transport requirements: ~p~n\", [maps:size(Transports)]),

            %% Validate extracted data
            case maps:size(Methods) of
              N when N >= 10 -> io:format(\"✅ Methods extracted: ~p~n\", [N]);
              _ -> io:format(\"❌ Insufficient methods extracted~n\"), init:stop(1)
            end,

            init:stop()
          " --name spec_parser_val@localhost --setcookie spec_cookie

          PARSER_EXIT=$?
          echo "::endgroup::"

          if [ $PARSER_EXIT -ne 0 ]; then
            echo "::error::Spec parser validation FAILED"
            echo "parser_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "parser_status=success" >> $GITHUB_OUTPUT
          echo "✅ Spec parser validation passed"

      - name: Generate spec requirements summary
        run: |
          echo "## Spec Parser Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Spec Parsing | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Method Requirements | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Code Requirements | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Transport Requirements | ✅ |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # JOB 4: Protocol Validator Tests
  # =============================================================================
  protocol-validator-tests:
    name: Protocol Validator Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [validation-compile, validation-tests]

    strategy:
      matrix:
        validator:
          - method_validator
          - error_response_validator
          - notification_validator

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Run ${{ matrix.validator }} tests
        id: validator_tests
        run: |
          echo "::group::${{ matrix.validator }} Tests"

          rebar3 as validation shell --eval "
            application:ensure_all_started(erlmcp_validation),

            %% Start test server
            {ok, ServerPid} = erlmcp_test_server:start_link(),
            timer:sleep(500),

            %% Run validator tests
            Result = case \"${{ matrix.validator }}\" of
              \"method_validator\" ->
                erlmcp_protocol_validator:test_all_methods();
              \"error_response_validator\" ->
                erlmcp_protocol_validator:test_error_responses();
              \"notification_validator\" ->
                erlmcp_protocol_validator:test_notifications()
            end,

            %% Cleanup
            erlmcp_test_server:stop(ServerPid),

            case Result of
              ok -> init:stop(0);
              {error, Reason} ->
                io:format(\"❌ Validator test failed: ~p~n\", [Reason]),
                init:stop(1)
            end
          " --name validator@localhost --setcookie validator_cookie

          VAL_EXIT=$?
          echo "::endgroup::"

          if [ $VAL_EXIT -ne 0 ]; then
            echo "::error::${{ matrix.validator }} tests FAILED"
            echo "validator_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "validator_status=success" >> $GITHUB_OUTPUT

  # =============================================================================
  # JOB 5: Coverage Threshold Check
  # =============================================================================
  coverage-threshold:
    name: Coverage Threshold Check
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    needs: [validation-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Download coverage artifacts
        uses: actions/download-artifact@v3
        with:
          pattern: validation-*-results-otp26
          path: coverage-data/

      - name: Check coverage threshold
        id: coverage_check
        run: |
          echo "::group::Coverage Threshold Check"

          # Aggregate coverage from all test runs
          TOTAL_COV=0
          COUNT=0

          for cover_dir in coverage-data/_build/validation/cover; do
            if [ -f "$cover_dir/cover.log" ]; then
              COV=$(grep "erlmcp_validation" "$cover_dir/cover.log" | awk '{print $NF}' | sed 's/%//' || echo "0")
              if [ "$COV" != "0" ]; then
                TOTAL_COV=$((TOTAL_COV + COV))
                COUNT=$((COUNT + 1))
              fi
            fi
          done

          if [ $COUNT -gt 0 ]; then
            AVG_COV=$((TOTAL_COV / COUNT))
            echo "**Average Coverage:** $AVG_COV%" >> $GITHUB_STEP_SUMMARY
          else
            AVG_COV=0
            echo "**Coverage:** N/A" >> $GITHUB_STEP_SUMMARY
          fi

          echo "::endgroup::"

          if [ $AVG_COV -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
            echo "::error::Coverage $AVG_COV% below threshold ${{ env.COVERAGE_THRESHOLD }}%"
            echo "coverage_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "coverage_status=success" >> $GITHUB_OUTPUT
          echo "✅ Coverage threshold met"

  # =============================================================================
  # JOB 6: Final Quality Gate
  # =============================================================================
  final-quality-gate:
    name: Validation Quality Gate
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: [validation-compile, validation-tests, spec-parser-validation, protocol-validator-tests, coverage-threshold]

    steps:
      - name: Quality gate summary
        run: |
          echo "╔════════════════════════════════════════════╗" >> $GITHUB_STEP_SUMMARY
          echo "║   Validation Framework Quality Gates      ║" >> $GITHUB_STEP_SUMMARY
          echo "╚════════════════════════════════════════════╝" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Compilation | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Spec Parser | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Protocol Validators | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage ≥${{ env.COVERAGE_THRESHOLD }}% | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all dependencies passed
          if [ "${{ needs.validation-compile.result }}" = "success" ] && \
             [ "${{ needs.validation-tests.result }}" = "success" ] && \
             [ "${{ needs.spec-parser-validation.result }}" = "success" ] && \
             [ "${{ needs.protocol-validator-tests.result }}" = "success" ] && \
             [ "${{ needs.coverage-threshold.result }}" = "success" ]; then
            echo "✅ **All validation quality gates PASSED**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "❌ **Some validation quality gates FAILED**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
