name: Breaking Change Detection

on:
  pull_request:
    branches: [main, 'release/**']
    types: [opened, synchronize, reopened]
  push:
    branches: ['release/**']

env:
  MCP_SPEC_VERSION: '2025-11-25'

jobs:
  # =============================================================================
  # API Surface Analysis
  # =============================================================================
  api-surface-analysis:
    name: API Surface Change Detection
    runs-on: ubuntu-latest
    outputs:
      has_breaking_changes: ${{ steps.analyze.outputs.has_breaking }}
      breaking_change_count: ${{ steps.analyze.outputs.breaking_count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get base branch
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            # For push events, compare against previous commit
            echo "ref=HEAD~1" >> $GITHUB_OUTPUT
          fi

      - name: Analyze API surface changes
        id: analyze
        run: |
          echo "::group::API Surface Analysis"

          BASE_REF="${{ steps.base.outputs.ref }}"
          echo "Comparing against: ${BASE_REF}"

          BREAKING_COUNT=0

          # Create summary header
          echo "## Breaking Change Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Base:** ${BASE_REF}" >> $GITHUB_STEP_SUMMARY
          echo "**Head:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 1: Initialize Flow Changes
          # =================================================================
          echo "### 1. Initialize Flow (CRITICAL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          INIT_FILES=(
            "apps/erlmcp_core/src/erlmcp_client.erl"
            "apps/erlmcp_core/src/erlmcp_server.erl"
            "apps/erlmcp_core/src/erlmcp_json_rpc.erl"
          )

          for file in "${INIT_FILES[@]}"; do
            if git diff ${BASE_REF}..HEAD -- "$file" | grep -E '(initialize|capability|protocolVersion)' > /tmp/init_changes_${file##*/}.txt; then
              if [ -s /tmp/init_changes_${file##*/}.txt ]; then
                echo "⚠️ **${file##*/}** - Initialize flow modified" >> $GITHUB_STEP_SUMMARY
                echo '```diff' >> $GITHUB_STEP_SUMMARY
                head -20 /tmp/init_changes_${file##*/}.txt >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY

                # Check for removed initialize logic (BREAKING)
                if grep -q '^-.*initialize' /tmp/init_changes_${file##*/}.txt; then
                  echo "::error::BREAKING: Initialize logic removed in ${file}"
                  ((BREAKING_COUNT++))
                fi
              fi
            fi
          done

          if [ $BREAKING_COUNT -eq 0 ]; then
            echo "✅ No breaking changes in initialize flow" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 2: Message Structure Changes
          # =================================================================
          echo "### 2. JSON-RPC Message Structure (CRITICAL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          git diff ${BASE_REF}..HEAD -- apps/erlmcp_core/src/erlmcp_json_rpc.erl > /tmp/jsonrpc_diff.txt

          # Check for required field removals
          REMOVED_REQUIRED=$(grep -P '^\-.*<<\"(jsonrpc|id|method|params|result|error)\"' /tmp/jsonrpc_diff.txt || true)

          if [ -n "$REMOVED_REQUIRED" ]; then
            echo "❌ **BREAKING:** JSON-RPC required fields removed" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$REMOVED_REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::error::BREAKING: JSON-RPC required fields removed"
            ((BREAKING_COUNT++))
          else
            echo "✅ JSON-RPC message structure intact" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 3: Capability Removals
          # =================================================================
          echo "### 3. Capability Removals (BREAKING)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          git diff ${BASE_REF}..HEAD -- apps/erlmcp_core/src/erlmcp_capabilities.erl > /tmp/cap_diff.txt

          REMOVED_CAPS=$(grep -P '^\-\s*(tools|resources|prompts|sampling|logging|tasks|completion|roots)' /tmp/cap_diff.txt | grep -v '^\-\-\-' || true)

          if [ -n "$REMOVED_CAPS" ]; then
            echo "❌ **BREAKING:** Capabilities removed" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$REMOVED_CAPS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::error::BREAKING: Capabilities removed"
            ((BREAKING_COUNT++))
          else
            echo "✅ No capabilities removed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 4: MCP Method Removals
          # =================================================================
          echo "### 4. MCP Method Removals (BREAKING)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Core methods that must not be removed
          CORE_METHODS=(
            "initialize"
            "tools/list"
            "tools/call"
            "resources/list"
            "resources/read"
            "prompts/list"
            "prompts/get"
          )

          METHOD_REMOVALS=0

          for method in "${CORE_METHODS[@]}"; do
            METHOD_SAFE=$(echo "$method" | sed 's/\//\\\//g')

            # Check if method was removed from any file
            if git diff ${BASE_REF}..HEAD -- apps/erlmcp_core/src/ | grep -P "^\-.*\"${METHOD_SAFE}\"" > /dev/null 2>&1; then
              # Verify it's not just moved
              if ! git diff ${BASE_REF}..HEAD -- apps/erlmcp_core/src/ | grep -P "^\+.*\"${METHOD_SAFE}\"" > /dev/null 2>&1; then
                echo "❌ **BREAKING:** Method \`${method}\` removed" >> $GITHUB_STEP_SUMMARY
                echo "::error::BREAKING: MCP method '${method}' removed"
                ((BREAKING_COUNT++))
                ((METHOD_REMOVALS++))
              fi
            fi
          done

          if [ $METHOD_REMOVALS -eq 0 ]; then
            echo "✅ All core methods present" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 5: Error Code Changes
          # =================================================================
          echo "### 5. Error Code Stability (CRITICAL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          git diff ${BASE_REF}..HEAD -- apps/erlmcp_core/src/erlmcp_errors.erl apps/erlmcp_core/src/erlmcp_refusal.erl > /tmp/error_full_diff.txt

          # Check for error code value changes (not just additions)
          CHANGED_ERROR_VALUES=$(grep -P '^\-\s*-define\([A-Z_]+,\s*-?\d+\)' /tmp/error_full_diff.txt | while read -r removed; do
            CODE_NAME=$(echo "$removed" | grep -oP '-define\(\K[^,]+')
            # Check if same code name appears with different value
            if grep -P "^\+\s*-define\(${CODE_NAME},\s*-?\d+\)" /tmp/error_full_diff.txt > /dev/null; then
              echo "$removed"
            fi
          done || true)

          if [ -n "$CHANGED_ERROR_VALUES" ]; then
            echo "❌ **BREAKING:** Error code values changed" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$CHANGED_ERROR_VALUES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::error::BREAKING: Error code values changed"
            ((BREAKING_COUNT++))
          else
            echo "✅ Error codes stable" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 6: Transport Behavior Changes
          # =================================================================
          echo "### 6. Transport Behavior Contract (BREAKING)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          git diff ${BASE_REF}..HEAD -- apps/erlmcp_transports/src/erlmcp_transport_behavior.erl > /tmp/transport_behavior_diff.txt

          # Check for callback signature changes
          CALLBACK_REMOVALS=$(grep -P '^\-\s*-callback' /tmp/transport_behavior_diff.txt || true)

          if [ -n "$CALLBACK_REMOVALS" ]; then
            echo "❌ **BREAKING:** Transport callbacks modified" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$CALLBACK_REMOVALS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::error::BREAKING: Transport behavior callbacks changed"
            ((BREAKING_COUNT++))
          else
            echo "✅ Transport behavior stable" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 7: Message Framing Changes
          # =================================================================
          echo "### 7. Message Framing (BREAKING)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for changes to framing in transport implementations
          FRAMING_CHANGES=$(git diff ${BASE_REF}..HEAD -- apps/erlmcp_transports/src/ | grep -E '(line-delimited|newline|\\n|json.*parse)' | grep '^[-+]' || true)

          if [ -n "$FRAMING_CHANGES" ]; then
            echo "⚠️ **WARNING:** Message framing logic modified" >> $GITHUB_STEP_SUMMARY
            echo "Review for breaking changes in transport framing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Message framing logic changed - manual review required"
          else
            echo "✅ Message framing unchanged" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # CHECK 8: Message Size Limits
          # =================================================================
          echo "### 8. Message Size Limits (BREAKING)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          git diff ${BASE_REF}..HEAD -- apps/erlmcp_core/src/erlmcp_message_size.erl > /tmp/size_diff.txt

          # Check for changes to 16 MB limit
          SIZE_LIMIT_CHANGES=$(grep -E '16.*1024.*1024|16777216' /tmp/size_diff.txt | grep '^[-]' || true)

          if [ -n "$SIZE_LIMIT_CHANGES" ]; then
            echo "❌ **BREAKING:** Message size limit changed" >> $GITHUB_STEP_SUMMARY
            echo "MCP spec requires 16 MB default limit" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::error::BREAKING: Message size limit changed from spec default"
            ((BREAKING_COUNT++))
          else
            echo "✅ Message size limit compliant (16 MB)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # =================================================================
          # Final Summary
          # =================================================================
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $BREAKING_COUNT -eq 0 ]; then
            echo "✅ **No breaking changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All API surface changes are backward compatible." >> $GITHUB_STEP_SUMMARY
            echo "has_breaking=false" >> $GITHUB_OUTPUT
            echo "breaking_count=0" >> $GITHUB_OUTPUT
          else
            echo "❌ **${BREAKING_COUNT} breaking changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Actions Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review all breaking changes above" >> $GITHUB_STEP_SUMMARY
            echo "2. Update CHANGELOG.md with BREAKING CHANGE notices" >> $GITHUB_STEP_SUMMARY
            echo "3. Bump MAJOR version (SemVer)" >> $GITHUB_STEP_SUMMARY
            echo "4. Document migration guide" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "has_breaking=true" >> $GITHUB_OUTPUT
            echo "breaking_count=${BREAKING_COUNT}" >> $GITHUB_OUTPUT
            echo "::error::${BREAKING_COUNT} breaking changes detected"
          fi

          echo "::endgroup::"

  # =============================================================================
  # Version Bump Validation
  # =============================================================================
  version-bump-check:
    name: Version Bump Validation
    runs-on: ubuntu-latest
    needs: api-surface-analysis
    if: needs.api-surface-analysis.outputs.has_breaking_changes == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version bump
        run: |
          echo "::group::Version Bump Validation"

          # Get current version
          CURRENT_VERSION=$(grep -oP '{vsn,\s*"\K[^"]+' apps/erlmcp_core/src/erlmcp.app.src)

          # Get previous version from base branch
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          PREVIOUS_VERSION=$(git show origin/${{ github.base_ref }}:apps/erlmcp_core/src/erlmcp.app.src | grep -oP '{vsn,\s*"\K[^"]+')

          echo "Previous version: ${PREVIOUS_VERSION}"
          echo "Current version: ${CURRENT_VERSION}"

          # Parse versions
          PREV_MAJOR=$(echo $PREVIOUS_VERSION | cut -d. -f1)
          PREV_MINOR=$(echo $PREVIOUS_VERSION | cut -d. -f2)
          PREV_PATCH=$(echo $PREVIOUS_VERSION | cut -d. -f3)

          CURR_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          CURR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          CURR_PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

          echo "## Version Bump Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Breaking changes detected:** ${{ needs.api-surface-analysis.outputs.breaking_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Version | Previous | Current |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Full | ${PREVIOUS_VERSION} | ${CURRENT_VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Major | ${PREV_MAJOR} | ${CURR_MAJOR} |" >> $GITHUB_STEP_SUMMARY
          echo "| Minor | ${PREV_MINOR} | ${CURR_MINOR} |" >> $GITHUB_STEP_SUMMARY
          echo "| Patch | ${PREV_PATCH} | ${CURR_PATCH} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validate major version bump for breaking changes
          if [ "$CURR_MAJOR" -le "$PREV_MAJOR" ]; then
            echo "❌ **INVALID VERSION BUMP**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Breaking changes require MAJOR version bump (SemVer 2.0.0)" >> $GITHUB_STEP_SUMMARY
            echo "Expected: ${PREV_MAJOR}.X.X → $((PREV_MAJOR + 1)).0.0" >> $GITHUB_STEP_SUMMARY
            echo "::error::Breaking changes require MAJOR version bump"
            echo "::endgroup::"
            exit 1
          fi

          echo "✅ **VALID VERSION BUMP**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Major version bumped correctly for breaking changes." >> $GITHUB_STEP_SUMMARY

          echo "::endgroup::"

  # =============================================================================
  # CHANGELOG Validation
  # =============================================================================
  changelog-check:
    name: CHANGELOG Breaking Change Notice
    runs-on: ubuntu-latest
    needs: api-surface-analysis
    if: needs.api-surface-analysis.outputs.has_breaking_changes == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Validate CHANGELOG.md
        run: |
          echo "::group::CHANGELOG Validation"

          if [ ! -f "CHANGELOG.md" ]; then
            echo "::error::CHANGELOG.md not found"
            echo "❌ CHANGELOG.md must exist" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check for BREAKING CHANGE notice
          if grep -iq "BREAKING CHANGE" CHANGELOG.md; then
            echo "✅ BREAKING CHANGE documented in CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **BREAKING CHANGE not documented**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Add BREAKING CHANGE section to CHANGELOG.md:" >> $GITHUB_STEP_SUMMARY
            echo '```markdown' >> $GITHUB_STEP_SUMMARY
            echo "## [X.0.0] - YYYY-MM-DD" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### BREAKING CHANGES" >> $GITHUB_STEP_SUMMARY
            echo "- Description of breaking change" >> $GITHUB_STEP_SUMMARY
            echo "- Migration guide" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::CHANGELOG.md missing BREAKING CHANGE notice"
            exit 1
          fi

          echo "::endgroup::"

  # =============================================================================
  # Breaking Change Gate - BLOCKING
  # =============================================================================
  breaking-change-gate:
    name: Breaking Change Quality Gate
    runs-on: ubuntu-latest
    needs: [api-surface-analysis, version-bump-check, changelog-check]
    if: always()
    steps:
      - name: Evaluate gate
        run: |
          echo "::group::Breaking Change Gate"

          HAS_BREAKING="${{ needs.api-surface-analysis.outputs.has_breaking_changes }}"
          BREAKING_COUNT="${{ needs.api-surface-analysis.outputs.breaking_count }}"

          echo "## Breaking Change Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_BREAKING" = "false" ]; then
            echo "✅ **No breaking changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All changes are backward compatible." >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **${BREAKING_COUNT} breaking changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| API Analysis | ❌ Breaking |" >> $GITHUB_STEP_SUMMARY
            echo "| Version Bump | ${{ needs.version-bump-check.result == 'success' && '✅ Valid' || '❌ Invalid' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| CHANGELOG | ${{ needs.changelog-check.result == 'success' && '✅ Documented' || '❌ Missing' }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.version-bump-check.result }}" = "success" ] && \
               [ "${{ needs.changelog-check.result }}" = "success" ]; then
              echo "✅ **Breaking changes properly handled**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- Major version bumped" >> $GITHUB_STEP_SUMMARY
              echo "- CHANGELOG documented" >> $GITHUB_STEP_SUMMARY
              echo "- Ready for review" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Breaking change validation FAILED**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Fix the following before merging:" >> $GITHUB_STEP_SUMMARY
              if [ "${{ needs.version-bump-check.result }}" != "success" ]; then
                echo "- Bump MAJOR version" >> $GITHUB_STEP_SUMMARY
              fi
              if [ "${{ needs.changelog-check.result }}" != "success" ]; then
                echo "- Document in CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
              fi
              echo "::endgroup::"
              exit 1
            fi
          fi

          echo "::endgroup::"
