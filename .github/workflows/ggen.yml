name: ggen Validation & Generation

on:
  push:
    paths:
      - 'ggen/**'
  pull_request:
    paths:
      - 'ggen/**'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Ontologies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate ggen
        run: |
          docker compose run --rm ggen ggen validate

  generate:
    name: Generate Code
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate from ontologies
        run: |
          docker compose run --rm ggen ggen sync

      - name: Check generated files
        run: |
          if [ -d "ggen/src/generated" ]; then
            echo "Generated files:"
            find ggen/src/generated -type f | head -20
          fi

  compile:
    name: Compile Generated Code
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate code
        run: docker compose run --rm ggen ggen sync

      - name: Compile
        run: docker compose run --rm erlmcp-build

  test:
    name: Test Generated Code
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate code
        run: docker compose run --rm ggen ggen sync

      - name: Compile
        run: docker compose run --rm erlmcp-build

      - name: Test
        run: docker compose run --rm erlmcp-unit
