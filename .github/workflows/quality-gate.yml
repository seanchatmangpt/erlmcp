name: Quality Gate

on:
  push:
    branches: [main, 'release/**', 'feature/**', 'task/**', 'epic/**']
  pull_request:
    branches: [main, 'release/**', 'feature/**', 'task/**', 'epic/**']

jobs:
  comprehensive-quality-check:
    name: Comprehensive Quality Gate (Blocking)
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comparison

    - name: Setup Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: 26
        rebar3-version: '3.25'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/rebar3
          _build
        key: quality-gate-${{ runner.os }}-${{ hashFiles('rebar.lock', 'apps/*/rebar.config') }}
        restore-keys: |
          quality-gate-${{ runner.os }}-

    # ========================================================================
    # GATE 1: COMPILATION (MANDATORY)
    # ========================================================================
    - name: Gate 1 - Compilation
      id: gate_compile
      run: |
        echo "::group::Gate 1: Compilation"
        echo "Status: MANDATORY BLOCKING GATE"
        echo "Requirement: Zero compilation errors"
        echo ""

        TERM=dumb rebar3 compile 2>&1 | tee compile.log
        COMPILE_EXIT=${PIPESTATUS[0]}

        # Count warnings and errors
        WARNINGS=$(grep -c "Warning:" compile.log || echo 0)
        ERRORS=$(grep -c "Error:" compile.log || echo 0)

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”¨ Gate 1: Compilation" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $( [ $COMPILE_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âŒ FAILED' )" >> $GITHUB_STEP_SUMMARY
        echo "- Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
        echo "- Warnings: $WARNINGS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

        if [ $COMPILE_EXIT -ne 0 ]; then
          echo "::error::Compilation FAILED with $ERRORS errors - MERGE BLOCKED"
          echo "gate_compile=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "gate_compile=passed" >> $GITHUB_OUTPUT

    # ========================================================================
    # GATE 2: XREF (MANDATORY)
    # ========================================================================
    - name: Gate 2 - Cross-Reference Analysis (Xref)
      id: gate_xref
      run: |
        echo "::group::Gate 2: Xref"
        echo "Status: MANDATORY BLOCKING GATE"
        echo "Requirement: Zero undefined function calls"
        echo ""

        rebar3 xref 2>&1 | tee xref.log
        XREF_EXIT=${PIPESTATUS[0]}

        UNDEFINED=$(grep -c "undefined function" xref.log || echo 0)

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Gate 2: Cross-Reference (Xref)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $( [ $XREF_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âŒ FAILED' )" >> $GITHUB_STEP_SUMMARY
        echo "- Undefined functions: $UNDEFINED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

        if [ $XREF_EXIT -ne 0 ]; then
          echo "::error::Xref FAILED with $UNDEFINED undefined functions - MERGE BLOCKED"
          echo "gate_xref=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "gate_xref=passed" >> $GITHUB_OUTPUT

    # ========================================================================
    # GATE 3: DIALYZER (MANDATORY)
    # ========================================================================
    - name: Gate 3 - Type Checking (Dialyzer)
      id: gate_dialyzer
      run: |
        echo "::group::Gate 3: Dialyzer"
        echo "Status: MANDATORY BLOCKING GATE"
        echo "Requirement: Zero type errors"
        echo ""

        rebar3 dialyzer 2>&1 | tee dialyzer.log
        DIALYZER_EXIT=${PIPESTATUS[0]}

        TYPE_ERRORS=$(grep -c "dialyzer: Analysis failed" dialyzer.log || echo 0)
        WARNINGS=$(grep -c "Warning:" dialyzer.log || echo 0)

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Gate 3: Type Checking (Dialyzer)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $( [ $DIALYZER_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âŒ FAILED' )" >> $GITHUB_STEP_SUMMARY
        echo "- Type errors: $TYPE_ERRORS" >> $GITHUB_STEP_SUMMARY
        echo "- Warnings: $WARNINGS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

        if [ $DIALYZER_EXIT -ne 0 ]; then
          echo "::error::Dialyzer FAILED - MERGE BLOCKED"
          echo "gate_dialyzer=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "gate_dialyzer=passed" >> $GITHUB_OUTPUT

    # ========================================================================
    # GATE 4: UNIT TESTS (MANDATORY - â‰¥90% pass rate)
    # ========================================================================
    - name: Gate 4 - Unit Tests (EUnit)
      id: gate_eunit
      run: |
        echo "::group::Gate 4: Unit Tests"
        echo "Status: MANDATORY BLOCKING GATE"
        echo "Requirement: â‰¥90% pass rate"
        echo ""

        rebar3 as test do compile, eunit --cover 2>&1 | tee eunit.log
        EUNIT_EXIT=${PIPESTATUS[0]}

        PASSED=$(grep -c "Test passed" eunit.log || echo 0)
        FAILED=$(grep -c "Test failed" eunit.log || echo 0)
        TOTAL=$((PASSED + FAILED))

        if [ $TOTAL -gt 0 ]; then
          PASS_RATE=$(echo "scale=2; $PASSED * 100 / $TOTAL" | bc)
        else
          PASS_RATE="0"
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§ª Gate 4: Unit Tests (EUnit)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $( [ $EUNIT_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âŒ FAILED' )" >> $GITHUB_STEP_SUMMARY
        echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
        echo "- Pass Rate: ${PASS_RATE}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

        # Require â‰¥90% pass rate
        if [ $EUNIT_EXIT -ne 0 ] || [ $(echo "$PASS_RATE < 90" | bc) -eq 1 ]; then
          echo "::error::Unit tests FAILED (pass rate: ${PASS_RATE}%) - MERGE BLOCKED"
          echo "gate_eunit=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "gate_eunit=passed" >> $GITHUB_OUTPUT

    # ========================================================================
    # GATE 5: CODE COVERAGE (MANDATORY - â‰¥80%)
    # ========================================================================
    - name: Gate 5 - Code Coverage
      id: gate_coverage
      run: |
        echo "::group::Gate 5: Code Coverage"
        echo "Status: MANDATORY BLOCKING GATE"
        echo "Requirement: â‰¥80% overall coverage"
        echo ""

        rebar3 cover --verbose

        if [ -f scripts/check_coverage_threshold.sh ]; then
          chmod +x scripts/check_coverage_threshold.sh
          ./scripts/check_coverage_threshold.sh 80
          COVERAGE_EXIT=$?

          # Extract coverage percentage
          if [ -f _build/test/cover/cover.log ]; then
            COVERAGE=$(grep "total" _build/test/cover/cover.log | tail -1 | awk -F'|' '{print $3}' | tr -d ' %|' || echo "0")
          else
            COVERAGE="0"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Gate 5: Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $( [ $COVERAGE_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âŒ FAILED' )" >> $GITHUB_STEP_SUMMARY
          echo "- Overall Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "- Threshold: â‰¥80%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "::endgroup::"

          if [ $COVERAGE_EXIT -ne 0 ]; then
            echo "::error::Coverage ${COVERAGE}% below 80% threshold - MERGE BLOCKED"
            echo "gate_coverage=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "gate_coverage=passed" >> $GITHUB_OUTPUT
        else
          echo "::warning::Coverage script not found - Gate skipped"
          echo "gate_coverage=skipped" >> $GITHUB_OUTPUT
        fi

    # ========================================================================
    # GATE 6: QUALITY GATE INTEGRATION TESTS (MANDATORY)
    # ========================================================================
    - name: Gate 6 - Quality Gate Integration Tests
      id: gate_quality_integration
      run: |
        echo "::group::Gate 6: Quality Gate Integration Tests"
        echo "Status: MANDATORY BLOCKING GATE"
        echo "Requirement: All 35 integration tests pass"
        echo ""

        # Run quality gate integration tests (4 suites, 35 tests total)
        rebar3 ct --suite=test/quality_gates_SUITE,test/hooks_integration_SUITE,test/regression_detection_SUITE,test/auto_fix_SUITE --cover 2>&1 | tee quality_integration.log
        CT_EXIT=${PIPESTATUS[0]}

        # Parse test results
        PASSED=$(grep -oP "(\d+) ok," quality_integration.log | grep -oP "\d+" || echo 0)
        FAILED=$(grep -oP "(\d+) failed," quality_integration.log | grep -oP "\d+" || echo 0)
        TOTAL=$((PASSED + FAILED))

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Gate 6: Quality Gate Integration Tests" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $( [ $CT_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âŒ FAILED' )" >> $GITHUB_STEP_SUMMARY
        echo "- Test suites: 4 (quality_gates, hooks_integration, regression_detection, auto_fix)" >> $GITHUB_STEP_SUMMARY
        echo "- Total tests: $TOTAL" >> $GITHUB_STEP_SUMMARY
        echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

        if [ $CT_EXIT -ne 0 ]; then
          echo "::error::Quality gate integration tests FAILED - MERGE BLOCKED"
          echo "::error::These tests verify the quality gate enforcement system itself"
          echo "gate_quality_integration=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "gate_quality_integration=passed" >> $GITHUB_OUTPUT

    # ========================================================================
    # GATE 7: GENERAL INTEGRATION TESTS (OPTIONAL)
    # ========================================================================
    - name: Gate 7 - General Integration Tests (CT)
      id: gate_ct
      continue-on-error: true
      run: |
        echo "::group::Gate 7: General Integration Tests"
        echo "Status: OPTIONAL (non-blocking)"
        echo ""

        rebar3 ct --dir=test/integration --cover 2>&1 | tee ct.log
        CT_EXIT=${PIPESTATUS[0]}

        SUITES=$(grep -c "SUITE" ct.log || echo 0)

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Gate 7: General Integration Tests (CT)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $( [ $CT_EXIT -eq 0 ] && echo 'âœ… PASSED' || echo 'âš ï¸ WARNING' ) (non-blocking)" >> $GITHUB_STEP_SUMMARY
        echo "- Test suites: $SUITES" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

        if [ $CT_EXIT -ne 0 ]; then
          echo "::warning::General integration tests had issues (non-blocking)"
          echo "gate_ct=warning" >> $GITHUB_OUTPUT
        else
          echo "gate_ct=passed" >> $GITHUB_OUTPUT
        fi

    # ========================================================================
    # FINAL STATUS CHECK
    # ========================================================================
    - name: Generate Final Quality Gate Report
      if: always()
      run: |
        echo "# ðŸš¦ Quality Gate Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Blocking Gates (MUST PASS)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Compilation
        COMPILE_STATUS="${{ steps.gate_compile.outputs.gate_compile }}"
        echo "1. **Compilation:** $( [ "$COMPILE_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âŒ FAILED - BLOCKING' )" >> $GITHUB_STEP_SUMMARY

        # Xref
        XREF_STATUS="${{ steps.gate_xref.outputs.gate_xref }}"
        echo "2. **Xref:** $( [ "$XREF_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âŒ FAILED - BLOCKING' )" >> $GITHUB_STEP_SUMMARY

        # Dialyzer
        DIALYZER_STATUS="${{ steps.gate_dialyzer.outputs.gate_dialyzer }}"
        echo "3. **Dialyzer:** $( [ "$DIALYZER_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âŒ FAILED - BLOCKING' )" >> $GITHUB_STEP_SUMMARY

        # EUnit
        EUNIT_STATUS="${{ steps.gate_eunit.outputs.gate_eunit }}"
        echo "4. **Unit Tests (â‰¥90%):** $( [ "$EUNIT_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âŒ FAILED - BLOCKING' )" >> $GITHUB_STEP_SUMMARY

        # Coverage
        COVERAGE_STATUS="${{ steps.gate_coverage.outputs.gate_coverage }}"
        echo "5. **Coverage (â‰¥80%):** $( [ "$COVERAGE_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âŒ FAILED - BLOCKING' )" >> $GITHUB_STEP_SUMMARY

        # Quality Gate Integration Tests
        QUALITY_INTEGRATION_STATUS="${{ steps.gate_quality_integration.outputs.gate_quality_integration }}"
        echo "6. **Quality Gate Integration Tests:** $( [ "$QUALITY_INTEGRATION_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âŒ FAILED - BLOCKING' )" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Non-Blocking Gates" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # General Integration Tests
        CT_STATUS="${{ steps.gate_ct.outputs.gate_ct }}"
        echo "7. **General Integration Tests:** $( [ "$CT_STATUS" = "passed" ] && echo 'âœ… PASSED' || echo 'âš ï¸ WARNING' )" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        # Final decision
        if [ "$COMPILE_STATUS" = "passed" ] && [ "$XREF_STATUS" = "passed" ] && \
           [ "$DIALYZER_STATUS" = "passed" ] && [ "$EUNIT_STATUS" = "passed" ] && \
           [ "$COVERAGE_STATUS" = "passed" ] && [ "$QUALITY_INTEGRATION_STATUS" = "passed" ]; then
          echo "## âœ… RESULT: ALL GATES PASSED - MERGE ALLOWED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR meets all mandatory quality requirements and is approved for merge." >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "## âŒ RESULT: QUALITY GATES FAILED - MERGE BLOCKED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Fix the failing gates and re-push." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Gates:" >> $GITHUB_STEP_SUMMARY
          [ "$COMPILE_STATUS" != "passed" ] && echo "- âŒ Compilation" >> $GITHUB_STEP_SUMMARY
          [ "$XREF_STATUS" != "passed" ] && echo "- âŒ Xref" >> $GITHUB_STEP_SUMMARY
          [ "$DIALYZER_STATUS" != "passed" ] && echo "- âŒ Dialyzer" >> $GITHUB_STEP_SUMMARY
          [ "$EUNIT_STATUS" != "passed" ] && echo "- âŒ Unit Tests" >> $GITHUB_STEP_SUMMARY
          [ "$COVERAGE_STATUS" != "passed" ] && echo "- âŒ Coverage" >> $GITHUB_STEP_SUMMARY
          [ "$QUALITY_INTEGRATION_STATUS" != "passed" ] && echo "- âŒ Quality Gate Integration Tests" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Upload quality gate logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: quality-gate-logs
        path: |
          compile.log
          xref.log
          dialyzer.log
          eunit.log
          quality_integration.log
          ct.log
          _build/test/cover/
          _build/test/logs/
        retention-days: 30

    - name: Set commit status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const compile = '${{ steps.gate_compile.outputs.gate_compile }}';
          const xref = '${{ steps.gate_xref.outputs.gate_xref }}';
          const dialyzer = '${{ steps.gate_dialyzer.outputs.gate_dialyzer }}';
          const eunit = '${{ steps.gate_eunit.outputs.gate_eunit }}';
          const coverage = '${{ steps.gate_coverage.outputs.gate_coverage }}';
          const qualityIntegration = '${{ steps.gate_quality_integration.outputs.gate_quality_integration }}';

          const allPassed = compile === 'passed' && xref === 'passed' &&
                           dialyzer === 'passed' && eunit === 'passed' &&
                           coverage === 'passed' && qualityIntegration === 'passed';

          const state = allPassed ? 'success' : 'failure';
          const description = allPassed ?
            'All quality gates passed' :
            'One or more quality gates failed';

          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: state,
            context: 'Quality Gate',
            description: description,
            target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
          });
