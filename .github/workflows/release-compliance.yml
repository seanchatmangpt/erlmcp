name: Release & Versioning Compliance

on:
  push:
    branches: ['release/**']
    tags: ['v*']
  pull_request:
    branches: ['release/**']
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to validate (e.g., 2.2.0)'
        required: true
        type: string
      protocol_version:
        description: 'MCP protocol version (e.g., 2025-11-25)'
        required: true
        type: string
        default: '2025-11-25'

env:
  MCP_PROTOCOL_VERSION: '2025-11-25'
  ERLMCP_CURRENT_VERSION: '2.1.0'

jobs:
  # =============================================================================
  # Version Consistency Validation
  # =============================================================================
  version-consistency:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    outputs:
      erlmcp_version: ${{ steps.extract.outputs.erlmcp_version }}
      protocol_version: ${{ steps.extract.outputs.protocol_version }}
      version_consistent: ${{ steps.validate.outputs.consistent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract versions from codebase
        id: extract
        run: |
          echo "::group::Extracting Version Information"

          # Extract erlmcp version from app.src
          ERLMCP_VERSION=$(grep -oP '{vsn,\s*"\K[^"]+' apps/erlmcp_core/src/erlmcp.app.src || echo "UNKNOWN")
          echo "erlmcp_version=${ERLMCP_VERSION}" >> $GITHUB_OUTPUT
          echo "Found erlmcp version: ${ERLMCP_VERSION}"

          # Extract protocol version from multiple sources
          PROTOCOL_JSON_RPC=$(grep -oP '2025-\d{2}-\d{2}' apps/erlmcp_core/src/erlmcp_json_rpc.erl | head -1 || echo "UNKNOWN")
          PROTOCOL_CAPABILITIES=$(grep -oP '2025-\d{2}-\d{2}' apps/erlmcp_core/src/erlmcp_capabilities.erl | head -1 || echo "UNKNOWN")

          echo "protocol_version=${PROTOCOL_JSON_RPC}" >> $GITHUB_OUTPUT
          echo "Found protocol version: ${PROTOCOL_JSON_RPC}"

          # Extract from CHANGELOG if exists
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG_VERSION=$(grep -oP '##\s*\[\K[^\]]+' CHANGELOG.md | head -1 || echo "UNKNOWN")
            echo "Changelog version: ${CHANGELOG_VERSION}"
            echo "changelog_version=${CHANGELOG_VERSION}" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      - name: Validate version consistency
        id: validate
        run: |
          echo "::group::Validating Version Consistency"

          ERLMCP_VERSION="${{ steps.extract.outputs.erlmcp_version }}"
          PROTOCOL_VERSION="${{ steps.extract.outputs.protocol_version }}"

          echo "## Version Consistency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          ERRORS=0

          # Check erlmcp version format (SemVer)
          if [[ "$ERLMCP_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "| erlmcp Version | ${ERLMCP_VERSION} | ✅ Valid SemVer |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| erlmcp Version | ${ERLMCP_VERSION} | ❌ Invalid SemVer |" >> $GITHUB_STEP_SUMMARY
            ((ERRORS++))
          fi

          # Check protocol version format (YYYY-MM-DD)
          if [[ "$PROTOCOL_VERSION" =~ ^2025-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$ ]]; then
            echo "| MCP Protocol | ${PROTOCOL_VERSION} | ✅ Valid Format |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MCP Protocol | ${PROTOCOL_VERSION} | ❌ Invalid Format |" >> $GITHUB_STEP_SUMMARY
            ((ERRORS++))
          fi

          # Verify protocol version matches expected
          if [ "$PROTOCOL_VERSION" = "${{ env.MCP_PROTOCOL_VERSION }}" ]; then
            echo "| Protocol Match | ${PROTOCOL_VERSION} | ✅ Matches Expected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Protocol Match | Expected: ${{ env.MCP_PROTOCOL_VERSION }}, Got: ${PROTOCOL_VERSION} | ⚠️ Mismatch |" >> $GITHUB_STEP_SUMMARY
            ((ERRORS++))
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $ERRORS -eq 0 ]; then
            echo "consistent=true" >> $GITHUB_OUTPUT
            echo "✅ All version checks passed"
            echo "**Result:** ✅ CONSISTENT" >> $GITHUB_STEP_SUMMARY
          else
            echo "consistent=false" >> $GITHUB_OUTPUT
            echo "::error::Version consistency check failed with $ERRORS errors"
            echo "**Result:** ❌ INCONSISTENT ($ERRORS errors)" >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            exit 1
          fi

          echo "::endgroup::"

  # =============================================================================
  # Protocol Version Declaration Validation
  # =============================================================================
  protocol-version-check:
    name: Protocol Version Declaration
    runs-on: ubuntu-latest
    needs: version-consistency
    steps:
      - uses: actions/checkout@v4

      - name: Verify protocol version in all required files
        run: |
          echo "::group::Protocol Version Declaration Check"

          EXPECTED_VERSION="${{ env.MCP_PROTOCOL_VERSION }}"
          echo "Expected protocol version: ${EXPECTED_VERSION}"

          REQUIRED_FILES=(
            "apps/erlmcp_core/src/erlmcp_json_rpc.erl"
            "apps/erlmcp_core/src/erlmcp_capabilities.erl"
            "apps/erlmcp_core/src/erlmcp_client.erl"
            "apps/erlmcp_core/src/erlmcp_server.erl"
          )

          echo "## Protocol Version Declaration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Expected: **${EXPECTED_VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status | Found Version |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------------|" >> $GITHUB_STEP_SUMMARY

          ERRORS=0

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              if grep -q "${EXPECTED_VERSION}" "$file"; then
                FOUND_VERSION=$(grep -oP '2025-\d{2}-\d{2}' "$file" | head -1)
                echo "| ${file##*/} | ✅ PASS | ${FOUND_VERSION} |" >> $GITHUB_STEP_SUMMARY
                echo "✅ ${file##*/}: Found ${EXPECTED_VERSION}"
              else
                echo "| ${file##*/} | ❌ FAIL | Not found |" >> $GITHUB_STEP_SUMMARY
                echo "::error::Protocol version ${EXPECTED_VERSION} not found in $file"
                ((ERRORS++))
              fi
            else
              echo "| ${file##*/} | ⚠️ SKIP | File missing |" >> $GITHUB_STEP_SUMMARY
              echo "::warning::File not found: $file"
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $ERRORS -eq 0 ]; then
            echo "**Result:** ✅ All files declare correct protocol version" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Result:** ❌ $ERRORS files missing protocol version" >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            exit 1
          fi

          echo "::endgroup::"

  # =============================================================================
  # Backward Compatibility Detection
  # =============================================================================
  backward-compatibility:
    name: Backward Compatibility Check
    runs-on: ubuntu-latest
    needs: version-consistency
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect capability changes
        id: capabilities
        run: |
          echo "::group::Capability Changes Detection"

          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "::warning::No previous tag found, skipping backward compatibility check"
            echo "capabilities_status=skipped" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          echo "Comparing against: ${LAST_TAG}"

          # Check for capability removals
          git diff ${LAST_TAG}..HEAD -- apps/erlmcp_core/src/erlmcp_capabilities.erl > /tmp/cap_diff.txt

          # Look for removed capabilities
          REMOVED_CAPS=$(grep -P '^\-\s*<<"(tools|resources|prompts|sampling|logging|tasks|completion|roots)"' /tmp/cap_diff.txt || true)

          if [ -n "$REMOVED_CAPS" ]; then
            echo "::error::BREAKING CHANGE DETECTED: Capabilities removed"
            echo "$REMOVED_CAPS"
            echo "## ❌ BACKWARD COMPATIBILITY BROKEN" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Removed Capabilities:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$REMOVED_CAPS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "capabilities_status=broken" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

          # Check for new capabilities (backward compatible)
          ADDED_CAPS=$(grep -P '^\+\s*<<"(tools|resources|prompts|sampling|logging|tasks|completion|roots)"' /tmp/cap_diff.txt || true)

          if [ -n "$ADDED_CAPS" ]; then
            echo "✅ New capabilities added (backward compatible):"
            echo "$ADDED_CAPS"
            echo "## ✅ Backward Compatible Additions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**New Capabilities:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$ADDED_CAPS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "capabilities_status=compatible" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Detect error code changes
        id: error_codes
        run: |
          echo "::group::Error Code Changes Detection"

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "::warning::No previous tag found, skipping"
            echo "error_codes_status=skipped" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Check error code definitions
          git diff ${LAST_TAG}..HEAD -- apps/erlmcp_core/src/erlmcp_errors.erl apps/erlmcp_core/src/erlmcp_refusal.erl > /tmp/error_diff.txt

          # Look for removed error codes (breaking)
          REMOVED_ERRORS=$(grep -P '^\-\s*-define\(.*,\s*-?\d+\)' /tmp/error_diff.txt || true)

          if [ -n "$REMOVED_ERRORS" ]; then
            echo "::error::BREAKING CHANGE: Error codes removed"
            echo "$REMOVED_ERRORS"
            echo "## ❌ Error Code Breaking Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Removed Error Codes:**" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$REMOVED_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "error_codes_status=broken" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

          # Look for changed error code values (breaking)
          CHANGED_ERRORS=$(grep -P '^\+\s*-define\(' /tmp/error_diff.txt | while read -r line; do
            CODE_NAME=$(echo "$line" | grep -oP '-define\(\K[^,]+')
            if grep -q "^-.*-define(${CODE_NAME}," /tmp/error_diff.txt; then
              echo "$line"
            fi
          done || true)

          if [ -n "$CHANGED_ERRORS" ]; then
            echo "::error::BREAKING CHANGE: Error code values changed"
            echo "$CHANGED_ERRORS"
            echo "**Modified Error Codes:**" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$CHANGED_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "error_codes_status=broken" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

          echo "✅ Error codes backward compatible"
          echo "error_codes_status=compatible" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Detect transport interface changes
        id: transports
        run: |
          echo "::group::Transport Interface Changes"

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "::warning::No previous tag found, skipping"
            echo "transports_status=skipped" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Check transport behavior contract
          git diff ${LAST_TAG}..HEAD -- apps/erlmcp_transports/src/erlmcp_transport_behavior.erl > /tmp/transport_diff.txt

          # Look for callback signature changes (breaking)
          CALLBACK_CHANGES=$(grep -P '^\-\s*-callback' /tmp/transport_diff.txt || true)

          if [ -n "$CALLBACK_CHANGES" ]; then
            echo "::error::BREAKING CHANGE: Transport behavior callbacks changed"
            echo "$CALLBACK_CHANGES"
            echo "## ❌ Transport Breaking Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Modified Callbacks:**" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$CALLBACK_CHANGES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "transports_status=broken" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

          echo "✅ Transport interfaces backward compatible"
          echo "transports_status=compatible" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Generate compatibility report
        if: always()
        run: |
          cat > compatibility_report.md << 'EOF'
          # Backward Compatibility Analysis

          ## Summary

          | Component | Status |
          |-----------|--------|
          | Capabilities | ${{ steps.capabilities.outputs.capabilities_status }} |
          | Error Codes | ${{ steps.error_codes.outputs.error_codes_status }} |
          | Transports | ${{ steps.transports.outputs.transports_status }} |

          ## Backward Compatibility Rules

          ### ✅ Allowed (Backward Compatible)
          - Adding new capabilities
          - Adding new error codes
          - Adding new methods to capabilities
          - Adding optional fields to responses
          - Deprecating features (with warning period)

          ### ❌ Not Allowed (Breaking Changes)
          - Removing capabilities
          - Removing or changing error codes
          - Changing transport behavior callbacks
          - Removing required fields from requests
          - Changing method signatures

          ## MCP Specification Compliance

          Per MCP spec 2025-11-25:
          - Protocol version negotiation during `initialize` ensures compatibility
          - Clients MUST handle unknown capabilities gracefully
          - Error codes MUST remain stable within ranges
          - Transport framing MUST NOT change

          EOF

          cat compatibility_report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload compatibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backward-compatibility-report
          path: compatibility_report.md
          retention-days: 90

  # =============================================================================
  # Release Validation Checklist
  # =============================================================================
  release-checklist:
    name: Release Validation Checklist
    runs-on: ubuntu-latest
    needs: [version-consistency, protocol-version-check, backward-compatibility]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.0'
          rebar3-version: '3.24.0'

      - name: Validate release checklist
        run: |
          echo "::group::Release Validation Checklist"

          echo "## Release Validation Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Per MCP spec section 14 (Compliance Checklists)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CHECKLIST=(
            "CHANGELOG.md:Updated changelog"
            "apps/erlmcp_core/src/erlmcp.app.src:Version bumped"
            "README.md:Documentation updated"
            "rebar.config:Dependencies current"
          )

          PASSED=0
          FAILED=0

          echo "| Check | File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|--------|" >> $GITHUB_STEP_SUMMARY

          for item in "${CHECKLIST[@]}"; do
            FILE="${item%%:*}"
            DESC="${item##*:}"

            if [ -f "$FILE" ]; then
              # Check if file was modified in recent commits
              if git log --oneline -10 --name-only | grep -q "$(basename $FILE)"; then
                echo "| $DESC | $FILE | ✅ Updated |" >> $GITHUB_STEP_SUMMARY
                ((PASSED++))
              else
                echo "| $DESC | $FILE | ⚠️ Not updated |" >> $GITHUB_STEP_SUMMARY
                echo "::warning::$FILE may need updates for release"
              fi
            else
              echo "| $DESC | $FILE | ❌ Missing |" >> $GITHUB_STEP_SUMMARY
              ((FAILED++))
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:** $PASSED updated, $FAILED missing" >> $GITHUB_STEP_SUMMARY

          echo "::endgroup::"

      - name: Compile release build
        run: |
          echo "::group::Release Build"
          TERM=dumb rebar3 as prod compile
          echo "::endgroup::"

      - name: Run full test suite
        run: |
          echo "::group::Full Test Suite"
          rebar3 as test do eunit, ct
          echo "::endgroup::"

      - name: Generate release artifacts
        run: |
          echo "::group::Release Artifacts"

          # Create release directory
          mkdir -p _release

          # Generate version info
          cat > _release/version_info.txt << EOF
          erlmcp Version: ${{ needs.version-consistency.outputs.erlmcp_version }}
          MCP Protocol: ${{ needs.version-consistency.outputs.protocol_version }}
          Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          EOF

          # Create tarball
          rebar3 as prod tar

          echo "::endgroup::"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            _build/prod/rel/
            _release/
          retention-days: 90

  # =============================================================================
  # Release Gate - Final Validation
  # =============================================================================
  release-gate:
    name: Release Quality Gate
    runs-on: ubuntu-latest
    needs: [version-consistency, protocol-version-check, backward-compatibility, release-checklist]
    steps:
      - name: Evaluate release gate
        run: |
          echo "::group::Release Gate Evaluation"

          echo "## Release Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Consistency | ${{ needs.version-consistency.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Protocol Version | ${{ needs.protocol-version-check.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backward Compatibility | ${{ needs.backward-compatibility.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Checklist | ${{ needs.release-checklist.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.version-consistency.result }}" = "success" ] && \
             [ "${{ needs.protocol-version-check.result }}" = "success" ] && \
             [ "${{ needs.backward-compatibility.result }}" = "success" ] && \
             [ "${{ needs.release-checklist.result }}" = "success" ]; then
            echo "✅ **RELEASE APPROVED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All release validation gates passed. Release can proceed." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **RELEASE BLOCKED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more release gates failed. Fix issues before releasing." >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            exit 1
          fi

          echo "::endgroup::"
