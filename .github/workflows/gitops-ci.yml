name: GitOps CI Pipeline - erlmcp v3

on:
  push:
    branches: [main, develop, 'release/**', 'feature/**']
    tags: ['v*.*.*']
  pull_request:
    branches: [main, develop]

env:
  OTP_VERSION: '28'
  REBAR3_VERSION: '3.25.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # GATE 1: Compilation (BLOCKING)
  # ============================================================================
  compile:
    name: Compile (OTP ${{ matrix.otp_version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      otp_version: ${{ steps.otp.outputs.version }}
      compile_status: ${{ steps.compile.outputs.status }}

    strategy:
      matrix:
        otp_version: [27, 28]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Erlang/OTP
        id: otp
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-erlang-${{ matrix.otp_version }}-${{ hashFiles('rebar.lock') }}
          restore-keys: |
            ${{ runner.os }}-erlang-${{ matrix.otp_version }}-

      - name: Compile
        id: compile
        run: |
          echo "::group::Compiling with TERM=dumb"
          TERM=dumb rebar3 compile
          EXIT_CODE=$?
          echo "::endgroup::"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_ENV
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "status=failure" >> $GITHUB_ENV
            exit 1
          fi

      - name: Verify umbrella apps
        run: |
          for app in erlmcp_core erlmcp_transports erlmcp_observability erlmcp_validation erlmcp_zero_trust; do
            if [ -d "_build/default/lib/$app/ebin" ]; then
              echo "✓ $app compiled"
            else
              echo "::error::$app failed to compile"
              exit 1
            fi
          done

  # ============================================================================
  # GATE 2: Type Checking (Dialyzer) - BLOCKING
  # ============================================================================
  dialyzer:
    name: Dialyzer Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache PLT
        uses: actions/cache@v4
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-dialyzer-${{ env.OTP_VERSION }}-${{ hashFiles('rebar.lock') }}
          restore-keys: |
            ${{ runner.os }}-dialyzer-${{ env.OTP_VERSION }}-

      - name: Run Dialyzer
        run: |
          rebar3 dialyzer
        continue-on-error: false

  # ============================================================================
  # GATE 3: Xref (Cross-Reference) - BLOCKING
  # ============================================================================
  xref:
    name: Xref Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Run Xref
        run: |
          rebar3 xref

  # ============================================================================
  # GATE 4: Unit Tests (EUnit) - BLOCKING
  # ============================================================================
  eunit:
    name: EUnit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Run EUnit
        run: |
          rebar3 as test do compile, eunit --cover

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: eunit-coverage
          path: _build/test/cover/
          retention-days: 30

  # ============================================================================
  # GATE 5: Integration Tests (Common Test) - BLOCKING
  # ============================================================================
  ct:
    name: Common Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Run Common Test
        run: |
          rebar3 ct --cover

      - name: Upload CT logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ct-logs
          path: _build/test/ct_logs/
          retention-days: 30

  # ============================================================================
  # GATE 6: Property-Based Tests (Proper) - BLOCKING
  # ============================================================================
  proper:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Run Proper tests
        run: |
          rebar3 proper --cover
        continue-on-error: true

  # ============================================================================
  # GATE 7: Coverage Threshold (≥80%) - BLOCKING
  # ============================================================================
  coverage:
    name: Coverage Check (≥80%)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [eunit, ct]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Generate coverage report
        run: |
          rebar3 cover

      - name: Check coverage threshold
        run: |
          COVERAGE_FILE=$(find _build/test/cover -name "*.coverdata" | head -1)
          if [ -z "$COVERAGE_FILE" ]; then
            echo "::error::No coverage data found"
            exit 1
          fi

          # Parse coverage from cover.log
          rebar3 cover --verbose > coverage.txt
          COVERAGE_PERCENT=$(grep "total" coverage.txt | tail -1 | awk '{print $NF}' | sed 's/%//')

          if [ -z "$COVERAGE_PERCENT" ]; then
            COVERAGE_PERCENT=0
          fi

          echo "Coverage: ${COVERAGE_PERCENT}%"

          if [ "$COVERAGE_PERCENT" -lt 80 ]; then
            echo "::error::Coverage ${COVERAGE_PERCENT}% is below 80% threshold"
            exit 1
          fi

          echo "✓ Coverage ${COVERAGE_PERCENT}% meets threshold"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: _build/test/cover/
          retention-days: 30

  # ============================================================================
  # GATE 8: Security Scanning (Trivy) - BLOCKING
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for critical vulnerabilities
        run: |
          if grep -q '"severity":"CRITICAL"' trivy-results.sarif; then
            echo "::error::Critical vulnerabilities found"
            exit 1
          fi

  # ============================================================================
  # GATE 9: SBOM Generation (syft) - BLOCKING for release
  # ============================================================================
  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SBOM with syft
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

  # ============================================================================
  # GATE 10: License Compliance - BLOCKING
  # ============================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Check licenses
        run: |
          # Check for forbidden licenses
          rebar3 tree --format licenses > licenses.txt

          FORBIDDEN=("GPL" "AGPL")
          while IFS= read -r line; do
            for license in "${FORBIDDEN[@]}"; do
              if echo "$line" | grep -qi "$license"; then
                echo "::error::Forbidden license found: $line"
                exit 1
              fi
            done
          done < licenses.txt

          echo "✓ License check passed"

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.txt
          retention-days: 90

  # ============================================================================
  # Build Docker Image
  # ============================================================================
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [compile, dialyzer, xref, eunit, ct, coverage, security-scan, license-check]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            OTP_VERSION=${{ env.OTP_VERSION }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  # ============================================================================
  # Quality Gate Summary - BLOCKING
  # ============================================================================
  quality-gate:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [compile, dialyzer, xref, eunit, ct, coverage, security-scan, license-check, build-image]
    if: always()

    steps:
      - name: Evaluate quality gates
        run: |
          echo "## Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dialyzer | ${{ needs.dialyzer.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Xref | ${{ needs.xref.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EUnit | ${{ needs.eunit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Common Test | ${{ needs.ct.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage ≥80% | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Image | ${{ needs.build-image.result }} |" >> $GITHUB_STEP_SUMMARY

          # Block if any gate failed
          if [ "${{ needs.compile.result }}" != "success" ] || \
             [ "${{ needs.dialyzer.result }}" != "success" ] || \
             [ "${{ needs.xref.result }}" != "success" ] || \
             [ "${{ needs.eunit.result }}" != "success" ] || \
             [ "${{ needs.ct.result }}" != "success" ] || \
             [ "${{ needs.coverage.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.license-check.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## MERGE BLOCKED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ALL GATES PASSED - Ready for deployment" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Update GitOps Manifests
  # ============================================================================
  update-manifests:
    name: Update GitOps Manifests
    runs-on: ubuntu-latest
    needs: [build-image, quality-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "erlmcp-ci"
          git config --global user.email "ci@erlmcp.io"

      - name: Update image tag in Kustomize
        run: |
          cd gitops/overlays/production
          kustomize edit set image \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-image.outputs.image-tag }}

      - name: Commit manifests
        run: |
          git add gitops/overlays/production/
          git commit -m "chore: update image tag to ${{ needs.build-image.outputs.image-tag }}" \
            -m "Auto-generated by GitOps CI pipeline" \
            -m "Build: ${{ needs.build-image.outputs.image-digest }}"
          git push
