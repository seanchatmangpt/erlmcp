name: GCP Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'gcp/**'
      - '.github/workflows/gcp-deploy.yml'
      - 'Dockerfile'
      - 'src/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY_REPO: erlmcp-tai-repo
  GCP_PROJECT_ID: taiea-v1

jobs:
  validate:
    name: Validate GCP Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Validate Terraform configuration
        working-directory: gcp
        run: |
          terraform init -backend=false
          terraform validate
          echo "Terraform configuration is valid"

      - name: Check Terraform format
        working-directory: gcp
        run: |
          terraform fmt -check -recursive
          if [ $? -ne 0 ]; then
            echo "Terraform files need formatting"
            exit 1
          fi

      - name: Generate Terraform plan
        working-directory: gcp
        run: |
          terraform init -backend=false
          terraform plan -var-file=project.tfvars -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json
          cat tfplan.json | jq '.' > /tmp/tfplan_summary.txt
          echo "Terraform plan generated successfully"

      - name: Post plan to PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('/tmp/tfplan_summary.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan\n\`\`\`\n${plan}\n\`\`\``
            });

  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Terraform Plan
        working-directory: gcp
        run: |
          terraform init -backend=false
          terraform plan -var-file=project.tfvars -no-color -out=tfplan
          terraform show -no-color tfplan > plan.txt
          echo "Plan complete"

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: gcp/tfplan
          retention-days: 5

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('gcp/plan.txt', 'utf8');
            const maxChars = 30000;
            const truncatedPlan = plan.length > maxChars
              ? plan.substring(0, maxChars) + '\n... (truncated)'
              : plan;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan (GCP)\n\n\`\`\`terraform\n${truncatedPlan}\n\`\`\``
            });

  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write

    environment:
      name: production
      url: https://console.cloud.google.com/run?project=${{ env.GCP_PROJECT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init with Backend
        working-directory: gcp
        run: |
          terraform init \
            -backend-config='bucket=${{ env.GCP_PROJECT_ID }}-terraform-state' \
            -backend-config='prefix=prod'

      - name: Terraform Apply
        working-directory: gcp
        run: |
          terraform apply \
            -var-file=project.tfvars \
            -auto-approve \
            -no-color

      - name: Capture Terraform Outputs
        working-directory: gcp
        run: |
          terraform output -json > outputs.json
          echo "GCP_SERVICE_ACCOUNT_EMAIL=$(terraform output -raw service_account_email)" >> $GITHUB_ENV
          echo "ARTIFACT_REGISTRY_URL=$(terraform output -raw artifact_registry_repo_url)" >> $GITHUB_ENV

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: gcp/outputs.json
          retention-days: 30

      - name: Create Deployment Summary
        run: |
          cat > /tmp/deployment_summary.md << 'EOF'
          # GCP Infrastructure Deployment

          ## Status: SUCCESS

          ### Resources Created:
          - Service Account: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}
          - Artifact Registry: ${{ env.ARTIFACT_REGISTRY_URL }}
          - Cloud KMS Key Ring
          - Secret Manager (3 secrets)
          - Terraform State Bucket

          ### Next Steps:
          1. Populate secrets in Secret Manager
          2. Configure GitHub Action secrets
          3. Deploy containers to Cloud Run

          ### Resources:
          - [GCP Console](https://console.cloud.google.com/run?project=${{ env.GCP_PROJECT_ID }})
          - [Artifact Registry](https://console.cloud.google.com/artifacts?project=${{ env.GCP_PROJECT_ID }})
          - [Secret Manager](https://console.cloud.google.com/security/secret-manager?project=${{ env.GCP_PROJECT_ID }})
          EOF

      - name: Create GitHub Release
        uses: actions/create-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: gcp-deploy-${{ github.run_number }}
          release_name: GCP Infrastructure Deployed - Run ${{ github.run_number }}
          body_path: /tmp/deployment_summary.md
          draft: false
          prerelease: false

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Terraform Security Scan (tfsec)
        uses: aquasecurity/tfsec-action@v1
        with:
          working_directory: gcp
          version: latest
          args: --minimum-severity MEDIUM

      - name: Upload Security Report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Determine Status
        id: status
        run: |
          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "status=✅ GCP configuration validated successfully" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=❌ GCP configuration validation failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "title": "GCP Deployment",
                  "text": "${{ steps.status.outputs.status }}",
                  "fields": [
                    {
                      "title": "Project",
                      "value": "${{ env.GCP_PROJECT_ID }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View>",
                      "short": true
                    }
                  ]
                }
              ]
            }
