name: Security Audit

on:
  push:
    branches: [main, 'release/**', 'feature/**']
  pull_request:
    branches: [main, 'release/**']
  schedule:
    # Run security audit weekly on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

env:
  OTP_VERSION: '26'
  REBAR3_VERSION: '3.25'

jobs:
  # =============================================================================
  # JOB 1: Dependency Security Audit
  # =============================================================================
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-security-${{ hashFiles('rebar.lock') }}

      - name: Fetch dependencies
        run: rebar3 get-deps

      - name: Audit dependencies for known vulnerabilities
        id: audit
        run: |
          echo "::group::Dependency Security Audit"

          # Check rebar.lock for dependencies
          if [ -f "rebar.lock" ]; then
            echo "Auditing dependencies from rebar.lock..."

            # Extract packages and versions
            grep -E "^\s*{" rebar.lock | while read line; do
              PKG=$(echo "$line" | sed -E 's/.*\{([^,]+),.*/\1/' | tr -d '{}')
              echo "Checking package: $PKG"
            done

            echo "audit_status=completed" >> $GITHUB_OUTPUT
          else
            echo "No rebar.lock found"
            echo "audit_status=skipped" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      - name: Generate security report
        if: always()
        run: |
          echo "## Dependency Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.audit.outputs.audit_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependencies Audited" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "rebar.lock" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "^\s*{" rebar.lock | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # JOB 2: Secrets Scanning
  # =============================================================================
  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for hardcoded secrets
        id: secrets
        run: |
          echo "::group::Secrets Scanning"

          FOUND_SECRETS=false

          # Scan Erlang source files
          echo "Scanning Erlang source files..."
          if git ls-files '*.erl' '*.hrl' | xargs grep -nH -E '(password|secret|api_key|token|credential)\s*=\s*"[^"]+"' 2>/dev/null; then
            echo "::warning::Potential hardcoded secrets found in source files"
            FOUND_SECRETS=true
          fi

          # Scan configuration files
          echo "Scanning configuration files..."
          if git ls-files '*.config' 'rebar.config' | xargs grep -nH -E '(password|secret|api_key|token)\s*,' 2>/dev/null; then
            echo "::warning::Potential secrets found in configuration files"
            FOUND_SECRETS=true
          fi

          # Scan environment files
          echo "Scanning environment files..."
          if git ls-files '.env*' '*.env' | xargs cat 2>/dev/null | grep -E '(PASSWORD|SECRET|API_KEY|TOKEN)=' 2>/dev/null; then
            echo "::error::Secrets found in environment files (should not be committed)"
            FOUND_SECRETS=true
          fi

          echo "::endgroup::"

          if [ "$FOUND_SECRETS" = true ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "::warning::Potential secrets detected - review required"
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
            echo "✅ No secrets detected"
          fi

      - name: Generate secrets scan report
        if: always()
        run: |
          echo "## Secrets Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.secrets.outputs.secrets_found }}" = "true" ]; then
            echo "⚠️ **WARNING:** Potential secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "Ensure no actual secrets are committed to the repository." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **PASS:** No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # JOB 3: JOSE Security Tests (JWT/JWE/JWS)
  # =============================================================================
  jose-security:
    name: JOSE Security Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-jose-${{ hashFiles('rebar.lock') }}

      - name: Compile project
        run: TERM=dumb rebar3 compile

      - name: Run JOSE security tests
        id: jose
        run: |
          echo "::group::JOSE Security Tests"

          # Check if JOSE module exists
          if [ -f "apps/erlmcp_core/src/erlmcp_auth.erl" ]; then
            echo "Running JOSE-related tests..."
            rebar3 eunit --module=erlmcp_auth_tests || echo "JOSE tests not found or failed (non-fatal)"
          else
            echo "JOSE module not found, skipping tests"
          fi

          echo "jose_status=completed" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Generate JOSE security report
        if: always()
        run: |
          echo "## JOSE Security Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.jose.outputs.jose_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "JOSE (JSON Object Signing and Encryption) tests verify:" >> $GITHUB_STEP_SUMMARY
          echo "- JWT (JSON Web Token) signature validation" >> $GITHUB_STEP_SUMMARY
          echo "- JWE (JSON Web Encryption) security" >> $GITHUB_STEP_SUMMARY
          echo "- JWS (JSON Web Signature) integrity" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # JOB 4: Security Summary
  # =============================================================================
  security-summary:
    name: Security Audit Summary
    runs-on: ubuntu-22.04
    needs: [dependency-audit, secrets-scan, jose-security]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result == 'success' && '✅ PASS' || '⚠️ REVIEW' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JOSE Security | ${{ needs.jose-security.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.dependency-audit.result }}" = "success" ] && \
             [ "${{ needs.jose-security.result }}" = "success" ]; then
            echo "✅ **Overall Status:** PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Overall Status:** REVIEW REQUIRED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on critical issues
        if: needs.jose-security.result == 'failure'
        run: |
          echo "❌ Critical security tests failed"
          exit 1
