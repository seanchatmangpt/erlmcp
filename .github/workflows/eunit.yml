name: EUnit Tests with Chicago School TDD Compliance

on:
  push:
    branches: [main, develop, 'feature/**', 'task/**', 'epic/**', 'release/**']
    paths:
      - 'src/**'
      - 'test/**'
      - 'apps/*/src/**'
      - 'apps/*/test/**'
      - 'rebar.config'
      - 'Makefile'
      - '.github/workflows/eunit.yml'
  pull_request:
    branches: [main, develop, 'feature/**', 'task/**', 'epic/**', 'release/**']
    paths:
      - 'src/**'
      - 'test/**'
      - 'apps/*/src/**'
      - 'apps/*/test/**'
      - 'rebar.config'
      - 'Makefile'

env:
  OTP_VERSION: 26
  REBAR_VERSION: 3.25

jobs:
  eunit-tests:
    name: EUnit Tests - OTP ${{ matrix.otp_version }}
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    strategy:
      matrix:
        otp_version: [25, 26, 27, 28]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: ${{ matrix.otp_version >= 26 && '3.25' || '3.22' }}

      - name: Cache rebar3 dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-eunit-otp${{ matrix.otp_version }}-${{ hashFiles('rebar.lock', 'apps/*/rebar.config') }}
          restore-keys: |
            ${{ runner.os }}-eunit-otp${{ matrix.otp_version }}-
            ${{ runner.os }}-eunit-

      - name: Fetch dependencies
        run: rebar3 get-deps
        timeout-minutes: 5

      # ========================================================================
      # GATE 1: PRE-TEST COMPLIANCE CHECKS
      # ========================================================================
      - name: Chicago School Pre-Test Compliance Check
        id: pretest_compliance
        run: |
          echo "::group::Chicago School TDD Pre-Test Compliance"
          echo "Checking for test anti-patterns BEFORE running tests..."
          echo ""

          VIOLATIONS_FOUND=0
          VIOLATION_DETAILS=""

          # Check 1: Dummy process detection
          echo "### Check 1: Dummy Process Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DUMMY_PROCESSES=$(grep -r "spawn.*fun.*receive.*stop.*ok" apps/*/test/ test/ 2>/dev/null || echo "")
          if [ -n "$DUMMY_PROCESSES" ]; then
            echo "❌ VIOLATION: Dummy processes detected" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$DUMMY_PROCESSES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Dummy process pattern found - Use real erlmcp processes, not spawn/fun/receive/stop"
            VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}dummy_processes;"
          else
            echo "✅ No dummy processes found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check 2: State inspection via sys:get_status
          echo "### Check 2: State Inspection Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          STATE_INSPECTION=$(grep -r "sys:get_status" apps/*/test/ test/ 2>/dev/null || echo "")
          if [ -n "$STATE_INSPECTION" ]; then
            echo "❌ VIOLATION: State inspection detected" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$STATE_INSPECTION" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::State inspection via sys:get_status - Test observable behavior, not internal state"
            VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}state_inspection;"
          else
            echo "✅ No state inspection found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check 3: Record duplication (test-specific state records)
          echo "### Check 3: Record Duplication Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RECORD_DUP=$(grep -r "^-record(state," apps/*/test/ test/ 2>/dev/null || echo "")
          if [ -n "$RECORD_DUP" ]; then
            echo "❌ VIOLATION: Test-specific state records detected" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$RECORD_DUP" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Record duplication in tests - Use production records, don't define test-specific state"
            VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}record_duplication;"
          else
            echo "✅ No record duplication found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check 4: Mock detection (meck usage)
          echo "### Check 4: Mock Framework Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          MOCK_USAGE=$(grep -r "meck:" apps/*/test/ test/ 2>/dev/null || echo "")
          if [ -n "$MOCK_USAGE" ]; then
            echo "❌ VIOLATION: Mock framework usage detected" >> $GITHUB_STEP_SUMMARY
            echo '```erlang' >> $GITHUB_STEP_SUMMARY
            echo "$MOCK_USAGE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Mock framework (meck) usage - Use real erlmcp processes, not mocks"
            VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}mock_usage;"
          else
            echo "✅ No mock usage found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check 5: File size validation
          echo "### Check 5: Test File Size Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          OVERSIZED_FILES=""
          for test_file in $(find apps/*/test/ test/ -name "*_tests.erl" 2>/dev/null); do
            LINE_COUNT=$(wc -l < "$test_file" 2>/dev/null || echo 0)
            if [ "$LINE_COUNT" -gt 500 ]; then
              OVERSIZED_FILES="${OVERSIZED_FILES}${test_file}: ${LINE_COUNT} lines\n"
            fi
          done

          if [ -n "$OVERSIZED_FILES" ]; then
            echo "❌ VIOLATION: Test files exceeding 500 lines" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo -e "$OVERSIZED_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Test file(s) exceed 500 lines - Split into multiple test modules"
            VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}oversized_files;"
          else
            echo "✅ All test files under 500 lines" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary
          echo "## Pre-Test Compliance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $VIOLATIONS_FOUND -gt 0 ]; then
            echo "❌ **FAILED:** $VIOLATIONS_FOUND violation(s) detected" >> $GITHUB_STEP_SUMMARY
            echo "**Violations:** $VIOLATION_DETAILS" >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            echo "::error::Chicago School TDD pre-test compliance FAILED - $VIOLATIONS_FOUND violation(s)"
            echo "pretest_compliance=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "✅ **PASSED:** No anti-patterns detected" >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            echo "pretest_compliance=passed" >> $GITHUB_OUTPUT
          fi

      # ========================================================================
      # GATE 2: COMPILATION
      # ========================================================================
      - name: Compile project
        id: compile
        run: |
          echo "::group::Compilation"
          TERM=dumb rebar3 compile
          COMPILE_EXIT=$?
          echo "::endgroup::"

          if [ $COMPILE_EXIT -ne 0 ]; then
            echo "::error::Compilation FAILED"
            echo "compile_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "compile_status=passed" >> $GITHUB_OUTPUT

      # ========================================================================
      # GATE 3: EUNIT TESTS
      # ========================================================================
      - name: Run EUnit tests
        id: eunit
        run: |
          echo "::group::EUnit Tests"
          rebar3 as test do compile, eunit --cover 2>&1 | tee eunit.log
          EUNIT_EXIT=${PIPESTATUS[0]}
          echo "::endgroup::"

          # Parse test results
          PASSED=$(grep -c "Test passed" eunit.log || echo 0)
          FAILED=$(grep -c "Test failed" eunit.log || echo 0)
          ABORTED=$(grep -c "terminated abnormally" eunit.log || echo 0)
          TOTAL=$((PASSED + FAILED))

          if [ $TOTAL -gt 0 ]; then
            PASS_RATE=$(echo "scale=2; $PASSED * 100 / $TOTAL" | bc)
          else
            PASS_RATE="0"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## EUnit Test Results - OTP ${{ matrix.otp_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Aborted:** $ABORTED" >> $GITHUB_STEP_SUMMARY
          echo "- **Pass Rate:** ${PASS_RATE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $EUNIT_EXIT -ne 0 ]; then
            echo "::error::EUnit tests FAILED - $FAILED test(s) failed"
            echo "eunit_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "eunit_status=passed" >> $GITHUB_OUTPUT

      # ========================================================================
      # GATE 4: PROCESS USAGE VERIFICATION (Chicago School)
      # ========================================================================
      - name: Chicago School Process Usage Verification
        id: process_verification
        if: success()
        run: |
          echo "::group::Process Usage Verification"
          echo "Verifying tests use REAL erlmcp processes, not mocks..."
          echo ""

          # Pattern 1: Check for actual erlmcp process usage
          echo "### Check 1: Real erlmcp Process Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REAL_PROCESS_USAGE=$(grep -r "erlmcp_server:start_link\|erlmcp_client:start_link\|erlmcp_registry:" apps/*/test/ test/ 2>/dev/null | wc -l)
          if [ "$REAL_PROCESS_USAGE" -gt 0 ]; then
            echo "✅ Tests use real erlmcp processes ($REAL_PROCESS_USAGE instances)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ WARNING: No real erlmcp process usage detected" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Tests may not be using real erlmcp processes"
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Pattern 2: Check for interface testing (not implementation testing)
          echo "### Check 2: Interface Testing (vs Implementation)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Good patterns: testing via public API calls
          API_TESTING=$(grep -r "erlmcp_client:call_tool\|erlmcp_server:add_tool\|erlmcp_registry:register" apps/*/test/ test/ 2>/dev/null | wc -l)
          if [ "$API_TESTING" -gt 0 ]; then
            echo "✅ Tests use public API ($API_TESTING instances)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ WARNING: Limited public API testing detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Pattern 3: Check for gen_server pattern testing
          echo "### Check 3: gen_server Behavior Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          GENSERVER_TESTS=$(grep -r "gen_server:call\|gen_server:cast\|sys:terminate" apps/*/test/ test/ 2>/dev/null | wc -l)
          if [ "$GENSERVER_TESTS" -gt 0 ]; then
            echo "✅ Tests gen_server behaviors ($GENSERVER_TESTS instances)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ INFO: No direct gen_server testing (may use higher-level APIs)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "::endgroup::"
          echo "process_verification=completed" >> $GITHUB_OUTPUT

      # ========================================================================
      # GATE 5: COVERAGE VERIFICATION (Chicago School)
      # ========================================================================
      - name: Chicago School Coverage Verification
        id: coverage_verification
        if: success()
        run: |
          echo "::group::Coverage Verification"
          echo "Verifying ≥80% coverage threshold..."
          echo ""

          rebar3 cover --verbose

          if [ -f scripts/check_coverage_threshold.sh ]; then
            chmod +x scripts/check_coverage_threshold.sh
            ./scripts/check_coverage_threshold.sh 80
            COVERAGE_EXIT=$?

            # Extract coverage percentage
            if [ -f _build/test/cover/cover.log ]; then
              COVERAGE=$(grep "total" _build/test/cover/cover.log | tail -1 | awk -F'|' '{print $3}' | tr -d ' %|' || echo "0")
            else
              COVERAGE="0"
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Coverage Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Overall Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "- **Threshold:** ≥80%" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** $( [ $COVERAGE_EXIT -eq 0 ] && echo '✅ PASSED' || echo '❌ FAILED' )" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "::endgroup::"

            if [ $COVERAGE_EXIT -ne 0 ]; then
              echo "::error::Coverage ${COVERAGE}% below 80% threshold"
              echo "coverage_verification=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "coverage_verification=passed" >> $GITHUB_OUTPUT
          else
            echo "::warning::Coverage script not found"
            echo "coverage_verification=skipped" >> $GITHUB_OUTPUT
          fi

      # ========================================================================
      # FINAL SUMMARY
      # ========================================================================
      - name: Chicago School TDD Compliance Summary
        if: always()
        run: |
          echo "## Chicago School TDD Compliance Summary - OTP ${{ matrix.otp_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PRETEST="${{ steps.pretest_compliance.outputs.pretest_compliance }}"
          COMPILE="${{ steps.compile.outputs.compile_status }}"
          EUNIT="${{ steps.eunit.outputs.eunit_status }}"
          PROCESS="${{ steps.process_verification.outputs.process_verification }}"
          COVERAGE="${{ steps.coverage_verification.outputs.coverage_verification }}"

          echo "### Compliance Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Test Anti-Pattern Check | $( [ "$PRETEST" = "passed" ] && echo '✅ PASSED' || echo '❌ FAILED' ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Compilation | $( [ "$COMPILE" = "passed" ] && echo '✅ PASSED' || echo '❌ FAILED' ) |" >> $GITHUB_STEP_SUMMARY
          echo "| EUnit Tests | $( [ "$EUNIT" = "passed" ] && echo '✅ PASSED' || echo '❌ FAILED' ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Process Usage Verification | $( [ "$PROCESS" = "completed" ] && echo '✅ COMPLETED' || echo '⚠️ SKIPPED' ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage (≥80%) | $( [ "$COVERAGE" = "passed" ] && echo '✅ PASSED' || echo '❌ FAILED' ) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PRETEST" != "passed" ] || [ "$COMPILE" != "passed" ] || \
             [ "$EUNIT" != "passed" ] || [ "$COVERAGE" != "passed" ]; then
            echo "## ❌ CHICAGO SCHOOL TDD COMPLIANCE FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Fix violations and re-push." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Chicago School TDD Rules:**" >> $GITHUB_STEP_SUMMARY
            echo "- NO mocks, fake, or placeholder implementations" >> $GITHUB_STEP_SUMMARY
            echo "- NO dummy processes (spawn/fun/receive/stop)" >> $GITHUB_STEP_SUMMARY
            echo "- NO state inspection (sys:get_status)" >> $GITHUB_STEP_SUMMARY
            echo "- NO record duplication (test-specific state records)" >> $GITHUB_STEP_SUMMARY
            echo "- Test files MUST be < 500 lines" >> $GITHUB_STEP_SUMMARY
            echo "- Test ALL observable behavior through ALL interfaces" >> $GITHUB_STEP_SUMMARY
            echo "- Use REAL erlmcp processes (gen_server, supervised)" >> $GITHUB_STEP_SUMMARY
            echo "- Coverage MUST be ≥80%" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "## ✅ CHICAGO SCHOOL TDD COMPLIANCE PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests follow Chicago School TDD principles:" >> $GITHUB_STEP_SUMMARY
          echo "- Real erlmcp processes (no mocks)" >> $GITHUB_STEP_SUMMARY
          echo "- Observable behavior testing (no state inspection)" >> $GITHUB_STEP_SUMMARY
          echo "- Appropriate file sizes (< 500 lines)" >> $GITHUB_STEP_SUMMARY
          echo "- ≥80% code coverage" >> $GITHUB_STEP_SUMMARY

      - name: Upload EUnit logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: eunit-logs-otp-${{ matrix.otp_version }}
          path: |
            eunit.log
            _build/test/cover/
          retention-days: 30

  summary:
    name: EUnit Summary
    runs-on: ubuntu-22.04
    needs: [eunit-tests]
    if: always()

    steps:
      - name: Check EUnit status
        if: needs.eunit-tests.result == 'failure'
        run: |
          echo "::error::EUnit tests FAILED on one or more OTP versions"
          exit 1

      - name: All EUnit tests passed
        if: success()
        run: |
          echo "✅ EUnit tests PASSED on all OTP versions"
