name: MCP Specification Compliance Validation

on:
  push:
    branches: [main, 'release/**', 'feature/**', 'epic/**']
    tags: ['v*']
  pull_request:
    branches: [main, 'release/**']
  schedule:
    # Run full compliance validation daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'Validation level'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - standard
          - full

env:
  VALIDATION_APP: erlmcp_validation
  SPEC_VERSION: "2025-11-25"
  COMPLIANCE_THRESHOLD: 95

jobs:
  # =============================================================================
  # JOB 1: Specification Parsing & Validation Setup
  # =============================================================================
  spec-parser:
    name: Specification Parser
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    strategy:
      matrix:
        otp_version: [25, 26, 27]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: ${{ matrix.otp_version >= 26 && '3.25' || '3.22' }}

      - name: Cache specification parser build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build/validation
          key: ${{ runner.os }}-spec-parser-otp${{ matrix.otp_version }}-${{ hashFiles('apps/erlmcp_validation/rebar.config') }}
          restore-keys: |
            ${{ runner.os }}-spec-parser-otp${{ matrix.otp_version }}-
            ${{ runner.os }}-spec-parser-

      - name: Build validation application
        id: build_validation
        run: |
          echo "::group::Building Validation Tools"
          rebar3 as validation compile
          BUILD_EXIT=$?
          echo "::endgroup::"

          if [ $BUILD_EXIT -ne 0 ]; then
            echo "::error::Validation app compilation FAILED"
            echo "build_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "build_status=success" >> $GITHUB_OUTPUT
          echo "✅ Validation app built successfully"

      - name: Validate specification parser
        run: |
          echo "::group::Specification Parser Validation"
          rebar3 as validation shell --eval "
            case code:load_file(erlmcp_spec_parser) of
              {module, erlmcp_spec_parser} ->
                io:format(\"✅ Spec parser module loaded~n\"),
                case erlmcp_spec_parser:parse_specification(<<\"${{ env.SPEC_VERSION }}\">>) of
                  {ok, Spec} ->
                    io:format(\"✅ Spec version ~s parsed successfully~n\", [\"${{ env.SPEC_VERSION }}\"]),
                    io:format(\"Methods: ~p~n\", [maps:size(Spec#mcp_spec.methods)]),
                    io:format(\"Error codes: ~p~n\", [maps:size(Spec#mcp_spec.error_codes)]),
                    io:format(\"Transports: ~p~n\", [maps:size(Spec#mcp_spec.transports)]),
                    init:stop();
                  {error, Reason} ->
                    io:format(\"❌ Spec parsing failed: ~p~n\", [Reason]),
                    init:stop(1)
                end;
              {error, Reason} ->
                io:format(\"❌ Failed to load spec parser: ~p~n\", [Reason]),
                init:stop(1)
            end
          " --name spec_parser@localhost --setcookie spec_cookie
          echo "::endgroup::"

      - name: Extract spec requirements
        id: extract_requirements
        run: |
          echo "::group::Extracting Requirements"
          rebar3 as validation shell --eval "
            {ok, Spec} = erlmcp_spec_parser:parse_specification(<<\"${{ env.SPEC_VERSION }}\">>),
            Methods = erlmcp_spec_parser:method_requirements(),
            ErrorCodes = erlmcp_spec_parser:error_code_requirements(),
            Transports = erlmcp_spec_parser:transport_requirements(),
            io:format(\"Total method requirements: ~p~n\", [maps:size(Methods)]),
            io:format(\"Total error code requirements: ~p~n\", [maps:size(ErrorCodes)]),
            io:format(\"Total transport requirements: ~p~n\", [maps:size(Transports)]),
            init:stop()
          " --name requirements@localhost --setcookie req_cookie 2>&1 | tee spec_requirements.log
          echo "::endgroup::"

      - name: Upload spec requirements
        uses: actions/upload-artifact@v3
        with:
          name: spec-requirements-otp${{ matrix.otp_version }}
          path: spec_requirements.log
          retention-days: 7

  # =============================================================================
  # JOB 2: Protocol Compliance Validation (Black-Box Testing)
  # =============================================================================
  protocol-compliance:
    name: Protocol Compliance
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: spec-parser

    strategy:
      matrix:
        otp_version: [25, 26]
        transport: [stdio, tcp, http]
        exclude:
          # Exclude HTTP transport on OTP 25 (known issues)
          - otp_version: 25
            transport: http

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: ${{ matrix.otp_version >= 26 && '3.25' || '3.22' }}

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-protocol-otp${{ matrix.otp_version }}-${{ matrix.transport }}-${{ hashFiles('rebar.lock') }}

      - name: Compile validation and test apps
        run: |
          echo "::group::Compiling for Protocol Validation"
          rebar3 as validation compile
          rebar3 as test compile
          echo "::endgroup::"

      - name: Run protocol compliance tests (${{ matrix.transport }})
        id: protocol_tests
        run: |
          echo "::group::Protocol Compliance Tests - ${{ matrix.transport }} Transport"

          cat > run_protocol_validation.erl << 'EOF'
          #!/usr/bin/env escript
          main([]) ->
              Transport = <<"${{ matrix.transport }}">>,
              io:format("Running protocol compliance for: ~s~n", [Transport]),

              %% Start test server
              {ok, ServerPid} = erlmcp_test_server:start_link([{transport, Transport}]),
              timer:sleep(1000),

              %% Run validation
              Result = case erlmcp_protocol_validator:validate_transport(Transport) of
                  #{compliant := true, details := Details} ->
                      io:format("✅ ~s transport COMPLIANT~n", [Transport]),
                      io:format("Details: ~p~n", [Details]),
                      0;
                  #{compliant := false, details := Details} ->
                      io:format("❌ ~s transport NON-COMPLIANT~n", [Transport]),
                      io:format("Issues: ~p~n", [Details]),
                      1
              end,

              %% Cleanup
              erlmcp_test_server:stop(ServerPid),
              halt(Result).
          EOF

          escript run_protocol_validation.erl
          PROTOCOL_EXIT=$?
          echo "::endgroup::"

          if [ $PROTOCOL_EXIT -ne 0 ]; then
            echo "::error::Protocol compliance tests FAILED for ${{ matrix.transport }}"
            echo "protocol_status=failed" >> $GITHUB_OUTPUT
          else
            echo "protocol_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Validate method compliance
        run: |
          echo "::group::Method Compliance Validation"
          rebar3 as validation shell --eval "
            {ok, Methods} = erlmcp_protocol_validator:validate_all_methods(),
            io:format(\"~n~n=== METHOD COMPLIANCE RESULTS ===~n\"),
            lists:foreach(fun({Method, Status}) ->
              case Status of
                compliant -> io:format(\"✅ ~s~n\", [Method]);
                {non_compliant, Reason} -> io:format(\"❌ ~s: ~p~n\", [Method, Reason])
              end
            end, Methods),
            CompliantCount = length([M || {M, compliant} <- Methods]),
            TotalCount = length(Methods),
            CompliancePct = (CompliantCount * 100) div TotalCount,
            io:format(\"~nCompliance: ~p/~p (~p%)~n\", [CompliantCount, TotalCount, CompliancePct]),
            init:stop()
          " --name method_validation@localhost --setcookie method_cookie
          echo "::endgroup::"

      - name: Upload protocol compliance results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: protocol-compliance-otp${{ matrix.otp_version }}-${{ matrix.transport }}
          path: |
            protocol_validation.log
            method_compliance.log
          retention-days: 7

  # =============================================================================
  # JOB 3: Full Compliance Test Suite
  # =============================================================================
  full-compliance:
    name: Full Compliance Test Suite
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    needs: [spec-parser, protocol-compliance]

    strategy:
      matrix:
        otp_version: [26]
        compliance_suite:
          - erlmcp_spec_compliance_SUITE
          - erlmcp_transport_behavior_SUITE
          - erlmcp_error_response_SUITE

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: '3.25'

      - name: Cache compliance test build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/rebar3
            _build
          key: ${{ runner.os }}-compliance-otp${{ matrix.otp_version }}-${{ hashFiles('rebar.lock', 'apps/erlmcp_validation/rebar.config') }}

      - name: Build validation test suite
        run: |
          echo "::group::Building Compliance Test Suite"
          rebar3 as validation compile
          rebar3 as validation ct --compile_only
          echo "::endgroup::"

      - name: Run compliance test suite
        id: compliance_tests
        run: |
          echo "::group::Compliance Tests - ${{ matrix.compliance_suite }}"

          rebar3 as validation ct --suite=apps/erlmcp_validation/test/${{ matrix.compliance_suite }}.ct --cover
          CT_EXIT=$?
          echo "::endgroup::"

          if [ $CT_EXIT -ne 0 ]; then
            echo "::error::Compliance suite ${{ matrix.compliance_suite }} FAILED"
            echo "compliance_status=failed" >> $GITHUB_OUTPUT
          else
            echo "compliance_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Generate compliance coverage report
        if: always()
        run: |
          echo "::group::Compliance Coverage Report"
          rebar3 as validation cover --verbose

          # Extract coverage percentage
          COVERAGE=$(rebar3 as validation cover --verbose 2>&1 | grep "total" | tail -1 | awk '{print $NF}' || echo "N/A")
          echo "Compliance test coverage: $COVERAGE"

          # Check minimum coverage for validation code
          if [ "$COVERAGE" != "N/A" ]; then
            COV_NUM=$(echo $COVERAGE | sed 's/%//')
            if [ "$COV_NUM" -lt 80 ]; then
              echo "::warning::Compliance test coverage below 80%: $COVERAGE"
            fi
          fi
          echo "::endgroup::"

      - name: Upload compliance test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: compliance-results-${{ matrix.compliance_suite }}-otp${{ matrix.otp_version }}
          path: |
            _build/validation/cover/
            _build/validation/logs/
          retention-days: 14

  # =============================================================================
  # JOB 4: Transport Behavior Validation
  # =============================================================================
  transport-validation:
    name: Transport Behavior Validation
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: protocol-compliance

    strategy:
      matrix:
        otp_version: [26]
        validation_scenario:
          - stdio_newline_delimited
          - tcp_connection_lifecycle
          - http_sse_support
          - websocket_message_framing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp_version }}
          rebar3-version: '3.25'

      - name: Run transport validation scenario
        id: transport_scenario
        run: |
          echo "::group::Transport Validation: ${{ matrix.validation_scenario }}"

          rebar3 as validation shell --eval "
            Scenario = <<\"${{ matrix.validation_scenario }}\">>,
            io:format(\"Running transport validation scenario: ~s~n\", [Scenario]),

            Result = erlmcp_transport_validator:validate_scenario(
              <<\"${{ matrix.validation_scenario }}\">>
            ),

            case Result of
              #{compliant := true} ->
                io:format(\"✅ Transport scenario COMPLIANT~n\"),
                init:stop(0);
              #{compliant := false, issues := Issues} ->
                io:format(\"❌ Transport scenario NON-COMPLIANT~n\"),
                lists:foreach(fun(I) -> io:format(\"  - ~p~n\", [I]) end, Issues),
                init:stop(1)
            end
          " --name transport_val@localhost --setcookie transport_cookie

          SCENARIO_EXIT=$?
          echo "::endgroup::"

          if [ $SCENARIO_EXIT -ne 0 ]; then
            echo "::warning::Transport scenario ${{ matrix.validation_scenario }} has issues"
            echo "transport_status=warning" >> $GITHUB_OUTPUT
          else
            echo "transport_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Upload transport validation results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: transport-validation-${{ matrix.validation_scenario }}
          path: transport_validation_*.log
          retention-days: 7

  # =============================================================================
  # JOB 5: Compliance Report Generation
  # =============================================================================
  compliance-report:
    name: Generate Compliance Report
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [spec-parser, full-compliance, transport-validation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.25'

      - name: Download all compliance artifacts
        uses: actions/download-artifact@v3
        with:
          path: compliance-artifacts/

      - name: Generate comprehensive compliance report
        id: generate_report
        run: |
          echo "::group::Generating Compliance Report"

          rebar3 as validation escriptize

          # Run validation runner
          ./_build/validation/bin/erlmcp_validate run --all \
            --spec-version "${{ env.SPEC_VERSION }}" \
            --output-format json \
            --output-file compliance_report.json

          # Generate markdown report
          ./_build/validation/bin/erlmcp_validate report \
            --input-file compliance_report.json \
            --output-format markdown \
            --output-file compliance_report.md

          # Extract overall compliance percentage
          COMPLIANCE_PCT=$(jq '.overall_compliance' compliance_report.json || echo "0")

          echo "compliance_percentage=$COMPLIANCE_PCT" >> $GITHUB_OUTPUT
          echo "::endgroup::"

          echo "## Compliance Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Compliance:** $COMPLIANCE_PCT%" >> $GITHUB_STEP_SUMMARY
          echo "**Specification:** MCP ${{ env.SPEC_VERSION }}" >> $GITHUB_STEP_SUMMARY

          # Check compliance threshold
          if (( $(echo "$COMPLIANCE_PCT < ${{ env.COMPLIANCE_THRESHOLD }}" | bc -l) )); then
            echo "::warning::Compliance $COMPLIANCE_PCT% below threshold ${{ env.COMPLIANCE_THRESHOLD }}%"
          else
            echo "✅ Compliance meets threshold ${{ env.COMPLIANCE_THRESHOLD }}%"
          fi

      - name: Generate spec traceability matrix
        run: |
          echo "::group::Spec Traceability Matrix"
          ./scripts/validation/generate_traceability_matrix.sh > docs/SPEC_COMPLIANCE_MATRIX.md
          echo "::endgroup::"

      - name: Upload compliance report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report-${{ github.sha }}
          path: |
            compliance_report.json
            compliance_report.md
            docs/SPEC_COMPLIANCE_MATRIX.md
          retention-days: 90

      - name: Comment PR with compliance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('compliance_report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## MCP Specification Compliance Report\n\n${report}\n\n**Overall Compliance:** ${{ steps.generate_report.outputs.compliance_percentage }}%\n**Threshold:** ${{ env.COMPLIANCE_THRESHOLD }}%`
            })

  # =============================================================================
  # JOB 6: Final Compliance Gate
  # =============================================================================
  compliance-gate:
    name: Compliance Quality Gate
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: [spec-parser, protocol-compliance, full-compliance, compliance-report]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download compliance report
        uses: actions/download-artifact@v3
        with:
          name: compliance-report-${{ github.sha }}
          path: ./

      - name: Validate compliance threshold
        id: compliance_threshold
        run: |
          echo "::group::Compliance Threshold Check"

          COMPLIANCE_PCT=$(jq '.overall_compliance' compliance_report.json || echo "0")
          THRESHOLD=${{ env.COMPLIANCE_THRESHOLD }}

          echo "## Compliance Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall Compliance | $COMPLIANCE_PCT% | ≥$THRESHOLD% | $([ "$COMPLIANCE_PCT" -ge "$THRESHOLD" ] && echo '✅ PASS' || echo '❌ FAIL') |" >> $GITHUB_STEP_SUMMARY

          if [ "$COMPLIANCE_PCT" -ge "$THRESHOLD" ]; then
            echo "✅ Compliance gate PASSED"
            echo "gate_status=passed" >> $GITHUB_OUTPUT
            echo "::endgroup::"
          else
            echo "::error::Compliance gate FAILED: $COMPLIANCE_PCT% < $THRESHOLD%"
            echo "gate_status=failed" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

      - name: Create compliance badge
        if: always()
        run: |
          COMPLIANCE_PCT=$(jq '.overall_compliance' compliance_report.json || echo "0")
          COLOR=$([ "$COMPLIANCE_PCT" -ge 95 ] && echo "brightgreen" || ([ "$COMPLIANCE_PCT" -ge 80 ] && echo "yellow" || echo "red"))

          cat > compliance-badge.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="220" height="24">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <mask id="a">
              <rect width="220" height="24" rx="4" fill="#fff"/>
            </mask>
            <g mask="url(#a)">
              <path fill="#555" d="M0 0h110v24H0z"/>
              <path fill="${COLOR}" d="M110 0h110v24H110z"/>
              <path fill="url(#b)" d="M0 0h220v24H0z"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="55" y="17" fill="#010101" fill-opacity=".3">MCP Spec</text>
              <text x="55" y="16">MCP Spec</text>
              <text x="165" y="17" fill="#010101" fill-opacity=".3">${COMPLIANCE_PCT}%</text>
              <text x="165" y="16">${COMPLIANCE_PCT}%</text>
            </g>
          </svg>
          EOF

      - name: Upload compliance badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: compliance-badge
          path: compliance-badge.svg

      - name: Final gate summary
        if: always()
        run: |
          echo "╔═══════════════════════════════════════════╗" >> $GITHUB_STEP_SUMMARY
          echo "║     MCP Specification Compliance Gate     ║" >> $GITHUB_STEP_SUMMARY
          echo "╚═══════════════════════════════════════════╝" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.compliance_threshold.outputs.gate_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Specification:** MCP ${{ env.SPEC_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Compliance:** $(jq '.overall_compliance' compliance_report.json || echo '0')%" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** ≥${{ env.COMPLIANCE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.compliance_threshold.outputs.gate_status }}" = "passed" ]; then
            echo "✅ **MERGE ALLOWED** - All compliance gates passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **MERGE BLOCKED** - Fix compliance issues before merging" >> $GITHUB_STEP_SUMMARY
          fi
