name: Regression Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  regression-detection:
    name: Detect Quality Regressions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparison
      
      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26'
          rebar3-version: '3.22'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc jq
          rebar3 get-deps
      
      - name: Fetch baseline from main branch
        run: |
          git fetch origin main:main
          git checkout main
          
          # Collect baseline metrics
          mkdir -p .metrics
          
          # Run compilation and tests on main
          TERM=dumb rebar3 compile 2>&1 | tee /tmp/baseline-compile.log || true
          rebar3 eunit 2>&1 | tee /tmp/baseline-test.log || true
          
          # Extract baseline metrics
          baseline_warnings=$(grep -c "Warning:" /tmp/baseline-compile.log || echo "0")
          baseline_tests=$(grep -oP '\d+(?= tests)' /tmp/baseline-test.log | head -1 || echo "0")
          baseline_failed=$(grep -oP '\d+(?= failed)' /tmp/baseline-test.log | head -1 || echo "0")
          
          if [[ $baseline_tests -gt 0 ]]; then
            baseline_passed=$((baseline_tests - baseline_failed))
            baseline_pass_rate=$(awk "BEGIN {printf \"%.2f\", ($baseline_passed / $baseline_tests) * 100}")
          else
            baseline_pass_rate="0"
          fi
          
          # Create baseline JSON
          cat > .metrics/baseline.json << JSON
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "git_commit": "$(git rev-parse main)",
            "git_branch": "main",
            "metrics": {
              "test_pass_rate": ${baseline_pass_rate},
              "coverage": 0,
              "warnings": ${baseline_warnings},
              "perf_throughput_msg_per_s": 0,
              "avg_module_complexity": 0
            }
          }
          JSON
          
          echo "Baseline collected from main branch"
          cat .metrics/baseline.json
      
      - name: Return to PR branch
        run: |
          git checkout ${{ github.event.pull_request.head.sha }}
      
      - name: Run regression detection
        id: regression
        continue-on-error: true
        run: |
          ./tools/regression/detect-regression.sh
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Enforce quality gates
        id: quality_gate
        continue-on-error: true
        run: |
          ./tools/regression/block-on-regression.sh
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Generate HTML report
        if: always()
        run: |
          # Generate HTML report from JSON
          if [[ -f .metrics/regression-report.json ]]; then
            ./tools/regression/generate-html-report.sh
          fi
      
      - name: Upload regression report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-report
          path: |
            .metrics/regression-report.json
            .metrics/regression-report.html
            .metrics/regression-summary.txt
          retention-days: 30
      
      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read regression report
            let reportContent = '## üîç Regression Detection Report\n\n';
            
            if (fs.existsSync('.metrics/regression-summary.txt')) {
              const summary = fs.readFileSync('.metrics/regression-summary.txt', 'utf8');
              reportContent += '```\n' + summary + '\n```\n\n';
            }
            
            if (fs.existsSync('.metrics/regression-report.json')) {
              const report = JSON.parse(fs.readFileSync('.metrics/regression-report.json', 'utf8'));
              
              const severityEmoji = {
                'none': '‚úÖ',
                'low': '‚ÑπÔ∏è',
                'medium': '‚ö†Ô∏è',
                'high': '‚ùå',
                'critical': 'üö´'
              };
              
              reportContent += `**Severity:** ${severityEmoji[report.severity]} ${report.severity}\n\n`;
              
              if (report.regressions.length > 0) {
                reportContent += '### Regressions Detected\n\n';
                
                for (const reg of report.regressions) {
                  reportContent += `- **${reg.metric}** [${reg.severity}]: ${reg.message}\n`;
                  reportContent += `  - Baseline: ${reg.baseline}\n`;
                  reportContent += `  - Current: ${reg.current}\n\n`;
                }
              } else {
                reportContent += '‚úÖ No regressions detected!\n\n';
              }
            }
            
            // Quality gate status
            const qualityGateExitCode = '${{ steps.quality_gate.outputs.exit_code }}';
            
            if (qualityGateExitCode === '0') {
              reportContent += '### ‚úÖ Quality Gate: PASSED\n\n';
              reportContent += 'This PR is safe to merge from a quality perspective.\n';
            } else if (qualityGateExitCode === '1') {
              reportContent += '### ‚ö†Ô∏è Quality Gate: PASSED WITH WARNINGS\n\n';
              reportContent += 'Please document justification for medium severity regressions in PR description.\n';
            } else {
              reportContent += '### ‚ùå Quality Gate: FAILED\n\n';
              reportContent += 'This PR is **BLOCKED** due to critical or high severity regressions.\n\n';
              reportContent += 'To proceed:\n';
              reportContent += '1. Fix the regressions, or\n';
              reportContent += '2. Add to allowlist with justification, or\n';
              reportContent += '3. Request override from tech lead\n';
            }
            
            reportContent += '\n---\n';
            reportContent += '_Generated by erlmcp Regression Guard üõ°Ô∏è_\n';
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reportContent
            });
      
      - name: Set status check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = '${{ steps.quality_gate.outputs.exit_code }}';
            
            const state = exitCode === '0' ? 'success' : 'failure';
            const description = exitCode === '0' 
              ? 'No regressions detected' 
              : 'Quality regressions detected - see PR comment';
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              context: 'Regression Guard',
              description: description,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
      
      - name: Fail if blocked
        if: steps.quality_gate.outputs.exit_code != '0'
        run: |
          echo "Quality gate failed - merge blocked"
          exit 1
