name: ci

on:
  push:
    branches: [main, 'release/**', 'task/**', 'feature/**', 'epic/**']
    tags: ['**']
  pull_request:
    branches: [main, 'release/**', 'task/**', 'feature/**', 'epic/**']

jobs:

  test:
    name: Erlang ${{ matrix.otp_version }} build
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        otp_version: [25, 26, 27, 28]

    steps:
    - uses: actions/checkout@v4
    - uses: erlef/setup-beam@v1
      with:
        otp-version: ${{ matrix.otp_version }}
        rebar3-version: ${{ matrix.otp_version >= 26 && '3.25' || '3.22' }}
    - name: Check rebar3 Version
      run: rebar3 --version
    - name: Compile
      run: rebar3 compile
    - name: Xref Checks
      run: rebar3 xref

    - name: Run Tests with Coverage
      run: |
        rebar3 as test do compile, eunit --cover, ct --dir=test/integration --cover, cover --verbose
      continue-on-error: true

    - name: Check Coverage Threshold (80%)
      run: |
        chmod +x scripts/check_coverage_threshold.sh
        ./scripts/check_coverage_threshold.sh 80

    - name: Upload Coverage HTML Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-otp-${{ matrix.otp_version }}
        path: _build/test/cover/
        retention-days: 30

    - name: Generate Coverage Summary
      if: always()
      run: |
        echo "## Coverage Report - OTP ${{ matrix.otp_version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        grep -A 60 "module.*coverage" _build/test/cover/cover.log || echo "Coverage data not available"
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        COVERAGE=$(grep "total" _build/test/cover/cover.log | tail -1 | awk '{print $NF}' || echo "N/A")
        echo "**Overall Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
