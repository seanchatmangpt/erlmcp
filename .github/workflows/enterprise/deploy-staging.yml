name: Staging Deployment

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, pre-production]

env:
  KUBECONFIG: ${{ secrets.KUBECONFIG }}
  REGISTRY_URL: ghcr.io/${{ github.repository }}

jobs:
  pre-deploy:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      image_tag: ${{ steps.version.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          VERSION=${GITHUB_SHA:0:8}
          echo "image_tag=${VERSION}" >> $GITHUB_OUTPUT

      - name: Check Deployment Approval
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });

            const hasApproval = checkRuns.check_runs.some(
              run => run.name === 'Quality Gates' && run.status === 'completed' && run.conclusion === 'success'
            );

            if (!hasApproval) {
              core.setOutput('should_deploy', 'false');
              core.info('Deployment blocked: Quality gates not passed');
            } else {
              core.setOutput('should_deploy', 'true');
            }

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Image
        run: |
          docker build \
            -t ${{ env.REGISTRY_URL }}:${{ needs.pre-deploy.outputs.image_tag }} \
            -t ${{ env.REGISTRY_URL }}:staging-${{ github.sha }} \
            --build-arg OTP_VERSION=${{ env.OTP_VERSION }} \
            .

      - name: Push Images
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ${{ env.REGISTRY_URL }}:${{ needs.pre-deploy.outputs.image_tag }}
          docker push ${{ env.REGISTRY_URL }}:staging-${{ github.sha }}

      - name: Deploy with Feature Flags
        uses: steebchen/kubectl@v4.2.0
        with:
          config: ${{ secrets.KUBECONFIG }}
          command: |
            kubectl apply -f ./k8s/staging/overlays/feature-flags.yaml

      - name: Canary Deploy
        run: |
          ./scripts/canary/deploy.sh \
            --namespace erlmcp-staging \
            --image ${{ env.REGISTRY_URL }}:staging-${{ github.sha }} \
            --canary-percent 20 \
            --timeout 300

      - name: Validate Deployment
        run: |
          ./scripts/health/validate.sh \
            --namespace erlmcp-staging \
            --timeout 600 \
            --health-threshold 90 \
            --readiness-threshold 90

      - name: Run Smoke Tests
        run: |
          ./scripts/test/smoke.sh \
            --namespace erlmcp-staging \
            --timeout 300 \
            --threshold 95

      - name: Rollback on Failure
        if: failure()
        run: |
          ./scripts/canary/rollback.sh \
            --namespace erlmcp-staging

  post-deploy:
    name: Post-Deployment Actions
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always()

    steps:
      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy-staging.result }}
          channel: '#staging-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Update Monitoring Dashboard
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id,
              state: 'success'
            });

      - name: Run Integration Tests
        if: needs.deploy-staging.result == 'success'
        run: |
          ./scripts/test/integration.sh \
            --namespace erlmcp-staging \
            --env staging