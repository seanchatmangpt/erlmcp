name: Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options: [production, pre-production]

env:
  KUBECONFIG: ${{ secrets.KUBECONFIG }}
  REGISTRY_URL: ghcr.io/${{ github.repository }}

jobs:
  pre-deploy:
    name: Pre-Production Validation
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      image_tag: ${{ steps.version.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          VERSION=${GITHUB_SHA:0:8}
          echo "image_tag=${VERSION}" >> $GITHUB_OUTPUT

      - name: Check Staging Health
        uses: steebchen/kubectl@v4.2.0
        with:
          config: ${{ secrets.KUBECONFIG }}
          command: |
            kubectl get pods -n erlmcp-staging --selector=app=erlmcp
            kubectl get svc -n erlmcp-staging

      - name: Get Approval
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request?.number || 0
            });

            const hasApproval = reviews.some(
              review => review.state === 'APPROVED' && review.author_association === 'OWNER'
            );

            if (!hasApproval) {
              core.setOutput('should_deploy', 'false');
              core.info('Deployment blocked: Production approval required');
            } else {
              core.setOutput('should_deploy', 'true');
            }

  deploy-canary:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    environment: production
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Image
        run: |
          docker build \
            -t ${{ env.REGISTRY_URL }}:${{ needs.pre-deploy.outputs.image_tag }} \
            -t ${{ env.REGISTRY_URL }}:production-${{ github.sha }} \
            --build-arg OTP_VERSION=${{ env.OTP_VERSION }} \
            .

      - name: Push Images
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ${{ env.REGISTRY_URL }}:${{ needs.pre-deploy.outputs.image_tag }}
          docker push ${{ env.REGISTRY_URL }}:production-${{ github.sha }}

      - name: Deploy Canary
        run: |
          ./scripts/canary/deploy.sh \
            --namespace erlmcp-prod \
            --image ${{ env.REGISTRY_URL }}:production-${{ github.sha }} \
            --canary-percent 5 \
            --timeout 600

      - name: Canary Health Check
        run: |
          ./scripts/health/canary-check.sh \
            --namespace erlmcp-prod \
            --timeout 300 \
            --error-threshold 1 \
            --warning-threshold 3

      - name: Canary Performance Test
        run: |
          ./scripts/performance/canary-test.sh \
            --namespace erlmcp-prod \
            --threshold 95 \
            --timeout 300

      - name: Approve Canary
        uses: actions/github-script@v7
        with:
          script: |
            const approval = await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Canary deployment successful. Continue with full deployment?`
            });

            // Wait for approval
            // In real implementation, this would use wait-for-user-action

  deploy-blue-green:
    name: Blue-Green Deployment
    runs-on: ubuntu-latest
    needs: deploy-canary
    if: needs.deploy-canary.result == 'success'
    environment: production
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Blue-Green
        run: |
          ./scripts/bluegreen/prepare.sh \
            --namespace erlmcp-prod \
            --version ${{ needs.pre-deploy.outputs.image_tag }}

      - name: Deploy Green Environment
        run: |
          ./scripts/bluegreen/deploy-green.sh \
            --namespace erlmcp-prod \
            --image ${{ env.REGISTRY_URL }}:production-${{ github.sha }}

      - name: Verify Green Environment
        run: |
          ./scripts/health/validate.sh \
            --namespace erlmcp-prod \
            --timeout 900 \
            --health-threshold 95 \
            --readiness-threshold 95

      - name: Traffic Switch
        run: |
          ./scripts/bluegreen/switch-traffic.sh \
            --namespace erlmcp-prod \
            --timeout 300 \
            --grace-period 30

      - name: Terminate Blue
        run: |
          ./scripts/bluegreen/terminate-blue.sh \
            --namespace erlmcp-prod

      - name: Final Validation
        run: |
          ./scripts/health/final-check.sh \
            --namespace erlmcp-prod \
            --timeout 300 \
            --threshold 95

  post-deploy:
    name: Post-Deployment
    runs-on: ubuntu-latest
    needs: [deploy-canary, deploy-blue-green]
    if: always()

    steps:
      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy-blue-green.result }}
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Update Release Tag
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = `v${{ needs.pre-deploy.outputs.image_tag }}`;
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tagName}`,
              sha: context.sha
            });

      - name: Generate Release Notes
        run: |
          ./scripts/releases/notes.sh \
            --tag ${{ needs.pre-deploy.outputs.image_tag }} \
            --output release-notes.md

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.pre-deploy.outputs.image_tag }}
          release_name: Release v${{ needs.pre-deploy.outputs.image_tag }}
          body_path: release-notes.md

      - name: Rollback on Failure
        if: failure()
        run: |
          ./scripts/deploy/rollback.sh \
            --namespace erlmcp-prod \
            --version ${{ needs.pre-deploy.outputs.image_tag }}