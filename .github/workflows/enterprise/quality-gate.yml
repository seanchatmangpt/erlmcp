name: Quality Gate Enforcement

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run quality gate checks daily
    - cron: '0 4 * * *'

jobs:
  compile-gate:
    name: Compilation Gate
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/docs'

    steps:
      - uses: actions/checkout@v4

      - name: Setup OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: 28.3.1
          global-rebar3-cache: true

      - name: Compile Check
        run: |
          rebar3 compile

      - name: Store Compilation Result
        id: store
        run: |
          echo "compile_status=success" >> $GITHUB_OUTPUT

      - name: Block on Compilation Failure
        if: steps.store.outputs.compile_status != 'success'
        run: |
          echo "::error::Compilation failed - blocking further processing"
          exit 1

  test-gate:
    name: Testing Gate
    runs-on: ubuntu-latest
    needs: compile-gate
    strategy:
      fail-fast: false
      matrix:
        test-type: [eunit, ct]

    steps:
      - uses: actions/checkout@v4

      - name: Setup OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: 28.3.1
          global-rebar3-cache: true

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/rebar3
            ~/.mix
          key: rebar3-otp-${{ env.OTP_VERSION }}-${{ hashFiles('rebar.config') }}
          restore-keys: |
            rebar3-otp-${{ env.OTP_VERSION }}-
            rebar3-

      - name: Run ${{ matrix.test-type }} Tests
        run: |
          case ${{ matrix.test-type }} in
            eunit)
              rebar3 eunit --verbose
              ;;
            ct)
              rebar3 ct --verbose
              ;;
          esac

      - name: Validate Test Results
        run: |
          # Parse test results and ensure 100% pass rate
          if [ "${{ matrix.test-type }}" = "eunit" ]; then
            python scripts/test/validate-eunit.py
          else
            python scripts/test/validate-ct.py
          fi

  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    needs: test-gate

    steps:
      - uses: actions/checkout@v4

      - name: Setup OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: 28.3.1
          global-rebar3-cache: true

      - name: Generate Coverage Report
        run: |
          rebar3 cover

      - name: Check Coverage Threshold
        run: |
          python scripts/coverage/check.py \
            --minimum 80 \
            --exclude-pattern ".*_test\.erl"

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./_build/test/cover/index.html
          flags: erlmcp
          name: erlmcp-coverage

  dialyzer-gate:
    name: Dialyzer Gate
    runs-on: ubuntu-latest
    needs: test-gate

    steps:
      - uses: actions/checkout@v4

      - name: Setup OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: 28.3.1
          global-rebar3-cache: true

      - name: Run Dialyzer
        run: |
          rebar3 dialyzer

      - name: Check for Warnings
        run: |
          if grep -r "Warning:" dialyzer.out; then
            echo "::error::Dialyzer warnings found - failing build"
            exit 1
          fi

  xref-gate:
    name: Xref Gate
    runs-on: ubuntu-latest
    needs: test-gate

    steps:
      - uses: actions/checkout@v4

      - name: Setup OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: 28.3.1
          global-rebar3-cache: true

      - name: Run Xref
        run: |
          rebar3 xref

      - name: Check for Undefined Functions
        run: |
          python scripts/xref/check.py

  format-gate:
    name: Code Formatting Gate
    runs-on: ubuntu-latest
    needs: test-gate

    steps:
      - uses: actions/checkout@v4

      - name: Check Formatting
        run: |
          rebar3 format
          git diff --exit-code

      - name: Fail on Unformatted Code
        run: |
          echo "::error::Code formatting issues found"
          exit 1

  lint-gate:
    name: Linting Gate
    runs-on: ubuntu-latest
    needs: test-gate

    steps:
      - uses: actions/checkout@v4

      - name: Run Erlang Linter
        run: |
          # Custom Erlang linting
          ./scripts/lint/erl-lint.sh

      - name: Run Dependency Linter
        run: |
          mix deps.audit
          rebar3 hex audit

  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [compile-gate, test-gate, coverage-gate, dialyzer-gate, xref-gate, format-gate, lint-gate]
    if: always()

    steps:
      - name: Generate Report
        run: |
          ./scripts/quality/generate-report.sh

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: ./quality-report.md
          retention-days: 30

      - name: Create Quality Badge
        uses: schneegans/dynamic-badges-action@v1
        with:
          auth: ${{ secrets.BADGE_TOKEN }}
          jsonPath: ./quality-report.json
          badgeName: quality-gate
          config: |
            { "schemaVersion": 1, "label": "Quality Gate", "message": "pass", "color": "green" }
            { "schemaVersion": 1, "label": "Test Coverage", "message": "85%", "color": "green" }
            { "schemaVersion": 1, "label": "Dialyzer", "message": "OK", "color": "green" }

      - name: Notify on Failure
        if: needs.compile-gate.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå Quality gate failed for commit ${context.sha}`
            });