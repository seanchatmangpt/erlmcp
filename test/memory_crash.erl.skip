#!/usr/bin/env escript
-mode(compile).

main(_) ->
    io:format("~n=== DESTRUCTIVE MEMORY EXHAUSTION TEST ===~n"),
    io:format("Objective: Find exact breaking point~n"),
    io:format("NO MERCY - PUSH UNTIL CRASH~n~n"),
    
    Sizes = [
        {1 * 1024, "1KB"},
        {10 * 1024, "10KB"},
        {100 * 1024, "100KB"},
        {1 * 1024 * 1024, "1MB"},
        {10 * 1024 * 1024, "10MB"},
        {100 * 1024 * 1024, "100MB"},
        {256 * 1024 * 1024, "256MB"},
        {512 * 1024 * 1024, "512MB"},
        {1 * 1024 * 1024 * 1024, "1GB"},
        {2 * 1024 * 1024 * 1024, "2GB"},
        {4 * 1024 * 1024 * 1024, "4GB"},
        {8 * 1024 * 1024 * 1024, "8GB"},
        {16 * 1024 * 1024 * 1024, "16GB"}
    ],
    
    Results = test_sizes(Sizes, []),
    print_results(Results),
    
    io:format("~n=== TEST COMPLETE ===~n~n").

test_sizes([], Acc) ->
    lists:reverse(Acc);
test_sizes([{Size, Label} | Rest], Acc) ->
    io:format("Testing: ~s (~p bytes)~n", [Label, Size]),
    
    MemoryBefore = erlang:memory(total) / (1024 * 1024),
    
    Result = case catch test_size(Size) of
        {'EXIT', {Reason, _}} ->
            MemAfter = erlang:memory(total) / (1024 * 1024),
            {Label, Size, MemoryBefore, MemAfter, 0.0, crash, Reason};
        {error, Reason} ->
            MemAfter = erlang:memory(total) / (1024 * 1024),
            Status = case Reason of
                {system_memory_limit_exceeded, _} -> oom;
                _ -> crash
            end,
            {Label, Size, MemoryBefore, MemAfter, 0.0, Status, Reason};
        {Time, MemAfter} ->
            TimeFloat = Time * 1.0,
            {Label, Size, MemoryBefore, MemAfter, TimeFloat, pass, undefined}
    end,
    
    case element(6, Result) of
        crash -> io:format("CRASH at ~s - STOPPING~n", [Label]), lists:reverse([Result | Acc]);
        oom -> io:format("OOM at ~s - STOPPING~n", [Label]), lists:reverse([Result | Acc]);
        _ -> test_sizes(Rest, [Result | Acc])
    end.

test_size(Size) ->
    StartTime = erlang:monotonic_time(millisecond),
    
    %% Allocate
    Payload = generate(Size),
    
    %% Create pressure
    _ = create_pressure(Payload, 100),
    
    EndTime = erlang:monotonic_time(millisecond),
    MemAfter = erlang:memory(total) / (1024 * 1024),
    
    {EndTime - StartTime, MemAfter}.

generate(Size) ->
    Pattern = <<"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789">>,
    PatternSize = byte_size(Pattern),
    Repeats = (Size div PatternSize) + 1,
    Bin = binary:copy(Pattern, Repeats),
    binary:part(Bin, {0, Size}).

create_pressure(_Payload, 0) -> [];
create_pressure(Payload, N) -> [Payload | create_pressure(Payload, N - 1)].

print_results(Results) ->
    io:format("~n=== MEMORY EXHAUSTION CRASH TEST ===~n~n"),
    
    lists:foreach(fun({Label, _Size, MemBefore, MemAfter, Time, Status, Error}) ->
        StatusStr = case Status of
            pass -> "PASS";
            crash -> "CRASH";
            oom -> "OOM";
            timeout -> "TIMEOUT"
        end,
        
        io:format("- ~s: ~s (memory: ~.2f -> ~.2f MB, time: ~.2f ms)~n", [
            Label, StatusStr, MemBefore, MemAfter, Time
        ]),
        
        case Error of
            undefined -> ok;
            _ -> io:format("  ERROR: ~p~n", [Error])
        end
    end, Results),
    
    %% Find breaking point
    BreakingPoint = case [R || R <- Results, element(6, R) =/= pass] of
        [] -> undefined;
        [First | _] -> First
    end,
    
    case BreakingPoint of
        undefined ->
            io:format("~nNO BREAKING POINT (all tests passed)~n");
        {Label, Size, MemAfter, _, _, _, Error} ->
            io:format("~nBREAKING POINT:~n"),
            io:format("- Payload Size: ~s (~p bytes)~n", [Label, Size]),
            io:format("- Total Memory: ~.2f MB~n", [MemAfter]),
            io:format("- Error: ~p~n", [Error]),
            io:format("- Crash Type: ~p~n", [element(6, BreakingPoint)])
    end,
    
    %% Summary
    Total = length(Results),
    Passed = length([R || R <- Results, element(6, R) =:= pass]),
    Crashed = length([R || R <- Results, element(6, R) =:= crash]),
    Oom = length([R || R <- Results, element(6, R) =:= oom]),
    MaxMem = case Results of
        [] -> 0.0;
        _ -> lists:max([element(4, R) || R <- Results])
    end,
    
    io:format("~nSUMMARY:~n"),
    io:format("- Total Tests: ~p~n", [Total]),
    io:format("- Passed: ~p~n", [Passed]),
    io:format("- Crashed: ~p~n", [Crashed]),
    io:format("- OOM: ~p~n", [Oom]),
    io:format("- Peak Memory: ~.2f MB~n", [MaxMem]).
