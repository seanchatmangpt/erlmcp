%%%==============================================================
%%%% Gap #33: Resource Link Content Type Tests
%%%%==============================================================
%%%%
%%%% Tests for MCP 2025-11-25 resource_link content type support.
%%%% This module validates encoding, validation, and integration
%%%% of resource_link types in MCP content blocks.
%%%%

-module(erlmcp_resource_link_tests).

-include_lib("eunit/include/eunit.hrl").
-include("erlmcp.hrl").

%%====================================================================
%% Test Exports
%%====================================================================

-export([
    test_encode_resource_link_basic/0,
    test_encode_resource_link_with_name/0,
    test_encode_resource_link_with_size/0,
    test_encode_resource_link_with_all_fields/0,
    test_validate_resource_link_http_uri/0,
    test_validate_resource_link_https_uri/0,
    test_validate_resource_link_ftp_uri/0,
    test_validate_resource_link_file_uri/0,
    test_validate_resource_link_resource_uri/0,
    test_validate_resource_link_data_uri/0,
    test_validate_resource_link_absolute_path/0,
    test_validate_resource_link_relative_path/0,
    test_validate_resource_link_parent_path/0,
    test_validate_resource_link_invalid_empty/0,
    test_validate_resource_link_invalid_no_scheme/0,
    test_content_with_resource_link/0,
    test_content_multiple_fields_with_link/0,
    test_resource_link_in_response/0,
    test_invalid_size_handling/0,
    test_resource_link_mime_types/0
]).

%%====================================================================
%% Test Cases
%%====================================================================

%% Test 1: Basic resource link encoding
test_encode_resource_link_basic() ->
    Uri = <<"https://example.com/resource.pdf">>,
    MimeType = <<"application/pdf">>,

    Result = erlmcp_server:encode_resource_link(Uri, MimeType),

    ?assertIsMap(Result),
    ?assertEqual(?MCP_CONTENT_TYPE_RESOURCE_LINK, maps:get(?MCP_RESOURCE_LINK_FIELD_TYPE, Result)),
    ?assertEqual(Uri, maps:get(?MCP_RESOURCE_LINK_FIELD_URI, Result)),
    ?assertEqual(MimeType, maps:get(?MCP_RESOURCE_LINK_FIELD_MIME_TYPE, Result)),
    ?assertFalse(maps:is_key(?MCP_RESOURCE_LINK_FIELD_NAME, Result)),
    ?assertFalse(maps:is_key(?MCP_RESOURCE_LINK_FIELD_SIZE, Result)).

%% Test 2: Resource link with name
test_encode_resource_link_with_name() ->
    Uri = <<"https://example.com/document.docx">>,
    MimeType = <<"application/vnd.openxmlformats-officedocument.wordprocessingml.document">>,
    Name = <<"Important Document">>,

    Result = erlmcp_server:encode_resource_link(Uri, MimeType, Name, undefined),

    ?assertEqual(Name, maps:get(?MCP_RESOURCE_LINK_FIELD_NAME, Result)),
    ?assertEqual(Uri, maps:get(?MCP_RESOURCE_LINK_FIELD_URI, Result)),
    ?assertFalse(maps:is_key(?MCP_RESOURCE_LINK_FIELD_SIZE, Result)).

%% Test 3: Resource link with size
test_encode_resource_link_with_size() ->
    Uri = <<"https://example.com/image.png">>,
    MimeType = <<"image/png">>,
    Size = 1024000,

    Result = erlmcp_server:encode_resource_link(Uri, MimeType, undefined, Size),

    ?assertEqual(Size, maps:get(?MCP_RESOURCE_LINK_FIELD_SIZE, Result)),
    ?assertEqual(Uri, maps:get(?MCP_RESOURCE_LINK_FIELD_URI, Result)),
    ?assertFalse(maps:is_key(?MCP_RESOURCE_LINK_FIELD_NAME, Result)).

%% Test 4: Resource link with all fields
test_encode_resource_link_with_all_fields() ->
    Uri = <<"https://example.com/video.mp4">>,
    MimeType = <<"video/mp4">>,
    Name = <<"Demo Video">>,
    Size = 5242880,

    Result = erlmcp_server:encode_resource_link(Uri, MimeType, Name, Size),

    ?assertEqual(?MCP_CONTENT_TYPE_RESOURCE_LINK, maps:get(?MCP_RESOURCE_LINK_FIELD_TYPE, Result)),
    ?assertEqual(Uri, maps:get(?MCP_RESOURCE_LINK_FIELD_URI, Result)),
    ?assertEqual(MimeType, maps:get(?MCP_RESOURCE_LINK_FIELD_MIME_TYPE, Result)),
    ?assertEqual(Name, maps:get(?MCP_RESOURCE_LINK_FIELD_NAME, Result)),
    ?assertEqual(Size, maps:get(?MCP_RESOURCE_LINK_FIELD_SIZE, Result)).

%% Test 5: Validate HTTP URI
test_validate_resource_link_http_uri() ->
    Uri = <<"http://example.com/resource">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 6: Validate HTTPS URI
test_validate_resource_link_https_uri() ->
    Uri = <<"https://secure.example.com/api/v1/data">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 7: Validate FTP URI
test_validate_resource_link_ftp_uri() ->
    Uri = <<"ftp://ftp.example.com/files/document.txt">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 8: Validate FILE URI
test_validate_resource_link_file_uri() ->
    Uri = <<"file:///var/data/resource.json">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 9: Validate RESOURCE URI (MCP-specific)
test_validate_resource_link_resource_uri() ->
    Uri = <<"resource://example/data/resource.md">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 10: Validate DATA URI
test_validate_resource_link_data_uri() ->
    Uri = <<"data:application/json,{\"key\":\"value\"}">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 11: Validate absolute path
test_validate_resource_link_absolute_path() ->
    Uri = <<"/home/user/documents/file.pdf">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 12: Validate relative path
test_validate_resource_link_relative_path() ->
    Uri = <<"./resources/images/logo.png">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 13: Validate parent path
test_validate_resource_link_parent_path() ->
    Uri = <<"../config/settings.yaml">>,
    ?assertEqual({ok, Uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 14: Reject empty URI
test_validate_resource_link_invalid_empty() ->
    Uri = <<"">>,
    ?assertEqual({error, invalid_uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 15: Reject invalid URI (no scheme or path)
test_validate_resource_link_invalid_no_scheme() ->
    Uri = <<"example.com">>,
    ?assertEqual({error, invalid_uri}, erlmcp_server:validate_resource_link_uri(Uri)).

%% Test 16: Content with resource link
test_content_with_resource_link() ->
    Link = #mcp_resource_link{
        uri = <<"https://example.com/data.csv">>,
        mime_type = <<"text/csv">>,
        name = <<"Data Export">>,
        size = 2048
    },
    Content = #mcp_content{
        type = ?MCP_CONTENT_TYPE_TEXT,
        text = <<"Reference to external data">>,
        mime_type = ?MCP_MIME_TEXT_PLAIN,
        resource_link = Link
    },

    Resource = #mcp_resource{
        uri = <<"resource://example/doc">>,
        name = <<"Example Document">>
    },

    Result = erlmcp_server:encode_content_item(Content, Resource, <<"resource://example/doc">>),

    ?assertIsMap(Result),
    ?assertEqual(?MCP_CONTENT_TYPE_TEXT, maps:get(?MCP_PARAM_TYPE, Result)),
    ?assertEqual(<<"Reference to external data">>, maps:get(?MCP_PARAM_TEXT, Result)),
    ?assert(maps:is_key(<<"resourceLink">>, Result)),
    ResourceLink = maps:get(<<"resourceLink">>, Result),
    ?assertEqual(?MCP_CONTENT_TYPE_RESOURCE_LINK, maps:get(?MCP_RESOURCE_LINK_FIELD_TYPE, ResourceLink)).

%% Test 17: Content with multiple fields including resource link
test_content_multiple_fields_with_link() ->
    Link = #mcp_resource_link{
        uri = <<"https://example.com/reference.pdf">>,
        mime_type = <<"application/pdf">>,
        name = <<"Full Reference">>,
        size = 1024000
    },
    Annotation = #mcp_annotation{
        name = <<"audience">>,
        value = <<"technical">>
    },
    Content = #mcp_content{
        type = ?MCP_CONTENT_TYPE_TEXT,
        text = <<"This is the main content">>,
        mime_type = ?MCP_MIME_TEXT_MARKDOWN,
        annotations = [Annotation],
        resource_link = Link
    },

    Resource = #mcp_resource{
        uri = <<"resource://main">>,
        name = <<"Main">>
    },

    Result = erlmcp_server:encode_content_item(Content, Resource, <<"resource://main">>),

    ?assertIsMap(Result),
    ?assert(maps:is_key(?MCP_PARAM_TEXT, Result)),
    ?assert(maps:is_key(?MCP_PARAM_ANNOTATIONS, Result)),
    ?assert(maps:is_key(<<"resourceLink">>, Result)).

%% Test 18: Resource link in response structure
test_resource_link_in_response() ->
    Uri = <<"https://example.com/data.json">>,
    MimeType = <<"application/json">>,

    ResourceLink = erlmcp_server:encode_resource_link(Uri, MimeType, <<"Data API">>, 512),

    Response = #{
        ?MCP_PARAM_TYPE => ?MCP_CONTENT_TYPE_RESOURCE_LINK,
        <<"resourceLink">> => ResourceLink
    },

    ?assertIsMap(Response),
    StoredLink = maps:get(<<"resourceLink">>, Response),
    ?assertEqual(Uri, maps:get(?MCP_RESOURCE_LINK_FIELD_URI, StoredLink)),
    ?assertEqual(MimeType, maps:get(?MCP_RESOURCE_LINK_FIELD_MIME_TYPE, StoredLink)).

%% Test 19: Invalid size handling
test_invalid_size_handling() ->
    Uri = <<"https://example.com/file.txt">>,
    MimeType = <<"text/plain">>,
    InvalidSize = -100,

    %% Negative size should be ignored
    Result = erlmcp_server:encode_resource_link(Uri, MimeType, undefined, InvalidSize),

    ?assertFalse(maps:is_key(?MCP_RESOURCE_LINK_FIELD_SIZE, Result)).

%% Test 20: Resource link with various MIME types
test_resource_link_mime_types() ->
    MimeTypes = [
        <<"application/pdf">>,
        <<"text/plain">>,
        <<"text/html">>,
        <<"image/png">>,
        <<"image/jpeg">>,
        <<"video/mp4">>,
        <<"audio/mpeg">>,
        <<"application/json">>,
        <<"application/zip">>,
        <<"application/vnd.ms-excel">>
    ],

    Uri = <<"https://example.com/resource">>,

    lists:foreach(fun(MimeType) ->
        Result = erlmcp_server:encode_resource_link(Uri, MimeType),
        ?assertEqual(MimeType, maps:get(?MCP_RESOURCE_LINK_FIELD_MIME_TYPE, Result))
    end, MimeTypes).

%%====================================================================
%% Test Fixtures and Utilities
%%====================================================================

setup() ->
    ok.

cleanup(_) ->
    ok.

%%====================================================================
%% EUnit Test Descriptions
%%====================================================================

resource_link_encoding_test_() ->
    {setup,
        fun setup/0,
        fun cleanup/1,
        [
            {"Basic resource link encoding", fun test_encode_resource_link_basic/0},
            {"Resource link with name", fun test_encode_resource_link_with_name/0},
            {"Resource link with size", fun test_encode_resource_link_with_size/0},
            {"Resource link with all fields", fun test_encode_resource_link_with_all_fields/0}
        ]}.

resource_link_validation_test_() ->
    {setup,
        fun setup/0,
        fun cleanup/1,
        [
            {"HTTP URI validation", fun test_validate_resource_link_http_uri/0},
            {"HTTPS URI validation", fun test_validate_resource_link_https_uri/0},
            {"FTP URI validation", fun test_validate_resource_link_ftp_uri/0},
            {"FILE URI validation", fun test_validate_resource_link_file_uri/0},
            {"RESOURCE URI validation", fun test_validate_resource_link_resource_uri/0},
            {"DATA URI validation", fun test_validate_resource_link_data_uri/0},
            {"Absolute path validation", fun test_validate_resource_link_absolute_path/0},
            {"Relative path validation", fun test_validate_resource_link_relative_path/0},
            {"Parent path validation", fun test_validate_resource_link_parent_path/0},
            {"Empty URI rejection", fun test_validate_resource_link_invalid_empty/0},
            {"Invalid URI rejection", fun test_validate_resource_link_invalid_no_scheme/0}
        ]}.

resource_link_integration_test_() ->
    {setup,
        fun setup/0,
        fun cleanup/1,
        [
            {"Content with resource link", fun test_content_with_resource_link/0},
            {"Content with multiple fields and link", fun test_content_multiple_fields_with_link/0},
            {"Resource link in response", fun test_resource_link_in_response/0},
            {"Invalid size handling", fun test_invalid_size_handling/0},
            {"Various MIME types", fun test_resource_link_mime_types/0}
        ]}.

all_tests() ->
    [
        resource_link_encoding_test_(),
        resource_link_validation_test_(),
        resource_link_integration_test_()
    ].
