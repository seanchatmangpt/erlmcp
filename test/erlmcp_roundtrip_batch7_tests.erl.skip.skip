-module(erlmcp_roundtrip_batch7_tests).
-include_lib("eunit/include/eunit.hrl").
-include("erlmcp.hrl").

%%%===================================================================
%%% MCP Roundtrip Batch 7: Server Lifecycle Tests (Servers 31-35)
%%%===================================================================
%%% Tests MCP server lifecycle and basic operations:
%%% - Server startup
%%% - Tool registration
%%% - Resource registration
%%% - Concurrent server creation
%%% - Performance metrics
%%%
%%% 5 servers Ã— 5 operations = 25 total operations
%%%===================================================================

-define(SERVER_IDS, lists:seq(31, 35)).
-define(OPERATIONS_PER_SERVER, 20).

%%%-------------------------------------------------------------------
%%% Test Fixture: Setup/Teardown
%%%-------------------------------------------------------------------

batch7_test_() ->
    {setup,
     fun setup_batch7/0,
     fun teardown_batch7/1,
     fun run_batch7_tests/1}.

setup_batch7() ->
    error_logger:tty(false),
    application:ensure_all_started(erlmcp),
    {ok, Pids} = start_servers(?SERVER_IDS, []),
    timer:sleep(500),
    Pids.

teardown_batch7(ServerPids) ->
    stop_servers(ServerPids),
    error_logger:tty(true).

run_batch7_tests(ServerPids) ->
    [
     ?_test(test_server_creation(ServerPids)),
     ?_test(test_tool_addition(ServerPids)),
     ?_test(test_resource_addition(ServerPids)),
     ?_test(test_concurrent_creation(ServerPids)),
     ?_test(test_performance_benchmark(ServerPids))
    ].

%%%-------------------------------------------------------------------
%%% Tool Handler Functions
%%%-------------------------------------------------------------------

handle_stream_events(_ServerPid, Args) ->
    Count = maps:get(<<"count">>, Args, 10),
    Events = lists:map(fun(N) ->
        #{<<"event_number">> => N, <<"timestamp">> => erlang:system_time(millisecond)}
    end, lists:seq(1, Count)),
    {ok, #{<<"events">> => Events}}.

%%%-------------------------------------------------------------------
%%% Server Setup
%%%-------------------------------------------------------------------

start_servers([], Acc) ->
    {ok, lists:reverse(Acc)};
start_servers([Id | Ids], Acc) ->
    ServerId = list_to_binary("mcp_batch7_server_" ++ integer_to_list(Id)),

    Capabilities = #mcp_server_capabilities{
        resources = #mcp_resources_capability{},
        tools = #mcp_tools_capability{},
        prompts = #mcp_prompts_capability{}
    },

    case erlmcp_server:start_link(ServerId, Capabilities) of
        {ok, Pid} ->
            % Register tools
            erlmcp_server:add_tool(Pid, <<"stream_events">>,
                fun(Args) -> handle_stream_events(Pid, Args) end),

            % Register resource
            erlmcp_server:add_resource(Pid, <<"event_stream://test">>,
                fun(_Uri) -> {ok, #{<<"data">> => <<"test resource">>}} end),

            start_servers(Ids, [{Id, Pid} | Acc]);
        {error, Reason} ->
            error_logger:error_msg("Failed to start server ~p: ~p~n", [Id, Reason]),
            start_servers(Ids, Acc)
    end.

stop_servers(ServerPids) ->
    lists:foreach(fun({Id, Pid}) ->
        case erlmcp_server:stop(Pid) of
            ok -> ok;
            {error, Reason} ->
                error_logger:error_msg("Failed to stop server ~p: ~p~n", [Id, Reason])
        end
    end, ServerPids).

%%%-------------------------------------------------------------------
%%% Test 1: Server Creation
%%%-------------------------------------------------------------------

test_server_creation(ServerPids) ->
    error_logger:info_msg("=== Testing Server Creation ===~n"),

    TotalServers = length(ServerPids),
    OnlineServers = length([Pid || {_, Pid} <- ServerPids, is_pid(Pid) andalso is_process_alive(Pid)]),

    error_logger:info_msg("Server Creation: ~p/~p servers online~n", [OnlineServers, TotalServers]),
    ?assertEqual(TotalServers, OnlineServers).

%%%-------------------------------------------------------------------
%%% Test 2: Tool Addition
%%%-------------------------------------------------------------------

test_tool_addition(ServerPids) ->
    error_logger:info_msg("=== Testing Tool Addition ===~n"),

    % Add more tools to each server
    Results = lists:map(fun({ServerId, Pid}) ->
        % Try adding additional tools
        AddResults = lists:map(fun(N) ->
            ToolName = <<"dynamic_tool_", (integer_to_binary(N))/binary>>,
            case erlmcp_server:add_tool(Pid, ToolName, fun(_) -> {ok, #{}} end) of
                ok -> 1;
                {error, Reason} ->
                    error_logger:error_msg("Failed to add tool ~p: ~p~n", [ToolName, Reason]),
                    0
            end
        end, lists:seq(1, ?OPERATIONS_PER_SERVER)),

        SuccessCount = lists:sum(AddResults),
        error_logger:info_msg("Server ~p: ~p/~p tools added~n", [ServerId, SuccessCount, ?OPERATIONS_PER_SERVER]),
        {ServerId, SuccessCount, ?OPERATIONS_PER_SERVER}
    end, ServerPids),

    {TotalOps, SuccessfulOps} = lists:foldl(fun
        ({_SId, Success, Total}, {TotTotal, TotSuccess}) ->
            {TotTotal + Total, TotSuccess + Success}
    end, {0, 0}, Results),

    error_logger:info_msg("Tool Addition: ~p/~p successful~n", [SuccessfulOps, TotalOps]),
    ?assert(SuccessfulOps >= TotalOps * 0.95).

%%%-------------------------------------------------------------------
%%% Test 3: Resource Addition
%%%-------------------------------------------------------------------

test_resource_addition(ServerPids) ->
    error_logger:info_msg("=== Testing Resource Addition ===~n"),

    % Verify resource operations work
    Results = lists:map(fun({ServerId, Pid}) ->
        % Try to subscribe to the resource added during setup
        case erlmcp_server:subscribe_resource(Pid, <<"event_stream://test">>, self()) of
            ok ->
                error_logger:info_msg("Server ~p: resource subscription successful~n", [ServerId]),
                {ServerId, 1};
            {error, Reason} ->
                error_logger:error_msg("Server ~p: resource subscription failed: ~p~n", [ServerId, Reason]),
                {ServerId, 0}
        end
    end, ServerPids),

    {TotalServers, SuccessfulServers} = lists:foldl(fun
        ({_SId, 1}, {S, Succ}) -> {S + 1, Succ + 1};
        ({_SId, 0}, {S, Succ}) -> {S + 1, Succ}
    end, {0, 0}, Results),

    error_logger:info_msg("Resource Addition: ~p/~p servers have working resources~n", [SuccessfulServers, TotalServers]),
    ?assert(SuccessfulServers >= TotalServers * 0.80).

%%%-------------------------------------------------------------------
%%% Test 4: Concurrent Creation
%%%-------------------------------------------------------------------

test_concurrent_creation(ServerPids) ->
    error_logger:info_msg("=== Testing Concurrent Creation ===~n"),

    % Spawn concurrent server creation processes
    Self = self(),
    ServerIds = lists:seq(100, 104), % Use different IDs for concurrent test

    lists:foreach(fun(Id) ->
        spawn(fun() ->
            ServerId = list_to_binary("mcp_concurrent_server_" ++ integer_to_list(Id)),
            Capabilities = #mcp_server_capabilities{
                resources = #mcp_resources_capability{},
                tools = #mcp_tools_capability{},
                prompts = #mcp_prompts_capability{}
            },

            Result = case erlmcp_server:start_link(ServerId, Capabilities) of
                {ok, Pid} ->
                    % Add a tool
                    case erlmcp_server:add_tool(Pid, <<"concurrent_tool">>, fun(_) -> {ok, #{}} end) of
                        ok -> success;
                        {error, _} -> partial
                    end;
                {error, _} ->
                    error
            end,

            Self ! {Id, Result}
        end)
    end, ServerIds),

    % Collect results
    TotalConcurrent = length(ServerIds),
    SuccessCount = lists:foldl(fun(Id, Acc) ->
        receive
            {Id, success} -> Acc + 1;
            {Id, partial} -> Acc + 1;
            {Id, error} -> Acc
        after 5000 ->
            Acc
        end
    end, 0, ServerIds),

    error_logger:info_msg("Concurrent Creation: ~p/~p servers created~n", [SuccessCount, TotalConcurrent]),
    ?assert(SuccessCount >= TotalConcurrent * 0.80).

%%%-------------------------------------------------------------------
%%% Test 5: Performance Benchmark
%%%-------------------------------------------------------------------

test_performance_benchmark(ServerPids) ->
    error_logger:info_msg("=== Testing Performance Benchmark ===~n"),

    % Measure server operations performance
    {TotalOps, TotalLatencyUs} = lists:foldl(fun({ServerId, Pid}, {Ops, Latency}) ->
        Latencies = lists:map(fun(N) ->
            StartTime = erlang:monotonic_time(microsecond),

            % Measure add_tool performance
            ToolName = <<"bench_tool_", (integer_to_binary(N))/binary>>,
            case erlmcp_server:add_tool(Pid, ToolName, fun(_) -> {ok, #{}} end) of
                ok ->
                    EndTime = erlang:monotonic_time(microsecond),
                    EndTime - StartTime;
                {error, _} ->
                    1000000 % 1 second penalty
            end
        end, lists:seq(1, ?OPERATIONS_PER_SERVER)),

        ServerOps = length(Latencies),
        ServerLatency = lists:sum(Latencies),
        AvgLatency = ServerLatency div ServerOps,
        error_logger:info_msg("Server ~p: ~p ops, avg latency: ~p us~n", [ServerId, ServerOps, AvgLatency]),
        {Ops + ServerOps, Latency + ServerLatency}
    end, {0, 0}, ServerPids),

    AvgLatencyUs = TotalLatencyUs div max(TotalOps, 1),
    OpsPerSecond = case TotalLatencyUs of
        0 -> 0;
        _ -> (TotalOps * 1000000) div TotalLatencyUs
    end,

    error_logger:info_msg(
        "Performance Summary: ~p operations, avg latency: ~p us, rate: ~p ops/s~n",
        [TotalOps, AvgLatencyUs, OpsPerSecond]
    ),

    ?assert(TotalOps >= length(?SERVER_IDS) * ?OPERATIONS_PER_SERVER * 0.90),
    ?assert(AvgLatencyUs < 100000), % Less than 100ms average
    ?assert(OpsPerSecond > 50). % At least 50 ops/s
