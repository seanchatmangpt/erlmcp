%%%-------------------------------------------------------------------
%%% @doc erlmcp Integration Test Configuration
%%%
%%% Configuration for running integration tests with external services
%%% (PostgreSQL, Redis). Used by docker-compose.test.yml
%%%
%%% @end
%%%-------------------------------------------------------------------
[
    %% erlmcp_core application configuration
    {erlmcp_core, [
        %% Server configuration
        {server_id, integration_test},
        {log_level, info},

        %% Capabilities
        {capabilities, #{
            <<"resources">> => #{
                <<"subscribe">> => true,
                <<"listChanged">> => true
            },
            <<"tools">> => #{
                <<"listChanged">> => true
            },
            <<"prompts">> => #{
                <<"listChanged">> => true
            },
            <<"logging">> => true
        }},

        %% Test resources configuration
        {test_resources, [
            #mcp_resource{
                uri = <<"test://resource/1">>,
                name = <<"Test Resource 1">>,
                description = <<"First test resource for integration testing">>,
                mime_type = <<"text/plain">>,
                metadata = #{<<"type">> => <<"static">>, <<"version">> => <<"1.0">>}
            },
            #mcp_resource{
                uri = <<"test://resource/2">>,
                name = <<"Test Resource 2">>,
                description = <<"Second test resource with JSON content">>,
                mime_type = <<"application/json">>,
                metadata = #{<<"type">> => <<"dynamic">>, <<"version">> => <<"1.0">>}
            },
            #mcp_resource{
                uri = <<"test://resource/3">>,
                name = <<"Markdown Resource">>,
                description = <<"Markdown documentation resource">>,
                mime_type = <<"text/markdown">>,
                metadata = #{<<"type">> => <<"doc">>}
            }
        ]},

        %% Test tools configuration
        {test_tools, [
            #mcp_tool{
                name = <<"echo">>,
                description = <<"Echo input back - used for testing tool invocation">>,
                input_schema = #{
                    <<"type">> => <<"object">>,
                    <<"properties">> => #{
                        <<"message">> => #{
                            <<"type">> => <<"string">>,
                            <<"description">> => <<"Message to echo back">>
                        }
                    },
                    <<"required">> => [<<"message">>]
                },
                metadata = #{<<"category">> => <<"test">>, <<"version">> => <<"1.0">>}
            },
            #mcp_tool{
                name = <<"calculate">>,
                description = <<"Perform mathematical operations">>,
                input_schema = #{
                    <<"type">> => <<"object">>,
                    <<"properties">> => #{
                        <<"x">> => #{
                            <<"type">> => <<"number">>,
                            <<"description">> => <<"First operand">>
                        },
                        <<"y">> => #{
                            <<"type">> => <<"number">>,
                            <<"description">> => <<"Second operand">>
                        },
                        <<"operation">> => #{
                            <<"type">> => <<"string">>,
                            <<"enum">> => [<<"add">>, <<"subtract">>, <<"multiply">>, <<"divide">>],
                            <<"description">> => <<"Operation to perform">>
                        }
                    },
                    <<"required">> => [<<"x">>, <<"y">>, <<"operation">>]
                },
                metadata = #{<<"category">> => <<"math">>}
            }
        ]},

        %% Test prompts configuration
        {test_prompts, [
            #mcp_prompt{
                name = <<"test_prompt">>,
                description = <<"A simple test prompt template">>,
                arguments = [
                    #mcp_prompt_argument{
                        name = <<"name">>,
                        description = <<"User name to greet">>,
                        required = true
                    },
                    #mcp_prompt_argument{
                        name = <<"app">>,
                        description = <<"Application name">>,
                        required = false
                    }
                ]
            },
            #mcp_prompt{
                name = <<"summarize">>,
                description = <<"Summarize provided content">>,
                arguments = [
                    #mcp_prompt_argument{
                        name = <<"content">>,
                        description = <<"Content to summarize">>,
                        required = true
                    },
                    #mcp_prompt_argument{
                        name = <<"max_length">>,
                        description = <<"Maximum summary length">>,
                        required = false
                    }
                ]
            }
        ]},

        %% Subscription configuration
        {subscriptions, #{
            default_rate_limit => 1000,
            batch_window_ms => 100,
            max_subscriptions_per_resource => 100
        }},

        %% Test timeouts
        {test_timeouts, #{
            request_timeout => 30000,
            tool_timeout => 10000,
            resource_read_timeout => 5000
        }}
    ]},

    %% erlmcp_transports application configuration
    {erlmcp_transports, [
        {transports, [
            {stdio, [
                {enabled, true},
                {max_message_size, 16777216},  % 16 MB
                {encoding, utf8}
            ]},
            {http, [
                {enabled, true},
                {port, 8080},
                {max_connections, 100}
            ]}
        ]}
    ]},

    %% erlmcp_observability application configuration
    {erlmcp_observability, [
        {telemetry, [
            {enabled, true},
            {metrics_port, 9090}
        ]},
        {logging, [
            {level, info},
            {format, json}
        ]}
    ]},

    %% Database configuration (PostgreSQL for integration tests)
    {erlmcp_db, [
        {adapter, pgsql},
        {host, "postgres"},
        {port, 5432},
        {database, "erlmcp_test"},
        {user, "erlmcp_test"},
        {password, "erlmcp_test_password"},
        {pool_size, 10},
        {max_overflow, 20}
    ]},

    %% Redis configuration (for subscriptions and caching)
    {erlmcp_redis, [
        {host, "redis"},
        {port, 6379},
        {database, 0},
        {pool_size, 5},
        {reconnect_attempts, 3},
        {reconnect_timeout_ms, 1000}
    ]},

    %% Kernel configuration (integration test specific)
    {kernel, [
        {logger_level, info},
        {logger, [
            {handler, default, logger_std_h, #{
                level => info,
                config => #{
                    type => standard_io,
                    sync_mode_qlen => 10,
                    drop_mode_qlen => 50,
                    flush_qlen => 100
                },
                formatter => {logger_formatter, #{
                    single_line => true,
                    template => [time, " [", level, "] ", msg, "\n"]
                }}
            }}
        ]},
        {distributed, []},
        {net_ticktime, 60}
    ]},

    %% Common Test configuration
    {common_test, [
        {auto_compile, false},
        {create_priv_dir, auto_per_tc},
        {include, ["apps/erlmcp_core/include", "include"]},
        {logdir, "log/ct"}
    ]},

    %% SASL configuration
    {sasl, [
        {sasl_error_logger, false}
    ]}
].
