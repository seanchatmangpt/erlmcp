%%% ===================================================================
%%% TCPS Integration Test Configuration
%%%
%%% Common Test configuration for all TCPS integration test suites.
%%% Includes:
%%% - Database paths for test isolation
%%% - Mock service port configuration
%%% - Timeout settings for long-running tests
%%% - Coverage output directories
%%% - OTEL endpoint configuration
%%% ===================================================================

%% Application environment for test isolation
[
    {tcps, [
        %% Test data directory (isolated from production)
        {data_dir, "/tmp/tcps_test_data"},

        %% Test database paths
        {work_order_db, "/tmp/tcps_test_data/work_orders.db"},
        {receipt_db, "/tmp/tcps_test_data/receipts.db"},
        {andon_db, "/tmp/tcps_test_data/andons.db"},
        {kaizen_db, "/tmp/tcps_test_data/kaizen.db"},

        %% Receipt storage
        {receipt_dir, "/tmp/tcps_test_data/receipts"},

        %% Mock service endpoints
        {github_api_url, "http://localhost:9001"},
        {marketplace_api_url, "http://localhost:9002"},
        {cve_advisory_url, "http://localhost:9003"},
        {otlp_endpoint, "http://localhost:9004"},
        {sparql_endpoint, "http://localhost:9005/sparql"},

        %% Quality gate thresholds (test configuration)
        {min_test_pass_rate, 80.0},
        {min_code_coverage, 80.0},
        {max_compilation_warnings, 10},

        %% WIP limits (test configuration)
        {global_wip_limit, 20},
        {bucket_wip_limits, [
            {security, 5},
            {reliability, 5},
            {cost, 5},
            {compliance, 5}
        ]},

        %% Andon configuration
        {andon_escalation_timeout_ms, 5000},
        {andon_auto_resolve, false},

        %% Heijunka configuration
        {heijunka_enabled, true},
        {heijunka_scheduling_interval_ms, 1000},

        %% Deterministic build verification
        {deterministic_build_enabled, true},
        {build_reproducibility_checks, true},

        %% Dashboard (disabled for tests)
        {dashboard_enabled, false},
        {dashboard_port, 8080}
    ]},

    %% OpenTelemetry configuration for tests
    {opentelemetry, [
        {traces_exporter, {otlp, #{
            endpoints => [{http, "localhost", 9004, []}],
            protocol => http_protobuf
        }}},
        {resource, [
            {service, #{name => <<"tcps-test">>}},
            {attributes, [
                {environment, test},
                {test_suite, integration}
            ]}
        ]},
        {batch_processor, #{
            scheduled_delay_ms => 1000,
            max_queue_size => 2048
        }}
    ]},

    %% Kernel configuration
    {kernel, [
        {logger_level, warning},
        {logger, [
            {handler, default, logger_std_h, #{
                config => #{
                    file => "/tmp/tcps_test_data/logs/test.log",
                    max_no_files => 3,
                    max_no_bytes => 10485760
                },
                formatter => {logger_formatter, #{
                    single_line => true,
                    time_designator => $\s
                }}
            }}
        ]}
    ]},

    %% SASL configuration
    {sasl, [
        {sasl_error_logger, {file, "/tmp/tcps_test_data/logs/sasl.log"}},
        {errlog_type, error}
    ]}
].

%%% ===================================================================
%%% Common Test Specific Configuration
%%% ===================================================================

%% Timeouts (in milliseconds)
{ct_timeouts, [
    {suite_timeout, 600000},          % 10 minutes per suite
    {testcase_timeout, 120000},       % 2 minutes per test case
    {andon_wait_timeout, 5000},       % 5 seconds to wait for Andon
    {pipeline_timeout, 30000},        % 30 seconds for full pipeline
    {service_startup_timeout, 5000}   % 5 seconds for service startup
]}.

%% Coverage configuration
{cover, [
    {enabled, true},
    {export, "/tmp/tcps_test_data/cover"},
    {modules, [
        tcps_work_order,
        tcps_kanban,
        tcps_andon,
        tcps_kaizen,
        tcps_heijunka,
        tcps_quality,
        tcps_deterministic,
        tcps_receipt_verifier,
        tcps_persistence,
        tcps_root_cause
    ]},
    {level, detail}
]}.

%% Mock service port ranges
{mock_services, [
    {github_port, 9001},
    {marketplace_port, 9002},
    {cve_port, 9003},
    {otlp_port, 9004},
    {sparql_port, 9005},
    {port_range_start, 9000},
    {port_range_end, 9100}
]}.

%% Test data fixtures directory
{fixtures_dir, "test/integration/fixtures"}.

%% Performance benchmarking
{performance, [
    {enabled, true},
    {metrics_file, "/tmp/tcps_test_data/perf_metrics.json"},
    {profiler_enabled, false},
    {cpu_monitoring_enabled, true}
]}.
