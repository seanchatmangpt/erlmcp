-module(erlmcp_transport_registration_tests).
-include_lib("eunit/include/eunit.hrl").

%%====================================================================
%% Test Fixtures
%%====================================================================

setup() ->
    application:ensure_all_started(gproc),
    erlmcp_registry:start_link(),
    ok.

cleanup(_) ->
    ok.

%%====================================================================
%% stdio Transport Registration Tests
%%====================================================================

stdio_transport_registration_test_() ->
    {setup,
     fun setup/0,
     fun cleanup/1,
     [
      {"stdio transport registers on init",
       fun test_stdio_registration/0},
      {"stdio transport unregisters on terminate",
       fun test_stdio_unregistration/0}
     ]}.

test_stdio_registration() ->
    TransportId = test_stdio_transport,
    Owner = self(),

    %% Start transport with transport_id
    {ok, Pid} = erlmcp_transport_stdio:start_link(Owner, #{transport_id => TransportId}),

    %% Verify registration
    ?assertEqual(Pid, erlmcp_registry:whereis({transport, TransportId})),

    %% Cleanup
    erlmcp_transport_stdio:close(Pid),
    ok.

test_stdio_unregistration() ->
    TransportId = test_stdio_unreg,
    Owner = self(),

    %% Start transport
    {ok, Pid} = erlmcp_transport_stdio:start_link(Owner, #{transport_id => TransportId}),

    %% Verify registered
    ?assertEqual(Pid, erlmcp_registry:whereis({transport, TransportId})),

    %% Stop transport
    erlmcp_transport_stdio:close(Pid),

    %% Wait for cleanup
    timer:sleep(100),

    %% Verify unregistered
    ?assertEqual(undefined, erlmcp_registry:whereis({transport, TransportId})),
    ok.

%%====================================================================
%% TCP Transport Registration Tests
%%====================================================================

tcp_transport_registration_test_() ->
    {setup,
     fun setup/0,
     fun cleanup/1,
     [
      {"tcp client transport registers on init",
       fun test_tcp_client_registration/0},
      {"tcp client transport unregisters on terminate",
       fun test_tcp_client_unregistration/0}
     ]}.

test_tcp_client_registration() ->
    TransportId = test_tcp_client,
    Owner = self(),

    %% Start TCP client transport
    {ok, Pid} = erlmcp_transport_tcp:start_client(#{
        host => "localhost",
        port => 9999,
        owner => Owner,
        transport_id => TransportId,
        max_reconnect_attempts => 0  % Don't reconnect for test
    }),

    %% Verify registration
    ?assertEqual(Pid, erlmcp_registry:whereis({transport, TransportId})),

    %% Cleanup
    gen_server:stop(Pid),
    ok.

test_tcp_client_unregistration() ->
    TransportId = test_tcp_unreg,
    Owner = self(),

    %% Start TCP client
    {ok, Pid} = erlmcp_transport_tcp:start_client(#{
        host => "localhost",
        port => 9998,
        owner => Owner,
        transport_id => TransportId,
        max_reconnect_attempts => 0
    }),

    %% Verify registered
    ?assertEqual(Pid, erlmcp_registry:whereis({transport, TransportId})),

    %% Stop transport
    gen_server:stop(Pid),

    %% Wait for cleanup
    timer:sleep(100),

    %% Verify unregistered
    ?assertEqual(undefined, erlmcp_registry:whereis({transport, TransportId})),
    ok.

%%====================================================================
%% HTTP Transport Registration Tests
%%====================================================================

http_transport_registration_test_() ->
    {setup,
     fun setup/0,
     fun cleanup/1,
     [
      {"http transport registers on init",
       fun test_http_registration/0},
      {"http transport unregisters on terminate",
       fun test_http_unregistration/0}
     ]}.

test_http_registration() ->
    TransportId = test_http_transport,
    Owner = self(),

    %% Start HTTP transport
    {ok, Pid} = erlmcp_transport_http:start_link(#{
        url => "http://localhost:9997/mcp",
        owner => Owner,
        transport_id => TransportId
    }),

    %% Verify registration
    ?assertEqual(Pid, erlmcp_registry:whereis({transport, TransportId})),

    %% Cleanup
    gen_server:stop(Pid),
    ok.

test_http_unregistration() ->
    TransportId = test_http_unreg,
    Owner = self(),

    %% Start HTTP transport
    {ok, Pid} = erlmcp_transport_http:start_link(#{
        url => "http://localhost:9996/mcp",
        owner => Owner,
        transport_id => TransportId
    }),

    %% Verify registered
    ?assertEqual(Pid, erlmcp_registry:whereis({transport, TransportId})),

    %% Stop transport
    gen_server:stop(Pid),

    %% Wait for cleanup
    timer:sleep(100),

    %% Verify unregistered
    ?assertEqual(undefined, erlmcp_registry:whereis({transport, TransportId})),
    ok.

%%====================================================================
%% WebSocket Transport Registration Tests
%%====================================================================

websocket_transport_registration_test_() ->
    {setup,
     fun setup/0,
     fun cleanup/1,
     [
      {"websocket transport registers on connection",
       {timeout, 10, fun test_ws_registration/0}}
     ]}.

test_ws_registration() ->
    TransportId = <<"test_ws_transport">>,

    %% Start WS transport server
    {ok, _ServerPid} = erlmcp_transport_ws:init(TransportId, #{
        port => 18888,
        path => "/test/ws"
    }),

    %% Wait for server to start
    timer:sleep(500),

    %% Connect a WebSocket client (simulated via cowboy test)
    %% For now, just verify the server started
    %% Full WebSocket client connection testing requires cowboy_client

    %% Cleanup
    cowboy:stop_listener(erlmcp_ws_listener),
    ok.
