input {
  beats {
    port => 5044
  }
}

filter {
  # Parse timestamps
  grok {
    match => { "message" => "(?<timestamp>%{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{TIME})" }
    overwrite => [ "timestamp" ]
  }

  # Parse log levels
  grok {
    match => { "message" => "(?<log_level>%{WORD:log_level}): %{GREEDYDATA:log_message}" }
  }

  # Add erlmcp specific tags
  if [log_level] == "ERROR" {
    mutate {
      add_tag => ["erlmcp_error"]
    }
  } else if [log_level] == "WARN" {
    mutate {
      add_tag => ["erlmcp_warning"]
    }
  }

  # Parse JSON logs
  json {
    source => "message"
    target => "parsed_message"
  }

  # Add metadata
  mutate {
    add_field => {
      "cluster" => "erlmcp-swarm"
      "environment" => "production"
    }
  }

  # Remove duplicate message field
  mutate {
    remove_field => ["message"]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "erlmcp-logs-%{+YYYY.MM.dd}"
    template => "/usr/share/logstash/pipeline/logstash-template.json"
    template_name => "erlmcp-logs"
    template_overwrite => true
  }

  # Send to stdout for debugging
  stdout {
    codec => rubydebug
  }
}