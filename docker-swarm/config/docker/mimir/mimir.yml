# Mimir configuration for high-cardinality metrics storage

server:
  # Storage configuration
  storage:
    # Backend for high-cardinality data
    backend: s3
    s3:
      bucket: erlmcp-metrics
      endpoint: s3.amazonaws.com
      access_key_id: ${AWS_ACCESS_KEY_ID}
      secret_access_key: ${AWS_SECRET_ACCESS_KEY}
      region: ${AWS_REGION:-us-east-1}
      insecure: false
      sse_config:
        type: SSE-S3

    # Local cache for frequently accessed data
    chunk_encoding: snappy
    chunk_encoding: zstd
    encoding: snappy
    index_encoding_prefix: zstd

    # Chunk metadata cache
    metadata_cache:
      cache_dir: /data/mimir-cache
      max_size_mb: 2048
      ttl: 24h

  # Query configuration
  query_range:
    max_results_per_query: 500000
    max_query_length: 12h

    # Downsampling configuration
    downsampling:
      enabled: true
      resolutions:
        - 1m
        - 5m
        - 15m
        - 30m
        - 1h
        - 6h
        - 1d

      # Retention policies
      retention:
        - resolution: 1m
          period: 7d
        - resolution: 5m
          period: 30d
        - resolution: 15m
          period: 90d
        - resolution: 30m
          period: 180d
        - resolution: 1h
          period: 1y
        - resolution: 6h
          period: 2y
        - resolution: 1d
          period: 10y

  # Gateway configuration
  gateway:
    http_listen_address: 0.0.0.0:8080
    grpc_listen_address: 0.0.0.0:9095

    # Authentication
    auth:
      type: openid
      openid:
        issuer: https://accounts.example.com
        client_id: mimir-client
        client_secret: ${OIDC_CLIENT_SECRET}
        scopes:
          - openid
          - profile
          - email

    # Rate limiting
    rate_limit:
      enabled: true
      requests_per_second: 1000
      burst_size: 5000

  # Alerting configuration
  alertmanager:
    enabled: true
    uri: http://alertmanager:9093
    external_url: http://mimir:8080
    notification_timeout: 10s

  # Configuration for blocks
  blocks:
    # Number of blocks to keep in memory
    memory_chunks_to_keep: 10000
    # Number of blocks to process in parallel
    concurrent_compaction: 4
    # Maximum number of blocks to compact in one go
    max_compaction_concurrency: 1
    # Minimum age of a block before it can be compacted
    compaction_interval: 24h

# Feature flags
feature_flags:
  # Enable parallel query processing
  parallel_query: true
  # Enable query caching
  query_cache: true
  # Enable metadata caching
  metadata_cache: true
  # Enable metrics for query processing
  metrics_for_query: true
  # Enable fast forwarding
  fast_forwarding: true

# Runtime configuration
runtime:
  # Process configuration
  process:
    # Number of workers
    workers: 8
    # Maximum number of open files
    max_open_files: 1000000
    # Maximum memory usage
    max_memory_usage_mb: 8192

  # GC configuration
  gc:
    # When to run GC
    enabled: true
    # Interval between GC runs
    interval: 30m
    # Maximum memory before GC is forced
    max_memory_before_gc_mb: 4096
    # Percentage of memory to free
    memory_to_free_mb: 1024

# Observability configuration
observability:
  # Tracing
  tracing:
    enabled: true
    otlp:
      enabled: true
      grpc:
        endpoint: otel-collector:4317
      http:
        endpoint: http://otel-collector:4318

  # Metrics
  metrics:
    enabled: true
    # Enable built-in metrics
    built_in: true
    # Additional metrics to expose
    additional:
      - prometheus_http_requests_total
      - prometheus_http_duration_seconds
      - prometheus_scrape_duration_seconds

  # Logging
  logging:
    level: info
    format: json
    file: /var/log/mimir/mimir.log
    max_size_mb: 100
    max_age_hours: 24
    max_backups: 10

# Security configuration
security:
  # TLS configuration
  tls:
    enabled: true
    cert_file: /etc/mimir/tls.crt
    key_file: /etc/mimir/tls.key
    min_version: TLS12
    cipher_suites:
      - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
      - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256

  # Authentication
  auth:
    # Admin users
    admin:
      users:
        - admin
        - operator
    # Regular users
    user:
      users:
        - erlmcp
    # Service accounts
    service_accounts:
      - name: erlmcp-api
        roles:
          - query
      - name: grafana
        roles:
          - query
          - read

# Storage schema
schema:
  # Label index
  label_index:
    enabled: true
    # Maximum number of labels
    max_labels: 1000
    # Maximum label length
    max_label_length: 1024
    # Maximum number of label values
    max_label_values: 100

  # Time range index
  time_range_index:
    enabled: true
    # Maximum number of time ranges
    max_time_ranges: 100000
    # Minimum time range size
    min_time_range_size: 1m
    # Maximum time range size
    max_time_range_size: 1y

# Query optimization
query:
  # Caching
  cache:
    enabled: true
    max_size_mb: 1024
    ttl: 1h
    max_queries: 10000

  # Query planning
  planner:
    # Maximum number of series
    max_series_per_query: 100000
    # Maximum number of chunks per query
    max_chunks_per_query: 1000000
    # Maximum number of rows per query
    max_rows_per_query: 10000000

  # Query execution
  execution:
    # Maximum number of workers per query
    max_workers_per_query: 8
    # Maximum number of parallel series
    max_parallel_series: 1000
    # Maximum number of steps per series
    max_steps_per_series: 100000

# Alertmanager configuration
alertmanager:
  # Alertmanager instance
  instance:
    enabled: true
    uri: http://alertmanager:9093
    external_url: http://mimir:8080
    notification_timeout: 10s

  # Alertmanager configuration
  config:
    # Global configuration
    global:
      # Slack webhook URL
      slack_api_url: ${SLACK_WEBHOOK_URL}
      # PagerDuty integration
      pagerduty_url: ${PAGERDUTY_URL}
      # SMTP configuration
      smtp_smarthost: ${SMTP_SERVER}:587
      smtp_from: ${SMTP_FROM}
      smtp_auth_username: ${SMTP_USERNAME}
      smtp_auth_password: ${SMTP_PASSWORD}

    # Alertmanager receivers
    receivers:
      - name: "slack-notifications"
        email_configs:
          - to: "alerts@example.com"
            subject: "Mimir Alert"
            body: "{{ .CommonAnnotations.description }}"
      - name: "pagerduty-notifications"
        pagerduty_configs:
          - service_key: ${PAGERDUTY_SERVICE_KEY}
            description: "{{ .CommonAnnotations.summary }}"

    # Alertmanager routes
    route:
      group_by: ["alertname", "cluster"]
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: "slack-notifications"