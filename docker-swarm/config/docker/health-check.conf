# Health check configuration for erlmcp v3

[global]
# Health check settings
check_interval = 30s
timeout = 10s
retry_count = 3
start_period = 60s

# Default health check command
default_command = "/opt/erlmcp/bin/health_check.sh"

# Default HTTP health check
default_http_check = {
  url = "http://localhost:8080/health"
  expected_status = 200
  timeout = 5s
}

# Default TCP health check
default_tcp_check = {
  address = "localhost:8080"
  timeout = 5s
}

[erlmcp-core]
# erlmcp core service health checks
health_check_command = "/opt/erlmcp/bin/check_core.sh"
memory_threshold = 90%
cpu_threshold = 80%
response_time_threshold = 2000ms

# HTTP health check
http_check = {
  url = "http://localhost:8080/health"
  expected_status = 200
  timeout = 10s
  method = "GET"
  headers = {
    "X-Request-ID" = "{{.ServiceID}}"
  }
}

# TCP health check
tcp_check = {
  address = "localhost:8080"
  timeout = 5s
}

# Database connectivity check
db_check = {
  type = "postgresql"
  host = "postgres"
  port = 5432
  database = "erlmcp"
  username = "erlmcp_user"
  query = "SELECT 1"
  timeout = 5s
}

[redis]
# Redis health checks
redis_check = {
  command = "redis-cli"
  args = ["-a", "${ERLMCP_REDIS_PASSWORD}", "ping"]
  timeout = 5s
  expected_output = "PONG"
}

# Memory usage check
redis_memory_check = {
  threshold = 85%
  command = "redis-cli"
  args = ["-a", "${ERLMCP_REDIS_PASSWORD}", "INFO", "memory"]
  parse_command = "grep used_memory:"
}

[prometheus]
# Prometheus health checks
prometheus_check = {
  url = "http://localhost:9090/-/healthy"
  expected_status = 200
  timeout = 10s
}

# Metrics collection check
metrics_check = {
  url = "http://localhost:9090/api/v1/query?query=up"
  expected_status = 200
  timeout = 5s
  expected_contains = "result"
}

[grafana]
# Grafana health checks
grafana_check = {
  url = "http://localhost:3000/api/health"
  expected_status = 200
  timeout = 10s
}

# Dashboard availability check
dashboard_check = {
  url = "http://localhost:3000/api/dashboards/home"
  expected_status = 200
  timeout = 5s
}

[postgres]
# PostgreSQL health checks
postgres_check = {
  type = "postgresql"
  host = "postgres"
  port = 5432
  database = "erlmcp"
  username = "erlmcp_user"
  query = "SELECT 1"
  timeout = 5s
}

# Connection pool check
pool_check = {
  type = "postgresql"
  host = "postgres"
  port = 5432
  database = "erlmcp"
  username = "erlmcp_user"
  query = "SELECT count(*) FROM pg_stat_activity WHERE state = 'active'"
  expected_count = 50
}

[traefik]
# Traefik health checks
traefik_check = {
  url = "http://localhost:8080/api/health"
  expected_status = 200
  timeout = 10s
}

# Router check
router_check = {
  url = "http://localhost:8080/api/routers"
  expected_status = 200
  timeout = 5s
  expected_contains = "erlmcp"
}

[kafka]
# Kafka health checks
kafka_check = {
  command = "kafka-broker-api-versions"
  args = ["--bootstrap-server", "localhost:9092"]
  timeout = 10s
  expected_output = "successfully"
}

# Topic check
topic_check = {
  command = "kafka-topics"
  args = ["--bootstrap-server", "localhost:9092", "--list"]
  expected_contains = "erlmcp"
}

[elasticsearch]
# Elasticsearch health checks
elasticsearch_check = {
  url = "http://localhost:9200/_cluster/health?pretty"
  expected_status = 200
  timeout = 10s
  expected_contains = "green"
}

# Index check
index_check = {
  url = "http://localhost:9200/_cat/indices?v"
  expected_status = 200
  timeout = 5s
  expected_contains = "health"
}

[otel-collector]
# OpenTelemetry Collector health checks
otel_check = {
  url = "http://localhost:8888"
  expected_status = 200
  timeout = 5s
}

# Metrics check
metrics_otel_check = {
  url = "http://localhost:8888/metrics"
  expected_status = 200
  timeout = 5s
  expected_contains = "otel_collector_build_info"
}