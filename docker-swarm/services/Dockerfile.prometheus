# Prometheus for erlmcp v3 monitoring
FROM prom/prometheus:v2.48.0-alpine

# Install additional tools
RUN apk add --no-cache curl bash

# Create prometheus user
RUN addgroup -g 1003 -S prometheus && \
    adduser -S prometheus -u 1003

# Create directories
RUN mkdir -p /etc/prometheus /data /var/log/prometheus && \
    chown -R prometheus:prometheus /etc/prometheus /data /var/log/prometheus

# Copy Prometheus configuration
COPY config/docker/prometheus.yml /etc/prometheus/prometheus.yml

# Create alert rules
COPY config/docker/alert_rules.yml /etc/prometheus/alert_rules.yml

# Create liveness and readiness probes
COPY config/docker/probes.sh /usr/local/bin/probes.sh
RUN chmod +x /usr/local/bin/probes.sh

# Configure storage
COPY config/docker/tsdb.yml /etc/prometheus/tsdb.yml

# Expose ports
EXPOSE 9090 9091

# Storage
USER prometheus

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD /usr/local/bin/probes.sh

# Persistence
VOLUME ["/data"]

# Command
ENTRYPOINT ["prometheus", \
    "--config.file=/etc/prometheus/prometheus.yml", \
    "--storage.tsdb.path=/data", \
    "--web.console.libraries=/etc/prometheus/console_libraries", \
    "--web.console.templates=/etc/prometheus/consoles", \
    "--storage.tsdb.retention.time=30d", \
    "--web.enable-lifecycle", \
    "--web.enable-admin-api", \
    "--web.route-prefix=/"]