# =============================================================================
# ErlMCP Multi-Stage Dockerfile
# =============================================================================
# Generated from: ggen/ontology/instances/dockerfile.ttl
#
# Build stages:
#   1. builder - Compile with rebar3
#   2. runtime - Minimal runtime image
#
# Features:
#   - Minimal final image (Ubuntu base, no build tools)
#   - Security: non-root user (appuser:1000:1000)
#   - Optimized layer caching
#   - Health check on /health endpoint
#   - Exposed ports: 8080 (API), 9100 (metrics), 9090 (health)
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: BUILDER
# -----------------------------------------------------------------------------
# Purpose: Compile Erlang/OTP application with rebar3
# Base: ghcr.io/hexpm/elixir:ubuntu-erlang-26
# -----------------------------------------------------------------------------
FROM erlang:27-alpine AS builder

# Build metadata labels
LABEL maintainer="erlmcp@erlmcp.org" \
      version="3.0.0" \
      description="ErlMCP - Erlang/OTP MCP SDK - Builder Stage" \
      org.opencontainers.image.source="https://github.com/erlmcp/erlmcp"

# Environment variables for build
ENV REBAR_CACHE_DIR=/cache/rebar3 \
    HOME=/tmp \
    DEBIAN_FRONTEND=noninteractive

# Install build dependencies (minimal set - Alpine uses apk)
RUN set -eux && \
    apk add --no-cache \
        ca-certificates-bundle \
        curl \
        git \
        build-base \
        openssl-dev

# Configure git for safe directory (Docker context)
RUN git config --global --add safe.directory /usr/src/app

# Create working directory
WORKDIR /usr/src/app

# -----------------------------------------------------------------------------
# Layer Cache Optimization Strategy:
#   1. rebar.config (changes rarely)
#   2. rebar.lock (changes when deps update)
#   3. Source code (changes frequently)
# This maximizes cache hits during development
# -----------------------------------------------------------------------------

# Copy dependency files first (for better caching)
COPY rebar.config ./
COPY rebar.lock ./

# Download dependencies (cached layer)
RUN set -eux && \
    rebar3 get-deps

# Copy source code
COPY . .

# Compile application
# Note: swarmflow_os and swarmflow_pqchain are temporarily excluded due to compilation issues
RUN set -eux && \
    rm -rf _build apps/swarmflow_os apps/swarmflow_pqchain && \
    rebar3 compile

# Create production release
# - Extract tarball to temporary location
# - Only copy what's needed to runtime stage
# Note: tar generation may have symlink warnings, but release assembly succeeds
RUN set -eux && \
    VERSION=$(rebar3 version | tr -d '"') && \
    (rebar3 as prod tar || true) && \
    mkdir -p /tmp/release && \
    tar -xzf _build/prod/rel/erlmcp/*.tar.gz -C /tmp/release || \
    (cp -r _build/prod/rel/erlmcp/* /tmp/release/ && echo "Copied release directly")

# -----------------------------------------------------------------------------
# Stage 2: RUNTIME
# -----------------------------------------------------------------------------
# Purpose: Minimal runtime image with only compiled beams
# Base: ubuntu:24.04
# -----------------------------------------------------------------------------
FROM alpine:3.21 AS runtime

# Runtime metadata labels
LABEL maintainer="erlmcp@erlmcp.org" \
      version="3.0.0" \
      description="ErlMCP - Erlang/OTP MCP SDK - Runtime Stage" \
      org.opencontainers.image.source="https://github.com/erlmcp/erlmcp"

# Set locale
ENV LANG=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive \
    ERL_AFLAGS="-kernel shell_history enabled" \
    RELEASE_ROOT=/opt/erlmcp \
    BIND_ADDR=0.0.0.0 \
    PORT=8080

# Install minimal runtime dependencies
RUN set -eux && \
    apk add --no-cache \
        openssl-libs-static \
        ncurses-libs \
        libstdc++ \
        libgcc \
        curl \
        ca-certificates-bundle

# Create application directories
RUN set -eux && \
    mkdir -p /opt/erlmcp \
             /var/log/erlmcp \
             /var/lib/erlmcp \
             /home/appuser

# Create non-root user for security (Alpine uses adduser/addgroup)
RUN set -eux && \
    addgroup -g 1000 appuser && \
    adduser -u 1000 -G appuser -h /home/appuser -s /bin/sh -D appuser && \
    chown -R appuser:appuser /opt/erlmcp \
                           /var/log/erlmcp \
                           /var/lib/erlmcp \
                           /home/appuser

# Copy compiled release from builder stage
COPY --from=builder --chown=appuser:appuser /tmp/release/ /opt/erlmcp/

# Switch to non-root user
USER appuser
WORKDIR /opt/erlmcp

# Expose ports
#   8080 - JSON-RPC 2.0 API endpoint
#   9100 - Prometheus metrics exporter
#   9090 - Health check endpoint
EXPOSE 8080 9100 9090

# Health check
# - Interval: 30s
# - Timeout: 10s
# - Start period: 40s (allow time for startup)
# - Retries: 3
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -fSs http://localhost:8080/health || exit 1

# Entry point and default command
ENTRYPOINT ["/opt/erlmcp/bin/erlmcp"]
CMD ["foreground"]
