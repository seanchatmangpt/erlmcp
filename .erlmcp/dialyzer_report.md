# Dialyzer Analysis Report

**Date**: 2026-02-01  
**OTP Version**: 28.3.1  
**Dialyzer Version**: v5.4  
**PLT**: erlmcp_28.3.1_plt  
**Warnings Enabled**: error_handling, underspecs, unknown, unmatched_returns

## Summary

- **Total Warnings**: 849
- **Files Analyzed**: Core + Observability apps (excluded transports with missing includes)
- **Modules with Warnings**: 100+
- **Warning Categories**: 15+ types

## Top Warning Types

| Rank | Warning Type | Count | Severity |
|------|--------------|-------|----------|
| 1 | Expression produces a value of type | 93 | Medium |
| 2 | The pattern can never match | 75 | High |
| 3 | Variable can never match (type coverage) | 49 | Medium |
| 4 | Matching of pattern | 22 | Medium |
| 5 | Record construction | 21 | Low |
| 6 | Call to missing function `timer:cancel/1` | 10 | High |
| 7 | Function init/1 has no local return | 7 | Low |
| 8 | Call to missing function `erlang:process_next/1` | 7 | High |
| 9 | The call ets:whereis | 4 | Medium |
| 10 | Call to missing function `erlang:get_stacktrace/0` | 3 | High |

## Top Modules by Warning Count

| Rank | Module | Warnings | Category |
|------|--------|----------|----------|
| 1 | erlmcp_server.erl | 77 | Core MCP server |
| 2 | erlmcp_capabilities.erl | 75 | Capability negotiation |
| 3 | erlmcp_json_rpc.erl | 57 | Protocol handling |
| 4 | erlmcp_client.erl | 24 | MCP client |
| 5 | erlmcp_test_helpers.erl | 21 | Test utilities |
| 6 | erlmcp.erl | 20 | Main API |
| 7 | erlmcp_secrets.erl | 20 | Secrets management |
| 8 | erlmcp_cache.erl | 19 | Caching layer |
| 9 | erlmcp_pool_poc.erl | 18 | Connection pooling |
| 10 | erlmcp_code_reload.erl | 18 | Hot code upgrade |

## Critical Issues

### 1. Missing/Deprecated Functions
- **erlang:process_next/1** (7 calls) - Non-existent function
- **erlang:get_stacktrace/0** (3 calls) - Deprecated in OTP 21+, use `erlang:get_stacktrace/0` removed
- **timer:cancel/1** (10 calls) - Wrong arity, should be `timer:cancel/1` â†’ `timer:cancel(TimerRef)` returns `{ok, TRef | false}`

### 2. Type Specification Issues
Many specs are too broad (supertype of success typing):
- Return types use `term()` instead of specific types
- Pattern matching on overly broad types
- Example: `erlmcp:stop_server/1` spec says `{'error', term()}` but success typing shows `{'error', 'not_found'}`

### 3. Unreachable Code Patterns
- 75 pattern matches that can never succeed
- 49 variables covered by previous clauses
- Often due to overly specific type assertions in specs

## Detailed Warnings by Category

### Type Specifications (400+ warnings)
- Specs that are supertypes of actual success typing
- Missing specs for public functions (underspecs)
- Overspecified return types

### Pattern Matching (150+ warnings)
- Patterns that can never match the inferred type
- Variables made redundant by previous clauses
- Guard clauses that are always true/false

### API Calls (50+ warnings)
- Calls to non-existent or deprecated functions
- Wrong arities for standard library functions
- Missing error handling paths

## Recommendations

### Priority 1: Fix Critical Function Calls
1. Replace `erlang:get_stacktrace/0` with proper try/catch stacktrace
2. Fix `erlang:process_next/1` calls (remove or replace)
3. Correct `timer:cancel/1` usage

### Priority 2: Tighten Type Specifications
1. Replace `term()` with specific error types
2. Use proper success typing from Dialyzer output
3. Add `-dialyzer({nowarn_function, F/A})` for intentional deviations

### Priority 3: Fix Unreachable Code
1. Review pattern matches that can never succeed
2. Remove redundant clause variables
3. Simplify overly complex type guards

### Priority 4: Transport App Issues
Fix missing includes in transport modules:
```erlang
%% erlmcp_transport_ws.erl and erlmcp_transport_sse.erl
-include_lib("opentelemetry_api/include/otel_tracer.hrl").
```
Add include path or make optional.

## Excluded Files

Not analyzed due to compilation errors:
- `erlmcp_chaos_injector.erl` - Duplicate `init/1`, undefined `log_chaos/2`
- `erlmcp_cli_observability.erl` - Syntax errors, undefined VERSION macro
- `erlmcp_transport_ws.erl` - Missing include
- `erlmcp_transport_sse.erl` - Missing include

## Next Steps

1. Fix compilation errors in excluded files
2. Address critical missing/deprecated function calls
3. Run Dialyzer incrementally on fixed modules
4. Target: Reduce warnings from 849 to <100 (high priority modules first)

## Verification Command

```bash
export PATH="/usr/bin:/bin:/usr/local/bin:/usr/local/sbin:/Users/sac/erlmcp/.erlmcp/otp-28.3.1/bin:/opt/homebrew/bin:$PATH"
dialyzer --plt _build/default/erlmcp_28.3.1_plt \
  -Werror_handling -Wunderspecs -Wunknown -Wunmatched_returns \
  apps/erlmcp_core/src/*.erl \
  apps/erlmcp_observability/src/*.erl
```

---

**Generated by**: erlmcp build-engineer agent  
**Log file**: `.erlmcp/dialyzer_core_observability.log`
