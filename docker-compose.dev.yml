# ==============================================================================
# erlmcp v3 - Development Docker Compose Environment
# ==============================================================================
# Generated by: ggen ontology-driven code generation
# Source: ggen/ontology/instances/docker_compose.ttl
# Date: 2026-02-03
#
# Purpose: Full-featured development environment with hot reloading,
#          observability, and debugging support.
#
# Services:
#   - erlmcp: Main application with hot-reloaded source mounts
#   - postgres: PostgreSQL 16 for persistence
#   - redis: Redis 7 for caching and pub/sub
#   - prometheus: Metrics collection
#   - grafana: Metrics visualization
#   - otel-collector: OpenTelemetry trace/log/metric collection
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d
#   docker compose -f docker-compose.dev.yml logs -f erlmcp
#   docker compose -f docker-compose.dev.yml down -v
#
# AGI Joe Armstrong: "Make it work, make it right, make it fast."
# ==============================================================================

services:
  # ============================================================================
  # Main Application Service
  # ============================================================================
  erlmcp:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: erlmcp:dev
    container_name: erlmcp-dev
    restart: unless-stopped
    working_dir: /workspace

    # Port mappings
    # 8080: HTTP API endpoint
    # 4369: EPMD (Erlang Port Mapper Daemon)
    # 9100: Erlang distribution port
    # 9200: Debug observer console
    ports:
      - "8080:8080"
      - "4369:4369"
      - "9100:9100"
      - "9200:9200"

    # Environment configuration
    environment:
      - ERLMCP_PROFILE=dev
      - ERLMCP_NODE_NAME=erlmcp@erlmcp-dev
      - ERLANG_COOKIE=erlmcp_dev_cookie_change_in_production
      - ERLMCP_DISTRIBUTION_MODE=development
      - ERLMCP_LOG_LEVEL=debug
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - ERLMCP_POSTGRES_URI=postgresql://erlmcp:dev_password@postgres:5432/erlmcp
      - ERLMCP_REDIS_URI=redis://redis:6379
      - ERL_COMPILER_OPTIONS=deterministic
      - REBAR_NO_USER_CONFIG=true
      - TERM=dumb

    # Volume mounts for hot reloading
    volumes:
      # Source code - read/write for hot reload
      - ./apps:/workspace/apps:rw
      # Configuration - read only for safety
      - ./config:/workspace/config:ro
      # Build artifacts - shared with host
      - ./_build:/workspace/_build:rw
      # Logs - accessible from host
      - ./log:/workspace/log:rw
      # Include files for compilation
      - ./include:/workspace/include:ro
      # Rebar config
      - ./rebar.config:/workspace/rebar.config:ro
      - ./rebar.lock:/workspace/rebar.lock:ro
      - ./vm.args:/workspace/vm.args:ro

    # Service dependencies
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      prometheus:
        condition: service_started
      otel-collector:
        condition: service_started

    # Network attachment
    networks:
      - erlmcp-dev

    # Health check
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Keep container running for development
    command: ["sh", "-c", "rebar3 shell --apps erlmcp_core"]

  # ============================================================================
  # PostgreSQL Database Service
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: erlmcp-postgres-dev
    restart: unless-stopped

    ports:
      - "5432:5432"

    environment:
      - POSTGRES_PASSWORD=dev_password
      - POSTGRES_DB=erlmcp
      - POSTGRES_USER=erlmcp
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C

    volumes:
      - postgres-dev-data:/var/lib/postgresql/data
      - ./config/docker/postgres-init:/docker-entrypoint-initdb.d:ro

    networks:
      - erlmcp-dev

    healthcheck:
      test: ["CMD", "pg_isready", "-U", "erlmcp", "-d", "erlmcp"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================================
  # Redis Cache Service
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: erlmcp-redis-dev
    restart: unless-stopped

    ports:
      - "6379:6379"

    volumes:
      - redis-dev-data:/data

    networks:
      - erlmcp-dev

    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================================================
  # Prometheus Metrics Service
  # ============================================================================
  prometheus:
    image: prom/prometheus:v2.55.1
    container_name: erlmcp-prometheus-dev
    restart: unless-stopped

    ports:
      - "9090:9090"

    volumes:
      - ./config/docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-dev-data:/prometheus

    networks:
      - erlmcp-dev

    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--enable-feature=exemplar-storage"

  # ============================================================================
  # Grafana Visualization Service
  # ============================================================================
  grafana:
    image: grafana/grafana:11.3.1
    container_name: erlmcp-grafana-dev
    restart: unless-stopped

    ports:
      - "3000:3000"

    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/home.json

    volumes:
      - grafana-dev-data:/var/lib/grafana
      - ./config/docker/grafana/provisioning:/etc/grafana/provisioning:ro

    networks:
      - erlmcp-dev

    depends_on:
      prometheus:
        condition: service_started

  # ============================================================================
  # OpenTelemetry Collector Service
  # ============================================================================
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.114.0
    container_name: erlmcp-otel-dev
    restart: unless-stopped

    ports:
      - "4318:4318"  # OTLP HTTP
      - "4317:4317"  # OTLP gRPC
      - "9464:9464"  # Prometheus metrics exporter

    volumes:
      - ./config/docker/otel-collector.yaml:/etc/otel-collector/config.yaml:ro

    networks:
      - erlmcp-dev

    command: ["--config=/etc/otel-collector/config.yaml"]

# ==============================================================================
# Named Volumes
# ==============================================================================
volumes:
  postgres-dev-data:
    name: erlmcp-postgres-dev-data
    driver: local

  redis-dev-data:
    name: erlmcp-redis-dev-data
    driver: local

  prometheus-dev-data:
    name: erlmcp-prometheus-dev-data
    driver: local

  grafana-dev-data:
    name: erlmcp-grafana-dev-data
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  erlmcp-dev:
    name: erlmcp-dev
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
