%% -*- erlang -*-
%% vim: set ft=erlang ts=4 sw=4 et:

%% Rebar3 configuration for erlmcp
%% Purpose: Multi-application (umbrella) project for Model Context Protocol SDK
%% Structure: apps/{erlmcp_core, erlmcp_transports, erlmcp_observability, erlmcp_validation, erlmcp_compliance}

%% Minimum OTP version - STRICT: Only OTP 28+ allowed
%% This project requires Erlang/OTP 28+ for:
%%   - OTP 28: Priority messages, hibernate/0, PCRE2 regex, process iteration improvements
%%   - OTP 27: runtime_dependencies enforcement, json module, enhanced monitoring
%%   - OTP 26: Concurrent application startup, persistent configuration, prep_stop/1
%%   - Modern language features: Maybe expressions (default), map comprehensions, improved shell
%%   - Performance: JIT improvements, Base64 3-4x faster, TLS 1.3 15-25% faster
%%   - Security: SSL verify_peer default, legacy alg disabled, safer defaults
%% Lower versions will fail with a clear error message.
%% See docs/OTP_APPLICATION_CONFIG_RESEARCH.md for version-specific features.
{minimum_otp_vsn, "28"}.

%% Dependencies (shared across all apps)
{deps,
 [% JSON encoding/decoding (using OTP 27+ native json module)
  % jsx removed - migrated to native json:decode/encode
  % JSON Schema validation (jesse maintained fork)
  {jesse, "1.8.1"},
  % Process registry (O(log N) lookup)
  {gproc, "0.9.0"},
  % HTTP client (gun for HTTP/2 and WebSocket)
  {gun, "2.0.1"},
  % TCP acceptor pool (ranch)
  {ranch, "2.1.0"},
  % Connection pooling (poolboy)
  {poolboy, "1.5.2"},
  % HTTP server (cowboy for HTTP/WebSocket/SSE)
  {cowboy, "2.10.0"},
  % Template engine (bbmustache)
  {bbmustache, "1.12.2"},
  % JWT validation (CRITICAL - security dependency)
  {jose, "1.11.1"},
  % OpenTelemetry (observability)
  {opentelemetry_api, "1.5.0"},
  {opentelemetry, "1.7.0"},
  {opentelemetry_exporter, "1.10.0"},
  %% Compliance framework
  % {elixir, "~> 1.15"},     % Elixir support for policy templates - temporarily disabled
  % {yaml, "~> 2.0"}]}.        % YAML support for configuration files - temporarily disabled

%% Shell (for `rebar3 shell`)
{shell,
 [{apps, [erlmcp_core, erlmcp_transports, erlmcp_observability, erlmcp_validation]},  % erlmcp_compliance disabled due to Elixir dependency
  {config, "config/sys.config"},
  {vm_args, "vm.args"}]}.

%% EUnit configuration
{eunit_opts, [verbose, {report, {eunit_surefire, [{dir, "log/eunit"}]}}, {cover_enabled, true}]}.

%% Common Test configuration
{ct_opts, [{logdir, "log/ct"}, {cover_enabled, true}]}.

%% Coverage configuration
{cover_enabled, true}.

{cover_opts, [verbose]}.

{cover_export_enabled, true}.

%% Dialyzer configuration
{dialyzer,
 [{warnings, [error_handling, underspecs, unknown, unmatched_returns]},
  {get_warnings, true},
  {plt_apps, all_deps},
  {plt_location, local},
  {plt_prefix, "erlmcp"},
  {dialyzer_options, [incremental]},  % OTP 26+: Incremental mode (3-7x faster)
  {base_plt_apps, [stdlib, kernel, erts, sasl, mnesia, crypto, ssl, inets, public_key, asn1, ssh]},
  {base_plt_location, global}]}.