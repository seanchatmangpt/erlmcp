%% -*- erlang -*-
%% vim: set ft=erlang ts=4 sw=4 et:

%% Rebar3 configuration for erlmcp - TESTING ONLY (without OTEL and jesse)
%% Purpose: Run unit tests without problematic transitive dependencies
%% Strategy: Use OTP 28 native json module instead of jesse

{minimum_otp_vsn, "28"}.

%% Dependencies - OTEL and jesse removed
{deps,
 [% Process registry (O(log N) lookup)
  {gproc, "0.9.0"},
  % HTTP client (gun for HTTP/2 and WebSocket)
  {gun, "2.0.1"},
  % TCP acceptor pool (ranch)
  {ranch, "2.1.0"},
  % Connection pooling (poolboy)
  {poolboy, "1.5.2"},
  % HTTP server (cowboy for HTTP/WebSocket/SSE)
  {cowboy, "2.10.0"},
  % Template engine (bbmustache)
  {bbmustache, "1.12.2"},
  % JWT validation (CRITICAL - security dependency)
  {jose, "1.11.1"}
 ]}.

%% Shell (for `rebar3 shell`)
{shell,
 [{apps, [erlmcp_core, erlmcp_transports, erlmcp_validation]},
  {config, "config/sys.config"},
  {vm_args, "vm.args"}]}.

%% EUnit configuration
{eunit_opts, [verbose, {report, {eunit_surefire, [{dir, "log/eunit"}]}}, {cover_enabled, true}]}.

%% Common Test configuration
{ct_opts, [{logdir, "log/ct"}, {cover_enabled, true}]}.

%% Coverage configuration
{cover_enabled, true}.
{cover_opts, [verbose]}.
{cover_export_enabled, true}.

%% Dialyzer configuration
{dialyzer,
 [{warnings, [error_handling, underspecs, unknown, unmatched_returns]},
  {get_warnings, true},
  {plt_apps, all_deps},
  {plt_location, local},
  {plt_prefix, "erlmcp"},
  {dialyzer_options, [incremental]},
  {base_plt_apps, [stdlib, kernel, erts, sasl, mnesia, crypto, ssl, inets, public_key, asn1, ssh]},
  {base_plt_location, global}]}.

%% Xref configuration (cross-reference analysis)
{xref_checks,
 [undefined_function_calls,
  undefined_functions,
  locals_not_used,
  deprecated_function_calls,
  deprecated_functions]}.

%% Global compiler options
{erl_opts,
 [debug_info,
  {i, "include"},
  {i, "apps/erlmcp_core/include"},
  {i, "apps/erlmcp_transports/include"},
  {i, "apps/erlmcp_validation/include"},
  {platform_define, "^2[6-7]", 'OTP_LEGACY'},
  {platform_define, "^2[8-9]|^[3-9]", 'OTP_MODERN'},
  {warn_missing_spec_all, false}]}.

%% Profiles
{profiles,
 [{test,
   [{erl_opts,
     [debug_info,
      {i, "include"},
      {i, "apps/erlmcp_core/include"},
      {i, "apps/erlmcp_transports/include"},
      {i, "apps/erlmcp_validation/include"},
      {i, "_build/test/lib/*/include"},
      {d, 'TEST'}]},
    {deps, [{proper, "1.4.0"}, {meck, "0.9.2"}]},
    {cover_enabled, true},
    {cover_export_enabled, true}]},
  {prod,
   [{erl_opts,
     [no_debug_info,
      warnings_as_errors,
      {i, "include"},
      {i, "apps/erlmcp_core/include"},
      {i, "apps/erlmcp_transports/include"},
      {i, "apps/erlmcp_validation/include"}]},
    {relx, [{dev_mode, false}, {include_erts, true}, {include_src, false}, {system_libs, true}]}]}
 ]}.

%% Format configuration
{format,
 [{files,
   ["rebar.config",
    "{src,include,test}/**/*.{erl,hrl,app.src}",
    "apps/*/src/**/*.{erl,hrl}",
    "apps/*/include/**/*.hrl",
    "apps/*/test/**/*.{erl,hrl}"]},
  {formatter, default_formatter},
  {options,
   #{paper => 100,
     ribbon => 100,
     break_indent => 4}}]}.

%% Project applications
{project_app_dirs, ["apps/*"]}.

%% Source directories
{src_dirs,
 ["apps/erlmcp_core/src",
  "apps/erlmcp_transports/src",
  "apps/erlmcp_validation/src"]}.
