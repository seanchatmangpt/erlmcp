{{/*
  Horizontal Pod Autoscaler for erlmcp StatefulSet
*/}}

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: erlmcp-hpa
  namespace: erlmcp
  labels:
    app.kubernetes.io/name: erlmcp
    app.kubernetes.io/instance: erlmcp
    app.kubernetes.io/managed-by: manual
    app.kubernetes.io/component: erlmcp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: erlmcp
  minReplicas: 3
  maxReplicas: 10
  metrics:
    # CPU utilization
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    # Memory utilization
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom metrics - active connections
    - type: Pods
      pods:
        metric:
          name: active_connections
        target:
          type: AverageValue
          averageValue: "1000"
    # Custom metrics - request rate
    - type: Pods
      pods:
        metric:
          name: request_rate
        target:
          type: AverageValue
          averageValue: "500"
  behavior:
    # Scale down behavior
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
        - type: Pods
          value: 1
          periodSeconds: 60
      selectPolicy: Min
    # Scale up behavior
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 2
          periodSeconds: 15
      selectPolicy: Max

# Cluster Autoscaler configuration
apiVersion: autoscaling/v2beta2
kind: ClusterAutoscaler
metadata:
  name: erlmcp-cluster-autoscaler
  namespace: kube-system
  labels:
    app.kubernetes.io/name: erlmcp
    app.kubernetes.io/instance: erlmcp
    app.kubernetes.io/managed-by: manual
    app.kubernetes.io/component: cluster-autoscaler
spec:
  scaleDown:
    enabled: false
    delayAfterAdd: 10m
    delayAfterDelete: 30s
    unneededTime: 10m
    expendablePodsPriorityCutoff: -10
  scaleUp:
    enabled: true
    delayAfterAdd: 30s
    delayAfterDelete: 30s
    maxGracefulTerminationSecs: 600
  balanceSimilarNodeGroups: true
  expander: random
  ignoreOperatingSystem: false
  estimators:
    - binpacking
    - resources
  resourceLimits:
    maxNodeProvisionTime: 10m
    cores:
      min: 0
      max: 1000
    memory:
      min: 0
      max: 2000Gi
    gpu:
      min: 0
      max: 10