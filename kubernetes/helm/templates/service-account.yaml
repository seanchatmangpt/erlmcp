{{/*
  Service account for erlmcp deployment
*/}}

{{- if .Values.global.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "erlmcp.serviceAccountName" . }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: service-account
  {{- if .Values.global.serviceAccount.annotations }}
  annotations:
    {{- toYaml .Values.global.serviceAccount.annotations | nindent 4 }}
  {{- end }}
{{- end }}

{{/*
  RBAC rules for erlmcp
*/}}
{{- if .Values.security.rbac.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "erlmcp.serviceAccountName" . }}-rbac
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
    rbac: enabled
  {{- if .Values.security.rbac.annotations }}
  annotations:
    {{- toYaml .Values.security.rbac.annotations | nindent 4 }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "erlmcp.fullname" . }}-role
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
rules:
  {{- range .Values.security.rbac.rules }}
  - apiGroups: [{{ .apiGroups | join ", " }}]
    resources: [{{ .resources | join ", " }}]
    verbs: [{{ .verbs | join ", " }}]
    {{- if .resourceNames }}
    resourceNames: [{{ .resourceNames | join ", " }}]
    {{- end }}
    {{- if .resourceRules }}
    resourceRules:
      {{- toYaml .resourceRules | nindent 6 }}
    {{- end }}
    {{- if .verbsFrom }}
    verbsFrom:
      {{- toYaml .verbsFrom | nindent 6 }}
    {{- end }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "erlmcp.fullname" . }}-rolebinding
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: {{ include "erlmcp.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "erlmcp.fullname" . }}-role
  apiGroup: rbac.authorization.k8s.io
{{- end }}

{{/*
  Cluster role bindings (for cluster-wide resources)
*/}}
{{- if .Values.security.rbac.clusterRole.enabled }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "erlmcp.fullname" . }}-clusterrole
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
    rbac: cluster
rules:
  {{- range .Values.security.rbac.clusterRole.rules }}
  - apiGroups: [{{ .apiGroups | join ", " }}]
    resources: [{{ .resources | join ", " }}]
    verbs: [{{ .verbs | join ", " }}]
    {{- if .resourceNames }}
    resourceNames: [{{ .resourceNames | join ", " }}]
    {{- end }}
    {{- if .resourceRules }}
    resourceRules:
      {{- toYaml .resourceRules | nindent 6 }}
    {{- end }}
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "erlmcp.fullname" . }}-clusterrolebinding
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
    rbac: cluster
subjects:
  - kind: ServiceAccount
    name: {{ include "erlmcp.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: {{ include "erlmcp.fullname" . }}-clusterrole
  apiGroup: rbac.authorization.k8s.io
{{- end }}

{{/*
  Pod security policy (if supported)
*/}}
{{- if .Values.security.podSecurityPolicy.enabled }}
---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: {{ include "erlmcp.fullname" . }}-psp
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
    app.kubernetes.io/component: rbac
spec:
  privileged: {{ .Values.security.podSecurityPolicy.privileged | default false }}
  allowPrivilegeEscalation: {{ .Values.security.podSecurityPolicy.allowPrivilegeEscalation | default false }}
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
  readOnlyRootFilesystem: {{ .Values.security.podSecurityPolicy.readOnlyRootFilesystem | default false }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "erlmcp.fullname" . }}-psp-role
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
    app.kubernetes.io/component: security
rules:
  - apiGroups: ['policy']
    resources: ['podsecuritypolicies']
    verbs: ['use']
    resourceNames:
      - {{ include "erlmcp.fullname" . }}-psp
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "erlmcp.fullname" . }}-psp-rolebinding
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac
    app.kubernetes.io/component: security
subjects:
  - kind: ServiceAccount
    name: {{ include "erlmcp.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "erlmcp.fullname" . }}-psp-role
  apiGroup: rbac.authorization.k8s.io
{{- end }}