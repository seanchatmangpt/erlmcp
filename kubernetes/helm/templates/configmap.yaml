{{/*
  ConfigMaps for erlmcp configuration
*/}}

{{/*
  Main configuration configmap
*/}}
{{- if .Values.configMaps.main.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.configMapName" . }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
data:
  config.json: |
    {
      "cluster": {
        "enabled": {{ .Values.cluster.enabled }},
        "cookie": "{{ .Values.cluster.cookie }}",
        "heartbeat_interval": "{{ .Values.cluster.heartbeatInterval }}",
        "node_check_interval": "{{ .Values.cluster.nodeCheckInterval }}",
        "split_brain": {
          "strategy": "{{ .Values.cluster.splitBrain.strategy }}",
          "check_interval": "{{ .Values.cluster.splitBrain.checkInterval }}"
        }
      },
      "server": {
        "max_subscriptions_per_resource": {{ .Values.resources.limits.maxSubscriptionsPerResource | default 1000 }},
        "max_progress_tokens": {{ .Values.resources.limits.maxProgressTokens | default 10000 }}
      },
      "transports": {
        "tcp": {
          "connect_timeout": {{ .Values.resources.transports.tcp.connectTimeout | default 5000 }},
          "keepalive": {{ .Values.resources.transports.tcp.keepalive | default true }},
          "nodelay": {{ .Values.resources.transports.tcp.nodelay | default true }},
          "port": {{ .Values.resources.transports.tcp.port | default 3000 }}
        },
        "http": {
          "connect_timeout": {{ .Values.resources.transports.http.connectTimeout | default 5000 }},
          "request_timeout": {{ .Values.resources.transports.http.requestTimeout | default 30000 }},
          "max_connections": {{ .Values.resources.transports.http.maxConnections | default 100 }},
          "port": {{ .Values.resources.transports.http.port | default 3001 }}
        },
        "stdio": {
          "buffer_size": {{ .Values.resources.transports.stdio.bufferSize | default 65536 }},
          "read_timeout": {{ .Values.resources.transports.stdio.readTimeout | default "infinity" }}
        }
      },
      "logging": {
        "level": "{{ .Values.monitoring.logging.level }}",
        "format": "{{ .Values.monitoring.logging.format }}"
      },
      "registry": {
        "sharding_strategy": "{{ .Values.resources.registry.shardingStrategy | default "none" }}",
        "health_check_interval": {{ .Values.resources.registry.healthCheckInterval | default 30000 }}
      },
      "session": {
        "backend": "{{ .Values.resources.session.backend | default "ets" }}",
        "backend_config": {{ .Values.resources.session.backendConfig | default "{}" | tojson }}
      },
      "secrets": {
        "provider": "{{ .Values.resources.secrets.provider | default "kubernetes" }}",
        "config": {{ .Values.resources.secrets.config | default "{}" | tojson }}
      }
    }
  erlmcp.conf: |
    %% Erlang configuration file
    %% Auto-generated by Helm chart

    [
      {kernel, [
        {inet_dist_listen_min, 9000},
        {inet_dist_listen_max, 9000},
        {inet_dist_use_interface, {0,0,0,0}},
        {inet_dist_listen_options, [binary, {packet,4}, {nodelay,true}, {active,true}]},
        {dist_listen_options, [binary, {packet,4}, {nodelay,true}, {active:true}]}
      ]},
      {sasl, [
        {errlog_type, error},
        {sasl_error_logger, {file, "/var/log/erlmcp/sasl-error.log"}}
      ]},
      {logger, [
        {handler, default, logger_std_h,
          {logger_formatter,
           #{single_line => false,
             time_designator => " ",
             message模式和 => ["~p"]}},
          {level, {{ include "erlmcp.logLevel" . }}}
        }}
      ]},
      {erlmcp, [
        {cluster, [
          {enabled, {{ .Values.cluster.enabled }}},
          {cookie, "{{ .Values.cluster.cookie }}"},
          {heartbeat_interval, {{ .Values.cluster.heartbeatInterval | quote }}},
          {node_check_interval, {{ .Values.cluster.nodeCheckInterval | quote }}},
          {split_brain, [
            {strategy, "{{ .Values.cluster.splitBrain.strategy }}"},
            {check_interval, {{ .Values.cluster.splitBrain.checkInterval | quote }}}
          ]}
        ]},
        {server, [
          {max_subscriptions_per_resource, {{ .Values.resources.limits.maxSubscriptionsPerResource | default 1000 }}},
          {max_progress_tokens, {{ .Values.resources.limits.maxProgressTokens | default 10000 }}}
        ]},
        {transports, [
          {tcp, [
            {connect_timeout, {{ .Values.resources.transports.tcp.connectTimeout | default 5000 }}},
            {keepalive, {{ .Values.resources.transports.tcp.keepalive | default true }}},
            {nodelay, {{ .Values.resources.transports.tcp.nodelay | default true }}},
            {port, {{ .Values.resources.transports.tcp.port | default 3000 }}}
          ]},
          {http, [
            {connect_timeout, {{ .Values.resources.transports.http.connectTimeout | default 5000 }}},
            {request_timeout, {{ .Values.resources.transports.http.requestTimeout | default 30000 }}},
            {max_connections, {{ .Values.resources.transports.http.maxConnections | default 100 }}},
            {port, {{ .Values.resources.transports.http.port | default 3001 }}}
          ]},
          {stdio, [
            {buffer_size, {{ .Values.resources.transports.stdio.bufferSize | default 65536 }}},
            {read_timeout, {{ .Values.resources.transports.stdio.readTimeout | default "infinity" | quote }}}
          ]}
        ]},
        {logging, [
          {level, {{ include "erlmcp.logLevel" . }}},
          {format, {{ include "erlmcp.logFormat" . }}}
        ]}
      ]}
    ]}
{{- end }}

{{/*
  Environment variables configmap
*/}}
{{- if .Values.configMaps.env.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.fullname" . }}-env
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
data:
  env.sh: |
    #!/bin/sh
    # Environment variables for erlmcp
    # Auto-generated by Helm chart

    # Core configuration
    export ERLMCP_CLUSTER_ENABLED="{{ .Values.cluster.enabled }}"
    export ERLMCP_CLUSTER_COOKIE="{{ .Values.cluster.cookie }}"
    export ERLMCP_OTP_VERSION="28.3.1"
    export POD_IP="$(POD_IP)"
    export POD_NAME="{{ .Release.Name }}-{{ .Values.node.replicaCount | int | add 1 }}"
    export POD_NAMESPACE="{{ .Release.Namespace }}"

    # Configuration paths
    export ERLMCP_CONFIG_DIR="/etc/erlmcp"
    export ERLMCP_LOG_DIR="/var/log/erlmcp"
    export ERLMCP_DATA_DIR="/data"
    export ERLMCP_SECRETS_DIR="/etc/erlmcp/secrets"

    # Logging configuration
    export ERLMCP_LOG_LEVEL="{{ include "erlmcp.logLevel" . }}"
    export ERLMCP_LOG_FORMAT="{{ include "erlmcp.logFormat" . }}"

    # Transport configuration
    export ERLMCP_HTTP_PORT="{{ .Values.resources.transports.http.port | default 3001 }}"
    export ERLMCP_TCP_PORT="{{ .Values.resources.transports.tcp.port | default 3000 }}"
    export ERLMCP_CLUSTER_PORT="{{ .Values.services.cluster.port | default 9000 }}"

    # Resource limits
    export ERLMCP_MAX_CONNECTIONS="{{ .Values.resources.limits.maxConnectionsPerNode | default 5000 }}"
    export ERLMCP_MAX_SESSIONS="{{ .Values.resources.limits.maxSessions | default 10000 }}"
    export ERLMCP_MAX_REGISTRY_SIZE="{{ .Values.resources.limits.maxRegistrySize | default 1000000 }}"

    # Database configuration
    export ERLMCP_SESSION_BACKEND="{{ .Values.resources.session.backend | default "ets" }}"
    export ERLMCP_REGISTRY_BACKEND="{{ .Values.resources.registry.backend | default "ets" }}"

    # Monitoring configuration
    export ERLMCP_METRICS_ENABLED="{{ .Values.monitoring.prometheus.enabled }}"
    export ERLMCP_OTEL_ENABLED="{{ .Values.monitoring.otel.enabled }}"
    export OTEL_EXPORTER_OTLP_ENDPOINT="{{ .Values.monitoring.otel.exporters.otlp.endpoint | default "otel-collector.observability.svc.cluster.local:4317" }}"

    # Security configuration
    export ERLMCP_SECRET_PROVIDER="{{ .Values.resources.secrets.provider | default "kubernetes" }}"
    export ERLMCP_SSL_ENABLED="{{ .Values.security.sslEnabled | default false }}"

    # Health check endpoints
    export ERLMCP_HEALTH_ENDPOINT="/health"
    export ERLMCP_READY_ENDPOINT="/ready"
    export ERLMCP_METRICS_ENDPOINT="/metrics"

    # Cluster discovery
    if [ "{{ .Values.cluster.discovery.provider }}" = "kubernetes" ]; then
      export ERLMCP_DISCOVERY_MODE="kubernetes"
      export ERLMCP_DISCOVERY_SERVICE="{{ .Values.cluster.discovery.kubernetes.serviceName }}"
      export ERLMCP_DISCOVERY_PORT="{{ .Values.cluster.discovery.kubernetes.servicePort }}"
    elif [ "{{ .Values.cluster.discovery.provider }}" = "dns" ]; then
      export ERLMCP_DISCOVERY_MODE="dns"
      export ERLMCP_DISCOVERY_DOMAIN="{{ .Values.cluster.discovery.dns.domain }}"
    else
      export ERLMCP_DISCOVERY_MODE="manual"
      export ERLMCP_NODES="{{ .Values.cluster.discovery.manual.nodes }}"
    fi

    # Logging setup
    mkdir -p ${ERLMCP_LOG_DIR}
    touch ${ERLMCP_LOG_DIR}/erlmcp.log
    touch ${ERLMCP_LOG_DIR}/erlmcp-error.log

    echo "erlmcp environment loaded"
  erlmcp.env: |
    ERLMCP_CLUSTER_ENABLED="{{ .Values.cluster.enabled }}"
    ERLMCP_CLUSTER_COOKIE="{{ .Values.cluster.cookie }}"
    ERLMCP_OTP_VERSION="28.3.1"
    POD_IP="$(POD_IP)"
    POD_NAME="{{ .Release.Name }}-{{ .Values.node.replicaCount | int | add 1 }}"
    POD_NAMESPACE="{{ .Release.Namespace }}"
    ERLMCP_LOG_LEVEL="{{ include "erlmcp.logLevel" . }}"
    ERLMCP_LOG_FORMAT="{{ include "erlmcp.logFormat" . }}"
{{- end }}

{{/*
  TLS certificates configmap
*/}}
{{- if .Values.configMaps.tls.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.fullname" . }}-tls
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
data:
  tls.crt: |-
    {{ .Values.configMaps.tls.data.tls.crt }}
  tls.key: |-
    {{ .Values.configMaps.tls.data.tls.key }}
  ca.crt: |-
    {{ .Values.configMaps.tls.data.ca.crt | default "" }}
{{- end }}

{{/*
  OpenTelemetry collector configuration
*/}}
{{- if .Values.monitoring.otel.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: erlmcp-otel-collector-config
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        endpoint: 0.0.0.0:4317
        compression: gzip
      prometheus:
        config:
          global:
            scrape_interval: 30s
            scrape_timeout: 10s
          scrape_configs:
            - job_name: 'erlmcp'
              scrape_interval: 30s
              metrics_path: /metrics
              static_configs:
                - targets:
                  - localhost:9090
                - targets:
                  - localhost:9100
    processors:
      batch:
        timeout: 1s
        send_batch_max_size: 1000
      memory_limiter:
        limit_mib: 512
        check_interval: 1s
      attributes:
        actions:
          - key: service.name
            action: insert
            value: erlmcp
          - key: service.version
            action: insert
            value: {{ .Chart.Version }}
    exporters:
      otlp:
        endpoint: {{ .Values.monitoring.otel.exporters.otlp.endpoint | default "otel-collector.observability.svc.cluster.local:4317" }}
        compression: {{ .Values.monitoring.otel.exporters.otlp.compression | default "gzip" }}
      prometheus:
        endpoint: 0.0.0.0:8888
      logging:
        loglevel: info
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlp, logging]
        metrics:
          receivers: [otlp, prometheus]
          processors: [memory_limiter, attributes, batch]
          exporters: [prometheus, logging]
{{- end }}