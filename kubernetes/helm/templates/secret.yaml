{{/*
  Secrets for erlmcp deployment
*/}}

{{/*
  Main secrets
*/}}
{{- if .Values.secrets.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.secretName" . }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: secrets
type: Opaque
data:
  {{- if .Values.secrets.template.data }}
  {{- range $key, $value := .Values.secrets.template.data }}
  {{ $key }}: {{ $value | b64enc | quote }}
  {{- end }}
  {{- end }}

  # Auto-generated passwords
  database-password: {{ randAlphaNum 16 | b64enc | quote }}
  admin-password: {{ randAlphaNum 12 | b64enc | quote }}
  api-key: {{ randAlphaNum 32 | b64enc | quote }}

  # Session secrets
  session-secret: {{ randAlphaNum 32 | b64enc | quote }}

  # Cluster cookie (already in configmap but included for completeness)
  cluster-cookie: {{ .Values.cluster.cookie | b64enc | quote }}

  # Monitoring secrets
  prometheus-alertmanager-url: {{ .Values.monitoring.prometheus.alertmanagerUrl | default "http://alertmanager.monitoring:9093" | b64enc | quote }}

  # External service credentials
  {{- if .Values.secrets.externalServices }}
  {{- range $service := .Values.secrets.externalServices }}
  {{ $service.name }}-username: {{ $service.username | b64enc | quote }}
  {{ $service.name }}-password: {{ $service.password | b64enc | quote }}
  {{ $service.name }}-token: {{ $service.token | b64enc | quote }}
  {{- end }}
  {{- end }}
{{- end }}

{{/*
  TLS certificates (if not using cert-manager)
*/}}
{{- if and .Values.secrets.enabled .Values.certificates.enabled (not .Values.certificates.certManager.enabled) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-tls
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.certificates.tls.crt | b64enc | quote }}
  tls.key: {{ .Values.certificates.tls.key | b64enc | quote }}
{{- end }}

{{/*
  Database credentials
*/}}
{{- if .Values.secrets.database.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-database
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: Opaque
data:
  {{- if .Values.secrets.database.postgresql }}
  postgresql-host: {{ .Values.secrets.database.postgresql.host | b64enc | quote }}
  postgresql-port: {{ .Values.secrets.database.postgresql.port | toString | b64enc | quote }}
  postgresql-database: {{ .Values.secrets.database.postgresql.database | b64enc | quote }}
  postgresql-username: {{ .Values.secrets.database.postgresql.username | b64enc | quote }}
  postgresql-password: {{ .Values.secrets.database.postgresql.password | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.database.mysql }}
  mysql-host: {{ .Values.secrets.database.mysql.host | b64enc | quote }}
  mysql-port: {{ .Values.secrets.database.mysql.port | toString | b64enc | quote }}
  mysql-database: {{ .Values.secrets.database.mysql.database | b64enc | quote }}
  mysql-username: {{ .Values.secrets.database.mysql.username | b64enc | quote }}
  mysql-password: {{ .Values.secrets.database.mysql.password | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.database.redis }}
  redis-host: {{ .Values.secrets.database.redis.host | b64enc | quote }}
  redis-port: {{ .Values.secrets.database.redis.port | toString | b64enc | quote }}
  redis-password: {{ .Values.secrets.database.redis.password | b64enc | quote }}
  redis-database: {{ .Values.secrets.database.redis.database | toString | b64enc | quote }}
  {{- end }}
{{- end }}

{{/*
  External API keys
*/}}
{{- if .Values.secrets.externalApis.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-external-apis
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: external-api
type: Opaque
data:
  {{- range $api := .Values.secrets.externalApis.keys }}
  {{ $api.name }}-key: {{ $api.key | b64enc | quote }}
  {{ $api.name }}-secret: {{ $api.secret | b64enc | quote }}
  {{- end }}
{{- end }}

{{/*
 Monitoring secrets
*/}}
{{- if .Values.monitoring.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-monitoring
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitoring
type: Opaque
data:
  alertmanager-webhook-url: {{ .Values.monitoring.alertmanager.webhookUrl | default "" | b64enc | quote }}
  grafana-admin-password: {{ randAlphaNum 16 | b64enc | quote }}
  jaeger-collector-url: {{ .Values.monitoring.tracing.jaeger.collectorUrl | default "http://jaeger-collector.observability:14250" | b64enc | quote }}
  jaeger-agent-url: {{ .Values.monitoring.tracing.jaeger.agentUrl | default "http://jaeger-agent.observability:6831" | b64enc | quote }}
{{- end }}

{{/*
 Service mesh secrets
*/}}
{{- if .Values.global.serviceMesh.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-service-mesh
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: service-mesh
type: Opaque
data:
  {{- if eq (include "erlmcp.serviceMeshEnabled" .) "istio" }}
  istio-ca-root-cert: {{ .Values.global.serviceMesh.istio.caCert | b64enc | quote }}
  istio-sidecar-inject: {{ .Values.global.serviceMesh.istio.sidecarInject | b64enc | quote }}
  {{- else if eq (include "erlmcp.serviceMeshEnabled" .) "linkerd" }}
  linkerd-identity-trust-anchor: {{ .Values.global.serviceMesh.linkerd.identityTrustAnchor | b64enc | quote }}
  linkerd-identity-tls-crt: {{ .Values.global.serviceMesh.linkerd.identityTlsCrt | b64enc | quote }}
  linkerd-identity-tls-key: {{ .Values.global.serviceMesh.linkerd.identityTlsKey | b64enc | quote }}
  {{- end }}
{{- end }}