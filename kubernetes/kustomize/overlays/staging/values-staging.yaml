# Staging values for erlmcp

# Override global values for staging
global:
  nameOverride: erlmcp-staging
  fullnameOverride: erlmcp-staging
  additionalLabels:
    environment: staging
  serviceAccount:
    annotations:
      # Staging-specific annotations
      eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/erlmcp-staging-role"

# Cluster configuration for staging
cluster:
  enabled: true
  cookie: "erlmcp-cluster-staging-3-0-0"
  heartbeatInterval: "10s"
  nodeCheckInterval: "5s"
  splitBrain:
    strategy: "winner_takes_all"
    checkInterval: "30s"
  discovery:
    provider: "kubernetes"
    kubernetes:
      serviceName: "erlmcp-staging-cluster"
      servicePort: 9000
      namespace: "erlmcp-staging"

# Node configuration for staging
node:
  replicaCount: 3
  podTemplate:
    annotations:
      # Staging monitoring
      prometheus.io/scrape: "true"
      prometheus.io/port: "9090"
      prometheus.io/path: "/metrics"
      # Istio annotations
      sidecar.istio.io/inject: "true"
      sidecar.istio.io/rewriteAppHTTPProxies: "true"
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values: [erlmcp]
          topologyKey: "kubernetes.io/hostname"
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                values: [erlmcp]
            topologyKey: "topology.kubernetes.io/zone"
  priorityClassName: "system-cluster-critical"

# Resource management for staging
resources:
  core:
    requests:
      cpu: "2"
      memory: "4Gi"
    limits:
      cpu: "4"
      memory: "8Gi"
    extra: {}
  overhead:
    cpu: "0.5"
    memory: "1Gi"
  limits:
    maxPods: 10
    maxConnectionsPerNode: 5000
    maxSessions: 10000
    maxRegistrySize: 1000000

# Ingress configuration for staging
ingress:
  enabled: true
  className: "nginx"
  hosts:
    - host: erlmcp-staging.example.com
      paths:
        - path: /
          pathType: Prefix
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-staging"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    external-dns.alpha.kubernetes.io/hostname: erlmcp-staging.example.com
  tls:
    - secretName: erlmcp-staging-tls
      hosts:
        - erlmcp-staging.example.com

# Services configuration for staging
services:
  http:
    enabled: true
    type: LoadBalancer
    port: 3000
    targetPort: 3000
    nodePort: 30000
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    externalTrafficPolicy: Local
    healthCheckNodePort: 30001
  cluster:
    enabled: true
    type: ClusterIP
    port: 9000
    targetPort: 9000
  metrics:
    enabled: true
    type: ClusterIP
    port: 9090
    targetPort: 9090
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9090"
      prometheus.io/path: "/metrics"
  otel:
    enabled: true
    type: ClusterIP
    port: 4317
    targetPort: 4317

# Auto Scaling for staging
autoscaling:
  hpa:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    customMetrics:
      - type: Pods
        pods:
          metric:
            name: active_connections
          target:
            type: AverageValue
            averageValue: "500"
  clusterAutoscaler:
    enabled: true
    scaleDownDisabled: false
    balanceSimilarNodeGroups: true
    expander: "random"
    scaleDownDelayAfterAdd: "10m"
    scaleDownDelayAfterDelete: "30s"
    scaleDownUnneededTime: "10m"
    scaleDownUtilizationThreshold: 0.5
  vpa:
    enabled: false

# Pod Disruption Budgets for staging
pdb:
  enabled: true
  minAvailable: "2"
  maxUnavailable: "1"
  cluster:
    enabled: true
    minAvailable: 1
    maxUnavailable: 1

# Persistence for staging
persistence:
  sessions:
    enabled: true
    storageClass: "fast-ssd"
    size: 10Gi
    accessModes:
      - ReadWriteOnce
    mountPath: /data/sessions
    subPath: sessions
  registry:
    enabled: true
    storageClass: "fast-ssd"
    size: 5Gi
    accessModes:
      - ReadWriteOnce
    mountPath: /data/registry
    subPath: registry
  config:
    enabled: true
    storageClass: "fast-ssd"
    size: 1Gi
    accessModes:
      - ReadWriteOnce
    mountPath: /data/config
    subPath: config

# Monitoring for staging
monitoring:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: "30s"
      scrapeTimeout: "10s"
      honorLabels: false
  grafana:
    enabled: true
    dashboards:
      erlmcp: {}
      erlmcp-cluster: {}
  otel:
    enabled: true
    enabledFor: ["core", "transports", "observability"]
    sampling:
      type: "fixed_rate"
      rate: "1.0"
    exporters:
      otlp:
        enabled: true
        endpoint: "otel-collector.monitoring.svc.cluster.local:4317"
        compression: "gzip"
      jaeger:
        enabled: false
      prometheus:
        enabled: true
        endpoint: "prometheus.monitoring.svc.cluster.local:9090"
  logging:
    enabled: true
    level: "debug"
    format: "json"
    output: "stdout"
    logrotate:
      enabled: true
      maxFiles: 10
      maxSize: "100MB"
    forwarders:
      fluentd:
        enabled: false
      loki:
        enabled: false

# Security for staging
security:
  rbac:
    enabled: true
    create: true
    rules:
      - apiGroups: [""]
        resources: ["pods", "services", "configmaps", "secrets", "persistentvolumeclaims"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
      - apiGroups: [""]
        resources: ["pods/log", "pods/exec"]
        verbs: ["get", "list", "create"]
      - apiGroups: ["networking.k8s.io"]
        resources: ["networkpolicies"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  podSecurityPolicy:
    enabled: false
  secrets:
    enabled: true
    template:
      type: Opaque
      data:
        database-password: ""
        admin-password: ""
        api-key: ""
        session-secret: ""
        cluster-cookie: "ZWJsbWNwLXN0YWdpbmctMy0wLTA="
        prometheus-alertmanager-url: "aHR0cDovL2FsdGVybWFuZXJhbmRvbS5tb25pdG9yaW5nOjkwOTM="

# Service mesh for staging
global:
  serviceMesh:
    enabled: true
    istio:
      enabled: true
      gateway: "istio-system/ingressgateway"
      caCert: "-----BEGIN CERTIFICATE-----\n-----END CERTIFICATE-----"
      sidecarInject: "true"
    linkerd:
      enabled: false
      identityTrustAnchor: ""
      identityTlsCrt: ""
      identityTlsKey: ""

# TLS for staging
certificates:
  enabled: true
  tls:
    crt: |
      -----BEGIN CERTIFICATE-----
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      -----END PRIVATE KEY-----
  certManager:
    enabled: true
    issuer: "letsencrypt-staging"
    dnsNames: ["erlmcp-staging.example.com"]