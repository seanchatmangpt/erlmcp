# Base values for erlmcp Kubernetes deployment

# Set global values
global:
  nameOverride: erlmcp
  fullnameOverride: erlmcp
  additionalLabels:
    environment: base
  serviceAccount:
    create: true
    name: erlmcp-sa
    annotations:
      eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/erlmcp-role"
  image:
    repository: banyanplatform/erlmcp
    tag: "3.0.0"
    pullPolicy: IfNotPresent
    pullSecrets: []

# Cluster configuration
cluster:
  enabled: true
  cookie: "erlmcp-cluster-3-0-0"
  heartbeatInterval: "10s"
  nodeCheckInterval: "5s"
  splitBrain:
    strategy: "winner_takes_all"
    checkInterval: "30s"
  discovery:
    provider: "kubernetes"
    kubernetes:
      serviceName: "erlmcp-cluster"
      servicePort: 9000
      namespace: "erlmcp"

# Node configuration
node:
  replicaCount: 3
  podTemplate:
    annotations:
      # Add base annotations
      prometheus.io/scrape: "true"
      prometheus.io/port: "9090"
      prometheus.io/path: "/metrics"
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values: [erlmcp]
          topologyKey: "kubernetes.io/hostname"
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                values: [erlmcp]
            topologyKey: "topology.kubernetes.io/zone"
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - matchExpressions:
            - key: kubernetes.io/arch
              operator: In
              values: ["amd64", "arm64"]
        - matchExpressions:
            - key: node.kubernetes.io/memory-pressure
              operator: NotIn
              values: ["true"]
  priorityClassName: "system-cluster-critical"

# Resource management
resources:
  core:
    requests:
      cpu: "2"
      memory: "4Gi"
    limits:
      cpu: "4"
      memory: "8Gi"
  overhead:
    cpu: "0.5"
    memory: "1Gi"
  limits:
    maxPods: 10
    maxConnectionsPerNode: 5000
    maxSessions: 10000
    maxRegistrySize: 1000000

# Ingress configuration
ingress:
  enabled: true
  className: "nginx"
  hosts:
    - host: erlmcp.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Services configuration
services:
  http:
    enabled: true
    type: LoadBalancer
    port: 3000
    targetPort: 3000
    nodePort: 30000
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    externalTrafficPolicy: Local
    healthCheckNodePort: 30001
  cluster:
    enabled: true
    type: ClusterIP
    port: 9000
    targetPort: 9000
  metrics:
    enabled: true
    type: ClusterIP
    port: 9090
    targetPort: 9090
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9090"
      prometheus.io/path: "/metrics"
  otel:
    enabled: true
    type: ClusterIP
    port: 4317
    targetPort: 4317

# Liveness and Readiness Probes
probes:
  liveness:
    enabled: true
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1
  readiness:
    enabled: true
    httpGet:
      path: /ready
      port: http
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
    successThreshold: 1
  startup:
    enabled: true
    httpGet:
      path: /ready
      port: http
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30
    successThreshold: 1

# Auto Scaling
autoscaling:
  hpa:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  clusterAutoscaler:
    enabled: true
    scaleDownDisabled: false
    balanceSimilarNodeGroups: true
    expander: "random"
    scaleDownDelayAfterAdd: "10m"
    scaleDownDelayAfterDelete: "30s"
    scaleDownUnneededTime: "10m"
    scaleDownUtilizationThreshold: 0.5
  vpa:
    enabled: false
    updateMode: "Auto"
    recommendations:
      enabled: true
      resourcesPreset: "Dynamic"
      defaultContainerPolicy: "Auto"

# Pod Disruption Budgets
pdb:
  enabled: true
  minAvailable: "2"
  maxUnavailable: "1"
  cluster:
    enabled: true
    minAvailable: 1
    maxUnavailable: 1

# Persistence
persistence:
  sessions:
    enabled: true
    storageClass: "fast-ssd"
    size: 10Gi
    accessModes:
      - ReadWriteOnce
    mountPath: /data/sessions
    subPath: sessions
  registry:
    enabled: true
    storageClass: "fast-ssd"
    size: 5Gi
    accessModes:
      - ReadWriteOnce
    mountPath: /data/registry
    subPath: registry
  config:
    enabled: true
    storageClass: "fast-ssd"
    size: 1Gi
    accessModes:
      - ReadWriteOnce
    mountPath: /data/config
    subPath: config

# Monitoring and Observability
monitoring:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: "30s"
      scrapeTimeout: "10s"
      honorLabels: false
  grafana:
    enabled: false
  otel:
    enabled: true
    enabledFor: ["core", "transports", "observability"]
    sampling:
      type: "based_on_parent"
      rate: "1.0"
    exporters:
      otlp:
        enabled: true
        endpoint: "otel-collector.observability.svc.cluster.local:4317"
        compression: "gzip"
      prometheus:
        enabled: true
        endpoint: "prometheus.monitoring.svc.cluster.local:9090"
  logging:
    enabled: true
    level: "info"
    format: "json"
    output: "stdout"

# Security
security:
  rbac:
    enabled: true
    create: true
    rules:
      - apiGroups: [""]
        resources: ["pods", "services", "configmaps", "secrets"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
      - apiGroups: [""]
        resources: ["pods/log", "pods/exec"]
        verbs: ["get", "list", "create"]
      - apiGroups: ["networking.k8s.io"]
        resources: ["networkpolicies"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  podSecurityPolicy:
    enabled: false
  secrets:
    enabled: true
    template:
      type: Opaque
      data:
        database-password: ""
        admin-password: ""
        api-key: ""
        session-secret: ""
        cluster-cookie: ""

# ConfigMaps
configMaps:
  main:
    enabled: true
    data:
      config.json: |
        {
          "cluster": {
            "enabled": true,
            "cookie": "erlmcp-cluster-3-0-0",
            "heartbeat_interval": "10s",
            "node_check_interval": "5s",
            "split_brain": {
              "strategy": "winner_takes_all",
              "check_interval": "30s"
            }
          },
          "server": {
            "max_subscriptions_per_resource": 1000,
            "max_progress_tokens": 10000
          },
          "transports": {
            "tcp": {
              "connect_timeout": 5000,
              "keepalive": true,
              "nodelay": true,
              "port": 3000
            },
            "http": {
              "connect_timeout": 5000,
              "request_timeout": 30000,
              "max_connections": 100,
              "port": 3001
            }
          },
          "logging": {
            "level": "info",
            "format": "json"
          }
        }
  env:
    enabled: true
    data:
      ERLMCP_CLUSTER_ENABLED: "true"
      ERLMCP_CLUSTER_COOKIE: "erlmcp-cluster-3-0-0"
      ERLMCP_OTP_VERSION: "28.3.1"
      POD_NAME: "$(POD_NAME)"
      POD_NAMESPACE: "$(POD_NAMESPACE)"
      ERLMCP_LOG_LEVEL: "info"
      ERLMCP_LOG_FORMAT: "json"

# Sidecars
sidecars:
  prometheus-exporter:
    enabled: true
    image: prom/node-exporter:v1.5.0
    ports:
      - name: metrics
        containerPort: 9100
        protocol: TCP
    resources:
      limits:
        cpu: "100m"
        memory: "128Mi"
      requests:
        cpu: "50m"
        memory: "64Mi"
  otel-collector:
    enabled: false
    image: otel/opentelemetry-collector-contrib:0.78.0
    ports:
      - name: otlp
        containerPort: 4317
        protocol: TCP
      - name: metrics
        containerPort: 8888
        protocol: TCP
    resources:
      limits:
        cpu: "500m"
        memory: "512Mi"
      requests:
        cpu: "200m"
        memory: "256Mi"

# Jobs
jobs:
  migration:
    enabled: true
    backoffLimit: 3
    activeDeadlineSeconds: 3600
    template:
      spec:
        containers:
          - name: migration
            image: banyanplatform/erlmcp-migrations:3.0.0
            command: ["./run-migrations.sh"]
            envFrom:
              - configMapRef:
                  name: erlmcp-base-config
            resources:
              limits:
                cpu: "500m"
                memory: "1Gi"
              requests:
                cpu: "250m"
                memory: "512Mi"
  backup:
    enabled: true
    schedule: "0 2 * * *"
    successfulJobsHistoryLimit: 3
    failedJobsHistoryLimit: 1
    template:
      spec:
        containers:
          - name: backup
            image: banyanplatform/erlmcp-backup:3.0.0
            command: ["./backup.sh"]
            envFrom:
              - configMapRef:
                  name: erlmcp-base-config
            resources:
              limits:
                cpu: "250m"
                memory: "512Mi"
              requests:
                cpu: "125m"
                memory: "256Mi"

# Tests
tests:
  enabled: true
  image:
    repository: busybox
    tag: "1.35"
    pullPolicy: IfNotPresent
  command: ["sh", "-c", "echo 'erlmcp test successful'"]
  resources:
    limits:
      cpu: "100m"
      memory: "128Mi"
    requests:
      cpu: "50m"
      memory: "64Mi"