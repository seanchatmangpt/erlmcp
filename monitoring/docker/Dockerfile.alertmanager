# Dockerfile for Alertmanager with erlmcp configuration
# This Dockerfile builds Alertmanager with custom routing and templates

FROM prom/alertmanager:v0.25.0

# Create directories for configuration and data
RUN mkdir -p /etc/alertmanager /alertmanager /alertmanager/templates

# Copy configuration files
COPY alertmanager/alertmanager.yml /etc/alertmanager/alertmanager.yml
COPY alertmanager/templates /etc/alertmanager/templates

# Set working directory
WORKDIR /etc/alertmanager

# Add non-root user
RUN useradd -u 65534 -l -g nogroup -s /bin/false -d /etc/alertmanager alertmanager

# Copy configuration files as non-root user
COPY --chown=alertmanager:nogroup alertmanager/alertmanager.yml /etc/alertmanager/alertmanager.yml
COPY --chown=alertmanager:nogroup alertmanager/templates /etc/alertmanager/templates

# Expose ports
EXPOSE 9093 9094

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:9093/-/healthy || exit 1

# Command to run Alertmanager
CMD ["--config.file=/etc/alertmanager/alertmanager.yml", \
     "--storage.path=/alertmanager", \
     "--external-url=http://localhost:9093", \
     "--web.route-prefix=/alertmanager"]