groups:
  - name: erlmcp-critical-alerts
    interval: 30s
    rules:
      # P0: Critical Alerts - Production Down
      - alert: erlmcp_core_down
        expr: up{job="erlmcp_core"} == 0
        for: 30s
        labels:
          severity: critical
          priority: P0
          team: erlmcp
        annotations:
          summary: "erlmcp core service is down"
          description: "erlmcp core service has been down for more than 30 seconds. This is a critical P0 alert."
          runbook_url: "https://runbook.erlmcp.com/core-down"
          dashboard_url: "https://grafana.erlmcp.com/d/erlmcp-overview?viewPanel=1"

      - alert: erlmcp_registry_down
        expr: up{job="erlmcp_registry"} == 0
        for: 30s
        labels:
          severity: critical
          priority: P0
          team: erlmcp
        annotations:
          summary: "erlmcp registry service is down"
          description: "erlmcp registry service has been down for more than 30 seconds. This is a critical P0 alert."
          runbook_url: "https://runbook.erlmcp.com/registry-down"
          dashboard_url: "https://grafana.erlmcp.com/d/erlmcp-registry-overview?viewPanel=1"

      - alert: erlmcp_sessions_down
        expr: up{job="erlmcp_sessions"} == 0
        for: 30s
        labels:
          severity: critical
          priority: P0
          team: erlmcp
        annotations:
          summary: "erlmcp sessions service is down"
          description: "erlmcp sessions service has been down for more than 30 seconds. This is a critical P0 alert."
          runbook_url: "https://runbook.erlmcp.com/sessions-down"
          dashboard_url: "https://grafana.erlmcp.com/d/erlmcp-sessions-overview?viewPanel=1"

      # P1: High Alerts - Performance Degradation
      - alert: high_error_rate
        expr: rate(erlmcp_requests_total{status=~"5.."}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
          priority: P1
          team: erlmcp
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} requests per second. Alert threshold exceeded."
          runbook_url: "https://runbook.erlmcp.com/high-error-rate"

      - alert: high_latency_p99
        expr: histogram_quantile(0.99, sum(rate(erlmcp_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
          priority: P1
          team: erlmcp
        annotations:
          summary: "High latency detected"
          description: "P99 latency is {{ $value }} seconds. Alert threshold exceeded."
          runbook_url: "https://runbook.erlmcp.com/high-latency"

      - alert: session_leak
        expr: erlmcp_active_sessions > erlmcp_max_sessions * 0.9
        for: 10m
        labels:
          severity: warning
          priority: P1
          team: erlmcp
        annotations:
          summary: "Potential session leak detected"
          description: "Active sessions {{ $value }} exceed 90% of maximum capacity."
          runbook_url: "https://runbook.erlmcp.com/session-leak"

      # P2: Medium Alerts - Resource Exhaustion
      - alert: high_memory_usage
        expr: (erlmcp_memory_usage_bytes / erlmcp_memory_limit_bytes) * 100 > 80
        for: 15m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}%. Alert threshold exceeded."
          runbook_url: "https://runbook.erlmcp.com/high-memory"

      - alert: high_cpu_usage
        expr: rate(erlmcp_cpu_usage_seconds_total[5m]) * 100 > 80
        for: 15m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}%. Alert threshold exceeded."
          runbook_url: "https://runbook.erlmcp.com/high-cpu"

      - alert: connection_pool_exhausted
        expr: erlmcp_active_connections > erlmcp_max_connections * 0.9
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "Connection pool exhaustion"
          description: "Active connections {{ $value }} exceed 90% of maximum capacity."
          runbook_url: "https://runbook.erlmcp.com/connection-exhausted"

      # P3: Low Alerts - Maintenance Required
      - alert: disk_space_low
        expr: (disk_free_bytes / disk_total_bytes) * 100 < 20
        for: 1h
        labels:
          severity: info
          priority: P3
          team: erlmcp
        annotations:
          summary: "Low disk space"
          description: "Disk space is {{ $value }}%. Maintenance required."
          runbook_url: "https://runbook.erlmcp.com/disk-space"

      - alert: certificate_expiry_soon
        expr: time() - erlmcp_cert_expiry_timestamp < 7 * 24 * 3600
        for: 1d
        labels:
          severity: warning
          priority: P3
          team: erlmcp
        annotations:
          summary: "Certificate expiry soon"
          description: "Certificate expires in {{ $value | humanizeDuration }}."
          runbook_url: "https://runbook.erlmcp.com/certificate-expiry"

  - name: erlmcp-business-alerts
    interval: 5m
    rules:
      # Business metrics alerts
      - alert: high_request_volume
        expr: rate(erlmcp_requests_total[5m]) > 10000
        for: 5m
        labels:
          severity: info
          priority: P3
          team: erlmcp
        annotations:
          summary: "High request volume detected"
          description: "Current request volume is {{ $value }} requests per second."

      - alert: api_quota_exceeded
        expr: rate(erlmcp_api_quota_exceeded_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "API quota exceeded"
          description: "API quota exceeded for {{ $value }} times in last 5 minutes."

      - alert: authentication_failures
        expr: rate(erlmcp_auth_failures_total[5m]) > 10
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "High authentication failures"
          description: "Authentication failures rate is {{ $value }} per minute."

  - name: erlmcp-security-alerts
    interval: 30s
    rules:
      # Security event alerts
      - alert: brute_force_detection
        expr: rate(erlmcp_brute_force_attempts[5m]) > 100
        for: 5m
        labels:
          severity: critical
          priority: P1
          team: security
        annotations:
          summary: "Brute force attack detected"
          description: "Brute force attempts detected at {{ $value }} attempts per minute."
          runbook_url: "https://runbook.erlmcp.com/brute-force"

      - alert: unauthorized_access_attempts
        expr: rate(erlmcp_unauthorized_attempts[5m]) > 50
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: security
        annotations:
          summary: "Unauthorized access attempts"
          description: "Unauthorized access attempts detected at {{ $value }} per minute."

      - alert: suspicious_ip_access
        expr: rate(erlmcp_requests_total{ip!~"^(10|172\\.1[6-9]|172\\.2[0-9]|172\\.3[01]|192\\.168)"}[5m]) > 1000
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: security
        annotations:
          summary: "Suspicious external IP access"
          description: "High volume of requests from external IP addresses detected."

  - name: erlmcp-scaling-alerts
    interval: 5m
    rules:
      # Scaling alerts
      - alert: node_count_high
        expr: count(count_up{job="erlmcp"}) > 50
        for: 5m
        labels:
          severity: info
          priority: P3
          team: erlmcp
        annotations:
          summary: "High node count"
          description: "Current node count is {{ $value }}. Consider scaling optimization."

      - alert: auto_scaling_failed
        expr: rate(kubernetes_hpa_failed_scaling_events_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
          priority: P1
          team: erlmcp
        annotations:
          summary: "Auto-scaling failed"
          description: "Auto-scaling has failed {{ $value }} times in last 5 minutes."

      - alert: cluster_overloaded
        expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (node) / sum(kubernetes_node_status_allocatable_cpu_cores) by (node) * 100 > 80
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "Cluster overloaded"
          description: "Node {{ $labels.node }} CPU usage is {{ $value }}%. Consider adding nodes."

  - name: erlmcp-database-alerts
    interval: 5m
    rules:
      # Database alerts
      - alert: database_connection_pool_full
        expr: pg_stat_database_numbackends / pg_settings_max_connections * 100 > 90
        for: 5m
        labels:
          severity: critical
          priority: P1
          team: erlmcp
        annotations:
          summary: "Database connection pool full"
          description: "Connection pool usage is {{ $value }}% on {{ $labels.datname }}."

      - alert: database_replication_lag
        expr: pg_stat_database_xact_commit_lag > 10
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "Database replication lag"
          description: "Replication lag is {{ $value }} seconds on {{ $labels.datname }}."

      - alert: database_slow_queries
        expr: pg_stat_database_calls_total{state="total"} / pg_stat_database_calls_total * 100 > 10
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: erlmcp
        annotations:
          summary: "Slow database queries"
          description: "Query performance is {{ $value }}% slower than baseline."