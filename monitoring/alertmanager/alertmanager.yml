# Enterprise Alertmanager Configuration for erlmcp v3

global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@erlmcp.com'
  smtp_auth_username: 'alerts@erlmcp.com'
  smtp_auth_password: '${SMTP_PASSWORD}'

# Templates for alert notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert routing
route:
  group_by: ['alertname', 'cluster', 'priority']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'web.hook'

  # Routes for different priorities
  routes:
    # P0: Critical alerts - immediate escalation
    - match:
        priority: P0
      receiver: 'critical-pagerduty'
      continue: true

    # P1: High alerts - immediate notification
    - match:
        priority: P1
      receiver: 'high-slack'
      continue: true

    # P2: Medium alerts - team notification
    - match:
        priority: P2
      receiver: 'medium-slack'
      continue: true

    # P3: Low alerts - email notification
    - match:
        priority: P3
      receiver: 'low-email'
      continue: true

    # Security alerts - security team
    - match:
        severity: critical
      receiver: 'security-slack'
      continue: true

    # Default route
    - receiver: 'web.hook'

# Inhibit rules - suppress lower severity alerts when higher severity is active
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'info'
    equal: ['alertname', 'dev', 'instance']

# Receivers for different notification channels
receivers:
  # Critical alerts - PagerDuty escalation
  - name: 'critical-pagerduty'
    email_configs:
      - to: 'erlmcp-oncall@company.com'
        subject: '[CRITICAL] {{ .GroupLabels.alertname }} in {{ .GroupLabels.cluster }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Priority: {{ .Labels.priority }}
          Started At: {{ .StartsAt }}
          {{ end }}
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
      - severity: critical

  # High alerts - Slack notifications
  - name: 'high-slack'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        title: '[P1] {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Priority:* {{ .Labels.priority }}
          *Instance:* {{ .Labels.instance }}
          *Started At:* {{ .StartsAt }}
          {{ end }}
        color: 'danger'
        channel: '#erlmcp-alerts'

  # Medium alerts - Slack notifications
  - name: 'medium-slack'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        title: '[P2] {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Priority:* {{ .Labels.priority }}
          *Instance:* {{ .Labels.instance }}
          *Started At:* {{ .StartsAt }}
          {{ end }}
        color: 'warning'
        channel: '#erlmcp-alerts'

  # Low alerts - Email notifications
  - name: 'low-email'
    email_configs:
      - to: 'erlmcp-team@company.com'
        subject: '[P3] {{ .GroupLabels.alertname }} in {{ .GroupLabels.cluster }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Priority: {{ .Labels.priority }}
          Instance: {{ .Labels.instance }}
          Started At: {{ .StartsAt }}
          {{ end }}

  # Security alerts - Security team Slack
  - name: 'security-slack'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        title: '[SECURITY] {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Security Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Cluster:* {{ .GroupLabels.cluster }}
          *Instance:* {{ .Labels.instance }}
          *Priority:* {{ .Labels.priority }}
          *Started At:* {{ .StartsAt }}
          {{ end }}
        color: 'danger'
        channel: '#security-incidents'

  # Webhook for integration with external systems
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://webhook-service:8080/hooks/alertmanager'
        send_resolved: true
        http_config:
          basic_auth:
            username: '${WEBHOOK_USERNAME}'
            password: '${WEBHOOK_PASSWORD}'

# Mute timings for maintenance windows
mute_time_intervals:
  - name: 'maintenance-window-weekly'
    time_intervals:
      - times:
          - start_time: '2024-01-01T02:00:00Z'
            end_time: '2024-01-01T06:00:00Z'
        weekdays: ['saturday']

# Alertmanager cluster configuration
cluster:
  name: 'erlmcp-alertmanager'
  ring:
    kvstore:
      store: 'inmem'
      prefix: 'alertmanager'
  gossip_interval: 200ms
  pull_timeout: 4s

# Retention configuration
retention: 120h  # 5 days of alert history