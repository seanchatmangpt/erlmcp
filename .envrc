# === direnv Configuration for erlmcp Workspace ===
# Automatically sets up environment when entering the workspace directory
#
# Priority: flake.nix -> asdf -> system Erlang
# Usage:
#   direnv allow    # Enable direnv for this project
#   direnv deny     # Disable direnv for this project

use flake || (echo "flake not found; using system Erlang"; use asdf || true)

# Ensure OTP paths are set
export OTP_ROOT="$(asdf where erlang 2>/dev/null || erl -noshell -eval 'io:format(code:root_dir())' -s init stop 2>/dev/null || echo '')"

# Set up PATH for local build binaries
export PATH="$PWD/_build/default/bin:$PATH"
export PATH="$PWD/taiea/_build/default/bin:$PATH"

# Set up ERL environment variables
export ERL_LIBS="$PWD/_build/default/lib:$PWD/taiea/_build/default/lib"

# Add vendor/erlmcp to code path for development
export ERLANG_LIBS="${PWD}/vendor/erlmcp:${ERLANG_LIBS:-}"

# erlmcp workspace home
export ERLMCP_HOME="$PWD"

# Watch configuration files for changes
watch_file rebar.config
watch_file taiea/rebar.config
watch_file Makefile

# Improve performance by batching directory tracking
direnv_layout_dir "$PWD/.direnv"

# Helper message
if [ -z "$DIRENV_QUIET" ]; then
    erlang_version=$(erl -version 2>&1 | cut -d' ' -f2)
    echo "âœ“ erlmcp workspace loaded (Erlang $erlang_version)"
fi
