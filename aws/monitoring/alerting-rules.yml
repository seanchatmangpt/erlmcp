# ============================================================================
# Prometheus Alerting Rules for erlmcp
# ============================================================================
# Defines alert conditions for erlmcp application and infrastructure
#
# DOCKER-ONLY CONSTITUTION: Alerts trigger Andon-style responses
# ============================================================================

groups:
  # =========================================================================
  # erlmcp Application Alerts
  # =========================================================================
  - name: erlmcp_application
    interval: 30s
    rules:
      # High error rate
      - alert: ErlmcpHighErrorRate
        expr: |
          sum(rate(erlmcp_request_errors_total[5m])) by (instance)
          / sum(rate(erlmcp_request_total[5m])) by (instance) > 0.05
        for: 5m
        labels:
          severity: critical
          service: erlmcp
        annotations:
          summary: "High error rate on {{ $labels.instance }}"
          description: "Error rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.erlmcp.dev/runbooks/high-error-rate"

      # High request latency
      - alert: ErlmcpHighLatency
        expr: |
          histogram_quantile(0.99, sum(rate(erlmcp_request_duration_seconds_bucket[5m])) by (le, instance)) > 2
        for: 5m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "High request latency on {{ $labels.instance }}"
          description: "P99 latency is {{ $value | humanizeDuration }} on {{ $labels.instance }}"

      # Service down
      - alert: ErlmcpServiceDown
        expr: up{job="erlmcp"} == 0
        for: 1m
        labels:
          severity: critical
          service: erlmcp
        annotations:
          summary: "erlmcp service is down"
          description: "Instance {{ $labels.instance }} is not responding"

      # Low session count (potential issue)
      - alert: ErlmcpLowSessionCount
        expr: erlmcp_active_sessions < 1 and erlmcp_request_total > 0
        for: 10m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "Low session count on {{ $labels.instance }}"
          description: "Active sessions: {{ $value }}"

      # High connection queue
      - alert: ErlmcpHighConnectionQueue
        expr: erlmcp_connection_queue_size > 100
        for: 5m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "High connection queue on {{ $labels.instance }}"
          description: "Queue size: {{ $value }}"

  # =========================================================================
  # Erlang VM Alerts
  # =========================================================================
  - name: erlang_vm
    interval: 30s
    rules:
      # High process count
      - alert: ErlangHighProcessCount
        expr: erlang_vm_process_count > 200000
        for: 5m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "High Erlang process count on {{ $labels.instance }}"
          description: "Process count: {{ $value }}"

      # Memory approaching limit
      - alert: ErlangHighMemory
        expr: |
          erlang_vm_memory_bytes_total{kind="system"}
          / erlang_vm_memory_bytes_total{kind="maximum"} > 0.85
        for: 5m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "Erlang VM memory usage high on {{ $labels.instance }}"
          description: "Memory usage: {{ $value | humanizePercentage }}"

      # Scheduler utilization high
      - alert: ErlangSchedulerOverloaded
        expr: avg(erlang_vm_scheduler_utilization) by (instance) > 0.9
        for: 10m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "Erlang schedulers overloaded on {{ $labels.instance }}"
          description: "Average scheduler utilization: {{ $value | humanizePercentage }}"

      # Message queue buildup
      - alert: ErlangMessageQueueBuildup
        expr: erlang_vm_process_message_queue_len > 10000
        for: 5m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "Message queue buildup on {{ $labels.instance }}"
          description: "Process {{ $labels.pid }} has {{ $value }} messages"

      # Reductions per second dropping (potential deadlock)
      - alert: ErlangLowReductions
        expr: rate(erlang_vm_statistics_reductions_total[5m]) < 1000
        for: 10m
        labels:
          severity: critical
          service: erlmcp
        annotations:
          summary: "Low reduction rate on {{ $labels.instance }}"
          description: "Reduction rate: {{ $value }}/s - potential deadlock"

      # GC taking too long
      - alert: ErlangHighGCTime
        expr: |
          rate(erlang_vm_statistics_garbage_collection_time_milliseconds_total[5m])
          / rate(erlang_vm_statistics_garbage_collection_number_of_gcs[5m]) > 100
        for: 5m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "High GC time on {{ $labels.instance }}"
          description: "Average GC time: {{ $value }}ms"

  # =========================================================================
  # Cluster Health Alerts
  # =========================================================================
  - name: erlmcp_cluster
    interval: 30s
    rules:
      # Node disconnected from cluster
      - alert: ErlmcpClusterNodeDisconnected
        expr: erlang_vm_cluster_nodes_connected < 2
        for: 2m
        labels:
          severity: critical
          service: erlmcp
        annotations:
          summary: "Cluster node disconnected"
          description: "Only {{ $value }} nodes connected on {{ $labels.instance }}"

      # Split brain detection
      - alert: ErlmcpClusterSplitBrain
        expr: |
          count(erlang_vm_cluster_nodes_connected) by (cluster)
          != sum(erlang_vm_cluster_nodes_connected) by (cluster) / count(erlang_vm_cluster_nodes_connected) by (cluster)
        for: 5m
        labels:
          severity: critical
          service: erlmcp
        annotations:
          summary: "Possible cluster split brain detected"
          description: "Nodes reporting different cluster sizes"

      # Cluster membership changing frequently
      - alert: ErlmcpClusterInstability
        expr: changes(erlang_vm_cluster_nodes_connected[10m]) > 5
        for: 1m
        labels:
          severity: warning
          service: erlmcp
        annotations:
          summary: "Cluster membership unstable"
          description: "{{ $value }} membership changes in 10 minutes"

  # =========================================================================
  # Infrastructure Alerts
  # =========================================================================
  - name: infrastructure
    interval: 60s
    rules:
      # High CPU usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage: {{ $value }}%"

      # High memory usage
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage: {{ $value }}%"

      # Disk space low
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Available disk space: {{ $value }}%"

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Available disk space: {{ $value }}%"

  # =========================================================================
  # Database Alerts
  # =========================================================================
  - name: database
    interval: 60s
    rules:
      # PostgreSQL connection pool exhausted
      - alert: PostgresConnectionPoolExhausted
        expr: |
          pg_stat_activity_count{state="active"}
          / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "PostgreSQL connection pool near exhaustion"
          description: "Using {{ $value | humanizePercentage }} of max connections"

      # PostgreSQL replication lag
      - alert: PostgresReplicationLag
        expr: pg_replication_lag_seconds > 30
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "PostgreSQL replication lag"
          description: "Replication lag: {{ $value }}s"

  # =========================================================================
  # Cache Alerts
  # =========================================================================
  - name: cache
    interval: 30s
    rules:
      # Redis memory high
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis memory usage high"
          description: "Memory usage: {{ $value | humanizePercentage }}"

      # Redis connection refused
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis instance {{ $labels.instance }} is not responding"
