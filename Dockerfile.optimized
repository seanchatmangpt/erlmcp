# ==============================================================================
# erlmcp v3 - Production-Optimized Multi-Stage Dockerfile
# ==============================================================================
# Target: Minimal production image (<100MB) with security scanning & SBOM
#
# Build: docker build --target runtime -t erlmcp:3.0.0 -f Dockerfile.optimized .
# Run:   docker run -p 8080:8080 erlmcp:3.0.0
# Scan:  docker build --target security-scan -t erlmcp:scan -f Dockerfile.optimized .
# SBOM:  docker build --target sbom -t erlmcp:sbom -f Dockerfile.optimized .
#
# ==============================================================================

# Build arguments with defaults
ARG OTP_VERSION=28.3.1
ARG ALPINE_VERSION=3.20
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=3.0.0

# ==============================================================================
# STAGE 1: DEPS - Cache dependencies layer (longest cache life)
# ==============================================================================
FROM erlang:${OTP_VERSION}-alpine AS deps

LABEL stage="deps"

ENV ERL_COMPILER_OPTIONS=deterministic \
    REBAR_NO_USER_CONFIG=true

WORKDIR /build

# Install minimal build dependencies
RUN apk add --no-cache \
    ca-certificates \
    git \
    openssl-dev \
    musl-dev \
    ncurses-dev \
    zlib-dev \
    && update-ca-certificates

# Copy dependency files FIRST for optimal caching
COPY rebar.config rebar.lock ./

# Download dependencies (cached unless rebar.config changes)
RUN rebar3 get-deps

# ==============================================================================
# STAGE 2: COMPILE - Compile with layer caching
# ==============================================================================
FROM erlang:${OTP_VERSION}-alpine AS compile

LABEL stage="compile"

ENV ERL_COMPILER_OPTIONS=deterministic \
    REBAR_NO_USER_CONFIG=true

WORKDIR /build

# Install full build dependencies
RUN apk add --no-cache \
    ca-certificates \
    git \
    make \
    gcc \
    g++ \
    musl-dev \
    pkgconfig \
    openssl-dev \
    ncurses-dev \
    zlib-dev \
    linux-headers

# Copy dependencies from deps stage
COPY --from=deps /build/_build /build/_build
COPY rebar.config rebar.lock ./

# Copy configuration files
COPY include/ ./include/
COPY config/ ./config/
COPY vm.args ./

# Copy application source directories
# Using full directory copies for efficiency - rebar3 will compile what's needed
COPY apps/erlmcp_core/ ./apps/erlmcp_core/
COPY apps/erlmcp_transports/ ./apps/erlmcp_transports/
COPY apps/erlmcp_observability/ ./apps/erlmcp_observability/
COPY apps/erlmcp_validation/ ./apps/erlmcp_validation/
COPY apps/erlmcp_zero_trust/ ./apps/erlmcp_zero_trust/

# Compile all applications
RUN rebar3 compile
RUN rebar3 as prod compile

# ==============================================================================
# STAGE 3: RELEASE - Create production release
# ==============================================================================
FROM compile AS release

LABEL stage="release"

# Create production release with minimal settings
RUN rebar3 as prod release

# Verify release
RUN ls -la _build/prod/rel/erlmcp/bin/erlmcp

# Prepare for runtime
RUN mkdir -p /opt/erlmcp && \
    cp -r _build/prod/rel/erlmcp /opt/erlmcp && \
    chmod +x /opt/erlmcp/erlmcp/bin/*

# ==============================================================================
# STAGE 4: SECURITY-SCAN - Security scanning
# ==============================================================================
FROM release AS security-scan

LABEL stage="security-scan"

# Install Trivy
RUN apk add --no-cache curl wget && \
    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | tee /etc/apk/keys/trivy.asc && \
    echo "https://aquasecurity.github.io/trivy-repo/alpine/v3.20/community" >> /etc/apk/repositories && \
    apk add --no-cache trivy

# Install Syft for SBOM
RUN wget -qO - https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# Run scans
RUN trivy fs --severity HIGH,CRITICAL --no-progress /opt/erlmcp || echo "Trivy scan complete"
RUN syft /opt/erlmcp -o spdx-json > /sbom.json || echo "SBOM generated"

# ==============================================================================
# STAGE 5: SBOM - Software Bill of Materials
# ==============================================================================
FROM release AS sbom

LABEL stage="sbom"

RUN apk add --no-cache curl wget && \
    wget -qO - https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

RUN syft /opt/erlmcp -o spdx-json > /erlmcp.sbom.json && \
    syft /opt/erlmcp -o cyclonedx-json > /erlmcp.cyclonedx.json

RUN cp /erlmcp.*.json /opt/erlmcp/

# ==============================================================================
# STAGE 6: RUNTIME - Minimal production runtime (<100MB)
# ==============================================================================
FROM alpine:${ALPINE_VERSION} AS runtime

LABEL maintainer="erlmcp contributors" \
      description="erlmcp Erlang/OTP - Minimal production runtime" \
      stage="runtime" \
      org.opencontainers.image.title="erlmcp" \
      org.opencontainers.image.description="Erlang/OTP MCP SDK" \
      org.opencontainers.image.vendor="erlmcp" \
      org.opencontainers.image.licenses="Apache-2.0" \
      org.opencontainers.image.source="https://github.com/banyan-platform/erlmcp" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.version="${VERSION}"

# Install ONLY runtime dependencies
RUN apk add --no-cache \
    ca-certificates \
    libssl3 \
    libcrypto3 \
    ncurses-libs \
    libstdc++ \
    libgcc \
    bash \
    curl \
    tzdata \
    libzstd && \
    update-ca-certificates && \
    rm -rf /var/cache/apk/* /tmp/* /var/tmp/*

# Create directories
RUN mkdir -p \
    /opt/erlmcp \
    /var/log/erlmcp \
    /var/lib/erlmcp \
    /var/run/erlmcp \
    /etc/erlmcp

WORKDIR /opt/erlmcp

# Copy release
COPY --from=release /opt/erlmcp /opt/erlmcp
COPY --from=sbom /opt/erlmcp/erlmcp.sbom.json /opt/erlmcp/ 2>/dev/null || true

# Health check script
RUN cat > /opt/erlmcp/bin/healthcheck.sh <<'EOF'
#!/bin/bash
HEALTH_URL="${HEALTH_URL:-http://localhost:8080/health}"
if command -v curl >/dev/null 2>&1; then
    if curl -f -s --max-time 5 "${HEALTH_URL}" >/dev/null 2>&1; then
        echo "health: HTTP OK"
        exit 0
    fi
fi
if /opt/erlmcp/erlmcp/bin/erlmcp ping >/dev/null 2>&1; then
    echo "health: Node OK"
    exit 0
fi
if pgrep -f "beam.smp.*erlmcp" >/dev/null 2>&1; then
    echo "health: Degraded"
    exit 1
fi
echo "health: Down"
exit 1
EOF

RUN chmod +x /opt/erlmcp/bin/healthcheck.sh

# Startup script
RUN cat > /opt/erlmcp/bin/start-cluster.sh <<'EOF'
#!/bin/bash
if [ -f /etc/erlmcp/environment ]; then
    set -a
    . /etc/erlmcp/environment
    set +a
fi
export ERLMCP_NODE_NAME="${ERLMCP_NODE_NAME:-erlmcp@$(hostname)}"
export ERL_AFLAGS="${ERL_AFLAGS:--proto_dist inet_tls}"
export ERL_DIST_PORT="${ERL_DIST_PORT:-9100}"
export ERLANG_DISTRIBUTION_PORT_RANGE="${ERLANG_DISTRIBUTION_PORT_RANGE:-9100-9200}"
export ERLMCP_DISTRIBUTION_MODE="${ERLMCP_DISTRIBUTION_MODE:-cluster}"
echo "Starting erlmcp: ${ERLMCP_NODE_NAME}"
exec /opt/erlmcp/erlmcp/bin/erlmcp foreground
EOF

RUN chmod +x /opt/erlmcp/bin/start-cluster.sh

# Non-root user
RUN addgroup -S -g 1000 erlmcp && \
    adduser -S -u 1000 -G erlmcp -h /opt/erlmcp -s /bin/sh erlmcp && \
    chown -R erlmcp:erlmcp \
        /opt/erlmcp \
        /var/log/erlmcp \
        /var/lib/erlmcp \
        /var/run/erlmcp \
        /etc/erlmcp && \
    chmod -R 750 /opt/erlmcp && \
    chmod -R 755 /opt/erlmcp/erlmcp/bin

# Environment
ENV ERLMCP_ENV=production \
    ERLMCP_VERSION=3.0.0 \
    LANG=C.UTF-8 \
    HOME=/opt/erlmcp \
    PATH=/opt/erlmcp/erlmcp/bin:$PATH \
    ERL_CRASH_DUMP=/var/log/erlmcp/erl_crash.dump \
    ERL_MAX_PORTS=65536 \
    ERL_MAX_ETS_TABLES=50000 \
    ERL_AFLAGS="+MBacul 0 +MScgulf 8192 +MBacgs 0" \
    ERL_FLAGS="-noshell"

USER erlmcp

EXPOSE 8080 9100 9090 9100-9200

HEALTHCHECK --interval=15s --timeout=10s --start-period=45s --retries=3 \
    CMD /opt/erlmcp/bin/healthcheck.sh

ENTRYPOINT ["/opt/erlmcp/bin/start-cluster.sh"]
