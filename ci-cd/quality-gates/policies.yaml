# Quality Gate Policies for erlmcp v3
# Version: 1.0.0

# Policy Categories
categories:
  compilation:
    name: "Compilation"
    description: "Code compilation validation"
    required: true
    blocking: true
    threshold: 100  # 100% success rate required

  testing:
    name: "Testing"
    description: "Test execution and coverage"
    required: true
    blocking: true
    thresholds:
      eunit:
        pass_rate: 100.0  # All tests must pass
        coverage: 80.0     # Minimum 80% coverage
      ct:
        pass_rate: 100.0
        coverage: 80.0
      proper:
        shrink_limit: 5    # Maximum 5 counterexamples
        success_ratio: 95 # 95% success rate

  security:
    name: "Security"
    description: "Security vulnerability scanning"
    required: true
    blocking: true
    thresholds:
      critical: 0       # No critical vulnerabilities
      high: 0           # No high severity vulnerabilities
      medium: 5         # Maximum 5 medium severity
      low: 20          # Maximum 20 low severity

  performance:
    name: "Performance"
    description: "Performance regression testing"
    required: false
    blocking: false
    thresholds:
      response_time: 50   # Maximum 50ms response time
      throughput: 1000   # Minimum 1000 req/s
      error_rate: 0.01    # Maximum 1% error rate
      memory_usage: 85    # Maximum 85% memory usage
      cpu_usage: 80      # Maximum 80% CPU usage

  code_quality:
    name: "Code Quality"
    description: "Code quality metrics"
    required: true
    blocking: true
    thresholds:
      dialyzer_warnings: 0
      xref_undefined: 0
      cyclomatic_complexity: 15  # Maximum average complexity
      maintainability_index: 70  # Minimum maintainability score

# Environment-specific Policies
environments:
  development:
    name: "Development"
    strictness: low
    required_categories:
      - compilation
      - testing
    optional_categories:
      - security
      - performance
      - code_quality

  staging:
    name: "Staging"
    strictness: medium
    required_categories:
      - compilation
      - testing
      - security
      - code_quality
    optional_categories:
      - performance

  production:
    name: "Production"
    strictness: high
    required_categories:
      - compilation
      - testing
      - security
      - performance
      - code_quality
    blocking_categories:
      - compilation
      - testing
      - security
      - performance
      - code_quality

# Test Configuration
tests:
  eunit:
    enabled: true
    parallel: true
    timeout: 300  # 5 minutes
    pattern: "*_test.erl"

  ct:
    enabled: true
    parallel: true
    timeout: 600  # 10 minutes
    suites:
      - erlmcp_core
      - erlmcp_transports
      - erlmcp_observability
      - erlmcp_validation

  integration:
    enabled: true
    parallel: false
    timeout: 1200  # 20 minutes
    scenarios:
      - api_compatibility
      - transport_switching
      - session_management
      - error_handling

  performance:
    enabled: true
    parallel: true
    timeout: 900  # 15 minutes
    benchmarks:
      - registry_ops
      - message_queue
      - connection_handling
      - memory_usage

# Security Policies
security:
  scans:
    - trivy
    - grype
    - bandit
    - semgrep
    - snyk

  secrets:
    enabled: true
    patterns:
      - "API_KEY"
      - "PASSWORD"
      - "SECRET"
      - "TOKEN"
      - "PRIVATE_KEY"
      - "CREDENTIALS"

  licenses:
    allowed:
      - "Apache-2.0"
      - "MIT"
      - "BSD-3-Clause"
      - "ISC"
    denied:
      - "GPL-3.0"
      - "AGPL-3.0"

# Performance Baselines
performance_baselines:
  registry_ops:
    min_throughput: 500000  # messages per second
    max_latency: 10ms
    max_memory: 100MB

  message_queue:
    min_throughput: 1000000  # messages per second
    max_latency: 5ms
    max_memory: 50MB

  connection_handling:
    max_concurrent: 50000
    avg_response_time: 20ms
    error_rate: 0.001

# Quality Metrics Dashboard
dashboard:
  enabled: true
  update_interval: 300  # 5 minutes
  metrics:
    - name: "Test Pass Rate"
      type: "percentage"
      threshold: 100
      display: "gauge"

    - name: "Code Coverage"
      type: "percentage"
      threshold: 80
      display: "gauge"

    - name: "Vulnerabilities"
      type: "count"
      threshold: 0
      display: "counter"

    - name: "Performance Score"
      type: "score"
      threshold: 85
      display: "gauge"

    - name: "Maintainability"
      type: "score"
      threshold: 70
      display: "gauge"

# Enforcement Actions
enforcement:
  on_failure:
    - action: "notify"
      targets:
        - "slack"
        - "email"
      level: "error"

    - action: "block"
      reason: "Quality gate failed"

    - action: "escalate"
      targets:
        - "engineering-team"

  on_warning:
    - action: "notify"
      targets:
        - "slack"
      level: "warning"

    - action: "comment"
      platform: "github"

    - action: "create_issue"
      title: "Quality Warning Detected"
      labels: ["quality", "warning"]

# Notification Configuration
notifications:
  slack:
    enabled: true
    channel: "#quality-gates"
    webhook_url: "${SLACK_WEBHOOK}"

    templates:
      success: |
        üéâ Quality Gate Passed: ${{ env.JOB_NAME }} #${{ env.BUILD_ID }}

        Environment: ${{ env.ENVIRONMENT }}
        Duration: ${{ env.DURATION }}
        Coverage: ${{ env.COVERAGE }}%
        Security: ${{ env.SECURITY_STATUS }}
        Performance: ${{ env.PERFORMANCE_SCORE }}

        ${{ env.BUILD_URL }}

      failure: |
        ‚ùå Quality Gate Failed: ${{ env.JOB_NAME }} #${{ env.BUILD_ID }}

        Environment: ${{ env.ENVIRONMENT }}
        Duration: ${{ env.DURATION }}
        Errors: ${{ env.ERROR_COUNT }}
        Failures: ${{ env.FAILURE_COUNT }}
        Duration: ${{ env.DURATION }}

        ${{ env.BUILD_URL }}

      warning: |
        ‚ö†Ô∏è Quality Warning: ${{ env.JOB_NAME }} #${{ env.BUILD_ID }}

        Environment: ${{ env.ENVIRONMENT }}
        Issues: ${{ env.ISSUE_COUNT }}
        Thresholds: ${{ env.THRESHOLD_DETAILS }}

        ${{ env.BUILD_URL }}

  email:
    enabled: true
    recipients:
      - "engineering@example.com"
      - "quality@example.com"
    template: |
      Subject: Quality Gate Alert - ${{ env.SUMMARY }}

      Build: ${{ env.JOB_NAME }} #${{ env.BUILD_ID }}
      Branch: ${{ env.BRANCH_NAME }}
      Commit: ${{ env.GIT_COMMIT }}
      Status: ${{ env.STATUS }}

      Details:
      ${{ env.DETAILS }}