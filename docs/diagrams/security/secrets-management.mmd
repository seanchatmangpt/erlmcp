graph TB
    %% Secrets Management Architecture for erlmcp
    %% Shows: Vault, AWS Secrets Manager, Local Encrypted Storage
    %% Plus: Caching, Rotation, and Fallback mechanisms

    subgraph "Secrets Consumer Layer"
        Client["erlmcp_client<br/>(gen_server)"]
        Server["erlmcp_server<br/>(gen_server)"]
        Auth["erlmcp_auth<br/>(Authentication)"]
        Transports["Transport Layer<br/>(HTTP/TCP configs)"]
    end

    subgraph "Secrets Manager API"
        SecretsAPI["erlmcp_secrets<br/>(gen_server)"]
        Cache["ETS Cache<br/>(5 min TTL)<br/>secret_key → {value, expires_at}"]
    end

    subgraph "Backend Abstraction Layer"
        VaultBackend["Vault Backend<br/>(HashiCorp)"]
        AWSBackend["AWS Backend<br/>(Secrets Manager)"]
        LocalBackend["Local Backend<br/>(AES-256-GCM)"]
    end

    subgraph "HashiCorp Vault Integration"
        Vault["Vault Server<br/>(localhost:8200 or prod)"]
        KVEngine["KV Secrets Engine v2<br/>secret/data/*"]
        AppRole["AppRole Auth<br/>(role_id + secret_id)"]
        K8sAuth["Kubernetes Auth<br/>(JWT + service account)"]
        TokenAuth["Token Auth<br/>(root token)"]
    end

    subgraph "AWS Secrets Manager Integration"
        AWSService["AWS Secrets Manager<br/>(secretsmanager.*.amazonaws.com)"]
        SigV4["AWS SigV4 Signing<br/>(HMAC-SHA256)"]
        IAMRole["IAM Role Auth<br/>(EC2/ECS metadata service)"]
        AccessKey["Access Key Auth<br/>(AKID + secret key)"]
        STS["STS Assume Role<br/>(temporary credentials)"]
    end

    subgraph "Local Encrypted Storage"
        EncFile["Encrypted File<br/>(priv/secrets/secrets.enc)"]
        MasterKey["Master Key<br/>(priv/secrets/master.key)"]
        AESGCM["AES-256-GCM<br/>(crypto module)"]
    end

    %% Connections
    Client -->|get_secret/1| SecretsAPI
    Server -->|get_secret/1| SecretsAPI
    Auth -->|get_secret/1| SecretsAPI
    Transports -->|get_secret/1| SecretsAPI

    SecretsAPI -->|1. Check Cache| Cache
    Cache -->|Cache Hit| SecretsAPI
    Cache -->|Cache Miss<br/or Expired| SecretsAPI

    SecretsAPI -->|2. Fetch from Backend| VaultBackend
    SecretsAPI -->|2. Fetch from Backend| AWSBackend
    SecretsAPI -->|2. Fetch from Backend| LocalBackend

    %% Vault Flow
    VaultBackend -->|HTTP via gun| Vault
    Vault -->|AppRole Login| AppRole
    Vault -->|K8s Login| K8sAuth
    Vault -->|Direct Token| TokenAuth

    AppRole -->|POST /v1/auth/approle/login| Vault
    K8sAuth -->|POST /v1/auth/kubernetes/login| Vault
    TokenAuth -->|X-Vault-Token Header| Vault

    Vault -->|GET/POST/DELETE<br/>/v1/secret/data/{key}| KVEngine
    KVEngine -->|Secret Response| Vault
    Vault -->|JSON Response| VaultBackend

    %% AWS Flow
    AWSBackend -->|HTTPS via gun| AWSService
    AWSBackend -->|Calculate Signature| SigV4
    SigV4 -->|Canonical Headers<br/>Payload Hash<br/>HMAC-SHA256| AWSBackend

    AWSBackend -->|Get Credentials| IAMRole
    AWSBackend -->|Get Credentials| AccessKey
    IAMRole -->|STS Assume Role| STS
    STS -->|Temporary Creds| AWSBackend

    AWSBackend -->|POST /| AWSService
    AWSService -->|GetSecretValue<br/>CreateSecret<br/>UpdateSecret<br/>DeleteSecret| AWSService
    AWSService -->|JSON Response| AWSBackend

    %% Local Storage Flow
    LocalBackend -->|Read File| EncFile
    EncFile -->|Encrypted Data<br/>IV + Tag + CipherText| AESGCM
    AESGCM -->|Decrypt with Master Key| LocalBackend

    LocalBackend -->|Write Secret| AESGCM
    AESGCM -->|Encrypt with Master Key| EncFile

    MasterKey -->|Load/Generate| LocalBackend
    LocalBackend -->|file:read_file| MasterKey

    %% Cache Updates
    VaultBackend -->|3. Cache Result| Cache
    AWSBackend -->|3. Cache Result| Cache
    LocalBackend -->|3. Cache Result| Cache
    Cache -->|Return to Caller| SecretsAPI
    SecretsAPI -->|{ok, Value}| Client

    %% Rotation Flow
    Client -->|rotate_secret/1| SecretsAPI
    SecretsAPI -->|Generate Random| SecretsAPI
    Note1["crypto:strong_rand_bytes(32)<br/>base64 encoded"]
    SecretsAPI -->|New Value| Note1
    SecretsAPI -->|Store New Value| VaultBackend
    SecretsAPI -->|Store New Value| AWSBackend
    SecretsAPI -->|Store New Value| LocalBackend

    %% Styling
    classDef consumer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef api fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef backend fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef vault fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef aws fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef local fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class Client,Server,Auth,Transports consumer
    class SecretsAPI,Cache api
    class VaultBackend,AWSBackend,LocalBackend backend
    class Vault,KVEngine,AppRole,K8sAuth,TokenAuth vault
    class AWSService,SigV4,IAMRole,AccessKey,STS aws
    class EncFile,MasterKey,AESGCM local

    %% Notes
    NoteTop["<b>Security Features:</b><br/>✅ ETS cache with 5-min TTL (performance)<br/>✅ Async initialization (non-blocking)<br/>✅ Graceful fallback (Vault → AWS → Local)<br/>✅ Automatic secret rotation<br/>✅ Audit logging (all accesses logged)<br/>✅ Encryption at rest (AES-256-GCM)<br/>✅ Encryption in transit (TLS only)"]
    NoteRight["<b>Vault Auth Methods:</b><br/>• Token (root/admin tokens)<br/>• AppRole (production recommended)<br/>• Kubernetes (cloud-native)"]
    NoteBottom["<b>AWS Auth Methods:</b><br/>• Access Key (dev/testing)<br/>• IAM Role (EC2/ECS)<br/>• STS Assume Role (cross-account)"]
    NoteLeft["<b>Local Security:</b><br/>• 256-bit master key<br/>• AES-256-GCM encryption<br/>• 12-byte random IV<br/>• 16-byte auth tag<br/>• File permissions: 0600"]
