%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#ff69b4', 'primaryTextColor':'#fff', 'primaryBorderColor':'#ff1493', 'lineColor':'#ff1493', 'sectionBkgColor':'#ffe6f2', 'altSectionBkgColor':'#ffccf2', 'gridColor':'#ff99cc'}}}%%
flowchart TB
    subgraph Proper["Property-Based Testing with Proper"]
        direction TB

        subgraph Properties["Property Structure"]
            P1["?FORALL(Input, Generator, Property)"]
            P2["Generator → Input Domain"]
            P3["Property → Boolean Predicate"]
            P4["Auto-shrinking → Minimal Counterexample"]
        end

        subgraph Generators["Input Generators"]
            direction LR
            G1["Primitive Types<br/>int(), binary(), list()"]
            G2["JSON-RPC Messages<br/>json_rpc_request()"]
            G3["MCP Protocol<br/>mcp_capability()"]
            G4["Transport Types<br/>transport_type()"]
            G5["State Records<br/>state_record()"]
            G6["Complex Data<br/>weighted_union()"]
        end

        subgraph Invariants["Protocol Invariants"]
            direction TB

            subgraph Encoding["Encoding/Decoding"]
                INV1["Roundtrip Property<br/>encode(decode(X)) = X"]
                INV2["JSON Validity<br/>is_valid_json(encode(X))"]
                INV3["Schema Compliance<br/>validate_schema(encode(X))"]
            end

            subgraph StateMachines["State Machines"]
                INV4["Command Sequencing<br/>commands must be valid"]
                INV5["State Consistency<br/>state transitions preserve invariants"]
                INV6["Postcondition<br/>postcondition(State, Cmd, Result)"]
            end

            subgraph Concurrency["Concurrency"]
                INV7["Linearizability<br/>concurrent operations appear atomic"]
                INV8["No Race Conditions<br/>all interleavings safe"]
                INV9["Idempotence<br/>repeatable operations"]
            end
        end

        subgraph TestExecution["Property Test Execution"]
            direction LR
            TE1["rebar3 proper -c --module=Module"]
            TE2["Generate 100 random cases"]
            TE3["Test each case"]
            TE4["On failure: shrink to minimal"]
            TE5["Report counterexample"]
            TE6["Verify fix: re-run all"]
        end

        subgraph PropertiesMap["erlmcp Properties"]
            direction TB
            PM1["erlmcp_json_rpc_tests<br/>prop_encode_decode_roundtrip()"]
            PM2["erlmcp_server_tests<br/>prop_concurrent_operations()"]
            PM3["erlmcp_registry_tests<br/>prop_registration_idempotent()"]
            PM4["erlmcp_session_tests<br/>prop_session_persistence()"]
            PM5["erlmcp_transport_tests<br/>prop_transport_behavior()"]
        end
    end

    subgraph Examples["Property Examples"]
        direction TB

        subgraph Example1["JSON-RPC Roundtrip"]
            EX1S["Generator:<br/>json_rpc_request()"]
            EX1P["Property:<br/>decode(encode(Request)) = Request"]
            EX1R["1000 cases generated<br/>All pass"]
        end

        subgraph Example2["Registry Registration"]
            EX2S["Generator:<br/>{ServerName, Pid, Config}"]
            EX2P["Property:<br/>register(Name) → find(Name) = ok<br/>unregister(Name) → find(Name) = error"]
            EX2R["Idempotency verified<br/>500 cases"]
        end

        subgraph Example3["Session Persistence"]
            EX3S["Generator:<br/>SessionData"]
            EX3P["Property:<br/>save(Session) → load(Id) = Session<br/>State preserved across restart"]
            EX3R["ETS, DETS, Mnesia tested<br/>200 cases each"]
        end
    end

    subgraph Shrinking["Shrinking Strategy"]
        direction TB
        SH1["Find counterexample<br/>Large complex input"]
        SH2["Shrink step 1<br/>Reduce list size"]
        SH3["Shrink step 2<br/>Simplify values"]
        SH4["Shrink step 3<br/>Minimal case<br/>Easier to debug"]
    end

    subgraph Coverage["Property-Based Coverage"]
        direction LR
        C1["Edge Cases<br/>Empty lists, max values"]
        C2["Error Paths<br/>Invalid input, failures"]
        C3["Concurrency<br/>All interleavings"]
        C4["State Spaces<br/>All reachable states"]
        C5["Protocol<br/>All message types"]
    end

    %% Flow connections
    Properties --> Generators
    Generators --> Invariants
    Invariants --> TestExecution
    TestExecution --> PropertiesMap
    PropertiesMap --> Examples
    TestExecution --> Shrinking
    Invariants --> Coverage

    %% Styling
    classDef structureStyle fill:#ff69b4,stroke:#ff1493,stroke-width:3px,color:#fff
    classDef generatorStyle fill:#00bfff,stroke:#0080ff,stroke-width:2px,color:#fff
    classDef invariantStyle fill:#32cd32,stroke:#228b22,stroke-width:2px,color:#fff
    classDef executionStyle fill:#ffd700,stroke:#ff8c00,stroke-width:2px,color:#000
    classDef exampleStyle fill:#9370db,stroke:#8a2be2,stroke-width:2px,color:#fff
    classDef shrinkStyle fill:#ff6347,stroke:#ff4500,stroke-width:2px,color:#fff
    classDef coverageStyle fill:#20b2aa,stroke:#008b8b,stroke-width:2px,color:#fff

    class P1,P2,P3,P4 structureStyle
    class G1,G2,G3,G4,G5,G6 generatorStyle
    class INV1,INV2,INV3,INV4,INV5,INV6,INV7,INV8,INV9 invariantStyle
    class TE1,TE2,TE3,TE4,TE5,TE6 executionStyle
    class PM1,PM2,PM3,PM4,PM5 exampleStyle
    class EX1S,EX1P,EX1R,EX2S,EX2P,EX2R,EX3S,EX3P,EX3R exampleStyle
    class SH1,SH2,SH3,SH4 shrinkStyle
    class C1,C2,C3,C4,C5 coverageStyle

    %% Statistics
    subgraph Stats["Property Testing Statistics"]
        ST1["Total Properties: 50+"<br/>JSON-RPC: 12<br/>State Machines: 15<br/>Concurrency: 8<br/>Encoding: 10<br/>Other: 5+]
        ST2["Test Cases: 10,000+<br/>Generated randomly<br/>Shrunk to minimal"]
        ST3["Coverage: Edge cases<br/>that unit tests miss"]
    end

    PropertiesMap --> Stats
