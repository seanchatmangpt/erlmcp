%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#f1f5f9', 'primaryTextColor':'#0f172a', 'primaryBorderColor':'#3b82f6', 'lineColor':'#64748b', 'sectionBkgColor':'#e2e8f0', 'altSectionBkgColor':'#f8fafc'}}}%%
flowchart TD
    subgraph TDD["Test-Driven Development Cycle - Chicago School"]
        direction TB

        subgraph Phase1["Phase 1: Red - Write Failing Test"]
            R1["ðŸ”´ Understand Requirements<br/>Erlang specification & API design"]
            R2["ðŸ”´ Write Test First<br/>EUnit/CT test module"]
            R3["ðŸ”´ Verify Test Fails<br/>rebar3 eunit --module=M"]
            R1 --> R2 --> R3
        end

        subgraph Phase2["Phase 2: Green - Make Test Pass"]
            G1["ðŸŸ¢ Write Minimal Code<br/>gen_server callbacks"]
            G2["ðŸŸ¢ Run Test Suite<br/>rebar3 eunit"]
            G3["ðŸŸ¢ Verify All Pass<br/>pass_rate = 1.0"]
            G1 --> G2 --> G3
        end

        subgraph Phase3["Phase 3: Refactor - Improve Code"]
            Y1["ðŸŸ¡ Refactor Design<br/>Extract functions, improve names"]
            Y2["ðŸŸ¡ Ensure Tests Still Pass<br/>No behavior change"]
            Y3["ðŸŸ¡ Code Quality Gates<br/>dialyzer, xref, format"]
            Y1 --> Y2 --> Y3
        end

        R3 --> G1
        G3 --> Y1
        Y3 -.->|Repeat| R2
    end

    subgraph Quality["Quality Gates - Mandatory"]
        Q1["âœ… Compilation: errors = 0"]
        Q2["âœ… Coverage: â‰¥80%"]
        Q3["âœ… Dialyzer: warnings â†’ 0"]
        Q4["âœ… Xref: undefined = âˆ…"]
        Q5["âœ… Format: rebar3 format --verify"]
    end

    subgraph Testing["Testing Hierarchy"]
        T1["Unit Tests<br/>EUnit - function level<br/>tests/*_tests.erl"]
        T2["Integration Tests<br/>CommonTest - module level<br/>test/*.suite"]
        T3["Property Tests<br/>Proper - generative<br/>statistical verification"]
        T4["Chaos Tests<br/>Failure injection<br/>resilience validation"]
    end

    subgraph OTP["OTP Compliance Checks"]
        O1["gen_server Behavior<br/>6 callbacks implemented"]
        O2["Supervision Tree<br/>Child specs defined"]
        O3["Process Registration<br/>gproc naming"]
        O4["Error Handling<br/>let-it-crash semantics"]
    end

    Y3 --> Quality
    Quality --> Testing
    Testing --> OTP

    style TDD fill:#f8fafc,stroke:#3b82f6,stroke-width:3px
    style Quality fill:#dcfce7,stroke:#22c55e,stroke-width:2px
    style Testing fill:#fef9c3,stroke:#eab308,stroke-width:2px
    style OTP fill:#e0e7ff,stroke:#6366f1,stroke-width:2px

    classDef redPhase fill:#fecaca,stroke:#ef4444,stroke-width:2px,color:#7f1d1d
    classDef greenPhase fill:#bbf7d0,stroke:#22c55e,stroke-width:2px,color:#14532d
    classDef yellowPhase fill:#fef08a,stroke:#eab308,stroke-width:2px,color:#713f12

    class R1,R2,R3 redPhase
    class G1,G2,G3 greenPhase
    class Y1,Y2,Y3 yellowPhase
