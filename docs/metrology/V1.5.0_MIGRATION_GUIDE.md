# Metrology v1.5.0 Migration Guide

## Overview

erlmcp v1.5.0 introduces **canonical metrology standards** that eliminate ambiguous performance metrics and establish reproducible benchmarking practices.

**Key Changes:**
- ❌ Deprecated: `req/s`, `MiB/conn`, ambiguous `memory_mb`
- ✅ New: `msg_per_s`, `per_connection_heap_mib`, workload references
- ✅ Required: Every metric MUST reference a `workload_id`

## What Changed

### Before (v1.4.0 - Ambiguous)

```json
{
  "envelope": {
    "throughput_req_s": 450,
    "concurrent_connections": 25000,
    "p99_latency_ms": 150
  },
  "limits": {
    "memory_limit_mb": 512
  }
}
```

**Problems:**
- `throughput_req_s` - Does this count responses? (450 req/s or 900 msg/s?)
- `memory_limit_mb` - Heap? RSS? State? Unclear.
- No workload context - How was this measured? What transport?

### After (v1.5.0 - Canonical)

```json
{
  "envelope": {
    "throughput": {
      "value": 900,
      "unit": "msg_per_s",
      "definition": "JSON-RPC messages (requests + responses)",
      "workload_id": "tcp_sustained_25k_1kib",
      "transport": "tcp",
      "scope": "per_node",
      "duration_s": 30
    },
    "latency": {
      "p99_ms": 150,
      "workload_id": "tcp_sustained_25k_1kib",
      "transport": "tcp",
      "measurement_point": "client_to_client"
    }
  },
  "memory": {
    "per_connection_heap_mib": 0.048,
    "per_connection_state_mib": 0.012,
    "per_node_base_overhead_mib": 150,
    "per_node_total_rss_mib": 1536,
    "workload_id": "tcp_sustained_25k_1kib"
  }
}
```

**Benefits:**
- ✅ Clear unit: `msg_per_s` = requests + responses
- ✅ Memory breakdown: heap vs state vs RSS
- ✅ Reproducible: `workload_id` references exact benchmark
- ✅ Context: transport, scope, duration specified

## Migration Steps

### Step 1: Review Existing Metrics

```bash
# Find ambiguous patterns
grep -r "req/s\|req_s" plans/*.json
grep -r "MiB/conn\|MB/conn" plans/*.json
```

### Step 2: Create Workload Definitions

For each performance claim, create a workload file in `bench/workloads/`:

```json
{
  "workload_id": "tcp_sustained_25k_1kib",
  "description": "25K TCP connections, 1 KiB messages, 30s sustained",
  "transport": "tcp",
  "pattern": "sustained",
  "duration_s": 30,
  "connections": 25000,
  "message_size_bytes": 1024,
  "expected_performance": {
    "throughput_msg_per_s": 900,
    "p99_latency_ms": 150
  }
}
```

### Step 3: Transform Plan Files

Use the transformation table:

| Old (v1.4.0) | New (v1.5.0) | Required Fields |
|--------------|--------------|-----------------|
| `throughput_req_s: 450` | `throughput.msg_per_s: 900` | `workload_id`, `transport`, `scope` |
| `memory_limit_mb: 512` | `memory.per_node_total_rss_mib: 512` | `workload_id`, `scope` |
| `p99_latency_ms: 150` | `latency.p99_ms: 150` | `workload_id`, `transport` |

### Step 4: Add Metrology Compliance Section

```json
{
  "metrology_compliance": {
    "version": "v1.5.0",
    "validated": "2026-01-27",
    "validator": "scripts/validate_plan_metrology.sh",
    "violations": 0,
    "workload_definitions": "bench/workloads/",
    "metrics_glossary": "docs/metrology/METRICS_GLOSSARY.md"
  }
}
```

### Step 5: Validate

```bash
./scripts/validate_plan_metrology.sh
```

Expected output:
```
✓✓✓ ALL VALIDATIONS PASSED ✓✓✓
Plans are compliant with metrology v1.5.0
Total violations: 0
```

## Transformation Examples

### Example 1: Throughput

```diff
- "throughput_req_s": 450
+ "throughput": {
+   "value": 900,
+   "unit": "msg_per_s",
+   "definition": "JSON-RPC messages (requests + responses)",
+   "workload_id": "tcp_sustained_25k_1kib",
+   "transport": "tcp",
+   "scope": "per_node",
+   "duration_s": 30
+ }
```

### Example 2: Memory

```diff
- "memory_limit_mb": 512
+ "memory": {
+   "per_connection_heap_mib": 0.048,
+   "per_connection_state_mib": 0.012,
+   "per_node_base_overhead_mib": 150,
+   "per_node_total_rss_mib": 1536,
+   "workload_id": "tcp_sustained_25k_1kib",
+   "connections": 25000,
+   "scope": "per_node"
+ }
```

### Example 3: Latency

```diff
- "p99_latency_ms": 150
+ "latency": {
+   "p50_ms": 8,
+   "p95_ms": 50,
+   "p99_ms": 150,
+   "workload_id": "tcp_sustained_25k_1kib",
+   "transport": "tcp",
+   "measurement_point": "client_to_client"
+ }
```

## Validation Checklist

Before marking migration complete:

- [ ] All `req/s` replaced with `msg_per_s`
- [ ] All `MiB/conn` replaced with specific component (heap/state/RSS)
- [ ] Every performance metric has `workload_id`
- [ ] Every workload_id exists in `bench/workloads/*.json`
- [ ] Every metric has `transport` field
- [ ] Every metric has `scope` field
- [ ] Metrology compliance section added
- [ ] Validation script passes (0 violations)

## Common Issues

### Issue 1: Missing Workload Definition

**Error:**
```
✗ VIOLATION: workload_id 'tcp_sustained_25k_1kib' not found
```

**Solution:**
Create `bench/workloads/tcp_sustained_25k_1kib.json` with complete specification.

### Issue 2: Ambiguous Memory

**Error:**
```
✗ VIOLATION: Ambiguous 'MiB/conn' found (specify: heap, state, or RSS)
```

**Solution:**
Break down into components:
- `per_connection_heap_mib` - Process heap
- `per_connection_state_mib` - Application state
- `per_node_total_rss_mib` - Total RSS

### Issue 3: No Transport Specified

**Error:**
```
✗ VIOLATION: throughput missing transport
```

**Solution:**
Add `"transport": "tcp"` (or `http_sse`, `stdio`, `websocket`).

## References

- **Metrics Glossary**: `docs/metrology/METRICS_GLOSSARY.md`
- **Workload Definitions**: `bench/workloads/*.json`
- **Environment Specs**: `bench/environments/*.json`
- **Validator**: `scripts/validate_plan_metrology.sh`

## Support

Questions? Issues?
- GitHub Issues: `github.com/erlmcp/erlmcp/issues`
- Tag: `metrology`, `v1.5.0`

---

**Status**: CANONICAL (v1.5.0)
**Last Updated**: 2026-01-27
