apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
data:
  haproxy.cfg: |
    global
      daemon
      nbproc 4
      maxconn 100000
      ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11
      ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384
      stats socket /var/run/haproxy/stats mode 600 level admin
      tune.ssl.default-dh-param 2048
      tune.bufsize 65535
      tune.ssl.lifetime 86400

    defaults
      mode http
      timeout connect 5s
      timeout client 30s
      timeout server 30s
      timeout http-request 10s
      timeout http-keep-alive 10s
      maxconn 100000
      option redispatch
      option dontlognull
      option httpclose
      option httplog
      option forwardfor
      option http-keep-alive
      option http-server-close
      option dontlognull
      option httplog
      option dontlog-normal
      log global

    # Enable Prometheus metrics
    listen stats
      bind *:8404
      mode http
      stats enable
      stats uri /stats
      stats refresh 30s
      stats auth admin:admin123
      stats realm HAProxy-Statistics

    # Load balancing for erlmcp-core service
    frontend erlmcp-in
      bind *:80
      bind *:443 ssl crt /etc/haproxy/ssl/server.pem
      mode tcp
      option tcplog
      tcp-request inspect-delay 5s
      tcp-request content accept if HTTP
      tcp-request content reject unless HTTP
      use_backend erlmcp-backend-https

    frontend erlmcp-websocket
      bind *:8443
      mode tcp
      option tcplog
      tcp-request inspect-delay 5s
      tcp-request content accept if WS
      tcp-request content reject unless WS
      use_backend erlmcp-backend-ws

    # SSL Termination
    backend erlmcp-backend-https
      mode http
      balance leastconn
      option httpchk GET /health
      option httplog
      option forwardfor
      http-check expect status 200
      server erlmcp-node-1 erlmcp-node-1:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-2 erlmcp-node-2:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-3 erlmcp-node-3:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-4 erlmcp-node-4:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-5 erlmcp-node-5:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-6 erlmcp-node-6:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-7 erlmcp-node-7:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-8 erlmcp-node-8:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-9 erlmcp-node-9:8080 check inter 5s rise 3 fall 3 weight 100

      # Stick sessions based on X-Forwarded-For header
      stick-table type ip size 200k expire 1h
      stick on src

      # Enable compression
      compression algo gzip
      compression type text/html text/css text/javascript application/javascript application/json

    # Backend for WebSocket connections
    backend erlmcp-backend-ws
      mode tcp
      balance leastconn
      option tcp-check
      tcp-check send "\x00\x00\x00\x0E\x47\x45\x54\x20\x2F\x77\x65\x62\x73\x6F\x63\x6B\x65\x74\x20\x48\x54\x54\x50\x2F\x31\x2E\x31\x0D\x0A\x0D\x0A"
      tcp-check expect string "HTTP/1. 101"
      server erlmcp-node-1 erlmcp-node-1:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-2 erlmcp-node-2:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-3 erlmcp-node-3:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-4 erlmcp-node-4:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-5 erlmcp-node-5:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-6 erlmcp-node-6:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-7 erlmcp-node-7:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-8 erlmcp-node-8:8080 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-9 erlmcp-node-9:8080 check inter 5s rise 3 fall 3 weight 100

    # TCP backend for raw TCP traffic
    backend erlmcp-backend-tcp
      mode tcp
      balance leastconn
      option tcp-check
      server erlmcp-node-1 erlmcp-node-1:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-2 erlmcp-node-2:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-3 erlmcp-node-3:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-4 erlmcp-node-4:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-5 erlmcp-node-5:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-6 erlmcp-node-6:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-7 erlmcp-node-7:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-8 erlmcp-node-8:9090 check inter 5s rise 3 fall 3 weight 100
      server erlmcp-node-9 erlmcp-node-9:9090 check inter 5s rise 3 fall 3 weight 100

    # Health check backend
    backend erlmcp-health-backend
      mode http
      balance roundrobin
      option httpchk GET /health
      server erlmcp-node-1 erlmcp-node-1:8080 check inter 10s rise 2 fall 5
      server erlmcp-node-2 erlmcp-node-2:8080 check inter 10s rise 2 fall 5
      server erlmcp-node-3 erlmcp-node-3:8080 check inter 10s rise 2 fall 5

    # Metrics endpoint
    backend erlmcp-metrics-backend
      mode http
      balance roundrobin
      server erlmcp-node-1 erlmcp-node-1:8080/metrics
      server erlmcp-node-2 erlmcp-node-2:8080/metrics
      server erlmcp-node-3 erlmcp-node-3:8080/metrics