{{/*
  ERLMCP Enterprise Secrets
  Secure management of sensitive data
*/}}
{{- if .Values.security.secrets.enabled }}
{{- /* Main application secrets */}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.security.secrets.name | default "erlmcp-secrets" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: secrets
  annotations:
    "erlmcp.io/secret-type": "application"
type: Opaque
data:
  {{- /* Erlang cookie for clustering */}}
  {{- if .Values.security.secrets.erlangCookie }}
  erlang-cookie: {{ .Values.security.secrets.erlangCookie | b64enc }}
  {{- else }}
  erlang-cookie: {{ randAlphaNum 32 | b64enc }}
  {{- end }}

  {{- /* JWT secret */}}
  {{- if .Values.security.secrets.jwtSecret }}
  jwt-secret: {{ .Values.security.secrets.jwtSecret | b64enc }}
  {{- else }}
  jwt-secret: {{ randAlphaNum 64 | b64enc }}
  {{- end }}

  {{- /* Database credentials */}}
  {{- if .Values.app.database.enabled }}
  {{- if .Values.security.secrets.dbPassword }}
  db-password: {{ .Values.security.secrets.dbPassword | b64enc }}
  {{- else }}
  db-password: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  {{- if .Values.security.secrets.dbUrl }}
  db-url: {{ .Values.security.secrets.dbUrl | b64enc }}
  {{- end }}
  {{- end }}

  {{- /* Redis credentials */}}
  {{- if .Values.app.cache.enabled }}
  {{- if .Values.security.secrets.redisPassword }}
  redis-password: {{ .Values.security.secrets.redisPassword | b64enc }}
  {{- else }}
  redis-password: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  {{- if .Values.security.secrets.redisUrl }}
  redis-url: {{ .Values.security.secrets.redisUrl | b64enc }}
  {{- end }}
  {{- end }}

  {{- /* External API keys */}}
  {{- if .Values.security.secrets.apiKeys }}
  {{- range $key, $value := .Values.security.secrets.apiKeys }}
  {{ $key }}: {{ $value | b64enc }}
  {{- end }}
  {{- end }}

  {{- /* Session secret */}}
  session-secret: {{ .Values.security.secrets.sessionSecret | default (randAlphaNum 32) | b64enc }}

  {{- /* Encryption key */}}
  encryption-key: {{ .Values.security.secrets.encryptionKey | default (randAlphaNum 32) | b64enc }}
{{- end }}
---
{{- /* TLS Secret */}}
{{- if and .Values.ingress.enabled .Values.ingress.tls }}
{{- $tlsSecret := index .Values.ingress.tls 0 }}
{{- if and $tlsSecret (not $tlsSecret.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: tls
  annotations:
    "erlmcp.io/secret-type": "tls"
type: kubernetes.io/tls
data:
  {{- /* Note: Replace with actual certificates */}}
  tls.crt: {{ $tlsSecret.cert | default "LS0tLS1CRUdJTi..." }}
  tls.key: {{ $tlsSecret.key | default "LS0tLS1CRUdJTi..." }}
  ca.crt: {{ $tlsSecret.ca | default "LS0tLS1CRUdJTi..." }}
{{- end }}
{{- end }}
---
{{- /* Docker registry secret */}}
{{- if .Values.image.imagePullSecrets }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-registry
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: registry
  annotations:
    "erlmcp.io/secret-type": "docker-registry"
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ template "imagePullSecret" . }}
{{- end }}
---
{{- /* OAuth/OIDC secrets */}}
{{- if .Values.security.secrets.oauth.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-oauth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: oauth
  annotations:
    "erlmcp.io/secret-type": "oauth"
type: Opaque
data:
  client-id: {{ .Values.security.secrets.oauth.clientId | b64enc }}
  client-secret: {{ .Values.security.secrets.oauth.clientSecret | b64enc }}
  {{- if .Values.security.secrets.oauth.issuerUrl }}
  issuer-url: {{ .Values.security.secrets.oauth.issuerUrl | b64enc }}
  {{- end }}
{{- end }}
---
{{- /* Database connection secret */}}
{{- if and .Values.app.database.enabled .Values.app.database.existingSecret }}
{{- /* Use existing secret, just reference it */}}
{{- else if .Values.app.database.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-database
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: database
  annotations:
    "erlmcp.io/secret-type": "database"
type: Opaque
stringData:
  database: {{ .Values.app.database.type | default "postgresql" }}
  host: {{ .Values.app.database.host | default "erlmcp-postgresql" }}
  port: "{{ .Values.app.database.port | default 5432 }}"
  user: {{ .Values.app.database.user | default "erlmcp" }}
  password: {{ .Values.app.database.password | default (randAlphaNum 32) }}
  dbname: {{ .Values.app.database.name | default "erlmcp" }}
  sslmode: {{ .Values.app.database.sslMode | default "require" }}
data: {}
{{- end }}
---
{{- /* Redis connection secret */}}
{{- if and .Values.app.cache.enabled .Values.app.cache.redis.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-redis
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: redis
  annotations:
    "erlmcp.io/secret-type": "redis"
type: Opaque
stringData:
  host: {{ .Values.app.cache.redis.host | default "erlmcp-redis-master" }}
  port: "{{ .Values.app.cache.redis.port | default 6379 }}"
  password: {{ .Values.app.cache.redis.password | default (randAlphaNum 32) }}
  database: "{{ .Values.app.cache.redis.database | default 0 }}"
data: {}
{{- end }}
---
{{- /* Monitoring/Alertmanager secrets */}}
{{- if .Values.monitoring.prometheus.alertmanager.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-alertmanager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: alertmanager
  annotations:
    "erlmcp.io/secret-type": "alertmanager"
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'default'
      routes:
        - match:
            severity: critical
          receiver: 'critical'
        - match:
            severity: warning
          receiver: 'warning'
    receivers:
      - name: 'default'
        webhook_configs:
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhookUrl | default "http://localhost:5001/" }}
      - name: 'critical'
        webhook_configs:
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhookUrl | default "http://localhost:5001/" }}
      - name: 'warning'
        webhook_configs:
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhookUrl | default "http://localhost:5001/" }}
data: {}
{{- end }}
---
{{- /* Grafana credentials */}}
{{- if .Values.monitoring.grafana.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-grafana
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: grafana
  annotations:
    "erlmcp.io/secret-type": "grafana"
type: Opaque
stringData:
  admin-user: {{ .Values.monitoring.grafana.adminUser | default "admin" }}
  admin-password: {{ .Values.monitoring.grafana.adminPassword | default (randAlphaNum 16) }}
data: {}
{{- end }}
