{{/*
  ERLMCP Enterprise ConfigMap
  Application configuration for all environments
*/}}
{{- if .Values.storage.configMap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.storage.configMap.name | default "erlmcp-config" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: config
  annotations:
    "erlmcp.io/config": "application"
data:
  {{- /* Main configuration file */}}
  erlmcp.conf: |
    %% ERLMCP Configuration
    %% Generated by Helm Chart - {{ .Chart.Name }}-{{ .Chart.Version }}
    %% Environment: {{ .Values.global.cluster.environment }}
    %% Cluster: {{ .Values.global.cluster.name }}

    %% Cluster configuration
    {cluster, #{
        name => "{{ .Values.global.cluster.name }}",
        environment => "{{ .Values.global.cluster.environment }}",
        region => "{{ .Values.global.cluster.region }}",
        dns_suffix => "{{ .Values.global.cluster.dnsSuffix }}"
    }}.

    %% Session configuration
    {session, #{
        enabled => {{ .Values.app.sessions.enabled | default true }},
        backend => {{ .Values.app.sessions.backend | default "mnesia" }},
        sharding => #{
            enabled => {{ .Values.app.sessions.sharding.enabled | default true }},
            count => {{ .Values.app.sessions.sharding.count | default 16 }},
            strategy => {{ .Values.app.sessions.sharding.strategy | default "consistent_hash" }}
        },
        replication => #{
            enabled => {{ .Values.app.sessions.replication.enabled | default true }},
            nodes => {{ .Values.app.sessions.replication.nodes | default 3 }}
        },
        timeout => {{ .Values.app.sessions.timeout | default 3600 }},
        max_per_node => {{ .Values.app.sessions.maxPerNode | default 5000 }}
    }}.

    %% Transport configuration
    {transports, [
        {tcp, #{
            port => {{ .Values.service.ports.http.targetPort | default 8080 }},
            backlog => 1024,
            max_connections => 10000
        }},
        {http, #{
            port => {{ .Values.service.ports.http.targetPort | default 8080 }},
            max_connections => 5000
        }},
        {ws, #{
            port => 8082,
            max_connections => 5000
        }},
        {sse, #{
            port => 8083,
            max_connections => 5000
        }}
    ]}.

    %% Cache configuration
    {cache, #{
        enabled => {{ .Values.app.cache.enabled | default true }},
        type => {{ .Values.app.cache.type | default "redis" }},
        options => #{
            pool_size => 10,
            overflow => 5
        }
    }}.

    %% Observability configuration
    {observability, #{
        prometheus => #{
            enabled => {{ .Values.global.monitoring.prometheus.enabled | default true }},
            port => 9090,
            path => "/metrics"
        },
        opentelemetry => #{
            enabled => true,
            endpoint => "http://otel-collector:4317",
            compression => "gzip"
        },
        tracing => #{
            enabled => true,
            sampler => "always"
        }
    }}.

    %% Security configuration
    {security, #{
        rate_limiting => #{
            enabled => true,
            default_limit => 1000,
            window => 60
        },
        authentication => #{
            enabled => true,
            methods => ["jwt", "api_key"]
        },
        authorization => #{
            enabled => true,
            backend => "rbac"
        }
    }}.

  {{- /* Environment-specific overrides */}}
  {{- if eq .Values.global.cluster.environment "development" }}
  development.conf: |
    %% Development environment overrides
    {log, #{
        level => debug,
        format => text
    }}.
    {observability, #{
        prometheus => #{enabled => false}
    }}.
  {{- end }}

  {{- if eq .Values.global.cluster.environment "staging" }}
  staging.conf: |
    %% Staging environment overrides
    {log, #{
        level => info,
        format => json
    }}.
  {{- end }}

  {{- if eq .Values.global.cluster.environment "production" }}
  production.conf: |
    %% Production environment overrides
    {log, #{
        level => warning,
        format => json
    }}.
    {security, #{
        tls => #{enabled => true}
    }}.
  {{- end }}

  {{- /* Feature flags */}}
  feature-flags.yaml: |
    features:
      {{- with .Values.featureFlags }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
      multi_tenancy:
        enabled: {{ .Values.featureFlags.multiTenancy.enabled | default false }}
      sharding:
        enabled: {{ .Values.featureFlags.sharding.enabled | default true }}
      caching:
        enabled: {{ .Values.featureFlags.caching.enabled | default true }}
      monitoring:
        enabled: {{ .Values.featureFlags.monitoring.enabled | default true }}

{{- end }}
---
{{/*
  ERLMCP Enterprise ConfigMap for Monitoring
*/}}
{{- if .Values.monitoring.prometheus.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp-enterprise.fullname" . }}-monitoring
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp-enterprise.labels" . | nindent 4 }}
    component: monitoring
  annotations:
    "erlmcp.io/config": "monitoring"
data:
  prometheus-rules.yaml: |
    groups:
      - name: erlmcp
        interval: 30s
        rules:
          {{- /* Alert rules */}}
          - alert: ERLMCPHighCPU
            expr: rate(process_cpu_seconds_total{app="erlmcp"}[5m]) > 0.8
            for: 5m
            labels:
              severity: warning
              component: erlmcp
            annotations:
              summary: "High CPU usage detected"
              description: "ERLMCP pod has CPU usage above 80% for 5 minutes"

          - alert: ERLMCPHighMemory
            expr: process_resident_memory_bytes{app="erlmcp"} / 1024 / 1024 / 1024 > 3
            for: 5m
            labels:
              severity: critical
              component: erlmcp
            annotations:
              summary: "High memory usage detected"
              description: "ERLMCP pod has memory usage above 3GB for 5 minutes"

          - alert: ERLMCPDown
            expr: up{job="erlmcp"} == 0
            for: 2m
            labels:
              severity: critical
              component: erlmcp
            annotations:
              summary: "ERLMCP instance is down"
              description: "ERLMCP pod has been down for more than 2 minutes"

          - alert: ERLMCPSessionSaturation
            expr: erlmcp_sessions_active / erlmcp_sessions_max > 0.9
            for: 5m
            labels:
              severity: warning
              component: erlmcp
            annotations:
              summary: "Session capacity near saturation"
              description: "ERLMCP pod has more than 90% of sessions active"

  {{- /* Grafana dashboard */}}
  grafana-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "ERLMCP Enterprise",
        "tags": ["erlmcp", "enterprise"],
        "timezone": "browser",
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(erlmcp_requests_total[5m])",
                "legendFormat": "requests"
              }
            ]
          },
          {
            "id": 2,
            "title": "Error Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(erlmcp_errors_total[5m])",
                "legendFormat": "errors"
              }
            ]
          },
          {
            "id": 3,
            "title": "Active Sessions",
            "type": "graph",
            "targets": [
              {
                "expr": "erlmcp_sessions_active",
                "legendFormat": "Active Sessions"
              }
            ]
          },
          {
            "id": 4,
            "title": "Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "process_resident_memory_bytes{app=\"erlmcp\"}",
                "legendFormat": "memory"
              }
            ]
          },
          {
            "id": 5,
            "title": "CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(process_cpu_seconds_total{app=\"erlmcp\"}[5m])",
                "legendFormat": "cpu"
              }
            ]
          },
          {
            "id": 6,
            "title": "Response Time",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(erlmcp_request_duration_seconds_bucket[5m]))",
                "legendFormat": "p95"
              },
              {
                "expr": "histogram_quantile(0.99, rate(erlmcp_request_duration_seconds_bucket[5m]))",
                "legendFormat": "p99"
              }
            ]
          }
        ]
      }
    }
{{- end }}
