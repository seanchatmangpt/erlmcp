---
# Main Service for erlmcp
# ClusterIP service for internal communication
apiVersion: v1
kind: Service
metadata:
  name: erlmcp
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  type: ClusterIP
  selector:
    app: erlmcp
    component: server
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600

---
# Headless Service for Erlang clustering
# Allows direct pod-to-pod communication for distributed Erlang
apiVersion: v1
kind: Service
metadata:
  name: erlmcp-headless
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app: erlmcp
    component: server
  ports:
    - name: epmd
      port: 4369
      targetPort: 4369
      protocol: TCP
    - name: dist-erlang
      port: 9100
      targetPort: 9100
      protocol: TCP
  publishNotReadyAddresses: true

---
# LoadBalancer Service for external access
# Use this for exposing erlmcp outside the cluster
# Alternatively, use Ingress for better routing and TLS termination
apiVersion: v1
kind: Service
metadata:
  name: erlmcp-lb
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
  annotations:
    # AWS ELB annotations
    service.beta.kubernetes.io/aws-load-balancer-type: "external"
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    # Google Cloud Load Balancer annotations
    cloud.google.com/load-balancer-type: "External"
spec:
  type: LoadBalancer
  selector:
    app: erlmcp
    component: server
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
      nodePort: 30080
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
      nodePort: 30090
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600

---
# NodePort Service for development/testing
# Exposes service on a specific port on each node
apiVersion: v1
kind: Service
metadata:
  name: erlmcp-nodeport
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
spec:
  type: NodePort
  selector:
    app: erlmcp
    component: server
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
      nodePort: 30080
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
      nodePort: 30090

---
# ExternalName Service for external database access
# Maps Kubernetes service to external database (e.g., RDS)
apiVersion: v1
kind: Service
metadata:
  name: postgres-external
  namespace: erlmcp
  labels:
    app: postgres
spec:
  type: ExternalName
  externalName: postgres.example.com
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
