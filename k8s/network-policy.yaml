---
# =============================================================================
# Zero-Trust Network Policies for erlmcp
# =============================================================================
# Security Principle: Never trust, always verify
# Default Deny: All traffic is denied unless explicitly allowed
# Least Privilege: Each service can only communicate with what it explicitly needs
# Micro-segmentation: Namespace and service-level isolation
# =============================================================================
# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2024 erlmcp
# =============================================================================

# =============================================================================
# BASE POLICY: Default Deny All (Zero-Trust Foundation)
# =============================================================================
# This policy establishes the zero-trust baseline by denying all traffic
# between pods in the erlmcp namespace. All subsequent policies are
# explicit exceptions to this default deny.
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: erlmcp-deny-all-ingress
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
    policy-type: base-deny
    network-policy: "zero-trust"
  annotations:
    description: "Default deny all ingress traffic - zero-trust foundation"
    compliance: "CIS-controlled"
    security-level: "critical"
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: erlmcp-deny-all-egress
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
    policy-type: base-deny
    network-policy: "zero-trust"
  annotations:
    description: "Default deny all egress traffic - zero-trust foundation"
    compliance: "CIS-controlled"
    security-level: "critical"
spec:
  podSelector: {}
  policyTypes:
    - Egress

# =============================================================================
# POLICY 1: erlmcp Core Service Ingress
# =============================================================================
# Allows ingress to erlmcp core pods from:
# - Ingress controllers (for external traffic)
# - Istio/Linkerd service mesh (for mTLS)
# - Prometheus (for metrics scraping)
# - OpenTelemetry Collector (for traces)
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: erlmcp-ingress
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
    policy-type: ingress
  annotations:
    description: "Allow ingress to erlmcp from approved sources"
    allowed-from: "ingress,service-mesh,monitoring"
spec:
  podSelector:
    matchLabels:
      app: erlmcp
      component: server
  policyTypes:
    - Ingress
  ingress:
    # Allow from ingress controllers (external traffic)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: traefik
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: haproxy-ingress
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: gateway-api
      ports:
        - protocol: TCP
          port: 8080  # HTTP transport

    # Allow from ingress controllers (HTTPS traffic)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: traefik
      ports:
        - protocol: TCP
          port: 8443  # HTTPS transport

    # Allow from Istio service mesh (mTLS enforced)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
          podSelector:
            matchLabels:
              app: istio-ingressgateway
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443

    # Allow from Linkerd service mesh (mTLS enforced)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: linkerd
          podSelector:
            matchLabels:
              component: proxy
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443

    # Allow from Prometheus for metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: prometheus
          podSelector:
            matchLabels:
              app: prometheus
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-prometheus-stack
      ports:
        - protocol: TCP
          port: 9090  # Metrics endpoint

    # Allow from OpenTelemetry Collector
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
          podSelector:
            matchLabels:
              app: opentelemetry-collector
              component: collector
      ports:
        - protocol: TCP
          port: 9090  # Metrics for OTel

    # Allow from Grafana for dashboard queries
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: grafana
      ports:
        - protocol: TCP
          port: 9090

    # Allow inter-pod communication within erlmcp cluster
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: erlmcp
              component: server
      ports:
        - protocol: TCP
          port: 8080  # HTTP
        - protocol: TCP
          port: 8081  # HTTP admin
        - protocol: TCP
          port: 8082  # WebSocket
        - protocol: TCP
          port: 8083  # SSE
        - protocol: TCP
          port: 9090  # Metrics
        - protocol: TCP
          port: 4369  # EPMD
        - protocol: TCP
          port: 9100  # Distributed Erlang

# =============================================================================
# POLICY 2: erlmcp Core Service Egress
# =============================================================================
# Allows egress from erlmcp core pods to:
# - DNS (kube-system/CoreDNS)
# - Database (PostgreSQL)
# - Cache (Redis)
# - OpenTelemetry Collector
# - External HTTPS endpoints (scoped)
# - Inter-pod clustering (Erlang EPMD/Dist)
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: erlmcp-egress
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
    policy-type: egress
  annotations:
    description: "Allow egress from erlmcp to required services"
    allowed-to: "dns,database,cache,otel,external"
spec:
  podSelector:
    matchLabels:
      app: erlmcp
      component: server
  policyTypes:
    - Egress
  egress:
    # Allow DNS resolution (kube-system/CoreDNS)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: coredns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow DNS resolution (coredns namespace)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: coredns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow to PostgreSQL database
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: database
          podSelector:
            matchLabels:
              app: postgres
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: postgres
          podSelector:
            matchLabels:
              app: postgres
        - ipBlock:
            cidr: 10.0.0.0/8  # Internal PostgreSQL endpoints
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 5433  # PostgreSQL TLS

    # Allow to Redis cache
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: cache
          podSelector:
            matchLabels:
              app: redis
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: redis
          podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 6380  # Redis TLS

    # Allow to RabbitMQ message queue
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: messaging
          podSelector:
            matchLabels:
              app: rabbitmq
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: rabbitmq
      ports:
        - protocol: TCP
          port: 5672  # AMQP
        - protocol: TCP
          port: 15672  # Management UI

    # Allow to OpenTelemetry Collector
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
          podSelector:
            matchLabels:
              app: opentelemetry-collector
              component: collector
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: opentelemetry-collector
      ports:
        - protocol: TCP
          port: 4317  # OTLP gRPC
        - protocol: TCP
          port: 4318  # OTLP HTTP
        - protocol: TCP
          port: 8888  # Jaeger compatible

    # Allow to Jaeger for distributed tracing
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
          podSelector:
            matchLabels:
              app: jaeger
      ports:
        - protocol: TCP
          port: 6831  # Jaeger compact UDP
        - protocol: UDP
          port: 6831
        - protocol: TCP
          port: 6832  # Jaeger binary
        - protocol: TCP
          port: 14250  # Jaeger gRPC
        - protocol: TCP
          port: 14268  # Jaeger HTTP

    # Allow to Zipkin for distributed tracing
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
          podSelector:
            matchLabels:
              app: zipkin
      ports:
        - protocol: TCP
          port: 9411

    # Allow inter-pod clustering (EPMD + Distributed Erlang)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: erlmcp
              component: server
      ports:
        - protocol: TCP
          port: 4369  # EPMD
        - protocol: TCP
          port: 9100  # Distributed Erlang range start
        - protocol: TCP
          port: 9101
        - protocol: TCP
          port: 9102
        - protocol: TCP
          port: 9103
        - protocol: TCP
          port: 9104
        - protocol: TCP
          port: 9105

    # Allow to Istio sidecar/proxy
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
          podSelector:
            matchLabels:
              app: istio-proxy
      ports:
        - protocol: TCP
          port: 15001  # Envoy passthrough
        - protocol: TCP
          port: 15006  # Envoy passthrough
        - protocol: TCP
          port: 15021  # Health check

    # Allow to Linkerd proxy
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: linkerd
          podSelector:
            matchLabels:
              component: proxy
      ports:
        - protocol: TCP
          port: 4143  # Linkerd proxy
        - protocol: TCP
          port: 4191  # Linkerd admin

    # Allow external HTTPS (scoped to specific endpoints if possible)
    # WARNING: This allows all HTTPS egress. Restrict further for production.
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8     # RFC1918
              - 172.16.0.0/12  # RFC1918
              - 192.168.0.0/16 # RFC1918
              - 127.0.0.0/8    # Loopback
      ports:
        - protocol: TCP
          port: 443

    # Allow specific internal IPs for VPN/private endpoints
    # Add your private network ranges here
    - to:
        - ipBlock:
            cidr: 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8080

# =============================================================================
# POLICY 3: PostgreSQL Ingress (Database Isolation)
# =============================================================================
# Restricts PostgreSQL ingress to ONLY erlmcp pods
# No other services can connect to the database
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-ingress
  namespace: erlmcp
  labels:
    app: postgres
    component: database
    policy-type: ingress
  annotations:
    description: "Restrict PostgreSQL ingress to erlmcp pods only"
    allowed-from: "erlmcp-only"
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    # Allow from erlmcp pods only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: erlmcp
              component: server
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 5433

    # Allow from monitoring for backup/export jobs
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: pgbackrest
      ports:
        - protocol: TCP
          port: 5432

# =============================================================================
# POLICY 4: PostgreSQL Egress
# =============================================================================
# Allows PostgreSQL to reach DNS only
# Databases should not initiate external connections
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-egress
  namespace: erlmcp
  labels:
    app: postgres
    component: database
    policy-type: egress
  annotations:
    description: "Allow PostgreSQL egress to DNS only"
    allowed-to: "dns-only"
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

# =============================================================================
# POLICY 5: Redis Ingress (Cache Isolation)
# =============================================================================
# Restricts Redis ingress to ONLY erlmcp pods
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-ingress
  namespace: erlmcp
  labels:
    app: redis
    component: cache
    policy-type: ingress
  annotations:
    description: "Restrict Redis ingress to erlmcp pods only"
    allowed-from: "erlmcp-only"
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    # Allow from erlmcp pods only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: erlmcp
              component: server
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 6380

    # Allow from Redis Sentinel (if using HA)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: redis-sentinel
      ports:
        - protocol: TCP
          port: 26379

# =============================================================================
# POLICY 6: Redis Egress
# =============================================================================
# Allows Redis to reach DNS and other Redis nodes
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-egress
  namespace: erlmcp
  labels:
    app: redis
    component: cache
    policy-type: egress
  annotations:
    description: "Allow Redis egress to DNS and cluster"
    allowed-to: "dns,cluster"
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow Redis cluster communication
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 16379  # Cluster bus
        - protocol: TCP
          port: 26379  # Sentinel

# =============================================================================
# POLICY 7: RabbitMQ Ingress
# =============================================================================
# Restricts RabbitMQ ingress to erlmcp pods and management
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rabbitmq-ingress
  namespace: erlmcp
  labels:
    app: rabbitmq
    component: messaging
    policy-type: ingress
  annotations:
    description: "Restrict RabbitMQ ingress to erlmcp pods"
    allowed-from: "erlmcp,management"
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
    - Ingress
  ingress:
    # Allow from erlmcp pods for AMQP
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: erlmcp
              component: server
      ports:
        - protocol: TCP
          port: 5672  # AMQP
        - protocol: TCP
          port: 5671  # AMQP TLS

    # Allow from monitoring for management
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: rabbitmq-exporter
      ports:
        - protocol: TCP
          port: 15672  # Management UI
        - protocol: TCP
          port: 15692  # Metrics

    # Allow from RabbitMQ cluster nodes
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: rabbitmq
      ports:
        - protocol: TCP
          port: 25672  # Inter-node communication
        - protocol: TCP
          port: 5672
        - protocol: TCP
          port: 15672

# =============================================================================
# POLICY 8: RabbitMQ Egress
# =============================================================================
# Allows RabbitMQ to reach DNS and cluster nodes
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rabbitmq-egress
  namespace: erlmcp
  labels:
    app: rabbitmq
    component: messaging
    policy-type: egress
  annotations:
    description: "Allow RabbitMQ egress to DNS and cluster"
    allowed-to: "dns,cluster"
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow RabbitMQ cluster communication
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: rabbitmq
      ports:
        - protocol: TCP
          port: 25672  # Inter-node
        - protocol: TCP
          port: 5672
        - protocol: TCP
          port: 15672
        - protocol: TCP
          port: 15692

# =============================================================================
# POLICY 9: OpenTelemetry Collector Ingress
# =============================================================================
# Allows OTel to receive telemetry from all namespaces
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-ingress
  namespace: erlmcp
  labels:
    app: opentelemetry-collector
    component: observability
    policy-type: ingress
  annotations:
    description: "Allow OTel ingress from all services"
    allowed-from: "all-services"
spec:
  podSelector:
    matchLabels:
      app: opentelemetry-collector
  policyTypes:
    - Ingress
  ingress:
    # Allow from erlmcp pods
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: erlmcp
          podSelector:
            matchLabels:
              app: erlmcp
      ports:
        - protocol: TCP
          port: 4317  # OTLP gRPC
        - protocol: TCP
          port: 4318  # OTLP HTTP

    # Allow from Istio (for mesh telemetry)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
      ports:
        - protocol: TCP
          port: 4317
        - protocol: TCP
          port: 4318

# =============================================================================
# POLICY 10: OpenTelemetry Collector Egress
# =============================================================================
# Allows OTel to forward telemetry and reach external backends
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-egress
  namespace: erlmcp
  labels:
    app: opentelemetry-collector
    component: observability
    policy-type: egress
  annotations:
    description: "Allow OTel egress to backends and DNS"
    allowed-to: "dns,backends"
spec:
  podSelector:
    matchLabels:
      app: opentelemetry-collector
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow to Prometheus (for metrics forwarding)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090

    # Allow to Jaeger (for trace forwarding)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
          podSelector:
            matchLabels:
              app: jaeger
      ports:
        - protocol: TCP
          port: 14250  # Jaeger gRPC
        - protocol: TCP
          port: 14268  # Jaeger HTTP

    # Allow external telemetry backends (HTTPS only)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

    # Allow to specific OTLP endpoints (e.g., Honeycomb, Datadog)
    # Add your specific OTLP endpoint IPs here
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 4317  # OTLP gRPC
        - protocol: TCP
          port: 4318  # OTLP HTTP

# =============================================================================
# POLICY 11: Monitoring/Prometheus Ingress to Services
# =============================================================================
# This is applied in the monitoring namespace but referenced here
# for documentation purposes. Apply this in your monitoring namespace.
# -----------------------------------------------------------------------------
# Apply this policy in the monitoring namespace:
# ---
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: prometheus-scraper-egress
#   namespace: monitoring
# spec:
#   podSelector:
#     matchLabels:
#       app: prometheus
#   policyTypes:
#     - Egress
#   egress:
#     - to:
#         - namespaceSelector:
#             matchLabels:
#               kubernetes.io/metadata.name: erlmcp
#       ports:
#         - protocol: TCP
#           port: 9090

# =============================================================================
# POLICY 12: Service-to-Service Communication Matrix
# =============================================================================
# The following defines the explicit service communication matrix:
#
# FROM              | TO                | PORTS      | PURPOSE
# -----------------|-------------------|------------|---------------------------------
# erlmcp           | postgres          | 5432,5433  | Database access
# erlmcp           | redis             | 6379,6380  | Cache access
# erlmcp           | rabbitmq          | 5672,5671  | Message queue
# erlmcp           | otel-collector    | 4317,4318  | Telemetry export
# erlmcp           | DNS               | 53         | Name resolution
# erlmcp           | External HTTPS    | 443        | External API calls
# erlmcp           | erlmcp            | 4369,9100+ | Clustering (EPMD/Dist)
# ingress-nginx    | erlmcp            | 8080,8443  | External traffic
# istio-system     | erlmcp            | 8080,8443  | Service mesh (mTLS)
# prometheus       | erlmcp            | 9090       | Metrics scraping
# postgres         | DNS               | 53         | Name resolution
# redis            | DNS,Redis cluster | 53,26379   | DNS, cluster bus
# rabbitmq         | DNS,RabbitMQ clstr | 53,25672   | DNS, inter-node
# otel-collector   | prometheus,jaeger | 9090,14250 | Telemetry forwarding
# otel-collector   | DNS,External HTTPS | 53,443     | DNS, external backends
#
# Any communication not listed above is explicitly denied.
# =============================================================================

# =============================================================================
# VALIDATION SCRIPT
# =============================================================================
# Use the following script to validate network policy enforcement:
#
# kubectl run test-pod --image=nicolaka/netshoot --rm -it --restart=Never \
#   --namespace=erlmcp -- sh
#
# # From inside the pod, test connectivity:
# nc -zv postgres 5432    # Should succeed (erlmcp -> postgres)
# nc -zv redis 6379       # Should succeed (erlmcp -> redis)
# nc -zv google.com 443   # Should succeed (external HTTPS)
# nc -zv postgres 3306    # Should FAIL (wrong port)
# nc -zv 10.0.0.1 80      # Should FAIL (internal HTTP not allowed)
# =============================================================================
