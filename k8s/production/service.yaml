---
# ============================================================================
# ErlMCP v3.0.0 - Production Services
# ============================================================================
# Kubernetes Service definitions for ErlMCP production deployment
# Includes ClusterIP, headless, and optional LoadBalancer/NodePort services
# ============================================================================
# Usage:
#   kubectl apply -f k8s/production/service.yaml
# ============================================================================

---
# ============================================================================
# CLUSTERIP SERVICE - Internal cluster communication
# ============================================================================
# Primary service for internal cluster traffic
# Session affinity enabled for sticky sessions
# ----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: erlmcp
  namespace: erlmcp-production
  labels:
    app: erlmcp
    environment: production
    component: server
  annotations:
    description: "ErlMCP internal service for cluster communication"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  # Session affinity for maintaining client connections
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
  selector:
    app: erlmcp
    environment: production
    component: server
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
    - name: https
      port: 8443
      targetPort: https
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
    - name: health
      port: 9091
      targetPort: health
      protocol: TCP

---
# ============================================================================
# HEADLESS SERVICE - Erlang cluster discovery
# ============================================================================
# Headless service for distributed Erlang node discovery
# Required for EPMD-less clustering
# publishNotReadyAddresses ensures pods can communicate during startup
# ----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: erlmcp-headless
  namespace: erlmcp-production
  labels:
    app: erlmcp
    environment: production
    component: headless
  annotations:
    description: "Headless service for Erlang cluster discovery (EPMD-less)"
spec:
  type: ClusterIP
  clusterIP: None
  # Allow communication with pods not yet ready
  publishNotReadyAddresses: true
  selector:
    app: erlmcp
    environment: production
    component: server
  ports:
    - name: distribution
      port: 9100
      targetPort: distribution
      protocol: TCP
    - name: epmd
      port: 4369
      targetPort: 4369
      protocol: TCP

---
# ============================================================================
# LOADBALANCER SERVICE - External access (optional)
# ============================================================================
# LoadBalancer service for direct external access
# Typically used instead of Ingress for simple deployments
# Cloud provider annotations for AWS, GCP, Azure
# ----------------------------------------------------------------------------
# Uncomment if using LoadBalancer instead of Ingress
# ----------------------------------------------------------------------------
#apiVersion: v1
#kind: Service
#metadata:
#  name: erlmcp-lb
#  namespace: erlmcp-production
#  labels:
#    app: erlmcp
#    environment: production
#    component: loadbalancer
#  annotations:
#    # AWS ELB annotations
#    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
#    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
#    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:region:account:certificate/id"
#    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
#    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
#    # AWS NLB annotations
#    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
#    # GCP Load Balancer annotations
#    cloud.google.com/load-balancer-type: "External"
#    cloud.google.com/neg: '{"ingress": true}'
#    # Azure Load Balancer annotations
#    service.beta.kubernetes.io/azure-load-balancer-internal: "false"
#spec:
#  type: LoadBalancer
#  # LoadBalancer IP (optional - for static IP)
#  # loadBalancerIP: 192.168.1.100
#  # External traffic policy
#  externalTrafficPolicy: Local
#  selector:
#    app: erlmcp
#    environment: production
#    component: server
#  ports:
#    - name: http
#      port: 80
#      targetPort: http
#      protocol: TCP
#    - name: https
#      port: 443
#      targetPort: https
#      protocol: TCP
#  sessionAffinity: ClientIP
#  sessionAffinityConfig:
#    clientIP:
#      timeoutSeconds: 3600

---
# ============================================================================
# NODEPORT SERVICE - Development/testing access (optional)
# ============================================================================
# NodePort service for direct node access
# Useful for debugging and development
# ----------------------------------------------------------------------------
# Uncomment for development/testing only
# ----------------------------------------------------------------------------
#apiVersion: v1
#kind: Service
#metadata:
#  name: erlmcp-nodeport
#  namespace: erlmcp-production
#  labels:
#    app: erlmcp
#    environment: production
#    component: nodeport
#spec:
#  type: NodePort
#  selector:
#    app: erlmcp
#    environment: production
#    component: server
#  ports:
#    - name: http
#      port: 8080
#      targetPort: http
#      protocol: TCP
#      nodePort: 30080
#    - name: https
#      port: 8443
#      targetPort: https
#      protocol: TCP
#      nodePort: 30443

---
# ============================================================================
# EXTERNALNAME SERVICE - External database/service references
# ============================================================================
# ExternalName service for referencing external databases
# Maps Kubernetes service to external service (e.g., RDS, ElastiCache)
# ----------------------------------------------------------------------------
# Uncomment and configure if using external managed services
# ----------------------------------------------------------------------------
#apiVersion: v1
#kind: Service
#metadata:
#  name: postgres-external
#  namespace: erlmcp-production
#  labels:
#    app: erlmcp
#    component: external-database
#spec:
#  type: ExternalName
#  externalName: postgres.production.example.com
#  ports:
#    - port: 5432
#      targetPort: 5432
#      protocol: TCP
#
#---
#apiVersion: v1
#kind: Service
#metadata:
#  name: redis-external
#  namespace: erlmcp-production
#  labels:
#    app: erlmcp
#    component: external-cache
#spec:
#  type: ExternalName
#  externalName: redis.production.example.com
#  ports:
#    - port: 6379
#      targetPort: 6379
#      protocol: TCP

---
# ============================================================================
# ENDPOINTS - For static IP external services (optional)
# ============================================================================
# Manual endpoints for ExternalName services when DNS resolution is not enough
# ----------------------------------------------------------------------------
#kind: Endpoints
#apiVersion: v1
#metadata:
#  name: postgres-external
#  namespace: erlmcp-production
#subsets:
#  - addresses:
#      - ip: 10.0.0.10
#    ports:
#      - port: 5432
#        protocol: TCP
#        name: postgres
