---
# ============================================================================
# ErlMCP v3.0.0 - Production ServiceAccount and RBAC
# ============================================================================
# ServiceAccount and RBAC configuration for ErlMCP production deployment
# ============================================================================
# Usage:
#   kubectl apply -f k8s/production/serviceaccount.yaml
# ============================================================================

---
# ============================================================================
# SERVICE ACCOUNT
# ============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: erlmcp
  namespace: erlmcp-production
  labels:
    app: erlmcp
    environment: production
  annotations:
    description: "ErlMCP service account for pod identity"

---
# ============================================================================
# ROLE - Pod and ConfigMap access
# ============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: erlmcp
  namespace: erlmcp-production
  labels:
    app: erlmcp
    environment: production
rules:
  # ConfigMap access for configuration hot-reload
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Pod access for distributed Erlang node discovery
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Secret access for TLS certificates
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
    resourceNames: ["erlmcp-tls", "erlmcp-secrets"]

  # Endpoints access for service discovery
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

---
# ============================================================================
# ROLE BINDING
# ============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: erlmcp
  namespace: erlmcp-production
  labels:
    app: erlmcp
    environment: production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: erlmcp
subjects:
  - kind: ServiceAccount
    name: erlmcp
    namespace: erlmcp-production

---
# ============================================================================
# CLUSTER ROLE - For cluster-wide resources (limited)
# ============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: erlmcp
  labels:
    app: erlmcp
rules:
  # Nodes access for distributed Erlang clustering
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]

---
# ============================================================================
# CLUSTER ROLE BINDING
# ============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: erlmcp-production
  labels:
    app: erlmcp
    environment: production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: erlmcp
subjects:
  - kind: ServiceAccount
    name: erlmcp
    namespace: erlmcp-production

---
# ============================================================================
# PRIORITY CLASS - Critical production workload
# ============================================================================
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
  labels:
    app: erlmcp
    environment: production
  annotations:
    description: "High priority class for ErlMCP production workloads"
value: 1000
globalDefault: false
preemptionPolicy: PreemptLowerPriority
