---
# ==============================================================================
# ErlMCP Hot-Reload Sidecar Configuration
# ==============================================================================
# This manifest adds a sidecar container to watch for ConfigMap changes
# and trigger hot-reload without restarting pods.
#
# Usage:
#   kubectl apply -f k8s/configmap-hotreload-deployment.yaml
#
# ==============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: erlmcp-cluster
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
    version: "3.0.0"
spec:
  serviceName: erlmcp-headless
  replicas: 3
  selector:
    matchLabels:
      app: erlmcp
      component: server
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0

  template:
    metadata:
      labels:
        app: erlmcp
        component: server
        version: "3.0.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"

    spec:
      serviceAccountName: erlmcp
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        supplementalGroups: [1000]

      terminationGracePeriodSeconds: 60

      # Share process namespace for signaling
      shareProcessNamespace: true

      initContainers:
        - name: wait-for-postgres
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              until nc -z postgres 5432; do
                echo "Waiting for postgres..."
                sleep 2
              done
              echo "postgres is ready"

        - name: setup-configmap-watcher
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              # Create version marker file
              echo "initial" > /opt/erlmcp/etc/.configmap_version
              chmod 644 /opt/erlmcp/etc/.configmap_version
              echo "ConfigMap watcher initialized"

      containers:
        # ========================================================================
        # Main ErlMCP Container
        # ========================================================================
        - name: erlmcp
          image: erlmcp:3.0.0
          imagePullPolicy: IfNotPresent

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: admin
              containerPort: 8081
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP
            - name: epmd
              containerPort: 4369
              protocol: TCP
            - name: dist-erlang
              containerPort: 9100
              protocol: TCP

          env:
            # Pod information
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

            # Environment
            - name: ERLMCP_ENV
              valueFrom:
                configMapKeyRef:
                  name: erlmcp-config-prod
                  key: ERLMCP_ENV
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: erlmcp-config-prod
                  key: LOG_LEVEL

            # Node information
            - name: ERLMCP_NODE_NAME
              value: "erlmcp-$(POD_NAME).erlmcp-headless.erlmcp.svc.cluster.local"
            - name: ERLANG_COOKIE
              valueFrom:
                secretKeyRef:
                  name: erlmcp-secrets
                  key: erlang-cookie
                  optional: true

            # Database Configuration
            - name: ERLMCP_DB_HOST
              value: "postgres"
            - name: ERLMCP_DB_PORT
              value: "5432"
            - name: ERLMCP_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: erlmcp-secrets
                  key: db-name
            - name: ERLMCP_DB_USER
              valueFrom:
                secretKeyRef:
                  name: erlmcp-secrets
                  key: db-user
            - name: ERLMCP_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: erlmcp-secrets
                  key: db-password

            # OpenTelemetry
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://otel-collector:4317"
            - name: OTEL_SERVICE_NAME
              value: "erlmcp"

            # Feature Flags
            - name: FEATURE_FLAGS_PATH
              value: "/opt/erlmcp/etc/feature-flags.json"

            # Config Reload
            - name: ERLMCP_CONFIG_RELOAD_ENABLED
              value: "true"

          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi

          livenessProbe:
            exec:
              command:
                - /opt/erlmcp/bin/erlmcp
                - ping
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          startupProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 30

          volumeMounts:
            - name: erlmcp-data
              mountPath: /var/lib/erlmcp
            - name: erlmcp-logs
              mountPath: /var/log/erlmcp
            - name: erlmcp-tmp
              mountPath: /tmp
            - name: erlmcp-certs
              mountPath: /etc/erlmcp/certs
              readOnly: true
            - name: erlmcp-config
              mountPath: /opt/erlmcp/etc
              readOnly: true

        # ========================================================================
        # ConfigMap Hot-Reload Sidecar
        # ========================================================================
        - name: config-reloader
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent

          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

          command:
            - /bin/sh
            - -c
            - |
              # Copy script to writable location
              cp /scripts/config-reloader.sh /tmp/config-reloader.sh
              chmod +x /tmp/config-reloader.sh
              exec /tmp/config-reloader.sh

          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: CONFIGMAP_NAME
              value: "erlmcp-config"
            - name: WATCH_INTERVAL
              value: "5"
            - name: ERLMCP_ADMIN_PORT
              value: "8081"
            - name: LOG_LEVEL
              value: "info"

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi

          volumeMounts:
            - name: config-reloader-script
              mountPath: /scripts
              readOnly: true
            - name: tmp
              mountPath: /tmp

      volumes:
        - name: erlmcp-logs
          emptyDir: {}
        - name: erlmcp-tmp
          emptyDir: {}
        - name: tmp
          emptyDir: {}
        - name: erlmcp-certs
          secret:
            secretName: erlmcp-tls
        - name: erlmcp-config
          configMap:
            name: erlmcp-config
        - name: config-reloader-script
          configMap:
            name: erlmcp-config-reloader
            defaultMode: 0755
            items:
              - key: config-reloader.sh
                path: config-reloader.sh
                mode: 0755

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - erlmcp
                topologyKey: kubernetes.io/hostname
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/os
                    operator: In
                    values:
                      - linux

      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: erlmcp

  volumeClaimTemplates:
    - metadata:
        name: erlmcp-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
        storageClassName: standard

---
# ==============================================================================
# ConfigMap Watcher CronJob for Cluster-Wide Updates
# ==============================================================================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: erlmcp-configmap-watcher
  namespace: erlmcp
  labels:
    app: erlmcp
    component: config-watcher
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: erlmcp-config-watcher
          restartPolicy: OnFailure

          containers:
            - name: watcher
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  #!/bin/sh
                  set -e

                  CONFIGMAP_NAME="erlmcp-config"
                  NAMESPACE="erlmcp"
                  ADMIN_PORT=8081

                  echo "Checking ConfigMap for changes..."

                  # Get current version
                  VERSION=$(kubectl get configmap "${CONFIGMAP_NAME}" -n "${NAMESPACE}" \
                    -o jsonpath='{.metadata.resourceVersion}')

                  echo "Current version: ${VERSION}"

                  # Get all pods
                  PODS=$(kubectl get pods -n "${NAMESPACE}" -l app=erlmcp \
                    -o jsonpath='{.items[*].metadata.name}')

                  for pod in ${PODS}; do
                    echo "Triggering reload on ${pod}..."

                    # Try HTTP reload first
                    kubectl exec -n "${NAMESPACE}" "${pod}" -- curl -sf \
                      -X POST "http://localhost:${ADMIN_PORT}/admin/reload-config" \
                      || echo "HTTP reload failed on ${pod}"

                    sleep 1
                  done

                  echo "ConfigMap watcher completed"

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi

---
# ==============================================================================
# Service Account for ConfigMap Watcher
# ==============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: erlmcp-config-watcher
  namespace: erlmcp
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: erlmcp-config-watcher
  namespace: erlmcp
rules:
  - apiGroups: [""]
    resources: ["configmaps", "pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: erlmcp-config-watcher
  namespace: erlmcp
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: erlmcp-config-watcher
subjects:
  - kind: ServiceAccount
    name: erlmcp-config-watcher
    namespace: erlmcp
