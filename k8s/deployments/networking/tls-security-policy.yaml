---
# TLS Security Policy for erlmcp
# Implements TLS version and cipher suite requirements
# Enforces FIPS 140-2 compliant configurations

apiVersion: policy/v1
kind: PodSecurityPolicy
metadata:
  name: erlmcp-tls-psp
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
    policy-type: tls
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'secret'
    - 'emptyDir'
    - 'persistentVolumeClaim'
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    rule: MustRunAsNonRoot
  seLinux:
    rule: RunAsAny
  fsGroup:
    rule: MustRunAs
    ranges:
      - min: 1000
        max: 65535
  supplementalGroups:
    rule: MustRunAs
    ranges:
      - min: 1000
        max: 65535
  readOnlyRootFilesystem: true

---
# TLS Security Profile - Kubernetes v1.24+
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-security-profile
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
data:
  # TLS 1.3 is the minimum required version
  tls-version: "1.3"
  # FIPS 140-2 compliant cipher suites
  tls-ciphers: |
    TLS_AES_128_GCM_SHA256
    TLS_AES_256_GCM_SHA384
    TLS_CHACHA20_POLY1305_SHA256
  # ECDHE curves for key exchange
  tls-curves: |
    X25519
    prime256v1
    secp384r1
  # Signature algorithms
  tls-signature-algorithms: |
    ecdsa_secp256r1_sha256
    ecdsa_secp384r1_sha384
    ed25519
    rsa_pss_rsae_sha256
  # DH parameters size (minimum)
  dh-min-size: "2048"
  # Certificate validation settings
  cert-validation: |
    verify_peer = strict
    verify_hostname = enabled
    crl_check = enabled
    ocsp_check = enabled

---
# mTLS Policy for Service Mesh
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: erlmcp-mtls-strict
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
spec:
  selector:
    matchLabels:
      app: erlmcp
  mtls:
    mode: STRICT  # Enforce mTLS for all service-to-service communication

---
# mTLS Policy for Observability Services
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: erlmcp-observability-mtls-permissive
  namespace: erlmcp
  labels:
    app: erlmcp-observability
    component: security
spec:
  selector:
    matchLabels:
      app: erlmcp-observability
  mtls:
    mode: PERMISSIVE  # Allow legacy traffic during migration

---
# TLS Origination Configuration for External Services
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: erlmcp-tls-origination
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
spec:
  host: "*.erlmcp.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL  # Use mTLS for cluster internal traffic
      cipherSuites:
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
      minProtocolVersion: TLSV1_3
      maxProtocolVersion: TLSV1_3
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
        keepAlive:
          time: 300s
          interval: 60s
          probes: 3

---
# TLS Configuration for External API Calls
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-apis-tls
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
spec:
  hosts:
    - "api.external.com"
  ports:
    - number: 443
      name: https
      protocol: HTTPS
  location: MESH_EXTERNAL
  resolution: DNS
  subjectAltNames:
    - "api.external.com"
  tls:
    mode: SIMPLE  # One-way TLS for external APIs
    sni: api.external.com

---
# Authorization Policy for mTLS-only Access
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: erlmcp-mtls-only
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
spec:
  selector:
    matchLabels:
      app: erlmcp
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/erlmcp/sa/erlmcp"
              - "cluster.local/ns/erlmcp-observability/sa/observability"
              - "cluster.local/ns/istio-system/sa/istio-ingressgateway"
    to:
        - operation:
            notHosts:
              - "*/health"
              - "*/metrics"
  # Deny all other traffic (whitelist approach)

---
# Certificate Rotation Policy
apiVersion: v1
kind: ConfigMap
metadata:
  name: certificate-rotation-policy
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
data:
  # Certificate rotation schedule
  rotation-schedule: "0 2 * * *"  # Daily at 2 AM
  rotation-before-expiry: "720h"  # 30 days before expiry
  renewal-check-interval: "1h"
  # Notification settings
  notify-before-expiry: "744h"  # 30 days
  notify-email: "security@erlmcp.io"
  # Grace period for rotation
  rotation-grace-period: "168h"  # 7 days
  # Backup configuration
  backup-old-certs: "true"
  backup-retention: "2160h"  # 90 days

---
# Security Context Constraints for TLS
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-security-context
  namespace: erlmcp
  labels:
    app: erlmcp
    component: security
data:
  security-context.yaml: |
    # Pod security context for TLS workloads
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      seccompProfile:
        type: RuntimeDefault
    # Container security context
    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault
