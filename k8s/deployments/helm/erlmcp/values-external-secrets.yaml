# External Secrets Operator Configuration for erlmcp v3
# This file contains configuration for External Secrets Operator integration
# Usage: helm install erlmcp ./erlmcp -f values-external-secrets.yaml

# Enable External Secrets Operator
externalSecrets:
  enabled: true

  # Define secrets to sync from external providers
  secrets:
    # JWT secret from Vault
    - name: erlmcp-jwt
      key: jwt
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      targetType: jwt
      refreshInterval: 1h
      creationPolicy: Owner
      deletionPolicy: Retain
      rotationPolicy: automatic
      data:
        - secretKey: jwt-secret
          remoteRef:
            key: erlmcp/config/jwt
            property: secret
        - secretKey: jwt-algorithm
          remoteRef:
            key: erlmcp/config/jwt
            property: algorithm
        - secretKey: jwt-issuer
          remoteRef:
            key: erlmcp/config/jwt
            property: issuer

    # Session secret from Vault
    - name: erlmcp-session
      key: session
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 1h
      creationPolicy: Owner
      data:
        - secretKey: session-secret
          remoteRef:
            key: erlmcp/config/session
            property: secret

    # Database credentials from Vault
    - name: erlmcp-database
      key: database
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 24h
      creationPolicy: Owner
      data:
        - secretKey: database-host
          remoteRef:
            key: erlmcp/database
            property: host
        - secretKey: database-port
          remoteRef:
            key: erlmcp/database
            property: port
        - secretKey: database-user
          remoteRef:
            key: erlmcp/database
            property: user
        - secretKey: database-password
          remoteRef:
            key: erlmcp/database
            property: password
        - secretKey: database-name
          remoteRef:
            key: erlmcp/database
            property: name

    # TLS certificates from Vault
    - name: erlmcp-tls
      key: tls
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      type: kubernetes.io/tls
      refreshInterval: 168h  # 7 days
      creationPolicy: Owner
      data:
        - secretKey: tls.crt
          remoteRef:
            key: erlmcp/tls/server
            property: certificate
        - secretKey: tls.key
          remoteRef:
            key: erlmcp/tls/server
            property: private_key
        - secretKey: ca.crt
          remoteRef:
            key: erlmcp/tls/ca
            property: certificate

    # OAuth2 credentials from Vault
    - name: erlmcp-oauth
      key: oauth
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 1h
      data:
        - secretKey: client-id
          remoteRef:
            key: erlmcp/auth/oauth2
            property: client_id
        - secretKey: client-secret
          remoteRef:
            key: erlmcp/auth/oauth2
            property: client_secret

    # API keys from Vault
    - name: erlmcp-api-keys
      key: api-keys
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 24h
      dataFrom:
        extract:
          - key: erlmcp/auth/api-keys

    # Encryption key from Vault
    - name: erlmcp-encryption
      key: encryption
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 720h  # 30 days
      creationPolicy: Owner
      rotationPolicy: automatic
      data:
        - secretKey: encryption-key
          remoteRef:
            key: erlmcp/config/encryption
            property: key

    # Redis credentials from Vault
    - name: erlmcp-redis
      key: redis
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 24h
      data:
        - secretKey: redis-host
          remoteRef:
            key: erlmcp/redis
            property: host
        - secretKey: redis-port
          remoteRef:
            key: erlmcp/redis
            property: port
        - secretKey: redis-password
          remoteRef:
            key: erlmcp/redis
            property: password

    # Observability/API keys from Vault
    - name: erlmcp-observability
      key: observability
      secretStore: erlmcp-vault-store
      secretStoreKind: SecretStore
      refreshInterval: 24h
      data:
        - secretKey: external-api-key
          remoteRef:
            key: erlmcp/auth/api-keys
            property: external_api
        - secretKey: monitoring-api-key
          remoteRef:
            key: erlmcp/auth/api-keys
            property: monitoring_api

  # Cluster-wide secrets for multi-cluster deployments
  clusterSecrets:
    enabled: false
    secrets:
      - name: erlmcp-cluster-tls
        key: tls
        secretStore: erlmcp-cluster-vault-store
        targetType: tls
        namespaceSelectors:
          kubernetes.io/metadata.name: erlmcp-*
        data:
          - secretKey: tls.crt
            remoteRef:
              key: erlmcp/tls/ca
              property: certificate

  # SecretStore definitions
  secretStore:
    # Vault SecretStore
    vault:
      enabled: true
      name: erlmcp-vault-store
      address: https://vault.vault.svc.cluster.local:8200
      path: secret
      version: v2
      authMountPath: kubernetes
      role: erlmcp
      secretRef: erlmcp-vault-auth

    # AWS Secrets Manager SecretStore
    aws:
      enabled: false
      name: erlmcp-aws-store
      service: SecretsManager
      region: us-east-1
      serviceAccount: erlmcp

    # Azure Key Vault SecretStore
    azure:
      enabled: false
      name: erlmcp-azure-store
      tenantId: ""
      vaultUrl: ""
      identityId: ""

    # GCP Secret Manager SecretStore
    gcp:
      enabled: false
      name: erlmcp-gcp-store
      project: ""
      clusterLocation: ""
      clusterName: ""
      serviceAccount: erlmcp

  # ClusterSecretStore for multi-cluster
  clusterStore:
    vault:
      enabled: false
      name: erlmcp-cluster-vault-store
      address: ""
      path: secret
      version: v2
      authMountPath: kubernetes
      role: erlmcp-cluster
      secretRef: erlmcp-vault-auth
      namespace: erlmcp-system

# Secret Rotation Configuration
secretRotation:
  enabled: true

  # Individual rotation policies
  policies:
    - name: erlmcp-jwt-rotation
      key: jwt
      secretName: erlmcp-jwt
      schedule: "0 0 1 * *"  # Monthly on 1st day
      strategy:
        type: automatic
        generateNew: true
        length: 32
        policy: alphabetic
        characters:
          upper: true
          lower: true
          numeric: true
          special: true
      postRotation:
        restartPods:
          deployment: erlmcp
          strategy: RollingUpdate
          maxUnavailable: 1
      compliance:
        retentionPeriod: 90d
        auditLogging: true
        encryptionAtRest: true

    - name: erlmcp-database-rotation
      key: database
      secretName: erlmcp-database
      schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
      strategy:
        type: vault
        vaultPath: database/rotate/erlmcp-app
        renew: true
        ttl: 168h
      postRotation:
        actions:
          - type: rollout-restart
            target: deployment/erlmcp

    - name: erlmcp-tls-rotation
      key: tls
      secretName: erlmcp-tls
      schedule: "0 3 1 * *"  # Monthly on 1st day at 3 AM
      strategy:
        type: vault
        vaultPath: pki/issue/erlmcp-server
        renew: true
        ttl: 720h

  # Rotation tracking
  tracking:
    enabled: true
    secrets:
      - name: erlmcp-jwt-tracked
        secretName: erlmcp-jwt
        key: jwt
        historyLimit: 12
        retention: 90d
        trackHistory: true
        storeInVault: true
        vaultPath: audit/secret-rotations

  # Certificate rotation
  certificates:
    enabled: true
    certs:
      - name: erlmcp-server-cert
        secretName: erlmcp-tls
        key: tls
        schedule: "0 3 */30 * *"  # Every 30 days
        commonName: "erlmcp.erlmcp.svc.cluster.local"
        dnsNames:
          - "erlmcp.erlmcp.svc.cluster.local"
          - "erlmcp-*.erlmcp.svc.cluster.local"
          - "erlmcp.io"
          - "*.erlmcp.io"
        ipAddresses: []
        validity: 90d
        keySize: 4096
        keyAlgorithm: RSA
        renewBefore: 720h
        autoRenew: true
        authority:
          type: vault
          vaultPath: pki
          role: erlmcp-server

  # Rollback configuration
  rollback:
    enabled: true
    maxRollbacks: 3
    rollbackWindow: 24h
    validationTimeout: 5m
    notifyEnabled: true
    notificationChannel: slack

# Update the existing security configuration to use External Secrets
security:
  secrets:
    # When externalSecrets is enabled, native secrets are not created
    # All secret values should be stored in Vault and referenced via ExternalSecret

    # Vault configuration for ExternalSecret reference
    vault:
      enabled: true
      address: https://vault.vault.svc.cluster.local:8200
      auth:
        method: kubernetes
        role: erlmcp
        path: kubernetes
        token: ""  # NOT used with Kubernetes auth
      secrets:
        - path: erlmcp/config/jwt
          name: erlmcp-jwt
        - path: erlmcp/config/session
          name: erlmcp-session
        - path: erlmcp/config/encryption
          name: erlmcp-encryption
        - path: erlmcp/tls
          name: erlmcp-tls
        - path: erlmcp/auth
          name: erlmcp-auth

    # JWT secret (reference only, actual value in Vault)
    jwt:
      enabled: true
      secret: ""  # From Vault: erlmcp/config/jwt
      algorithm: HS256
      issuer: erlmcp
      audience: erlmcp-users
      expiration: 3600

    # Database credentials (reference only)
    database:
      enabled: true
      host: ""  # From Vault: erlmcp/database
      port: 5432
      name: erlmcp
      user: erlmcp-app
      password: ""  # From Vault database/creds
      ssl: true

    # OAuth2 credentials (reference only)
    oauth:
      enabled: false
      provider: ""
      clientId: ""  # From Vault: erlmcp/auth/oauth2
      clientSecret: ""  # From Vault
      redirectUri: ""

# Storage configuration updates for External Secrets
storage:
  tls:
    enabled: true
    secretName: erlmcp-tls  # Managed by ExternalSecret
    cert: ""  # From Vault
    key: ""  # From Vault
    ca: ""  # From Vault

  auth:
    enabled: true
    secretName: erlmcp-auth  # Managed by ExternalSecret
    username: erlmcp
    password: ""  # From Vault
    token: ""  # From Vault
