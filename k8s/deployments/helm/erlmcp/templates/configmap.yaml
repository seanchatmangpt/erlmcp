{{/*
  erlmcp ConfigMap
  Centralized configuration management for erlmcp
*/}}

{{- if .Values.storage.config.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.configMapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: config
  annotations:
    "erlmcp.io/config": "enabled"
    "erlmcp.io/version": {{ .Chart.AppVersion | quote }}
    "erlmcp.io/environment": {{ .Values.global.environment | default "production" | quote }}
data:
  {{- /* Main configuration */}}
  erlmcp.conf: |
    {{- if .Values.storage.config.data.erlmcp.conf }}
    {{- .Values.storage.config.data.erlmcp.conf | nindent 4 }}
    {{- else }}
    %% erlmcp configuration file
    %% Generated by Kubernetes deployment
    {session_backend, ets}.
    {session_backend_config, #{
        retention => "{{ .Values.erlmcp.config.session.retention | default "24h" }}",
        max_sessions => {{ .Values.erlmcp.config.session.maxSessions | default 10000 }},
        cleanup_interval => "{{ .Values.erlmcp.config.session.cleanupInterval | default "5m" }}"
    }}.
    {registry_type, {{ .Values.erlmcp.config.registry.type | default "distributed" }}}.
    {registry_config, #{
        max_entries => {{ .Values.erlmcp.config.registry.maxEntries | default 100000 }},
        cleanup_interval => "{{ .Values.erlmcp.config.registry.cleanupInterval | default "10m" }}"
    }}.
    {transport_tcp_port, {{ .Values.erlmcp.config.transport.tcp.port | default 8080 }}}.
    {transport_http_port, {{ .Values.erlmcp.config.transport.http.port | default 8081 }}}.
    {transport_ws_port, {{ .Values.erlmcp.config.transport.ws.port | default 8082 }}}.
    {transport_sse_port, {{ .Values.erlmcp.config.transport.sse.port | default 8083 }}}.
    {erlang_cookie, "{{ .Values.erlmcp.erlang.cookie | default "erlmcp-secret-cookie" }}"}.
    {erlang_config, #{
        schedulers => {{ .Values.erlmcp.erlang.schedulers | default "logical" }},
        max_process_size => {{ .Values.erlmcp.erlang.maxProcessSize | default 128 }},
        total_memory => "{{ .Values.erlmcp.erlang.totalMemory | default "70%" }}",
        processes => {{ .Values.erlmcp.erlang.processes | default 20000 }}
    }}.
    {{- end }}

  {{- /* Transport configuration */}}
  transport.conf: |
    {{- if .Values.storage.config.data.transport.conf }}
    {{- .Values.storage.config.data.transport.conf | nindent 4 }}
    {{- else }}
    %% Transport configuration
    {transport_tcp, #{
        port => {{ .Values.erlmcp.config.transport.tcp.port | default 8080 }},
        backlog => {{ .Values.erlmcp.config.transport.tcp.backlog | default 1024 }},
        max_connections => {{ .Values.erlmcp.config.transport.tcp.maxConnections | default 10000 }}
    }}.
    {transport_http, #{
        port => {{ .Values.erlmcp.config.transport.http.port | default 8081 }},
        max_connections => {{ .Values.erlmcp.config.transport.http.maxConnections | default 5000 }}
    }}.
    {transport_ws, #{
        port => {{ .Values.erlmcp.config.transport.ws.port | default 8082 }},
        max_connections => {{ .Values.erlmcp.config.transport.ws.maxConnections | default 5000 }}
    }}.
    {transport_sse, #{
        port => {{ .Values.erlmcp.config.transport.sse.port | default 8083 }},
        max_connections => {{ .Values.erlmcp.config.transport.sse.maxConnections | default 5000 }}
    }}.
    {{- end }}

  {{- /* Security configuration */}}
  security.conf: |
    {{- if .Values.storage.config.data.security.conf }}
    {{- .Values.storage.config.data.security.conf | nindent 4 }}
    {{- else }}
    %% Security configuration
    {mTLS, #{
        enabled => {{ .Values.erlmcp.config.security.mTLS.enabled | default true }},
        cert_file => "/etc/erlmcp/certs/server.crt",
        key_file => "/etc/erlmcp/certs/server.key",
        ca_file => "/etc/erlmcp/certs/ca.crt"
    }}.
    {rate_limit, #{
        enabled => {{ .Values.erlmcp.config.security.rateLimit.enabled | default true }},
        requests => {{ .Values.erlmcp.config.security.rateLimit.requests | default 100 }},
        window => "{{ .Values.erlmcp.config.security.rateLimit.window | default "1m" }}"
    }}.
    {{- end }}

  {{- /* Logging configuration */}}
  logging.conf: |
    {{- if .Values.storage.config.data.logging.conf }}
    {{- .Values.storage.config.data.logging.conf | nindent 4 }}
    {{- else }}
    %% Logging configuration
    {level, {{ .Values.logging.level | default "info" }}}.
    {format, {{ .Values.logging.format | default "json" }}}.
    {output, {{ .Values.logging.output | default "stdout" }}}.
    {retention, {{ .Values.logging.retention | default "7d" }}}.
    {rotate_size, {{ .Values.logging.rotateSize | default "100MB" }}}.
    {rotate_count, {{ .Values.logging.rotateCount | default 5 }}}.
    {{- end }}

  {{- /* OpenTelemetry configuration */}}
  otel.conf: |
    {{- if .Values.storage.config.data.otel.conf }}
    {{- .Values.storage.config.data.otel.conf | nindent 4 }}
    {{- else }}
    %% OpenTelemetry configuration
    {exporter, #{
        endpoint => "{{ .Values.global.monitoring.otel.endpoint | default "http://otel-collector:4317" }}",
        compression => "{{ .Values.global.monitoring.otel.compression | default "gzip" }}",
        timeout => 30
    }}.
    {tracing, #{
        enabled => true,
        sample_rate => "1.0",
        attributes => #{
            service.name => "{{ include "erlmcp.fullname" . }}",
            service.version => "{{ .Chart.AppVersion }}"
        }
    }}.
    {metrics, #{
        enabled => true,
        interval => 30,
        attributes => #{
            service.name => "{{ include "erlmcp.fullname" . }}",
            service.version => "{{ .Chart.AppVersion }}"
        }
    }}.
    {{- end }}

  {{- /* Service mesh configuration */}}
  mesh.conf: |
    {{- if .Values.storage.config.data.mesh.conf }}
    {{- .Values.storage.config.data.mesh.conf | nindent 4 }}
    {{- else }}
    %% Service mesh configuration
    {istio, #{
        enabled => {{ .Values.global.serviceMesh.istio.enabled | default true }},
        gateway => "{{ .Values.global.serviceMesh.istio.gateway | default "erlmcp-gateway" }}",
        namespace => "{{ .Values.global.serviceMesh.istio.namespace | default "istio-system" }}"
    }}.
    {linkerd, #{
        enabled => {{ .Values.global.serviceMesh.linkerd.enabled | default false }},
        inject => {{ .Values.global.serviceMesh.linkerd.inject | default true }},
        namespace => "{{ .Values.global.serviceMesh.linkerd.namespace | default "linkerd" }}"
    }}.
    {{- end }}

  {{- /* Multi-cluster configuration */}}
  multicluster.conf: |
    {{- if .Values.storage.config.data.multicluster.conf }}
    {{- .Values.storage.config.data.multicluster.conf | nindent 4 }}
    {{- else }}
    %% Multi-cluster configuration
    {discovery, #{
        enabled => {{ .Values.multicluster.discovery.enabled | default true }},
        method => "{{ .Values.multicluster.discovery.method | default "dns" }}",
        domain => "{{ .Values.multicluster.discovery.domain | default "erlmcp-cluster.local" }}"
    }}.
    {replication, #{
        enabled => {{ .Values.multicluster.replication.enabled | default true }},
        sync_interval => "{{ .Values.multicluster.replication.syncInterval | default "5m" }}",
        sync_timeout => "{{ .Values.multicluster.replication.syncTimeout | default "30s" }}"
    }}.
    {{- end }}

  {{- /* Monitoring configuration */}}
  monitoring.conf: |
    {{- if .Values.storage.config.data.monitoring.conf }}
    {{- .Values.storage.config.data.monitoring.conf | nindent 4 }}
    {{- else }}
    %% Monitoring configuration
    {prometheus, #{
        enabled => {{ .Values.monitoring.prometheus.enabled | default true }},
        port => 9090,
        path => "/metrics",
        interval => 30,
        timeout => 10
    }}.
    {grafana, #{
        enabled => {{ .Values.monitoring.grafana.enabled | default true }},
        dashboard => #{
            enabled => {{ .Values.monitoring.grafana.dashboard.enabled | default true }},
            name => "{{ .Values.monitoring.grafana.dashboard.name | default "erlmcp-dashboard" }}",
            path => "/dashboards/erlmcp.json"
        }
    }}.
    {{- end }}

  {{- /* Backup configuration */}}
  backup.conf: |
    {{- if .Values.storage.config.data.backup.conf }}
    {{- .Values.storage.config.data.backup.conf | nindent 4 }}
    {{- else }}
    %% Backup configuration
    {backup, #{
        enabled => {{ .Values.backup.enabled | default true }},
        strategy => "{{ .Values.backup.strategy | default "velero" }}",
        schedule => "{{ .Values.backup.schedule | default "0 2 * * *" }}",
        retention => "{{ .Values.backup.retention | default "7d" }}"
    }}.
    {recovery, #{
        enabled => {{ .Values.backup.recovery.enabled | default true }},
        strategy => "{{ .Values.backup.recovery.strategy | default "restore" }}",
        checkpoint => "{{ .Values.backup.recovery.checkpoint | default "auto" }}",
        snapshot => "{{ .Values.backup.recovery.snapshot | default "auto" }}"
    }}.
    {{- end }}

  {{- /* Disaster recovery configuration */}}
  disaster_recovery_conf: |
    {{- if .Values.storage.config.data.disaster_recovery_conf }}
    {{- .Values.storage.config.data.disaster_recovery_conf | nindent 4 }}
    {{- else }}
    %% Disaster recovery configuration
    {strategy, #{
        type => "{{ .Values.disasterRecovery.strategy | default "active-passive" }}",
        active_cluster => "{{ .Values.disasterRecovery.activeCluster | default "primary" }}",
        passive_cluster => "{{ .Values.disasterRecovery.passiveCluster | default "secondary" }}"
    }}.
    {failover, #{
        enabled => {{ .Values.disasterRecovery.failover.enabled | default true }},
        timeout => "{{ .Values.disasterRecovery.failover.timeout | default "5m" }}",
        health_check_interval => "{{ .Values.disasterRecovery.failover.healthCheckInterval | default "30s" }}"
    }}.
    {replication, #{
        enabled => {{ .Values.disasterRecovery.replication.enabled | default true }},
        interval => "{{ .Values.disasterRecovery.replication.interval | default "1m" }}",
        mode => "{{ .Values.disasterRecovery.replication.mode | default "async" }}"
    }}.
    {{- end }}

  {{- /* Compliance configuration */}}
  compliance.conf: |
    {{- if .Values.storage.config.data.compliance.conf }}
    {{- .Values.storage.config.data.compliance.conf | nindent 4 }}
    {{- else }}
    %% Compliance configuration
    {cis, #{
        enabled => {{ .Values.compliance.cis.enabled | default true }},
        version => "{{ .Values.compliance.cis.version | default "1.6" }}",
        checks => [
            "1.1.1", "1.1.2", "1.2.1", "1.2.2", "1.3.1", "1.3.2",
            "1.4.1", "1.4.2", "1.5.1", "1.5.2", "1.6.1", "1.6.2"
        ]
    }}.
    {iso27001, #{
        enabled => {{ .Values.compliance.iso27001.enabled | default true }},
        controls => [
            "A.8.1.1", "A.8.1.2", "A.8.1.3", "A.8.2.1", "A.8.2.2", "A.8.2.3",
            "A.8.3.1", "A.8.3.2", "A.8.3.3", "A.8.4.1", "A.8.4.2", "A.8.4.3"
        ]
    }}.
    {assessment, #{
        enabled => {{ .Values.compliance.assessment.enabled | default true }},
        interval => "{{ .Values.compliance.assessment.interval | default "monthly" }}",
        schedule => "{{ .Values.compliance.assessment.schedule | default "0 5 1 * *" }}"
    }}.
    {{- end }}
{{- end }}