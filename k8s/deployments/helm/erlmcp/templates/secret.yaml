{{/*
  Updated Secret Templates for erlmcp v3
  References External Secrets Operator for external secret management
*/}}

{{- if .Values.externalSecrets.enabled }}
{{/*
  NO NATIVE SECRETS CREATED - Using ExternalSecret instead
  All secrets are managed by External Secrets Operator
  See templates/external-secrets/externalsecret.yaml
*/}}
{{- else if .Values.storage.tls.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.tlsSecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: tls
  annotations:
    "kubernetes.io/secret-type": "kubernetes.io/tls"
    "erlmcp.io/secrets": "tls"
    "erlmcp.io/managed-by": "helm"
    "erlmcp.io/external-sync": "false"
type: kubernetes.io/tls
data:
  {{- /* TLS certificate - Use environment variable or ExternalSecret */}}
  {{- if .Values.storage.tls.cert }}
  tls.crt: {{ .Values.storage.tls.cert | b64enc }}
  {{- else if .Values.externalSecrets.enabled }}
  tls.crt: {{ "" | b64enc }}  # Populated by ExternalSecret
  {{- else }}
  tls.crt: {{ "" | b64enc }}  # REQUIRED: Set via environment or ExternalSecret
  {{- end }}
  {{- /* TLS private key - Use environment variable or ExternalSecret */}}
  {{- if .Values.storage.tls.key }}
  tls.key: {{ .Values.storage.tls.key | b64enc }}
  {{- else if .Values.externalSecrets.enabled }}
  tls.key: {{ "" | b64enc }}  # Populated by ExternalSecret
  {{- else }}
  tls.key: {{ "" | b64enc }}  # REQUIRED: Set via environment or ExternalSecret
  {{- end }}
  {{- /* CA certificate */}}
  {{- if .Values.storage.tls.ca }}
  ca.crt: {{ .Values.storage.tls.ca | b64enc }}
  {{- else }}
  ca.crt: {{ "" | b64enc }}
  {{- end }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.storage.auth.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.authSecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: generic
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "auth"
    "erlmcp.io/managed-by": "helm"
    "erlmcp.io/external-sync": "false"
type: Opaque
data:
  {{- /* WARNING: These secrets should be managed by External Secrets Operator */}}
  {{- /* See templates/external-secrets/externalsecret.yaml for proper configuration */}}

  {{- /* Authentication credentials */}}
  username: {{ .Values.storage.auth.username | default "" | b64enc }}
  {{- /* REQUIRED: Database password - Use environment variable */}}
  {{- if .Values.storage.auth.password }}
  password: {{ .Values.storage.auth.password | b64enc }}
  {{- else }}
  password: {{ required "Database password required! Set storage.auth.password or enable externalSecrets" "" | b64enc }}
  {{- end }}
  token: {{ .Values.storage.auth.token | default "" | b64enc }}

  {{- /* Database connection strings - Use environment variables */}}
  database-url: {{ .Values.storage.auth.databaseUrl | default "" | b64enc }}
  redis-url: {{ .Values.storage.auth.redisUrl | default "" | b64enc }}

  {{- /* API keys - Use ExternalSecret */}}
  external-api-key: {{ .Values.storage.auth.externalApiKey | default "" | b64enc }}
  monitoring-api-key: {{ .Values.storage.auth.monitoringApiKey | default "" | b64enc }}

  {{- /* Session secret - Generate securely */}}
  {{- if .Values.storage.auth.sessionSecret }}
  session-secret: {{ .Values.storage.auth.sessionSecret | b64enc }}
  {{- else }}
  session-secret: {{ randAlphaNum 32 | b64enc }}
  {{- end }}

  {{- /* Config secret */}}
  config-secret: {{ .Values.storage.auth.configSecret | default "" | b64enc }}

  {{- /* Vault credentials - Use ExternalSecret */}}
  vault-token: {{ .Values.storage.auth.vaultToken | default "" | b64enc }}
  vault-secret: {{ .Values.storage.auth.vaultSecret | default "" | b64enc }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.vault.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.vaultSecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: vault
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "vault"
    "erlmcp.io/managed-by": "helm"
    "erlmcp.io/external-sync": "false"
type: Opaque
data:
  {{- /* Vault configuration - These should come from ExternalSecret */}}
  vault-token: {{ .Values.security.secrets.vault.auth.token | default "" | b64enc }}
  vault-address: {{ .Values.security.secrets.vault.address | default "" | b64enc }}
  vault-role: {{ .Values.security.secrets.vault.auth.role | default "erlmcp" | b64enc }}
  vault-path: {{ .Values.security.secrets.vault.auth.path | default "kubernetes" | b64enc }}

  {{- /* Vault secrets reference */}}
  erlmcp-config-secret: {{ .Values.security.secrets.vault.secrets | default "{}" | b64enc }}
  erlmcp-tls-secret: {{ .Values.security.secrets.vault.secrets | default "{}" | b64enc }}
  erlmcp-auth-secret: {{ .Values.security.secrets.vault.secrets | default "{}" | b64enc }}

  {{- /* Vault authentication */}}
  vault-auth-method: {{ .Values.security.secrets.vault.auth.method | default "kubernetes" | b64enc }}
  vault-auth-path: {{ .Values.security.secrets.vault.auth.path | default "kubernetes" | b64enc }}
  vault-auth-role: {{ .Values.security.secrets.vault.auth.role | default "erlmcp" | b64enc }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.awsSecretsManager.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.awsSecretsManagerName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: aws
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "aws"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- /* AWS configuration - Use IRSA or ExternalSecret */}}
  aws-access-key-id: {{ .Values.security.secrets.awsSecretsManager.accessKeyId | default "" | b64enc }}
  aws-secret-access-key: {{ .Values.security.secrets.awsSecretsManager.secretAccessKey | default "" | b64enc }}
  aws-region: {{ .Values.security.secrets.awsSecretsManager.region | default "us-east-1" | b64enc }}

  {{- /* AWS secrets references */}}
  erlmcp-config: {{ .Values.security.secrets.awsSecretsManager.secrets | default "{}" | b64enc }}
  erlmcp-tls: {{ .Values.security.secrets.awsSecretsManager.secrets | default "{}" | b64enc }}
  erlmcp-auth: {{ .Values.security.secrets.awsSecretsManager.secrets | default "{}" | b64enc }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.generic }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-generic-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: generic
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "generic"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- range $key, $value := .Values.security.secrets.generic }}
  {{ $key }}: {{ $value | b64enc }}
  {{- end }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.encrypted }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-encrypted-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: encrypted
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "encrypted"
    "erlmcp.io/encryption": "enabled"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- range $key, $value := .Values.security.secrets.encrypted }}
  {{ $key }}: {{ $value | b64enc }}
  {{- end }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.oauth }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-oauth-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: oauth
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "oauth"
    "erlmcp.io/oauth": "enabled"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- /* OAuth configuration - Use ExternalSecret */}}
  client-id: {{ .Values.security.secrets.oauth.clientId | default "" | b64enc }}
  client-secret: {{ .Values.security.secrets.oauth.clientSecret | default "" | b64enc }}
  redirect-uri: {{ .Values.security.secrets.oauth.redirectUri | default "" | b64enc }}
  scope: {{ .Values.security.secrets.oauth.scope | default "" | b64enc }}
  token-url: {{ .Values.security.secrets.oauth.tokenUrl | default "" | b64enc }}
  auth-url: {{ .Values.security.secrets.oauth.authUrl | default "" | b64enc }}

  {{- /* OAuth provider */}}
  provider: {{ .Values.security.secrets.oauth.provider | default "" | b64enc }}
  tenant: {{ .Values.security.secrets.oauth.tenant | default "" | b64enc }}
  domain: {{ .Values.security.secrets.oauth.domain | default "" | b64enc }}

  {{- /* OAuth tokens */}}
  access-token: {{ .Values.security.secrets.oauth.accessToken | default "" | b64enc }}
  refresh-token: {{ .Values.security.secrets.oauth.refreshToken | default "" | b64enc }}
  id-token: {{ .Values.security.secrets.oauth.idToken | default "" | b64enc }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.jwt }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-jwt-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: jwt
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "jwt"
    "erlmcp.io/jwt": "enabled"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- /* JWT configuration - Use ExternalSecret for production */}}
  {{- if .Values.security.secrets.jwt.secret }}
  jwt-secret: {{ .Values.security.secrets.jwt.secret | b64enc }}
  {{- else }}
  jwt-secret: {{ randAlphaNum 32 | b64enc }}  # Auto-generated, NOT secure for production
  {{- end }}
  jwt-algorithm: {{ .Values.security.secrets.jwt.algorithm | default "HS256" | b64enc }}
  jwt-issuer: {{ .Values.security.secrets.jwt.issuer | default "erlmcp" | b64enc }}
  jwt-audience: {{ .Values.security.secrets.jwt.audience | default "erlmcp-users" | b64enc }}
  jwt-expiration: {{ .Values.security.secrets.jwt.expiration | default "3600" | b64enc }}

  {{- /* JWT keys */}}
  public-key: {{ .Values.security.secrets.jwt.publicKey | default "" | b64enc }}
  private-key: {{ .Values.security.secrets.jwt.privateKey | default "" | b64enc }}

  {{- /* JWT claims */}}
  custom-claims: {{ .Values.security.secrets.jwt.customClaims | default "{}" | b64enc }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.database }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-database-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: database
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "database"
    "erlmcp.io/database": "enabled"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- /* Database configuration - Use ExternalSecret or Vault */}}
  database-host: {{ .Values.security.secrets.database.host | default "" | b64enc }}
  database-port: {{ .Values.security.secrets.database.port | default "5432" | b64enc }}
  database-name: {{ .Values.security.secrets.database.name | default "erlmcp" | b64enc }}
  database-user: {{ .Values.security.secrets.database.user | default "erlmcp" | b64enc }}
  {{- /* REQUIRED: Database password */}}
  {{- if .Values.security.secrets.database.password }}
  database-password: {{ .Values.security.secrets.database.password | b64enc }}
  {{- else }}
  database-password: {{ required "Database password required! Set security.secrets.database.password or enable externalSecrets" "" | b64enc }}
  {{- end }}
  database-ssl: {{ .Values.security.secrets.database.ssl | default "true" | b64enc }}

  {{- /* Connection strings */}}
  connection-string: {{ .Values.security.secrets.database.connectionString | default "" | b64enc }}
  pool-settings: {{ .Values.security.secrets.database.poolSettings | default "{}" | b64enc }}

  {{- /* Replication */}}
  replication-host: {{ .Values.security.secrets.database.replicationHost | default "" | b64enc }}
  replication-port: {{ .Values.security.secrets.database.replicationPort | default "5432" | b64enc }}
  replication-role: {{ .Values.security.secrets.database.replicationRole | default "replica" | b64enc }}
{{- end }}

{{- if and (not .Values.externalSecrets.enabled) .Values.security.secrets.kubernetes }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-kubernetes-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets
    type: kubernetes
  annotations:
    "kubernetes.io/secret-type": "Opaque"
    "erlmcp.io/secrets": "kubernetes"
    "erlmcp.io/kubernetes": "enabled"
    "erlmcp.io/managed-by": "helm"
type: Opaque
data:
  {{- /* Kubernetes configuration */}}
  kubeconfig: {{ .Values.security.secrets.kubernetes.kubeconfig | default "" | b64enc }}
  service-account-token: {{ .Values.security.secrets.kubernetes.serviceAccountToken | default "" | b64enc }}
  cluster-name: {{ .Values.security.secrets.kubernetes.clusterName | default "erlmcp-cluster" | b64enc }}
  namespace: {{ .Values.security.secrets.kubernetes.namespace | default "erlmcp" | b64enc }}

  {{- /* RBAC */}}
  role: {{ .Values.security.secrets.kubernetes.role | default "" | b64enc }}
  role-binding: {{ .Values.security.secrets.kubernetes.roleBinding | default "" | b64enc }}
  service-account: {{ .Values.security.secrets.kubernetes.serviceAccount | default "erlmcp" | b64enc }}

  {{- /* API server */}}
  api-server: {{ .Values.security.secrets.kubernetes.apiServer | default "" | b64enc }}
  ca-data: {{ .Values.security.secrets.kubernetes.caData | default "" | b64enc }}
  ca-file: {{ .Values.security.secrets.kubernetes.caFile | default "" | b64enc }}
{{- end }}

{{- if .Values.externalSecrets.enabled }}
{{/*
  IMPORTANT NOTICE: External Secrets Operator is enabled
  Native Kubernetes Secrets will NOT be created by this template.
  All secrets are synced from external sources (Vault, AWS Secrets Manager, etc.)
  via ExternalSecret resources defined in templates/external-secrets/
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.fullname" . }}-external-secrets-info
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secrets-info
  annotations:
    "erlmcp.io/secret-management": "external-secrets-operator"
data:
  management: "external-secrets-operator"
  enabled: "true"
  info: |
    This deployment uses External Secrets Operator for secret management.
    Secrets are synced from external providers (Vault, AWS, Azure, GCP).
    See templates/external-secrets/ for configuration.
{{- end }}
