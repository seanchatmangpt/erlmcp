{{/*
  External Secrets Operator - ExternalSecret definitions
  Syncs secrets from external providers (Vault, AWS, etc.) to Kubernetes
*/}}

{{- if .Values.externalSecrets.enabled }}
{{- range .Values.externalSecrets.secrets }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .name | default (print (include "erlmcp.fullname" $) "-" .key) }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" $ | nindent 4 }}
    component: external-secrets
    managed-by: "external-secrets-operator"
  annotations:
    "external-secrets.io/secret-type": {{ .type | default "Opaque" }}
    "erlmcp.io/external-secret": {{ .key }}
    "erlmcp.io/rotation-policy": {{ .rotationPolicy | default "automatic" | quote }}
    "erlmcp.io/version": {{ $.Chart.AppVersion | quote }}
spec:
  refreshInterval: {{ .refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .secretStore | default "erlmcp-vault-store" }}
    kind: {{ .secretStoreKind | default "SecretStore" }}
  target:
    name: {{ .targetName | default (print (include "erlmcp.fullname" $) "-" .key) }}
    creationPolicy: {{ .creationPolicy | default "Owner" }}
    deletionPolicy: {{ .deletionPolicy | default "Retain" }}
    template:
      type: {{ .type | default "Opaque" }}
      {{- with .template }}
      data:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  {{- with .data }}
  data:
    {{- range . }}
  - secretKey: {{ .secretKey }}
    remoteRef:
      {{- if .key }}
      key: {{ .key }}
      {{- end }}
      {{- if .property }}
      property: {{ .property }}
      {{- end }}
      {{- if .version }}
      version: {{ .version }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- with .dataFrom }}
  dataFrom:
    {{- if .extract }}
    extract:
      {{- range .extract }}
      - key: {{ .key }}
        {{- with .property }}
        property: {{ . }}
        {{- end }}
        {{- with .conversionStrategy }}
        conversionStrategy: {{ . }}
        {{- end }}
        {{- with .decodingStrategy }}
        decodingStrategy: {{ . }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- if .all }}
    all: true
    {{- end }}
    {{- with .find }}
    find:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

{{/*
  ClusterExternalSecret for multi-cluster secret synchronization
*/}}
{{- if .Values.externalSecrets.clusterSecrets.enabled }}
{{- range .Values.externalSecrets.clusterSecrets.secrets }}
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterExternalSecret
metadata:
  name: {{ .name | default (print "erlmcp-" .key) }}
  labels:
    {{- include "erlmcp.labels" $ | nindent 4 }}
    component: cluster-external-secrets
    managed-by: "external-secrets-operator"
  annotations:
    "erlmcp.io/cluster-secret": {{ .key }}
    "erlmcp.io/rotation-policy": {{ .rotationPolicy | default "automatic" | quote }}
spec:
  refreshInterval: {{ .refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .secretStore | default "erlmcp-cluster-vault-store" }}
    kind: ClusterSecretStore
  target:
    name: {{ .targetName | default (print "erlmcp-" .key) }}
    template:
      type: {{ .type | default "Opaque" }}
      {{- with .template }}
      data:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  namespaceSelectors:
    matchLabels:
      {{- range $key, $value := .namespaceSelectors }}
      {{ $key }}: {{ $value }}
      {{- end }}
  {{- with .data }}
  data:
    {{- range . }}
  - secretKey: {{ .secretKey }}
    remoteRef:
      key: {{ .key }}
      {{- with .property }}
      property: {{ . }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

{{/*
  SecretStore definition for External Secrets Operator
*/}}
{{- if .Values.externalSecrets.secretStore.vault.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.externalSecrets.secretStore.vault.name | default "erlmcp-vault-store" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secret-store
  annotations:
    "erlmcp.io/store-type": "vault"
    "erlmcp.io/version": {{ .Chart.AppVersion | quote }}
spec:
  provider:
    vault:
      server: {{ .Values.externalSecrets.secretStore.vault.address | default "https://vault.vault.svc.cluster.local:8200" }}
      path: {{ .Values.externalSecrets.secretStore.vault.path | default "secret" }}
      version: {{ .Values.externalSecrets.secretStore.vault.version | default "v2" }}
      auth:
        kubernetes:
          mountPath: {{ .Values.externalSecrets.secretStore.vault.authMountPath | default "kubernetes" }}
          role: {{ .Values.externalSecrets.secretStore.vault.role | default "erlmcp" }}
          secretRef:
            name: {{ .Values.externalSecrets.secretStore.vault.secretRef | default "erlmcp-vault-auth" }}
            namespace: {{ .Release.Namespace }}
{{- end }}

{{/*
  ClusterSecretStore for multi-cluster deployments
*/}}
{{- if .Values.externalSecrets.clusterStore.vault.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: {{ .Values.externalSecrets.clusterStore.vault.name | default "erlmcp-cluster-vault-store" }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: cluster-secret-store
  annotations:
    "erlmcp.io/store-type": "vault-cluster"
spec:
  provider:
    vault:
      server: {{ .Values.externalSecrets.clusterStore.vault.address | required "Vault address required for cluster store" }}
      path: {{ .Values.externalSecrets.clusterStore.vault.path | default "secret" }}
      version: {{ .Values.externalSecrets.clusterStore.vault.version | default "v2" }}
      auth:
        kubernetes:
          mountPath: {{ .Values.externalSecrets.clusterStore.vault.authMountPath | default "kubernetes" }}
          role: {{ .Values.externalSecrets.clusterStore.vault.role | default "erlmcp-cluster" }}
          secretRef:
            name: {{ .Values.externalSecrets.clusterStore.vault.secretRef | default "erlmcp-vault-auth" }}
            namespace: {{ .Values.externalSecrets.clusterStore.vault.namespace | default "erlmcp-system" }}
{{- end }}

{{/*
  AWS Secrets Manager SecretStore
*/}}
{{- if .Values.externalSecrets.secretStore.aws.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.externalSecrets.secretStore.aws.name | default "erlmcp-aws-store" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secret-store
  annotations:
    "erlmcp.io/store-type": "aws-secrets-manager"
spec:
  provider:
    aws:
      service: {{ .Values.externalSecrets.secretStore.aws.service | default "SecretsManager" }}
      region: {{ .Values.externalSecrets.secretStore.aws.region | required "AWS region required" }}
      auth:
        jwt:
          serviceAccountRef:
            name: {{ .Values.externalSecrets.secretStore.aws.serviceAccount | default "erlmcp" }}
{{- end }}

{{/*
  Azure Key Vault SecretStore
*/}}
{{- if .Values.externalSecrets.secretStore.azure.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.externalSecrets.secretStore.azure.name | default "erlmcp-azure-store" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secret-store
  annotations:
    "erlmcp.io/store-type": "azure-keyvault"
spec:
  provider:
    azurekv:
      tenantId: {{ .Values.externalSecrets.secretStore.azure.tenantId | required "Azure tenant ID required" }}
      vaultUrl: {{ .Values.externalSecrets.secretStore.azure.vaultUrl | required "Azure Key Vault URL required" }}
      auth:
        managedIdentity:
          identityId: {{ .Values.externalSecrets.secretStore.azure.identityId | default "" }}
{{- end }}

{{/*
  GCPSecretManager SecretStore
*/}}
{{- if .Values.externalSecrets.secretStore.gcp.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.externalSecrets.secretStore.gcp.name | default "erlmcp-gcp-store" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secret-store
  annotations:
    "erlmcp.io/store-type": "gcp-secret-manager"
spec:
  provider:
    gcpsm:
      project: {{ .Values.externalSecrets.secretStore.gcp.project | required "GCP project required" }}
      auth:
        workloadIdentity:
          clusterLocation: {{ .Values.externalSecrets.secretStore.gcp.clusterLocation | required "GCP cluster location required" }}
          clusterName: {{ .Values.externalSecrets.secretStore.gcp.clusterName | required "GCP cluster name required" }}
          serviceAccountRef:
            name: {{ .Values.externalSecrets.secretStore.gcp.serviceAccount | default "erlmcp" }}
{{- end }}
