{{/*
  Secret Rotation Policy Configuration
  Defines automated secret rotation policies for security compliance
*/}}

{{- if .Values.secretRotation.enabled }}
{{- range .Values.secretRotation.policies }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretRotationPolicy
metadata:
  name: {{ .name | default (print (include "erlmcp.fullname" $) "-" .key "-rotation") }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" $ | nindent 4 }}
    component: secret-rotation
    policy-type: {{ .type | default "time-based" }}
  annotations:
    "erlmcp.io/rotation-schedule": {{ .schedule | default "monthly" | quote }}
    "erlmcp.io/rotation-compliance": {{ .complianceLevel | default "high" | quote }}
    "erlmcp.io/version": {{ $.Chart.AppVersion | quote }}
spec:
  schedule: {{ .schedule | default "0 0 1 * *" | quote }}
  {{- if .timeZone }}
  timeZone: {{ .timeZone | quote }}
  {{- end }}
  secretRef:
    name: {{ .secretName | required "Secret name required for rotation policy" }}
    namespace: {{ .namespace | default $.Release.Namespace }}
  rotationStrategy:
    type: {{ .strategy.type | default "automatic" }}
    {{- if eq .strategy.type "automatic" }}
    automatic:
      generateNew: {{ .strategy.generateNew | default true }}
      length: {{ .strategy.length | default 32 }}
      policy: {{ .strategy.policy | default "alphabetic" }}
      {{- with .strategy.characters }}
      characters:
        upper: {{ .upper | default true }}
        lower: {{ .lower | default true }}
        numeric: {{ .numeric | default true }}
        special: {{ .special | default true }}
      {{- end }}
    {{- end }}
    {{- if eq .strategy.type "manual" }}
    manual:
      approvalRequired: {{ .strategy.approvalRequired | default true }}
      approvers: {{ .strategy.approvers | default list }}
      notificationChannel: {{ .strategy.notificationChannel | default "" }}
    {{- end }}
    {{- if eq .strategy.type "vault" }}
    vault:
      path: {{ .strategy.vaultPath | required "Vault path required for vault rotation" }}
      renew: {{ .strategy.renew | default true }}
      ttl: {{ .strategy.ttl | default "720h" }}
    {{- end }}
  postRotation:
    {{- with .postRotation.actions }}
    actions:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- if .postRotation.restartPods }}
    restartPods:
      enabled: true
      rollout:
        deployment:
          name: {{ .postRotation.restartPods.deployment | default (include "erlmcp.fullname" $) }}
          namespace: {{ .postRotation.restartPods.namespace | default $.Release.Namespace }}
      strategy:
        type: {{ .postRotation.restartPods.strategy | default "RollingUpdate" }}
        maxUnavailable: {{ .postRotation.restartPods.maxUnavailable | default 1 }}
    {{- end }}
  compliance:
    retentionPeriod: {{ .compliance.retentionPeriod | default "90d" }}
    auditLogging: {{ .compliance.auditLogging | default true }}
    encryptionAtRest: {{ .compliance.encryptionAtRest | default true }}
    {{- if .compliance.notify }}
    notify:
      {{- toYaml .compliance.notify | nindent 6 }}
    {{- end }}
{{- end }}
{{- end }}

{{/*
  RotatedSecret - tracks secret rotation history
*/}}
{{- if .Values.secretRotation.tracking.enabled }}
{{- range .Values.secretRotation.tracking.secrets }}
---
apiVersion: external-secrets.io/v1beta1
kind: RotatedSecret
metadata:
  name: {{ .name | default (print (include "erlmcp.fullname" $) "-" .key "-rotated") }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" $ | nindent 4 }}
    component: rotated-secret
    tracked: "true"
  annotations:
    "erlmcp.io/rotation-tracking": {{ .key }}
    "erlmcp.io/last-rotation": {{ now | date "2006-01-02T15:04:05Z" }}
spec:
  secretRef:
    name: {{ .secretName | required "Secret name required for rotation tracking" }}
    namespace: {{ .namespace | default $.Release.Namespace }}
  history:
    limit: {{ .historyLimit | default 12 }}
    retention: {{ .retention | default "90d" }}
  rotationHistory:
    enabled: {{ .trackHistory | default true }}
    storeInVault: {{ .storeInVault | default true }}
    vaultPath: {{ .vaultPath | default "audit/secret-rotations" }}
{{- end }}
{{- end }}

{{/*
  Secret Rotation Certificate Policy for TLS certificates
*/}}
{{- if .Values.secretRotation.certificates.enabled }}
{{- range .Values.secretRotation.certificates.certs }}
---
apiVersion: external-secrets.io/v1beta1
kind: CertRotationPolicy
metadata:
  name: {{ .name | default (print (include "erlmcp.fullname" $) "-" .key "-cert-rotation") }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" $ | nindent 4 }}
    component: cert-rotation
    cert-type: {{ .type | default "tls" }}
  annotations:
    "erlmcp.io/cert-rotation": {{ .schedule | default "30d" | quote }}
spec:
  schedule: {{ .schedule | default "0 0 */30 * *" | quote }}
  secretRef:
    name: {{ .secretName | required "Certificate secret name required" }}
    namespace: {{ .namespace | default $.Release.Namespace }}
  certificate:
    commonName: {{ .commonName | required "Certificate common name required" }}
    dnsNames:
      {{- range .dnsNames }}
      - {{ . }}
      {{- end }}
    ipAddresses:
      {{- range .ipAddresses }}
      - {{ . }}
      {{- end }}
    validity: {{ .validity | default "90d" }}
    keySize: {{ .keySize | default 4096 }}
    keyAlgorithm: {{ .keyAlgorithm | default "RSA" }}
  renewBefore: {{ .renewBefore | default "720h" }}
  autoRenew: {{ .autoRenew | default true }}
  authority:
    type: {{ .authority.type | default "vault" }}
    {{- if eq .authority.type "vault" }}
    vault:
      path: {{ .authority.vaultPath | default "pki" }}
      role: {{ .authority.role | default "erlmcp" }}
    {{- end }}
    {{- if eq .authority.type "cert-manager" }}
    certManager:
      issuer:
        name: {{ .authority.issuer | required "Issuer name required for cert-manager" }}
        kind: {{ .authority.kind | default "Issuer" }}
    {{- end }}
{{- end }}
{{- end }}

{{/*
  Secret Rotation Rollback - emergency rollback configuration
*/}}
{{- if .Values.secretRotation.rollback.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: SecretRotationRollback
metadata:
  name: {{ include "erlmcp.fullname" . }}-rotation-rollback
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: secret-rollback
  annotations:
    "erlmcp.io/rollback-policy": "emergency"
spec:
  enabled: {{ .Values.secretRotation.rollback.enabled }}
  maxRollbacks: {{ .Values.secretRotation.rollback.maxRollbacks | default 3 }}
  rollbackWindow: {{ .Values.secretRotation.rollback.rollbackWindow | default "24h" }}
  validation:
    required: true
    timeout: {{ .Values.secretRotation.rollback.validationTimeout | default "5m" }}
  notifyOnRollback:
    enabled: {{ .Values.secretRotation.rollback.notifyEnabled | default true }}
    channels:
      - {{ .Values.secretRotation.rollback.notificationChannel | default "slack" }}
{{- end }}
