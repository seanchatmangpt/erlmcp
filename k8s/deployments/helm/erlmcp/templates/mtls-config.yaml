{{/*
  Mutual TLS (mTLS) Configuration for erlmcp
  Enables zero-trust security between all services
*/}}

{{- if .Values.tls.mtls.enabled }}
{{- /* PeerAuthentication for STRICT mTLS mode */}}
---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: {{ include "erlmcp.fullname" . }}-mtls-strict
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: security
    policy-type: mtls
  annotations:
    "erlmcp.io/mtls-mode": "strict"
    "erlmcp.io/zero-trust": "enabled"
spec:
  selector:
    matchLabels:
      {{- include "erlmcp.selectorLabels" . | nindent 6 }}
  mtls:
    mode: STRICT
    {{- if .Values.tls.mtls.principle }}
    principle: {{ .Values.tls.mtls.principle }}
    {{- end }}

{{- /* PeerAuthentication for observability services */}}
---
{{- if .Values.tls.mtls.observability.enabled }}
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: {{ include "erlmcp.fullname" . }}-observability-mtls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: observability
    policy-type: mtls
spec:
  selector:
    matchLabels:
      app: {{ include "erlmcp.fullname" . }}-observability
  mtls:
    mode: {{ .Values.tls.mtls.observability.mode | default "PERMISSIVE" }}
{{- end }}

{{- /* Authorization Policy for mTLS-only access */}}
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: {{ include "erlmcp.fullname" . }}-mtls-authz
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: security
    policy-type: authorization
  annotations:
    "erlmcp.io/authorization-mode": "whitelist"
    "erlmcp.io/mtls-required": "true"
spec:
  selector:
    matchLabels:
      {{- include "erlmcp.selectorLabels" . | nindent 6 }}
  action: ALLOW
  rules:
    {{- /* Allow traffic from namespace services with mTLS */}}
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ .Release.Namespace }}/sa/{{ include "erlmcp.serviceAccountName" . }}"
              - "cluster.local/ns/{{ .Release.Namespace }}/sa/{{ include "erlmcp.fullname" . }}-observability"
            namespaces:
              - "{{ .Release.Namespace }}"
            requestPrincipals:
              - "{{ .Values.tls.mtls.trustedDomains | default "*.erlmcp.io" }}"
    {{- /* Allow traffic from service mesh control plane */}}
    - from:
        - source:
            principals:
              - "cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
              - "cluster.local/ns/istio-system/sa/istio-egressgateway-service-account"
            namespaces:
              - "istio-system"
    {{- /* Allow monitoring systems */}}
    - from:
        - source:
            principals:
              - "cluster.local/ns/monitoring/sa/prometheus"
              - "cluster.local/ns/monitoring/sa/grafana"
            namespaces:
              - "monitoring"
      to:
        - operation:
            ports:
              - "9090"  # Metrics
    {{- /* Allow health and readiness from ingress */}}
    - from:
        - source:
            namespaces:
              - "istio-system"
              - "ingress-nginx"
      to:
        - operation:
            paths:
              - "/health"
              - "/ready"
              - "/live"
    {{- /* Allow observability for tracing */}}
    - from:
        - source:
            namespaces:
              - "observability"
              - "istio-system"
            principals:
              - "cluster.local/ns/observability/sa/jaeger"
              - "cluster.local/ns/observability/sa/otel-collector"
      to:
        - operation:
            ports:
              - "4317"  # OTLP gRPC
              - "4318"  # OTLP HTTP
              - "9411"  # Zipkin

{{- /* Destination Rule for mTLS traffic policy */}}
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ include "erlmcp.fullname" . }}-mtls-destination
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: security
    policy-type: destination-rule
spec:
  host: "{{ include "erlmcp.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
      cipherSuites:
        {{- range .Values.tls.mtls.cipherSuites }}
        - {{ . }}
        {{- end }}
      minProtocolVersion: {{ .Values.tls.mtls.minProtocolVersion | default "TLSV1_3" }}
      maxProtocolVersion: {{ .Values.tls.mtls.maxProtocolVersion | default "TLSV1_3" }}
    connectionPool:
      tcp:
        maxConnections: {{ .Values.tls.mtls.connectionPool.tcp.maxConnections | default 100 }}
        connectTimeout: {{ .Values.tls.mtls.connectionPool.tcp.connectTimeout | default "10s" }}
        keepAlive:
          time: {{ .Values.tls.mtls.connectionPool.tcp.keepAlive.time | default "300s" }}
          interval: {{ .Values.tls.mtls.connectionPool.tcp.keepAlive.interval | default "60s" }}
          probes: {{ .Values.tls.mtls.connectionPool.tcp.keepAlive.probes | default 3 }}
      http:
        h2UpgradePolicy: {{ .Values.tls.mtls.connectionPool.http.h2UpgradePolicy | default "UPGRADE" }}
        idleTimeout: {{ .Values.tls.mtls.connectionPool.http.idleTimeout | default "300s" }}
        http2MaxRequests: {{ .Values.tls.mtls.connectionPool.http.http2MaxRequests | default 1000 }}
    loadBalancer:
      simple: {{ .Values.tls.mtls.loadBalancer | default "ROUND_ROBIN" }}
    outlierDetection:
      consecutive5xxErrors: {{ .Values.tls.mtls.outlierDetection.consecutive5xxErrors | default 3 }}
      interval: {{ .Values.tls.mtls.outlierDetection.interval | default "30s" }}
      baseEjectionTime: {{ .Values.tls.mtls.outlierDetection.baseEjectionTime | default "30s" }}
      maxEjectionPercent: {{ .Values.tls.mtls.outlierDetection.maxEjectionPercent | default 50 }}
      minHealthPercent: {{ .Values.tls.mtls.outlierDetection.minHealthPercent | default 50 }}

{{- /* Destination Rule for observability services */}}
---
{{- if .Values.tls.mtls.observability.enabled }}
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ include "erlmcp.fullname" . }}-observability-destination
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: observability
    policy-type: destination-rule
spec:
  host: "{{ include "erlmcp.fullname" . }}-observability.{{ .Release.Namespace }}.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: {{ .Values.tls.mtls.observability.mode | default "ISTIO_MUTUAL" }}
    connectionPool:
      tcp:
        maxConnections: {{ .Values.tls.mtls.connectionPool.tcp.maxConnections | default 50 }}
        connectTimeout: "10s"
{{- end }}

{{- /* mTLS ConfigMap for application-level configuration */}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.fullname" . }}-mtls-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: security
    type: mtls-config
  annotations:
    "erlmcp.io/mtls-enabled": "true"
data:
  mtls.conf: |
    %% mTLS configuration for erlmcp
    {mtls, [
      {enabled, true},
      {mode, strict},
      {cert_file, "/etc/erlmcp/certs/server.crt"},
      {key_file, "/etc/erlmcp/certs/server.key"},
      {ca_file, "/etc/erlmcp/certs/ca.crt"},
      {verify, verify_peer},
      {verify_fun, {ssl_verify_fun, [
        {fail_if_no_peer_cert, true},
        {verify_client_once, false}
      ]}},
      {ciphers, [
        %% TLS 1.3 cipher suites (FIPS 140-2 compliant)
        "TLS_AES_128_GCM_SHA256",
        "TLS_AES_256_GCM_SHA384",
        "TLS_CHACHA20_POLY1305_SHA256"
      ]},
      {honor_cipher_order, true},
      {versions, ['tlsv1.3', 'tlsv1.2']},
      {secure_renegotiate, true},
      {client_renegotiation, false},
      {session_tickets, disabled},
      {max_connections, 10000},
      {handshake_timeout, 10000},
      {keyfile_callback, {fun ssl_pkix_to_oauth:validate_key/1}}
    ]}.

    %% mTLS client configuration
    {mtls_client, [
      {enabled, true},
      {cert_file, "/etc/erlmcp/certs/client.crt"},
      {key_file, "/etc/erlmcp/certs/client.key"},
      {ca_file, "/etc/erlmcp/certs/ca.crt"},
      {verify, verify_peer},
      {server_name_indication, disable},
      {check_hostname, true},
      {depth, 3}
    ]}.

    %% Certificate validation
    {cert_validation, [
      {crl_check, true},
      {ocsp_check, true},
      {ocsp_responder_url, "http://ocsp.erlmcp.io"},
      {crl_cache_dir, "/var/cache/erlmcp/crl"},
      {crl_refresh_interval, 3600}
    ]}.

    %% mTLS policies
    {mtls_policies, [
      {service_to_service, [
        {require_client_cert, true},
        {require_server_cert, true},
        {allowed_principals, [
          "cluster.local/ns/erlmcp/sa/erlmcp",
          "cluster.local/ns/erlmcp-observability/sa/observability"
        ]},
        {allowed_namespaces, [
          "erlmcp",
          "erlmcp-observability",
          "monitoring",
          "istio-system"
        ]}
      ]},
      {external_apis, [
        {require_client_cert, false},
        {require_server_cert, true},
        {verify_hostname, true}
      ]}
    ]}.
  cipher-suites.txt: |
    # FIPS 140-2 compliant TLS 1.3 cipher suites
    TLS_AES_128_GCM_SHA256
    TLS_AES_256_GCM_SHA384
    TLS_CHACHA20_POLY1305_SHA256
  supported-curves.txt: |
    # Supported elliptic curves
    X25519
    prime256v1
    secp384r1
    secp521r1

{{- /* Secret for mTLS client credentials */}}
---
{{- if not .Values.externalSecrets.enabled }}
{{- if .Values.tls.mtls.client.generateSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "erlmcp.fullname" . }}-client-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: security
    type: mtls-client
  annotations:
    "erlmcp.io/mtls-client": "generated-by-cert-manager"
type: kubernetes.io/tls
data:
  {{- if .Values.tls.mtls.client.existingSecret }}
  tls.crt: {{ .Values.tls.mtls.client.existingSecret.crt | b64enc }}
  tls.key: {{ .Values.tls.mtls.client.existingSecret.key | b64enc }}
  ca.crt: {{ .Values.tls.mtls.client.existingSecret.ca | b64enc }}
  {{- else }}
  tls.crt: ""  # Generated by cert-manager
  tls.key: ""  # Generated by cert-manager
  ca.crt: ""   # Generated by cert-manager
  {{- end }}
{{- end }}
{{- end }}

{{- /* mTLS health check endpoint configuration */}}
---
{{- if .Values.tls.mtls.healthCheck.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "erlmcp.fullname" . }}-mtls-health
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: health
    type: mtls-health
data:
  mtls-health-check.sh: |
    #!/bin/sh
    # mTLS health check script

    set -e

    TLS_DIR="${TLS_DIR:-/etc/erlmcp/certs}"
    SERVER_CERT="$TLS_DIR/server.crt"
    SERVER_KEY="$TLS_DIR/server.key"
    CA_CERT="$TLS_DIR/ca.crt"

    # Check certificate existence
    if [ ! -f "$SERVER_CERT" ]; then
      echo "ERROR: Server certificate not found"
      exit 1
    fi

    if [ ! -f "$SERVER_KEY" ]; then
      echo "ERROR: Server key not found"
      exit 1
    fi

    if [ ! -f "$CA_CERT" ]; then
      echo "ERROR: CA certificate not found"
      exit 1
    fi

    # Check certificate validity
    EXPIRY=$(openssl x509 -in "$SERVER_CERT" -noout -enddate | cut -d= -f2)
    EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
    CURRENT_EPOCH=$(date +%s)
    DAYS_LEFT=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))

    if [ $DAYS_LEFT -lt 7 ]; then
      echo "WARNING: Certificate expires in $DAYS_LEFT days"
      exit 1
    fi

    # Verify certificate chain
    if ! openssl verify -CAfile "$CA_CERT" "$SERVER_CERT" > /dev/null 2>&1; then
      echo "ERROR: Certificate chain verification failed"
      exit 1
    fi

    # Check key match
    CERT_MODULUS=$(openssl x509 -noout -modulus -in "$SERVER_CERT" | openssl md5)
    KEY_MODULUS=$(openssl rsa -noout -modulus -in "$SERVER_KEY" | openssl md5)

    if [ "$CERT_MODULUS" != "$KEY_MODULUS" ]; then
      echo "ERROR: Certificate and key do not match"
      exit 1
    fi

    echo "OK: mTLS configuration is valid"
    exit 0
  check-interval: "{{ .Values.tls.mtls.healthCheck.interval | default "30s" }}"
  failure-threshold: "{{ .Values.tls.mtls.healthCheck.failureThreshold | default 3 }}"
{{- end }}

---
{{- /* ServiceEntry for external services with mTLS */}}
{{- if .Values.tls.mtls.externalServices }}
{{- range $service := .Values.tls.mtls.externalServices }}
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: {{ $service.name }}-external
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" $ | nindent 4 }}
    component: external-mtls
spec:
  hosts:
    - {{ $service.host }}
  ports:
    - number: {{ $service.port | default 443 }}
      name: https
      protocol: HTTPS
  location: MESH_EXTERNAL
  resolution: {{ $service.resolution | default "DNS" }}
  {{- if $service.subjectAltNames }}
  subjectAltNames:
    {{- range $service.subjectAltNames }}
    - {{ . }}
    {{- end }}
  {{- end }}
  tls:
    mode: {{ $service.tlsMode | default "MUTUAL" }}
    {{- if $service.clientCertificate }}
    clientCertificate: /etc/certs/{{ $service.clientCertificate }}
    {{- end }}
    {{- if $service.privateKey }}
    privateKey: /etc/certs/{{ $service.privateKey }}
    {{- end }}
    {{- if $service.caCertificates }}
    caCertificates: /etc/certs/{{ $service.caCertificates }}
    {{- end }}
    sni: {{ $service.sni | default $service.host }}
---
{{- end }}
{{- end }}
{{- end }}
