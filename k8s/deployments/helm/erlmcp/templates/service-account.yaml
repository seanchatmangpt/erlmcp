{{/*
  erlmcp Service Account
  Handles authentication and authorization for erlmcp pods
*/}}

apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "erlmcp.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "erlmcp.labels" . | nindent 4 }}
    component: service-account
  annotations:
    {{- with .Values.rbac.serviceAccount.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    "erlmcp.io/service-account": "enabled"
    "erlmcp.io/version": {{ .Chart.AppVersion | quote }}
    "erlmcp.io/environment": {{ .Values.global.environment | default "production" | quote }}
    "serviceaccounts.openshift.io/token-request-secret": "{{ include "erlmcp.serviceAccountName" . }}-token"
    {{- if .Values.global.cloud.gcpServiceAccount }}
    "iam.gke.io/gcp-service-account": "{{ .Values.global.cloud.gcpServiceAccount }}"
    {{- end }}
    {{- if .Values.global.cloud.awsRole }}
    "eks.amazonaws.com/role-arn": "{{ .Values.global.cloud.awsRole }}"
    {{- end }}
    {{- if .Values.global.cloud.azureIdentity }}
    "azure.workload.identity/client-id": "{{ .Values.global.cloud.azureIdentity.clientId }}"
    {{- end }}
automountServiceAccountToken: {{ .Values.rbac.serviceAccount.automountServiceAccountToken | default true }}
secrets:
  {{- if .Values.rbac.serviceAccount.secrets }}
  {{- toYaml .Values.rbac.serviceAccount.secrets | nindent 4 }}
  {{- end }}
  {{- /* Token secret for authentication */}}
  - name: {{ include "erlmcp.serviceAccountName" . }}-token
imagePullSecrets:
  {{- if .Values.erlmcp.imagePullSecrets }}
  {{- toYaml .Values.erlmcp.imagePullSecrets | nindent 4 }}
  {{- end }}
  {{- /* Default pull secret */}}
  - name: erlmcp-pull-secret
{{- if .Values.rbac.serviceAccount.imagePullSecrets }}
{{- toYaml .Values.rbac.serviceAccount.imagePullSecrets | nindent 4 }}
{{- end }}