# -----------------------------------------------------------------------------
# Erlmcp K8s Deployment Manifest
# Generated via ggen methodology from k8s_deployment.ttl ontology
# Schema: k8s:Deployment, k8s:Container, k8s:Port, k8s:Probe, k8s:SecurityContext
# Version: 3.0.0
# -----------------------------------------------------------------------------

apiVersion: apps/v1
kind: Deployment
metadata:
  name: erlmcp
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
    version: "3.0.0"
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9100"
    prometheus.io/path: "/metrics"
    description: "Erlang/OTP MCP SDK - JSON-RPC 2.0 Server"
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: erlmcp
      component: server
  template:
    metadata:
      labels:
        app: erlmcp
        component: server
        version: "3.0.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
        prometheus.io/path: "/metrics"
    spec:
      # Zero-trust security baseline
      serviceAccountName: erlmcp
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # Graceful shutdown handling
      terminationGracePeriodSeconds: 60

      # Priority for production workload
      priorityClassName: high-priority

      # Init container for dependency readiness
      initContainers:
        - name: wait-for-otel
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z otel-collector 4317; do
                echo "Waiting for OTLP collector..."
                sleep 2
              done
              echo "OTLP collector ready"
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi

      containers:
        - name: erlmcp
          image: ghcr.io/seanchatmangpt/erlmcp:latest
          imagePullPolicy: IfNotPresent

          # Port mappings for HTTP, metrics, health, and Erlang distribution
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: metrics
              containerPort: 9100
              protocol: TCP
            - name: health
              containerPort: 9090
              protocol: TCP
            - name: epmd
              containerPort: 4369
              protocol: TCP
            - name: dist
              containerPort: 9100
              protocol: TCP

          # Environment configuration
          env:
            - name: ERLMCP_ENV
              value: "production"

            - name: LOG_LEVEL
              value: "info"

            # OpenTelemetry configuration
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://otel-collector:4317"
            - name: OTEL_SERVICE_NAME
              value: "erlmcp"
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: "service.namespace=production,service.version=3.0.0"

            # Pod metadata for distributed coordination
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

            # Erlang distribution configuration
            - name: ERL_AFLAGS
              value: "-proto_dist inet_tcp"

            # Optional: Secret references for production
            - name: ERLMCP_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: erlmcp-secrets
                  key: secret-key
                  optional: true

          # Resource limits and requests
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi

          # Container-level security context
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE

          # Liveness probe - checks if process is alive
          livenessProbe:
            exec:
              command:
                - /opt/erlmcp/bin/erlmcp
                - ping
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3

          # Readiness probe - checks if ready to serve traffic
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          # Startup probe - allows time for slow container initialization
          startupProbe:
            httpGet:
              path: /health
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 30

          # Volume mounts
          volumeMounts:
            - name: erlmcp-data
              mountPath: /var/lib/erlmcp
            - name: erlmcp-logs
              mountPath: /var/log/erlmcp
            - name: tmp
              mountPath: /tmp

      # High availability topology spread constraints
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: erlmcp
              component: server
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: erlmcp
              component: server

      # Pod anti-affinity for distribution
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - erlmcp
                    - key: component
                      operator: In
                      values:
                        - server
                topologyKey: kubernetes.io/hostname
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - erlmcp
                  - key: component
                    operator: In
                    values:
                      - server
              namespaces:
                - erlmcp
              topologyKey: kubernetes.io/hostname

      # Volumes
      volumes:
        - name: erlmcp-data
          persistentVolumeClaim:
            claimName: erlmcp-data
        - name: erlmcp-logs
          emptyDir: {}
        - name: tmp
          emptyDir: {}

---
# -----------------------------------------------------------------------------
# ClusterIP Service - Main HTTP API
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: erlmcp
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
    - name: metrics
      port: 9100
      targetPort: metrics
      protocol: TCP
    - name: health
      port: 9090
      targetPort: health
      protocol: TCP
  selector:
    app: erlmcp
    component: server

---
# -----------------------------------------------------------------------------
# Headless Service - Erlang Node Discovery
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: erlmcp-headless
  namespace: erlmcp
  labels:
    app: erlmcp
    component: server
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: epmd
      port: 4369
      targetPort: epmd
      protocol: TCP
    - name: dist
      port: 9100
      targetPort: dist
      protocol: TCP
  selector:
    app: erlmcp
    component: server

---
# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: erlmcp
  namespace: erlmcp
  labels:
    app: erlmcp
automountServiceAccountToken: false

---
# -----------------------------------------------------------------------------
# Persistent Volume Claim
# -----------------------------------------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: erlmcp-data
  namespace: erlmcp
  labels:
    app: erlmcp
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
# -----------------------------------------------------------------------------
# Pod Disruption Budget for high availability
# -----------------------------------------------------------------------------
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: erlmcp-pdb
  namespace: erlmcp
  labels:
    app: erlmcp
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: erlmcp
      component: server

---
# -----------------------------------------------------------------------------
# HorizontalPodAutoscaler for dynamic scaling
# -----------------------------------------------------------------------------
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: erlmcp-hpa
  namespace: erlmcp
  labels:
    app: erlmcp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: erlmcp
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 2
          periodSeconds: 30
      selectPolicy: Max
